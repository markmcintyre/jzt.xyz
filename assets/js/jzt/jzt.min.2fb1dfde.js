/* 
 * JZT — A DOS-Era Adventure Game for the Web
 * Copyright © 2022 Mark McIntyre
 * Created by Mark McIntyre
 * All rights reserved.
 * 
 * Version : 1.0.57
 * Released: 2022-03-06
 */
!function(t){if("object"==typeof exports&&"undefined"!=typeof module)module.exports=t();else if("function"==typeof define&&define.amd)define([],t);else{var e;e="undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:this,e.jzt=t()}}(function(){var t;return function(){function t(e,i,s){function o(n,a){if(!i[n]){if(!e[n]){var h="function"==typeof require&&require;if(!a&&h)return h(n,!0);if(r)return r(n,!0);var c=new Error("Cannot find module '"+n+"'");throw c.code="MODULE_NOT_FOUND",c}var d=i[n]={exports:{}};e[n][0].call(d.exports,function(t){var i=e[n][1][t];return o(i||t)},d,d.exports,t,e,i,s)}return i[n].exports}for(var r="function"==typeof require&&require,n=0;n<s.length;n++)o(s[n]);return o}return t}()({1:[function(e,i,s){var o=function(){function t(t,e){if(!o[t]){o[t]={};for(var i=0;i<t.length;i++)o[t][t.charAt(i)]=i}return o[t][e]}var e=String.fromCharCode,i="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",s="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+-$",o={},r={compressToBase64:function(t){if(null==t)return"";var e=r._compress(t,6,function(t){return i.charAt(t)});switch(e.length%4){default:case 0:return e;case 1:return e+"===";case 2:return e+"==";case 3:return e+"="}},decompressFromBase64:function(e){return null==e?"":""==e?null:r._decompress(e.length,32,function(s){return t(i,e.charAt(s))})},compressToUTF16:function(t){return null==t?"":r._compress(t,15,function(t){return e(t+32)})+" "},decompressFromUTF16:function(t){return null==t?"":""==t?null:r._decompress(t.length,16384,function(e){return t.charCodeAt(e)-32})},compressToUint8Array:function(t){for(var e=r.compress(t),i=new Uint8Array(2*e.length),s=0,o=e.length;s<o;s++){var n=e.charCodeAt(s);i[2*s]=n>>>8,i[2*s+1]=n%256}return i},decompressFromUint8Array:function(t){if(null===t||void 0===t)return r.decompress(t);for(var i=new Array(t.length/2),s=0,o=i.length;s<o;s++)i[s]=256*t[2*s]+t[2*s+1];var n=[];return i.forEach(function(t){n.push(e(t))}),r.decompress(n.join(""))},compressToEncodedURIComponent:function(t){return null==t?"":r._compress(t,6,function(t){return s.charAt(t)})},decompressFromEncodedURIComponent:function(e){return null==e?"":""==e?null:(e=e.replace(/ /g,"+"),r._decompress(e.length,32,function(i){return t(s,e.charAt(i))}))},compress:function(t){return r._compress(t,16,function(t){return e(t)})},_compress:function(t,e,i){if(null==t)return"";var s,o,r,n={},a={},h="",c="",d="",p=2,u=3,l=2,f=[],g=0,y=0;for(r=0;r<t.length;r+=1)if(h=t.charAt(r),Object.prototype.hasOwnProperty.call(n,h)||(n[h]=u++,a[h]=!0),c=d+h,Object.prototype.hasOwnProperty.call(n,c))d=c;else{if(Object.prototype.hasOwnProperty.call(a,d)){if(d.charCodeAt(0)<256){for(s=0;s<l;s++)g<<=1,y==e-1?(y=0,f.push(i(g)),g=0):y++;for(o=d.charCodeAt(0),s=0;s<8;s++)g=g<<1|1&o,y==e-1?(y=0,f.push(i(g)),g=0):y++,o>>=1}else{for(o=1,s=0;s<l;s++)g=g<<1|o,y==e-1?(y=0,f.push(i(g)),g=0):y++,o=0;for(o=d.charCodeAt(0),s=0;s<16;s++)g=g<<1|1&o,y==e-1?(y=0,f.push(i(g)),g=0):y++,o>>=1}p--,0==p&&(p=Math.pow(2,l),l++),delete a[d]}else for(o=n[d],s=0;s<l;s++)g=g<<1|1&o,y==e-1?(y=0,f.push(i(g)),g=0):y++,o>>=1;p--,0==p&&(p=Math.pow(2,l),l++),n[c]=u++,d=String(h)}if(""!==d){if(Object.prototype.hasOwnProperty.call(a,d)){if(d.charCodeAt(0)<256){for(s=0;s<l;s++)g<<=1,y==e-1?(y=0,f.push(i(g)),g=0):y++;for(o=d.charCodeAt(0),s=0;s<8;s++)g=g<<1|1&o,y==e-1?(y=0,f.push(i(g)),g=0):y++,o>>=1}else{for(o=1,s=0;s<l;s++)g=g<<1|o,y==e-1?(y=0,f.push(i(g)),g=0):y++,o=0;for(o=d.charCodeAt(0),s=0;s<16;s++)g=g<<1|1&o,y==e-1?(y=0,f.push(i(g)),g=0):y++,o>>=1}p--,0==p&&(p=Math.pow(2,l),l++),delete a[d]}else for(o=n[d],s=0;s<l;s++)g=g<<1|1&o,y==e-1?(y=0,f.push(i(g)),g=0):y++,o>>=1;p--,0==p&&(p=Math.pow(2,l),l++)}for(o=2,s=0;s<l;s++)g=g<<1|1&o,y==e-1?(y=0,f.push(i(g)),g=0):y++,o>>=1;for(;;){if(g<<=1,y==e-1){f.push(i(g));break}y++}return f.join("")},decompress:function(t){return null==t?"":""==t?null:r._decompress(t.length,32768,function(e){return t.charCodeAt(e)})},_decompress:function(t,i,s){var o,r,n,a,h,c,d,p,u=[],l=4,f=4,g=3,y="",m=[],v={val:s(0),position:i,index:1};for(r=0;r<3;r+=1)u[r]=r;for(a=0,c=Math.pow(2,2),d=1;d!=c;)h=v.val&v.position,v.position>>=1,0==v.position&&(v.position=i,v.val=s(v.index++)),a|=(h>0?1:0)*d,d<<=1;switch(o=a){case 0:for(a=0,c=Math.pow(2,8),d=1;d!=c;)h=v.val&v.position,v.position>>=1,0==v.position&&(v.position=i,v.val=s(v.index++)),a|=(h>0?1:0)*d,d<<=1;p=e(a);break;case 1:for(a=0,c=Math.pow(2,16),d=1;d!=c;)h=v.val&v.position,v.position>>=1,0==v.position&&(v.position=i,v.val=s(v.index++)),a|=(h>0?1:0)*d,d<<=1;p=e(a);break;case 2:return""}for(u[3]=p,n=p,m.push(p);;){if(v.index>t)return"";for(a=0,c=Math.pow(2,g),d=1;d!=c;)h=v.val&v.position,v.position>>=1,0==v.position&&(v.position=i,v.val=s(v.index++)),a|=(h>0?1:0)*d,d<<=1;switch(p=a){case 0:for(a=0,c=Math.pow(2,8),d=1;d!=c;)h=v.val&v.position,v.position>>=1,0==v.position&&(v.position=i,v.val=s(v.index++)),a|=(h>0?1:0)*d,d<<=1;u[f++]=e(a),p=f-1,l--;break;case 1:for(a=0,c=Math.pow(2,16),d=1;d!=c;)h=v.val&v.position,v.position>>=1,0==v.position&&(v.position=i,v.val=s(v.index++)),a|=(h>0?1:0)*d,d<<=1;u[f++]=e(a),p=f-1,l--;break;case 2:return m.join("")}if(0==l&&(l=Math.pow(2,g),g++),u[p])y=u[p];else{if(p!==f)return null;y=n+n.charAt(0)}m.push(y),u[f++]=n+y.charAt(0),l--,n=y,0==l&&(l=Math.pow(2,g),g++)}}};return r}();"function"==typeof t&&t.amd?t(function(){return o}):"undefined"!=typeof i&&null!=i&&(i.exports=o)},{}],2:[function(t,e,i){"use strict";function s(){var t;for(c.tick.push(3200),t=0;t<14;++t)c.tweet.push(100*t+1e3);for(t=0;t<16;++t)c.cowbell.push(t%2*1600+1600+t%4+1600);for(t=0;t<14;++t)c.snare.push(1600*Math.random()+800);for(t=0;t<8;++t)c.woodblock.push(1600),c.woodblock.push(1600*Math.random()+800);for(t=0;t<14;++t)c.lowSnare.push(t%2*880+880+t%3*440);for(t=0;t<14;++t)c.tom.push(700-12*t);for(t=0;t<14;++t)c.lowWoodblock.push(20*t+1200-Math.random()*t*40);for(t=0;t<14;++t)c.bass.push(440*Math.random()+220)}function o(t,e){if(!(this instanceof o))throw a;this.noteIndex=t,this.frequency=h[this.noteIndex],this.duration=e}function r(t){if(!(this instanceof r))throw a;this.notes=[],this.parse(t)}function n(){var t=window.AudioContext||window.webkitAudioContext;if(!(this instanceof n))throw a;this.setActive(!0),this.active&&(this.context=new t,this.userVolume=.1,this.delay=.06,this.volume=this.context.createGain?this.context.createGain():this.context.createGainNode(),this.volume.gain.value=0,this.volume.connect(this.context.destination),this.oscillator=this.context.createOscillator(),this.oscillator.type=this.oscillator.SQUARE||"square",this.oscillator.connect(this.volume),this.oscillator.start||(this.oscillator.start=this.oscillator.noteOn),this.timestamp=this.context.currentTime,this.interruptTimestamp=this.context.currentTime,this.oscillator.start(this.context.currentTime))}var a=t("./basic").ConstructorError,h=[16.35,17.32,18.35,19.45,20.6,21.83,23.12,24.5,25.96,27.5,29.14,30.87,32.7,34.65,36.71,38.89,41.2,43.65,46.25,49,51.91,55,58.27,61.74,65.41,69.3,73.42,77.78,82.41,87.31,92.5,98,103.8,110,116.5,123.5,130.8,138.6,146.8,155.6,164.8,174.6,185,196,207.7,220,233.1,246.9,261.6,277.2,293.7,311.1,329.6,349.2,370,392,415.3,440,466.2,493.9,523.3,554.4,587.3,622.3,659.3,698.5,740,784,830.6,880,932.3,987.8,1047,1109,1175,1245,1319,1397,1480,1568,1661,1760,1865,1976,2093,2217,2349,2489,2637,2794,2960,3136,3322,3520,3729,3951,4186,4435,4699,4978,5274,5588,5920,6272,6645,7040,7459,7902],c={tick:[],tweet:[],cowbell:[],snare:[],woodblock:[],lowSnare:[],tom:[],lowWoodblock:[],bass:[]},d=1.8;o.prototype.adjustNote=function(t){void 0!==this.noteIndex&&(this.noteIndex+=t,this.noteIndex>=h.length-1?this.noteIndex=h.length-1:this.noteIndex<0&&(this.noteIndex=0),this.frequency=h[this.noteIndex])},o.prototype.shiftUp=function(){this.adjustNote(1)},o.prototype.shiftDown=function(){this.adjustNote(-1)},o.prototype.octaveUp=function(t){this.adjustNote(12*t)},o.prototype.octaveDown=function(t){this.adjustNote(-12*t)},o.prototype.bendTo=function(t){this.endFrequency=h[t]},r.prototype.addPercussiveSound=function(t,e){var i,s=e;for(i in t)t.hasOwnProperty(i)&&(this.notes.push({frequency:t[i],duration:.0015}),s-=.0015);s>0&&this.addRest(s)},r.prototype.addRest=function(t){this.notes.push(new o((void 0),t))},r.prototype.parse=function(t){var e,i,s,r,n,a=4,h=d/32,p=h/3,u=-1,l=!1;for(t=t.toUpperCase(),n=0;n<t.length;n+=1){switch(e=void 0,i=t.charAt(n)){case"T":h=d/32;break;case"S":h=d/16;break;case"I":h=d/8;break;case"Q":h=d/4;break;case"H":h=d/2;break;case"W":h=d;break;case"3":u=3,p=h/3;break;case"+":a+=1;break;case"-":a-=1;break;case".":l=!0;break;case"X":e=new o;break;case"C":e=new o(0);break;case"D":e=new o(2);break;case"E":e=new o(4);break;case"F":e=new o(5);break;case"G":e=new o(7);break;case"A":e=new o(9);break;case"B":e=new o(11);break;case"0":this.addPercussiveSound(c.tick,h);break;case"1":this.addPercussiveSound(c.tweet,h);break;case"2":this.addPercussiveSound(c.cowbell,h);break;case"4":this.addPercussiveSound(c.snare,h);break;case"5":this.addPercussiveSound(c.woodblock,h);break;case"6":this.addPercussiveSound(c.lowSnare,h);break;case"7":this.addPercussiveSound(c.tom,h);break;case"8":this.addPercussiveSound(c.lowWoodblock,h);break;case"9":this.addPercussiveSound(c.bass,h);break;default:e=void 0}e&&(s=n>=t.length?void 0:t.charAt(n+1),r=h,"#"===s?(e.shiftUp(),n+=1):"!"===s&&(e.shiftDown(),n+=1),u>0&&(u-=1,r=p),l&&(l=!1,r=h+h/2),e.octaveUp(a),e.duration=r,this.notes.push(e))}},n.prototype.setActive=function(t,e){e=void 0===e||e,this.active&&!t&&e&&this.cancel(),this.active=t&&(window.AudioContext||window.webkitAudioContext)},n.prototype.cancel=function(){if(this.active&&this.oscillator){var t=this.context.currentTime+this.delay;this.oscillator.frequency.cancelScheduledValues(t),this.volume.gain.cancelScheduledValues(t),this.volume.gain.setValueAtTime(0,t),this.timestamp=this.context.currentTime,this.interruptTimestamp=this.context.currentTime}},n.prototype.isPlaying=function(){return this.active&&this.context.currentTime+this.delay<this.timestamp},n.prototype.playAfter=function(t,e){if(this.active){var i,s,o,n;for(o=new r(t),this.timestamp<this.context.currentTime+this.delay&&(this.timestamp=this.context.currentTime+this.delay),n=this.timestamp,i=0;i<o.notes.length;i+=1)s=o.notes[i],s.frequency&&s.endFrequency?(this.oscillator.frequency.setValueAtTime(s.frequency,this.timestamp),this.oscillator.frequency.linearRampToValueAtTime(s.endFrequency,this.timestamp+s.duration)):s.frequency?this.oscillator.frequency.setValueAtTime(s.frequency,this.timestamp):(this.volume.gain.setValueAtTime(0,this.timestamp),this.volume.gain.setValueAtTime(this.userVolume,this.timestamp+s.duration)),this.timestamp+=s.duration;this.volume.gain.setValueAtTime(this.userVolume,n),this.volume.gain.setValueAtTime(0,this.timestamp),e&&(this.interruptTimestamp=this.timestamp)}},n.prototype.play=function(t,e){this.active&&this.context.currentTime+this.delay>=this.interruptTimestamp&&(this.cancel(),this.playAfter(t,e))},s(),i.Audio=n},{"./basic":3}],3:[function(t,e,i){"use strict";function s(t,e){if(!(this instanceof s))throw a;this.x=t,this.y=e}function o(t,e){if(!(this instanceof o))throw a;this.initialDelay=t,this.subsequentDelay=e,this.event=void 0,this.nextAllowableEvent=0}function r(){if(!(this instanceof r))throw a;this.notifications=[]}var n,a="Constructor must be called with new.";s.prototype.clone=function(){return new s(this.x,this.y)},s.prototype.add=function(t){return new s(this.x+t.x,this.y+t.y)},s.prototype.subtract=function(t){return new s(this.x-t.x,this.y-t.y)},s.prototype.adjacent=function(t){var e=Math.abs(this.x-t.x),i=Math.abs(this.y-t.y);return!(e>1||i>1)},s.prototype.aligned=function(t,e,i){return e=void 0===e?1:e,i?i===n.North?t.y<this.y&&Math.abs(this.x-t.x)<e:i===n.South?t.y>this.y&&Math.abs(this.x-t.x)<e:i===n.East?t.x>this.x&&Math.abs(this.y-t.y)<e:i===n.West?t.x<this.x&&Math.abs(this.y-t.y)<e:void 0:Math.abs(this.x-t.x)<e||Math.abs(this.y-t.y)<e},s.prototype.directionTo=function(t,e){var i=this.x-t.x,s=this.y-t.y;if(0!==i||0!==s){if(void 0===e&&(e=0===i?"y":0===s?"x":Math.floor(2*Math.random())?"x":"y"),"x"===e){if(0===i)return;return i<0?n.East:n.West}if(0!==s)return s<0?n.South:n.North}},s.prototype.compareTo=function(t){return this.x===t.x?this.y-t.y:this.x-t.x},s.prototype.equals=function(t){return this.x===t.x&&this.y===t.y},s.prototype.toString=function(){return"("+this.x+", "+this.y+")"},n={North:new s(0,(-1)),East:new s(1,0),South:new s(0,1),West:new s((-1),0)},n.each=function(t){t(n.North),t(n.East),t(n.South),t(n.West)},n.fromName=function(t){switch(t){case"N":case"North":return n.North;case"E":case"East":return n.East;case"S":case"South":return n.South;case"W":case"West":return n.West;default:return}},n.getName=function(t){switch(t){case n.North:return"North";case n.East:return"East";case n.South:return"South";case n.West:return"West"}},n.getShortName=function(t){switch(t){case n.North:return"N";case n.East:return"E";case n.South:return"S";case n.West:return"W"}},n.clockwise=function(t){switch(t){case n.North:return n.East;case n.East:return n.South;case n.South:return n.West;case n.West:return n.North}},n.randomPerpendicular=function(t){switch(t){case n.North:case n.South:return n.randomEastWest();default:return n.randomNorthSouth()}},n.randomNorthSouth=function(){return n.random([n.North,n.South])},n.randomEastWest=function(){return n.random([n.East,n.West])},n.randomNorthEast=function(){return n.random([n.North,n.East])},n.random=function(t){return t||(t=[n.North,n.East,n.South,n.West]),t[Math.floor(Math.random()*t.length)]},n.counterClockwise=function(t){switch(t){case n.North:return n.West;case n.West:return n.South;case n.South:return n.East;case n.East:return n.North}},n.opposite=function(t){switch(t){case n.North:return n.South;case n.East:return n.West;case n.South:return n.North;case n.West:return n.East}},o.prototype.scheduleEvent=function(t,e){var i=Date.now();i>this.nextAllowableEvent&&(t+this.initialDelay<i?this.nextAllowableEvent=i+this.subsequentDelay:this.nextAllowableEvent=i+this.initialDelay,this.event=e)},o.prototype.cancelEvent=function(){this.nextAllowableEvent=0},o.prototype.takeEvent=function(){var t=this.event;return this.event=void 0,t},r.prototype.addNotification=function(t,e){this.notifications.push({type:t,message:e,timestamp:Date.now()})};var h={};h.storeOption=function(t,e,i,s){i!==s&&(t[e]=i)},h.generateLineData=function(t,e){var i,o,r,n={},a=Math.abs(e.x-t.x),h=Math.abs(e.y-t.y),c=t.x<e.x?1:-1,d=t.y<e.y?1:-1,p=a-h;for(n.points=[],n.contains=function(t){var e;for(e=0;e<this.points.length;e+=1)if(this.points[e].equals(t))return!0;return!1},n.forEach=function(t){var e;if(t&&"function"==typeof t)for(e=0;e<this.points.length;e+=1)t(this.points[e])},o=t.x,r=t.y;;){if(n.points.push(new s(o,r)),o===e.x&&r===e.y)return n;i=2*p,i>-h&&(p-=h,o+=c),i<a&&(p+=a,r+=d)}return n},h.generateCircleData=function(t,e){return h.generateEllipseData(t,2*e,e)},h.generateEllipseData=function(t,e,i){var s,o,r={},n=e*e,a=i*i,h=2*n,c=2*a,d=0,p=i,u=0,l=h*p;if(r.contains=function(t){return!!this[t.y]&&(o=this[t.y],t.x>=o[0]&&t.x<=o[1])},0===e&&0===i)return r[t.y]=[t.x,t.x],r;for(s=Math.round(a-n*i+.25*n);u<l;)d+=1,u+=c,s<0?s+=a+u:(p-=1,l-=h,s+=a+u-l),o=[t.x-d,t.x+d],r[t.y+p]=o,r[t.y-p]=o;for(s=Math.round(a*(d+.5)*(d+.5)+n*(p-1)*(p-1)-n*a);p>0;)p-=1,l-=h,s>0?s+=n-l:(d+=1,u+=c,s+=n-l+u),o=[t.x-d,t.x+d],r[t.y+p]=o,r[t.y-p]=o;return r},h.pointsInCircle=function(t,e){return h.pointsInEllipse(t,2*e,e)},h.pointsInEllipse=function(t,e,i){var o,r,n,a,c,d=[],p=h.generateEllipseData(t,e,i);for(r in p)if(p.hasOwnProperty(r))for(n=p[r],a=n[0],c=n[1],o=a;o<=c;o+=1)d.push(new s(o,r));return d},i.Point=s,i.Direction=n,i.DelayedEventScheduler=o,i.NotificationListener=r,i.utilities=h,i.ConstructorError=a},{}],4:[function(t,e,i){"use strict";function s(t,e){if(!(this instanceof s))throw o;this.validateData(t),this.name=t.name,this.game=e,this.tiles=[],this.scripts=[],this.dark=t.dark,this.reenter=t.reenter,this.smartPath=[],this.customRenderSet=[],this.torches=[],this.previousTorches=[],this.focusPoint=new r(0,0),this.maxPlayerBullets=void 0!==t.maxPlayerBullets?t.maxPlayerBullets:1/0,this.playerBullets=0,this.i18n=void 0,this.north=t.north,this.east=t.east,this.south=t.south,this.west=t.west,this.northOffset=t.northOffset||0,this.eastOffset=t.eastOffset||0,this.southOffset=t.southOffset||0,this.westOffset=t.westOffset||0,this.defaultPlayerX=t.playerX,this.defaultPlayerY=t.playerY,t.hasOwnProperty("entryPointX")&&t.hasOwnProperty("entryPointY")&&(this.entryPoint=new r(t.entryPointX,t.entryPointY)),this.displayMessage=void 0,this.displayMessageTick=0,this.DISPLAY_MESSAGE_TTL=3*e.FPS,this.DARK_SPRITE=e.resources.graphics.getSprite(176),this.DARK_SPRITE_COLOR=n.Grey,this.height=t.height,this.width=t.width,this.initializeI18n(t.i18n),this.initializeScripts(t.scripts),this.initializeTiles(t.tiles),this.initializeWindow()}var o=t("./basic").ConstructorError,r=t("./basic").Point,n=t("./graphics").Colors,a=t("./basic").utilities,h=t("./jzt-script").JztScript,c=(t("./things").things,t("./things").ThingFactory),d=t("./basic").Direction,p=t("./i18n");s.prototype.validateData=function(t){var e=!0;if(t.height&&t.width||(e=!1),"number"!=typeof t.height&&(e=!1),"number"!=typeof t.width&&(e=!1),(t.height>256||t.height<10)&&(e=!1),(t.width>256||t.width<10)&&(e=!1),t.tiles&&Array.isArray(t.tiles)||(e=!1),t.scripts&&Array.isArray(t.scripts)||(e=!1),!e)throw"Invalid board data."},s.prototype.serialize=function(){var t,e,i,s={};for(s.name=this.name,a.storeOption(s,"dark",this.dark),a.storeOption(s,"displayMessage",this.displayMessage),a.storeOption(s,"north",this.north),a.storeOption(s,"east",this.east),a.storeOption(s,"south",this.south),a.storeOption(s,"west",this.west),a.storeOption(s,"northOffset",this.northOffset),a.storeOption(s,"eastOffset",this.eastOffset),a.storeOption(s,"southOffset",this.southOffset),a.storeOption(s,"westOffset",this.westOffset),a.storeOption(s,"reenter",this.reenter),this.maxPlayerBullets!==1/0&&(s.maxPlayerBullets=this.maxPlayerBullets),this.player?(s.playerX=this.player.point.x,s.playerY=this.player.point.y):(s.playerX=this.defaultPlayerX,s.playerY=this.defaultPlayerY),this.entryPoint&&(s.entryPointX=this.entryPoint.x,s.entryPointY=this.entryPoint.y),s.width=this.width,s.height=this.height,s.tiles=[],s.scripts=[],this.each(function(t){t?s.tiles.push(t.serialize()):s.tiles.push(0)}),t=0;t<this.scripts.length;t+=1)e=this.scripts[t],this.game.isEditor?s.scripts.push({name:e.name,rawScript:e.rawScript||e.script}):s.scripts.push(e.serialize());if(this.i18n){s.i18n={};for(t in this.i18n)if(this.i18n.hasOwnProperty(t)&&("string"==typeof this.i18n[t]||2===t.length)){s.i18n[t]={};for(i in this.i18n[t])this.i18n[t].hasOwnProperty(i)&&"string"==typeof this.i18n[t][i]&&(s.i18n[t][i]=this.i18n[t][i])}}return s},s.prototype.initializeScripts=function(t){var e,i;if(this.game.isEditor)return void(this.scripts=t);for(e=0;e<t.length;e+=1)try{i=new h(t[e].name,t[e].rawScript,(!0)),this.scripts.push(i)}catch(s){this.game.notifyListeners("script-error",{scriptName:t[e].name,error:s})}},s.prototype.initializeI18n=function(t){var e,i;if(t){this.i18n={};for(e in t)if(t.hasOwnProperty(e)&&"string"==typeof e&&2===e.length){this.i18n[e]={};for(i in t[e])t[e].hasOwnProperty(i)&&"string"==typeof t[e][i]&&(this.i18n[e][i]=t[e][i])}}},s.prototype.getScriptables=function(t){var e=[];return this.each(function(i){i&&"Scriptable"===i.type&&(!t||i.name&&i.name.toUpperCase()===t)&&e.push(i)}),e},s.prototype.initializePlayer=function(t){var e,i,s;if(this.isOutside(t.point)&&(t.point.x=this.defaultPlayerX,t.point.y=this.defaultPlayerY),s=this.getTile(t.point),t.under=s,this.player=t,this.setTile(t.point,t),this.player.board=this,this.initializeTorch(this.player),this.focusPoint=this.player.point,this.entryPoint||(this.entryPoint=t.point.clone()),!this.game.isEditor)for(e=this.getScriptables(),i=0;i<e.length;i+=1)e[i].sendMessage("ENTER")},s.prototype.initializeTiles=function(t){var e,i,s,o=new r(0,0);for(e in t)t.hasOwnProperty(e)&&(i=t[e],s=c.deserialize(i,this),void 0!==s&&(this.setTile(o,s),this.initializeTorch(s)),o.x+=1,o.x>=this.width&&(o.x=0,o.y+=1))},s.prototype.initializeTorch=function(t){var e;!this.game.isEditor&&this.dark&&"function"==typeof t.getTorch&&(e=t.getTorch(),e&&this.torches.push(e))},s.prototype.initializeWindow=function(){var t=this.game.context.canvas.width,e=this.game.context.canvas.height;this.windowSize=new r(0,0),this.windowOrigin=new r(0,0),this.windowSize.x=Math.floor(t/this.game.resources.graphics.TILE_SIZE.x),this.windowSize.y=Math.floor(e/this.game.resources.graphics.TILE_SIZE.y),this.windowLimit=new r(this.width-this.windowSize.x,this.height-this.windowSize.y),this.updateWindowPosition(),this.windowSize.x>this.width&&(this.windowOrigin.x=-Math.round((this.windowSize.x-this.width)/2)),this.windowSize.y>this.height&&(this.windowOrigin.y=-Math.round((this.windowSize.y-this.height)/2))},s.prototype.updateWindowPosition=function(){this.focusPoint&&(this.width>this.windowSize.x&&(this.windowOrigin.x=this.focusPoint.x-Math.round(this.windowSize.x/2),this.windowOrigin.x=this.windowOrigin.x<0?0:this.windowOrigin.x>this.windowLimit.x?this.windowLimit.x:this.windowOrigin.x),this.height>this.windowSize.y&&(this.windowOrigin.y=this.focusPoint.y-Math.round(this.windowSize.y/2),this.windowOrigin.y=this.windowOrigin.y<0?0:this.windowOrigin.y>this.windowLimit.y?this.windowLimit.y:this.windowOrigin.y))},s.prototype.getScript=function(t){var e,i;if(t&&this.scripts)for(e=0;e<this.scripts.length;e+=1)if(i=this.scripts[e],t===i.name)return i},s.prototype.each=function(t){var e=this.tiles.slice(0),i=new r(0,0);for(i.y=0;i.y<this.height;i.y+=1)for(i.x=0;i.x<this.width;i.x+=1)t(e[i.x+i.y*this.width],i)},s.prototype.eachBackwards=function(t){var e=this.tiles.slice(0),i=new r(0,0);for(i.y=this.height-1;i.y>=0;i.y-=1)for(i.x=this.width-1;i.x>=0;i.x-=1)t(e[i.x+i.y*this.width],i)},s.prototype.eachDisplayable=function(t){var e=this.tiles.slice(0),i=new r(0,0),s=this.windowOrigin.y,o=s+this.windowSize.y,n=this.windowOrigin.x,a=n+this.windowSize.x;for(n=n<0?0:n,s=s<0?0:s,a=a>this.width?this.width:a,o=o>this.height?this.height:o,i.y=s;i.y<o;i.y+=1)for(i.x=n;i.x<a;i.x+=1)t(e[i.x+i.y*this.width],i)},s.prototype.hasTile=function(t,e){var i=0;return this.each(function(e){e&&e.equals(t)&&(i+=1)}),void 0===e?i>0:e<=0?i<=0:i>=e},s.prototype.changeTiles=function(t,e){var i,s=this;this.each(function(o){o&&o.equals(t)&&(i=c.deserialize(e,s),i&&void 0===e.color&&(i.foreground=o.foreground),s.replaceTile(o.point,i))})},s.prototype.deleteTile=function(t){var e=this.getTile(t);e&&this.setTile(t,e.under)},s.prototype.moveTile=function(t,e,i,s){var o,r,n=this.getTile(t),a=this.getTile(e);if(this.isFree(e))return s||(this.setTile(e,n),this.setTile(t,void 0===n?void 0:n.under),void 0!==n&&(n.under=void 0)),!0;if(!this.isOutside(e)&&a.isSurrenderable(n))return!(a.under&&!a.under.isSurrenderable(n))&&(s||(void 0!==n&&(o=n.under,n.under=a),this.setTile(e,n),this.setTile(t,o)),!0);if(!i&&a){if(a.under&&!a.under.isSurrenderable(n))return!1;if(r=a.push(t.directionTo(e),n))return!0;if(this.isFree(e)||this.getTile(e).isSurrenderable(n))return this.moveTile(t,e,i,s)}return!1},s.prototype.setTile=function(t,e){this.isOutside(t)||(e&&(e.point=t.clone(),"Player"!==e.type||t.equals(this.player.point)||(this.deleteTile(this.player.point),e=this.player,e.point=t.clone(),this.initializePlayer(this.player))),this.tiles[t.x+t.y*this.width]=e)},s.prototype.addThing=function(t,e,i){var s=this.getTile(t);s&&(i&&s.isSurrenderable(e)?e.under=s:this.deleteTile(t)),this.setTile(t,e)},s.prototype.isFreeOrSurrenderable=function(t,e){var i=this.getTile(t);return!this.isOutside(t)&&(!i||i.isSurrenderable(e))},s.prototype.getTile=function(t){if(!(t.x>=this.width||t.x<0||t.y>=this.height||t.y<0))return this.tiles[t.x+t.y*this.width]},s.prototype.replaceTile=function(t,e){this.deleteTile(t),this.addThing(t,e,!0)},s.prototype.isOutside=function(t){return t.y<0||t.y>=this.height||(t.x<0||t.x>=this.width)},s.prototype.isOutsideWindow=function(t){return t.x<this.windowOrigin.x||t.x>=this.windowOrigin.x+this.windowSize.x||(t.y<this.windowOrigin.y||t.y>=this.windowOrigin.y+this.windowSize.y)},s.prototype.isFree=function(t){return!this.isOutside(t)&&!this.getTile(t)},s.prototype.movePlayerOffBoard=function(t){var e,i;switch(t){case d.North:e=this.north,i=this.northOffset;break;case d.East:e=this.east,i=this.eastOffset;break;case d.South:e=this.south,i=this.southOffset;break;case d.West:e=this.west,i=this.westOffset;break;default:return}this.game.movePlayerToBoardEdge(d.opposite(t),e,i)},s.prototype.getPassage=function(t){var e,i,s;for(e=0;e<this.height;e+=1)for(i=0;i<this.width;i+=1)if(s=this.getTile(new r(i,e)),s&&"Passage"===s.type&&s.passageId===t)return s},s.prototype.addMessage=function(t){this.messageQueue.push(t)},s.prototype.isLit=function(t,e,i){var s,o,r=i?this.previousTorches:this.torches;if(!this.dark)return!0;if(e&&e.glow)return!0;for(s=0;s<r.length;s+=1)if(o=r[s],o.contains(t))return!0;return!1},s.prototype.canPlayerShoot=function(t){return t&&this.maxPlayerBullets<=0&&this.setDisplayMessage(p.getMessage("status.noshoot")),this.playerBullets<this.maxPlayerBullets},s.prototype.update=function(){var t=this;this.updateSmartPath(this.player.point),this.customRenderSet=[],this.playerBullets=0,this.dark&&(this.previousTorches=this.torches,this.torches=[]),this.each(function(e){e&&("Bullet"===e.type&&e.fromPlayer&&(t.playerBullets+=1),"function"==typeof e.update&&"function"==typeof e.updateOnReverse&&"Player"!==e.type&&(e.updateOnReverse()||e.update()),e.under&&e.under.updateWhileUnder&&e.under.updateWhileUnder(),e.render&&t.customRenderSet.push(e),"Player"!==e.type&&t.initializeTorch(e))}),this.eachBackwards(function(t){t&&"function"==typeof t.update&&"function"==typeof t.updateOnReverse&&t.updateOnReverse()&&"Player"!==t.type&&t.update()})},s.prototype.equals=function(t){var e=t instanceof s?t.name:t;return this.name===e},s.prototype.setDisplayMessage=function(t,e){void 0!==t?(this.displayMessage=" "+t+" ",this.displayMessage.length>this.windowSize.x&&(this.displayMessage=this.displayMessage.substring(0,this.windowSize.x)),this.displayMessageTick=e?this.game.FPS*e:this.DISPLAY_MESSAGE_TTL):(this.displayMessage=void 0,this.displayMessageTick=0)},s.prototype.render=function(t){var e,i,s,o,r,a=this,h=this.game.context.canvas.width,c=this.game.context.canvas.height;for(this.updateWindowPosition(),(this.windowOrigin.x<0||this.windowOrigin.y<0)&&(t.fillStyle=n.Grey.rgbValue,t.fillRect(0,0,h,c)),t.fillStyle=!a.game.isEditor&&a.dark?this.game.DARK_PATTERN:n.Black.rgbValue,i=Math.max(-this.windowOrigin.x*this.game.resources.graphics.TILE_SIZE.x,0),s=Math.max(-this.windowOrigin.y*this.game.resources.graphics.TILE_SIZE.y,0),o=Math.min(this.width*this.game.resources.graphics.TILE_SIZE.x,this.windowSize.x*this.game.resources.graphics.TILE_SIZE.x),r=Math.min(this.height*this.game.resources.graphics.TILE_SIZE.y,this.windowSize.y*this.game.resources.graphics.TILE_SIZE.y),t.fillRect(i,s,o,r),this.eachDisplayable(function(e,i){var s,o;(a.game.isEditor||!a.dark||a.isLit(i,e))&&(e&&!e.hidden?(s=a.game.resources.graphics.getSprite(e.getSpriteIndex()),o=e.background,!o&&e.under&&e.under.background?o=e.under.background.isLight()?e.under.background.darken():e.under.background:!o&&a.dark&&(o=n.Black),s.draw(t,i.subtract(a.windowOrigin),e.foreground,o)):!e&&a.dark&&a.game.resources.graphics.fillTile(t,i.subtract(a.windowOrigin),n.Black))}),e=0;e<this.customRenderSet.length;e+=1)this.customRenderSet[e].render(t);void 0!==this.displayMessage&&this.renderMessage(t)},s.prototype.adjustSmartPathWeight=function(t,e){var i=t.x+t.y*this.width;this.isOutside(t)||void 0===this.smartPath[i]||(this.smartPath[i]+=e)},s.prototype.updateSmartPath=function(t){function e(t,s,o){var r,n,a,h;o<50&&t>=0&&t<i.width&&s>=0&&s<i.height&&(r=t+s*i.width,n=i.tiles[r],h=void 0===n||n&&"Bullet"===n.type,a=i.smartPath[r],(o<=0||h&&(void 0===a||a>o))&&(i.smartPath[t+s*i.width]=o,o+=1,e(t+1,s,o),e(t-1,s,o),e(t,s+1,o),e(t,s-1,o)))}var i=this;this.smartPath=[],e(t.x,t.y,0),this.updatePathWeights()},s.prototype.updatePathWeights=function(){this.each(function(t){t&&t.influenceSmartPath&&t.influenceSmartPath()})},s.prototype.getSmartValue=function(t){var e;return t.x>=this.width||t.x<0||t.y>=this.height||t.y<0?1/0:(e=this.smartPath[t.x+t.y*this.width],void 0===e?1/0:e)},s.prototype.getSmartDirection=function(t){var e,i=[],s=this,o=1/0;if(d.each(function(r){e=s.getSmartValue(t.add(r)),e<o?(i=[],i.push(r),o=e):e===o&&i.push(r)}),o!==1/0)return i.length<=1?i[0]:d.random(i)},s.prototype.getMessage=function(t){var e,i=p.getLanguage();return e=this.getMessageForLanguage(i,t),void 0===e&&i!==p.DefaultLanguage&&(e=this.getMessageForLanguage(p.DefaultLanguage,t)),void 0!==e?e:"??? "+t+" ???"},s.prototype.getMessageForLanguage=function(t,e){if(this.i18n&&this.i18n.hasOwnProperty(t)&&this.i18n[t].hasOwnProperty(e))return this.i18n[t][e]},s.prototype.playerHurt=function(){this.setDisplayMessage(p.getMessage("status.hurt")),this.reenter&&this.moveTile(this.player.point,this.entryPoint)},s.prototype.renderMessage=function(t){var e=new r;e.x=Math.floor((this.windowSize.x-this.displayMessage.length)/2),e.y=this.windowSize.y-1,this.game.resources.graphics.drawString(t,e,this.displayMessage,n.Cycle,n.Black),this.displayMessageTick-=1,this.displayMessageTick<=0&&(this.displayMessage=void 0)},i.Board=s},{"./basic":3,"./graphics":7,"./i18n":8,"./jzt-script":13,"./things":20}],5:[function(t,e,i){"use strict";function s(t){return"jzt-save-meta|"+(t||"")}function o(t){return"jzt-save|"+(t||"")}function r(t){if(!(this instanceof r))throw n;this.game=t,this.dialogType=r.Type.SAVE,this.files=[],this.graphics=this.game.resources.graphics,this.cycleCount=0,this.selectedIndex=0,this.offset=0,this.width=48,this.height=Math.min(Math.floor(t.context.canvas.height/this.graphics.TILE_SIZE.y)-2,24),this.boxWidth=this.width-3,this.boxHeight=5,this.visibleBoxCount=Math.floor((this.height-2)/this.boxHeight),this.eventScheduler=new h(2*this.game.CYCLE_TICKS,this.game.CYCLE_TICKS),this.popup=new c((void 0),new a(this.width,this.height),this.game),this.popup.setColor(d.Blue,d.BrightWhite,d.Blue,d.BrightBlue),this.spriteGrid=this.popup.spriteGrid}var n=t("./basic").ConstructorError,a=t("./basic").Point,h=t("./basic").DelayedEventScheduler,c=t("./popup").Popup,d=t("./graphics").Colors,p=t("lz-string"),u=t("./i18n"),l={Up:0,Down:1,Select:2,Delete:3,Exit:4};r.Type={SAVE:1,OPEN:2},r.prototype.setAlert=function(t){var e=this.game.keyboard;e.cancelInput(),this.alert=new c((void 0),new a(t.length+4,3),this.game),this.alert.spriteGrid.addText(new a(2,1),t,d.BrightWhite,d.Blue)},r.prototype.clearAlert=function(){this.alert=void 0},r.prototype.open=function(t,e){var i,o,n=s();t&&(this.dialogType=t),this.popup.title=u.getMessage(this.dialogType===r.Type.SAVE?"file.save":"file.load"),this.selectedIndex=0,this.offset=0,this.files=[];for(o in localStorage)localStorage.hasOwnProperty(o)&&0===o.lastIndexOf(n,0)&&(i=JSON.parse(localStorage[o]),i.name===this.game.name&&this.files.push(i));this.files.sort(function(t,e){return e.timestamp-t.timestamp}),e||this.files.unshift(null),this.popup.redraw(),this.initializeSlots()},r.prototype.update=function(){var t=this.game.keyboard;t.isPressed(t.UP)?this.eventScheduler.scheduleEvent(t.isPressed(t.UP),l.Up):t.isPressed(t.DOWN)?this.eventScheduler.scheduleEvent(t.isPressed(t.DOWN),l.Down):t.isPressed(t.ENTER)||t.isPressed(t.SPACE)?this.eventScheduler.scheduleEvent(t.isPressed(t.ENTER),l.Select):t.isPressed(t.DELETE)||t.isPressed(t.BACKSPACE)?this.eventScheduler.scheduleEvent(t.isPressed(t.DELETE),l.Delete):t.isPressed(t.ESCAPE)||t.isPressed(t.S)||t.isPressed(t.R)?this.eventScheduler.scheduleEvent(t.isPressed(t.ESCAPE),l.Exit):this.eventScheduler.cancelEvent(),this.cycleCount+=1,this.cycleCount>=this.game.CYCLE_RATE&&(this.cycleCount=0,
this.doTick())},r.prototype.doTick=function(){var t,e=this.eventScheduler.takeEvent();if(this.alert&&(e===l.Select||e===l.Exit))return void this.clearAlert();if(e===l.Up)this.selectedIndex-=1,this.selectedIndex<0&&(this.selectedIndex=0),this.selectedIndex<this.offset&&(this.offset=this.selectedIndex),this.initializeSlots();else if(e===l.Down)this.selectedIndex+=1,this.selectedIndex>=this.files.length-1&&(this.selectedIndex=this.files.length-1),this.selectedIndex>=this.offset+this.visibleBoxCount&&(this.offset=this.selectedIndex-this.visibleBoxCount+1),this.initializeSlots();else if(e===l.Select){if(this.dialogType===r.Type.SAVE){t=this.files[this.selectedIndex],t&&this.deleteFile(t);try{this.saveFile()}catch(i){return void this.setAlert(u.getMessage("status.nosave"))}}else this.dialogType===r.Type.OPEN&&(t=this.files[this.selectedIndex],this.loadFile(t));this.game.restoreState()}else e===l.Delete?(t=this.files[this.selectedIndex],t&&this.deleteFile(t)):e===l.Exit&&this.game.restoreState()},r.prototype.deleteFile=function(t){var e=o(t.timestamp),i=s(t.timestamp);localStorage.hasOwnProperty(e)&&delete localStorage[e],localStorage.hasOwnProperty(i)&&delete localStorage[i],this.open()},r.prototype.loadFile=function(t){var e,i;t?(i=o(t.timestamp),localStorage.hasOwnProperty(i)&&(e=localStorage[i],e=p.decompressFromUTF16(e),e=JSON.parse(e),this.game.deserialize(e))):this.game.restartGame()},r.prototype.saveFile=function(){var t,e={name:this.game.name,board:this.game.currentBoard.name,timestamp:Date.now()},i=s(e.timestamp),r=o(e.timestamp);t=this.game.serialize(),t=JSON.stringify(t),t=p.compressToUTF16(t),localStorage[i]=JSON.stringify(e),localStorage[r]=t},r.prototype.initializeSlots=function(){function t(t){return t<=9?"0"+t:t}function e(e){var i=e.getDate(),s=e.getMonth()+1,o=e.getFullYear(),r=e.getHours(),n=e.getMinutes();return o+"-"+t(s)+"-"+t(i)+" "+r+":"+t(n)}function i(t,i,s){var o,h,c=new a(0,0),p=s?d.White:d.Cyan,l=i*n.boxHeight+2;for(c.x=2;c.x<n.boxWidth;c.x+=1)for(c.y=l;c.y<l+n.boxHeight;c.y+=1)c.x===n.boxWidth-1&&c.y===l?n.spriteGrid.setTile(c,220,d.Black):c.x===n.boxWidth-1&&c.y!==l+n.boxHeight-1?n.spriteGrid.setTile(c,void 0,d.BrightWhite,d.Black):c.y===l+n.boxHeight-1&&2!==c.x?n.spriteGrid.setTile(c,223,d.Black):c.y===l+n.boxHeight-1&&2===c.x||n.spriteGrid.setTile(c,void 0,d.BrightWhite,p);c.x=3,c.y=l+1,t?(h=t.name||u.getMessage("file.saved"),n.spriteGrid.addText(c,h,s?d.BrightWhite:d.Grey,p)):n.dialogType===r.Type.SAVE?(h=u.getMessage("file.new"),c.x=Math.round((n.boxWidth-h.length)/2),n.spriteGrid.addText(c,h,s?d.BrightWhite:d.Grey,p)):(h=u.getMessage("file.restart"),c.x=Math.round((n.boxWidth-h.length)/2),n.spriteGrid.addText(c,h,s?d.BrightWhite:d.Grey,p),c.y+=1,c.x=Math.round((n.boxWidth-n.game.name.length)/2),n.spriteGrid.addText(c,n.game.name,s?d.BrightBlue:d.Grey,p)),t&&t.timestamp&&(o=e(new Date(t.timestamp)),c.x=n.boxWidth-o.length-2,n.spriteGrid.addText(c,o,d.Grey,p)),t&&t.board&&(c.x=3,c.y+=1,n.spriteGrid.addText(c,t.board,s?d.BrightBlue:d.Grey,p))}var s,o,n=this;for(o=Math.min(this.visibleBoxCount,this.files.length),s=0;s<o;s+=1)i(this.files[this.offset+s],s,s+this.offset===this.selectedIndex);this.popup.setScrollBar(this.offset,this.files.length,o)},r.prototype.render=function(t){this.alert?this.alert.render(t):this.popup.render(t)},i.FileManagement=r},{"./basic":3,"./graphics":7,"./i18n":8,"./popup":18,"lz-string":1}],6:[function(t,e,i){"use strict";var s={Error:-2,Splash:-1,Loading:0,Playing:1,Paused:2,GameOver:3,Reading:4,Title:5,Victory:6,FileManagement:7,Transition:8};i.GameState=s},{}],7:[function(t,e,i){"use strict";function s(t,e){if(!(this instanceof s))throw f;this.point=t,this.owner=e}function o(t){if(!(this instanceof o))throw f;var e=this;this.TILE_SIZE=new g(16,32),this.SPRITE_SIZE=new g(8,16),this.DARK_IMAGE=void 0,this.NOISE_IMAGE=void 0,this.blinkCycle=0,this.blinkState=!0,this.sprites=[],this.spriteSource=new Image,this.spriteSource.src=m,this.colorSpriteSources=[],this.onLoadCallback=t,this.spriteSource.onload=function(){var t,o,r,n,a,h,c,d,p,l,f,y,m;for(n in u)if(u.hasOwnProperty(n)){for(t=document.createElement("canvas"),t.width=this.width,t.height=this.height,e.colorSpriteSources[n]=t,o=t.getContext("2d"),r=this.width*this.height*4,n=u[n],o.drawImage(this,0,0),a=o.getImageData(0,0,this.width,this.height),h=a.data,c=0;c<r;c+=4)h[c]>=255?(h[c]=n.r,h[c+1]=n.g,h[c+2]=n.b,h[c+3]=255):h[c+3]=0;o.putImageData(a,0,0)}for(d=this.width/e.SPRITE_SIZE.x,p=this.height/e.SPRITE_SIZE.y,l=0;l<p;l+=1)for(f=0;f<d;f+=1)y=new g(f*e.SPRITE_SIZE.x,l*e.SPRITE_SIZE.y),m=new s(y,e),e.sprites.push(m);for(t=document.createElement("canvas"),t.width=256,t.height=256,r=262144,o=t.getContext("2d"),a=o.getImageData(0,0,o.canvas.width,o.canvas.height),h=a.data,c=0;c<r;c+=4)h[c]=0,h[c+1]=0,h[c+2]=0,h[c+3]=Math.round(20*Math.random());o.putImageData(a,0,0),e.NOISE_IMAGE=t,t=document.createElement("canvas"),t.width=e.TILE_SIZE.x,t.height=e.TILE_SIZE.y,o=t.getContext("2d"),o.imageSmoothingEnabled=!1,o.webkitImageSmoothingEnabled=!1,o.mozImageSmoothingEnabled=!1,m=e.getSprite(176),m.draw(o,new g(0,0),i.Colors.Grey,i.Colors.Black),e.DARK_IMAGE=t,e.onLoadCallback()}}function r(t,e,i){if(!(this instanceof r))throw f;this.width=t,this.height=e,this.graphics=i,this.tiles=[]}function n(t,e,i,s,o,r){function a(t){var e=t.toString(16);return e.length<=1&&(e="0"+e),e}if(!(this instanceof n))throw f;this.code=t,this.name=e,void 0!==i&&(this.index=i),void 0!==s&&void 0!==o&&void 0!==r&&(this.r=s,this.g=o,this.b=r,this.rgbValue="#"+a(s)+a(o)+a(r))}function a(t,e,i){if(!(this instanceof a))throw f;n.call(this,t,e),this.cycles=!0,this.cycleSequence=i,this.code=t,this.name=e,this.cycleIndex=0,this.update()}function h(t){return u[parseInt(t,16)]}function c(t){var e;if(2===t.length?e=t.charAt(1):1===t.length&&(e=t.charAt(0)),e)return"*"===e?l:h(e);throw"Invalid color code: "+t}function d(t){var e;if(2===t.length)return e=t.charAt(0),"*"===e?void 0:h(e)}function p(t,e){return(void 0===t?"*":t.code)+(void 0===e?"E":e instanceof a?"*":e.code)}var u,l,f=t("./basic").ConstructorError,g=t("./basic").Point,y=10,m="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAIAAAAEAAQMAAABBN+zkAAAABlBMVEUAAAD///+l2Z/dAAAGBElEQVRYw8WXv4skRRTHC4WOmr01e7jLbWJwYaEwV0ixC+K/YGJU3El5QSEbtQMWfWdy/4OJmYn/g9DMycOguHAZmHHZaDeRY0DYm2Cp9vuqZ2Z/eHqnrlrT86M/87rej3r9XrVSq9HjdW1cgrZdg7v24DF+fY1/iARs+Q8eklLfzcK2tQLe9QePSSSysa3q7bP3vX44KyCe9XTmvxkDWKV+eJbzGf7/6Idk9cMzpb45g0RbABWJr/toiOSS1B5+XuYw26LWPku0OCMxbFsNasd0cko3TO9e5csbg8148hY+4hXQVeQfMwKwVniyZf3MwZI1WNxt/czAvAK2s1ruk58FuYS0umeyypn8V2WO2nXBxCKxU0DOXY6xzLETcjtIRCNa1I7JllrS+V42xY6dOhNZ0ZK3xVLMIZdctT+qfzzo+qkXoK/87aHE6HqDrA+sgr60w74XJpPgdF3OEFCrcsdG6dqLTCUqQqwbgBLEuoCK5gB9q7IoFKDTWqLoyk9dKnOAuCLBnCQz8ZO6YdKnjRLDAJ5c80X/gXP/fBiKsc5GFnGIfzDMu51jZnHVseJxVdmuq5ixukoDUF2FFcD61uoIq5ouLurYiqU1AegqV0xciasV4RJX1RVrAbqtBXQrIJkJrwIx1wxQFy2kTJvj3Rh1HCsNO27d8T8a2xd2mbNle/d0wRxVNN4H7z289u7FKdwPfuIfPJgUkM8B2Hf+0aMOILicWR1z7Px43GWqx+7oGCAXiWMWwM9FAsAhyJRCCfWcZdIC/AMBHYta5wV4AZHFsMWHbMenWQz7F1z/XXIodREvYgv97LNVNuB+Ys8DYP2k5gF8ivPgn+pO7hkAh9Xk6Gt9IiAyaiPzkbGkDwU4DnUBpLUZgK8ERHJ6t4AjeM4hB5rorQKOBZgX+NCVgEU8jTZuB7bZvlWKSn3T/K0bRfP1Q78WkDpRuwjMCVUnZkAOmgMytFonqYDP5B5fgfEYlrommC1Pv8yxcnXgwIvUUBUoe8Qw+i5llzxVYzoSkAC6V4OwBpy4AD+AJsYmIiq2OrXsN/lRSwm8OtJNMJYKdwt5s0WHzbWo4dae3wQQnjfzeJEkqbMAo3xqWAMETodYtADgHcCRkQqDYgHgzAD0BtQDcBvAo2RzKFUJRTgiFrsNBW4zDJNVWedHtfregHrTCVc/lm9aPOXibeUMvHKKkNbKJjJJBwVLvdXinMIZGXhFyhNCNVl1mdUUaI0pjjF8jNEYEwIA1xhSGOCLFIOE+hwjiksewCR1CcN3XVeaMNwvwA4AEjaxgHozR93EBqPCPNZagOqaHX+v99Ir7heEQjsURfi83EJY9hGKMdqGouDTDmTgISVCVbCf+SRLlYZrUVKcXSJKKcHIlGC6W9CPpFyDgscDcG1qVRylS0DHkGg3wOM3wHQDrBNt/hLQqYD8xXNoaZo2RrogvvRkFZepUtfT4/DqDfNno7kaILQzNbeSKF3Z4mmUvAYh0AJEKYLl5lzAZLKx4nTflIgUdSam+XmJbUo0mqLDcvK5jbqkA8IZBRxjrq7SmqYjlQQ8FxWV8xYSBWA27qr5c4s5roCn30oONDY2pRTB4f0b60rVDRf3qzfLj3c++RkWjpQajXBg1o+///I6+LsSy5Fano/y+Wh5KUHVqKrWEsvleYbEec7L5VpihGNU0nal5RL8NxJlryNElddtgr3R/YOX/f3+Zb+R0HpVeff6Xo77B/i7SJQnIgnZqERV/V9ADpK3PJ8t7vS3A3Ds7eHrmgRdkej7/mBv76DvlwjL4o7YNZK3BPP/Ba8f47xuPuhWu9LPWQlqDUrI2zoKwB7US+sjVWED36QuuNbPUfTrtgWYT7ugp57Qgvdns8hqCgkSkIOfzSAx5bUEwK8r4KaRLMAwBwBPnZQfjxo2aMmHjlrzwqpul9fPn7f+QFcAquOd6boib8nzg+yqhpqt6501kOyXGrlT9hkALpaiLLsIKdN1+ElAi60bynQByyiXiEQrmn4Z+qLsQ6ao7PB31Sh1TdOyvRmALAHAqqOKRI8n6sHC3T915S+A3wBO89vlg2hdWgAAAABJRU5ErkJggg==";s.prototype.draw=function(t,e,i,s){var o,r,n;s&&s.isLight()&&(o=!0,s=s.darken()),r=e.x*this.owner.TILE_SIZE.x,n=e.y*this.owner.TILE_SIZE.y,s&&(t.fillStyle=s.rgbValue,t.fillRect(r,n,this.owner.TILE_SIZE.x,this.owner.TILE_SIZE.y)),o&&this.owner.blinkState||t.drawImage(this.owner.colorSpriteSources[i.index],this.point.x,this.point.y,this.owner.SPRITE_SIZE.x,this.owner.SPRITE_SIZE.y,r,n,this.owner.TILE_SIZE.x,this.owner.TILE_SIZE.y)},o.prototype.update=function(){this.blinkCycle+=1,this.blinkCycle>y&&(this.blinkState=!this.blinkState,i.Colors.Cycle.update(),this.blinkCycle=0)},o.prototype.fillTile=function(t,e,i){var s=e.x*this.TILE_SIZE.x,o=e.y*this.TILE_SIZE.y;i&&(t.fillStyle=i.rgbValue,t.fillRect(s,o,this.TILE_SIZE.x,this.TILE_SIZE.y))},o.prototype.getSprite=function(t){return this.sprites[t]},o.prototype.textToSprites=function(t){var e,i,s=[];for(e=0;e<t.length;e+=1)i=this.convertSpecialCharacter(t.charAt(e)),s.push(this.getSprite(i));return s},o.prototype.drawString=function(t,e,i,s,o){this.drawSprites(t,e,this.textToSprites(i),s,o)},o.prototype.drawSprites=function(t,e,i,s,o){var r,n;for(e=e.clone(),s=s||u.Yellow,o=o||void 0,n=0;n<i.length;n+=1)r=i[n],r.draw(t,e,s,o),e.x+=1},o.characterTable={"⍪":1,"☻":2,"♥":3,"♦":4,"♣":5,"♠":6,"•":7,"◘":8,"○":9,"◙":10,"♂":11,"♀":12,"♪":13,"♫":14,"☼":15,"►":16,"◄":17,"↕":18,"‼":19,"¶":20,"§":21,"▬":22,"↊":23,"↑":24,"↓":25,"→":26,"←":27,"∟":28,"↔":29,"▲":30,"▼":31,"⌃":127,"Ç":128,"ü":129,"é":130,"â":131,"ä":132,"à":133,"å":134,"ç":135,"ê":136,"ë":137,"è":138,"ï":139,"î":140,"ì":141,"Ä":142,"Å":143,"É":144,"æ":145,"Æ":146,"ô":147,"ö":148,"ò":149,"û":150,"ù":151,"ÿ":152,"Ö":153,"Ü":154,"¢":155,"£":156,"¥":157,"₧":158,"ƒ":159,"á":160,"í":161,"ó":162,"ú":163,"ñ":164,"Ñ":165,"ª":166,"º":167,"¿":168,"⌐":169,"¬":170,"½":171,"¼":172,"¡":173,"«":174,"»":175,"░":176,"▒":177,"▓":178,"│":179,"┤":180,"╡":181,"╢":182,"╖":183,"╕":184,"╣":185,"║":186,"╗":187,"╝":188,"╜":189,"╛":190,"┐":191,"└":192,"┴":193,"┬":194,"├":195,"─":196,"┼":197,"╞":198,"╟":199,"╚":200,"╔":201,"╩":202,"╦":203,"╠":204,"═":205,"╬":206,"╧":207,"╨":208,"╤":209,"╥":210,"╙":211,"╘":212,"╒":213,"╓":214,"╫":215,"╪":216,"┘":217,"┌":218,"█":219,"▄":220,"▌":221,"▐":222,"▀":223,"α":224,"ß":225,"Γ":226,"π":227,"Σ":228,"σ":229,"µ":230,"τ":231,"Φ":232,"Θ":233,"Ω":234,"δ":235,"∞":236,"φ":237,"ε":238,"∩":239,"≡":240,"±":241,"≥":242,"≤":243,"⌠":244,"⌡":245,"÷":246,"≈":247,"°":248,"∙":249,"·":250,"√":251,"ⁿ":252,"²":253,"■":254},o.prototype.convertSpecialCharacter=function(t){var e=t.charCodeAt(0);return e>=32&&e<=126?e:o.characterTable.hasOwnProperty(t)?o.characterTable[t]:63},r.prototype.setTile=function(t,e,i,s){this.tiles[t.x+t.y*this.width]={sprite:e?this.graphics.getSprite(e):void 0,foreground:i||u.White,background:s}},r.prototype.setColor=function(t,e,i){var s=this.tiles[t.x+t.y*this.width];s&&(s.foreground=e||s.foreground,s.background=i||s.background)},r.prototype.clear=function(){this.tiles=[]},r.prototype.addText=function(t,e,i,s){var o,r=t.clone();for(e=this.graphics.textToSprites(e),o=0;o<e.length;o+=1)r.x=t.x+o,this.tiles[r.x+r.y*this.width]={sprite:e[o],foreground:i,background:s}},r.prototype.addArt=function(t,e){var s,o,r,n=t.clone();for(s=0;s<e.length;s+=1)o=e.charAt(s),"\n"===o?(n.x=t.x,n.y+=1):(o=this.graphics.convertSpecialCharacter(o),s+1<=e.length&&(s+=1,r=i.ColorUtilities.getColor(e.charAt(s))),this.setTile(n,o,r),n.x+=1)},r.prototype.getTile=function(t){return this.tiles[t.x+t.y*this.width]},r.prototype.draw=function(t,e){var i,s=new g(0,0);for(s.x=0;s.x<this.width;s.x+=1)for(s.y=0;s.y<this.height;s.y+=1)i=this.getTile(s),i&&(i.sprite?i.sprite.draw(t,s.add(e),i.foreground,i.background):this.graphics.fillTile(t,s.add(e),i.background))},n.prototype.darken=function(){var t=u[this.index-8];return t||this},n.prototype.lighten=function(){var t=u[this.index+8];return t||this},n.prototype.isLight=function(){return this.index>=8},n.prototype.isDark=function(){return this.index<8},a.prototype=new n,a.prototype.constructor=a,a.prototype.update=function(){var t;this.cycleIndex=this.cycleIndex+1<this.cycleSequence.length?this.cycleIndex+1:0,t=this.cycleSequence[this.cycleIndex],this.index=t.index,this.r=t.r,this.g=t.g,this.b=t.b,this.rgbValue=t.rgbValue},u=[new n("0","Black",0,0,0,0),new n("1","Blue",1,0,0,170),new n("2","Green",2,0,170,0),new n("3","Cyan",3,0,170,170),new n("4","Red",4,170,0,0),new n("5","Magenta",5,170,0,170),new n("6","Brown",6,170,85,0),new n("7","White",7,170,170,170),new n("8","Grey",8,85,85,85),new n("9","BrightBlue",9,85,85,255),new n("A","BrightGreen",10,85,255,85),new n("B","BrightCyan",11,85,255,255),new n("C","BrightRed",12,255,85,85),new n("D","BrightMagenta",13,255,85,255),new n("E","Yellow",14,255,255,85),new n("F","BrightWhite",15,255,255,255)],l=new a("*","Cycle",[u[9],u[10],u[11],u[12],u[13],u[14],u[15]]),i.Colors={},function(t,e){var i;for(i=0;i<t.length;i+=1)e[t[i].name]=t[i],e[t[i].name.toUpperCase()]=t[i]}(u,i.Colors),i.Colors.Cycle=l,i.ColorUtilities={getColor:h,deserializeForeground:c,deserializeBackground:d,serialize:p},i.Color=n,i.Graphics=o,i.Sprite=s,i.SpriteGrid=r},{"./basic":3}],8:[function(t,e,i){"use strict";function s(t,e){var i,s=e.split("."),o=t;for(i=0;i<s.length;i+=1){if(void 0===o[s[i]])return;o=o[s[i]]}return o}function o(t){var e,i,o=s(c,t);if(void 0===o&&c!==d&&(o=s(p[d],t)),void 0===o)return t;for(e=1;e<arguments.length;e+=1)i=new RegExp("\\{"+(e-1)+"\\}","g"),o=o.replace(i,arguments[e]);return o}function r(){return h}function n(t){h=t,c=p.hasOwnProperty(t)?p[t]:p[d]}function a(t,e){return 0===e.indexOf("i18n:")?t.getMessage(e.substring(5)):e}var h,c,d="en",p={en:{keys:{collect:"You now have the {0} key.",toomany:"You already have a {0} key.",9:"blue",A:"green",B:"cyan",C:"red",D:"purple",E:"yellow",F:"white"},doors:{locked:"The {0} door is locked.",open:"The {0} door is now open.",1:"blue",2:"green",3:"cyan",4:"red",5:"purple",6:"yellow",7:"white"},obstacles:{water:"Your way is blocked by water.",signpost:"Signpost",signpostmessage:"The signpost is curiously left blank."},status:{gameover:"Game over!",noammo:"You don't have any ammo.",hurt:"Ouch!",notorches:"You don't have any torches.",title:"Press [P] to play.",forest:"A path is cleared through the forest.",gem:"Gems give you health.",torch:"Torches light up dark rooms.",ammo:"Ammunition: 5 shots per container.",dark:"Room is dark -- You need to light a torch.",breakable:"This wall has several cracks.",noshoot:"You can't shoot here.",heart:"Maximum health increased by 10!",invisible:"You are blocked by an invisible wall.",notdark:"You don't need a torch here.",loading:"Loading...",loaderror:"Oops! Loading failed.",fatalerror:"I has error, Jim.",incompatible:"Um, this file isn't compatible.",nosave:"Yikes! You're out of save space."},pause:{paused:"Paused",health:"    Health:",ammo:"      Ammo:",gems:"      Gems:",torches:"   Torches:",score:"     Score:",keys:"      Keys:"},file:{"new":"Empty Slot",saved:"Saved Game",save:"Save Game",load:"Restore Game",restart:"Restart Game"}},fr:{keys:{collect:"Vous avez maintenant la clé {0}.",toomany:"Vous avez déja une clé {0}.",9:"bleue",A:"verte",B:"cyan",C:"rouge",D:"violet",E:"jaune",F:"blanche"},doors:{locked:"La porte {0} est verrouillée.",open:"La porte {0} est maintenant overte.",1:"bleue",2:"verte",3:"cyan",4:"rouge",5:"violet",6:"jaune",7:"blanche"},obstacles:{water:"Votre chemin est bloquée par de l'eau",signpost:"Poteau Indicateur",signpostmessage:"Le poteau indicateur est curieusement vierge."},status:{gameover:"Game over !",noammo:"Vous n'avez plus de munitions.",hurt:"Aïe !",notorches:"Vous n'avez plus de torches.",title:"Appuyez sur [P] pour jouer.",forest:"Vous frayez un chemin dans la fôret.",gem:"Les bijoux augmentent vos PV.",torch:"Les torches éclairent des pièces sombres.",ammo:"Munitions: 5 bulles par unité.",dark:"Pièce sombre -- Vous avez besoin d'une torche!",breakable:"Ce mur a plusieurs fissures.",noshoot:"Il est interdit de tirer ici.",heart:"PV max a augmenté par 10 !",invisible:"Vous êtes bloqué par un mur invisible.",notdark:"Vous n'avez pas besoin d'une torche ici.",loading:"Chargement...",loaderror:"Oups! Chargement echoué.",fatalerror:"J'ai l'erreur, Jim.",incompatible:"Mais ce fichier est incompatible...",nosave:"Vous n'avez plus d'éspace pour sauvegarder."},pause:{paused:"Pause",health:"        PV:",ammo:" Munitions:",gems:"    Bijous:",torches:"   Torches:",score:"     Score:",keys:"      Clés:"},file:{"new":"Espace Vide",saved:"Jeu Sauvegardé",save:"Sauvegarder",load:"Ouvrir",restart:"Récommencer"}}};n(d),i.DefaultLanguage=d,i.Messages=p,i.getMessage=o,i.findMessage=s,i.getLanguage=r,i.setLanguage=n,i.getBoardMessage=a},{}],9:[function(t,e,i){"use strict";function s(){if(!(this instanceof s))throw o;this.LEFT=37,this.UP=38,this.RIGHT=39,this.DOWN=40,this.SHIFT=16,this.SPACE=32,this.ENTER=13,this.ESCAPE=27,this.T=84,this.P=80,this.S=83,this.R=82,this.BACKSPACE=8,this.DELETE=46,this.pressedKeys=0,this.pressed={},this.capturableKeys=[this.LEFT,this.UP,this.RIGHT,this.DOWN,this.SHIFT,this.SPACE,this.T,this.P,this.S,this.R,this.ENTER,this.ESCAPE,this.BACKSPACE,this.DELETE]}var o=t("./basic").ConstructorError;s.prototype.initialize=function(){this.initialized||(this.boundOnKeyUp=this.onKeyUp.bind(this),this.boundOnKeyDown=this.onKeyDown.bind(this),window.addEventListener("keydown",this.boundOnKeyDown,!1),window.addEventListener("keyup",this.boundOnKeyUp,!1)),this.initialized=!0},s.prototype.cancelInput=function(){var t;for(t in this.pressed)this.pressed.hasOwnProperty(t)&&(this.pressed[t]=-1);this.pressedKeys=0},s.prototype.cancelKey=function(t){void 0!==this.pressed[t]&&(this.pressed[t]=-1,this.pressedKeys-=1,this.pressedKeys<0&&(this.pressedKeys=0))},s.prototype.isAnyPressed=function(){return this.pressedKeys>0},s.prototype.isPressed=function(t){return void 0!==this.pressed[t]&&this.pressed[t]>0?this.pressed[t]:void 0},s.prototype.getMostRecentPress=function(t){var e,i,s,o=0;if(!(this.pressedKeys<=0)){for(t||(t=this.capturableKeys),e=0;e<t.length;e+=1)i=t[e],this.pressed[i]>o&&(o=this.pressed[i],s=i);return s}},s.prototype.onKeyDown=function(t){this.capturableKeys.indexOf(t.keyCode)>=0&&(void 0===this.pressed[t.keyCode]&&(this.pressed[t.keyCode]=Date.now(),this.pressedKeys+=1),t.preventDefault())},s.prototype.onKeyUp=function(t){this.capturableKeys.indexOf(t.keyCode)>=0&&(delete this.pressed[t.keyCode],this.pressedKeys-=1,this.pressedKeys<0&&(this.pressedKeys=0),t.preventDefault())},i.KeyboardInput=s},{"./basic":3}],10:[function(t,e,i){"use strict";function s(t){if(!(this instanceof s))throw j;this.name=t}function o(t){if(!(this instanceof o))throw j;this.modifiers=[],this.terminal=t,this.count=1}function r(t){if(!(this instanceof r))throw j;this.thingTemplate=t}function n(t){this.newForeground=t}function a(t,e){if(!(this instanceof a))throw j;this.fromTemplate=t,this.toTemplate=e}function h(t){if(!(this instanceof h))throw j;this.value=t}function c(t){if(!(this instanceof c))throw j;this.magnetically=t}function d(){if(!(this instanceof d))throw j}function p(t,e){if(!(this instanceof p))throw j;this.counter=t.toUpperCase(),this.amount=e}function u(t,e){if(!(this instanceof u))throw j;this.label=t,this.expression=e}function l(){if(!(this instanceof l))throw j}function f(t,e){this.directionExpression=t,this.forceful=e}function g(t){this.sequence=t}function y(t,e){this.thingTemplate=t,this.directionExpression=e}function m(t){this.label=t}function v(t){this.text=t}function w(t,e,i){this.text=t,this.bold=e,this.label=i,this.modifiesScroll=!0}function b(t,e){this.directionExpression=t,this.message=e}function x(t,e){this.recipient=t,this.message=e}function S(t,e){this.counter=t,this.value=e}function T(t){this.directionExpression=t}function E(){if(!(this instanceof E))throw j}function k(t){this.speed=t||3}function C(t,e,i){this.counter=t,this.value=e,this.label=i}function P(t){this.directionExpression=t}function M(t){this.radius=t}function I(){if(!(this instanceof I))throw j}function O(){if(!(this instanceof O))throw j}function B(t){this.count=t}function A(t){this.directionExpression=t}function L(t){this.label=t}function R(t){this.subExpression=t}function z(){if(!(this instanceof z))throw j}function N(t){this.directionExpression=t}function F(t){this.directionExpression=t}function D(t){this.radius=t}function W(t,e){this.thingTemplate=t,this.count=e}function U(){if(!(this instanceof U))throw j}function H(t,e,i){this.counter=t,this.operand=e,this.value=i}var G=t("./things").ThingFactory,V=t("./basic").Direction,j=t("./basic").ConstructorError,_=t("./game-state").GameState,q=t("./i18n").getBoardMessage,K=Object.freeze({NORMAL:0,CONTINUE:1,CONTINUE_AFTER_JUMP:2,REPEAT:3}),Y=Object.freeze({CW:{name:"Clockwise",type:"modifier",process:function(t){return V.clockwise(t)}},CCW:{name:"Counter-clockwise",type:"modifier",process:function(t){return V.counterClockwise(t)}},OPP:{name:"Opposite",type:"modifier",process:function(t){return V.opposite(t)}},RNDP:{name:"Perpendicularly Random",type:"modifier",process:function(t){return V.randomPerpendicular(t)}}}),Z=Object.freeze({SEEK:{name:"Toward player",type:"terminal",process:function(t){return t.getPlayerDirection()}},SMART:{name:"Smart seek",type:"terminal",process:function(t){return t.getSmartDirection()||t.getPlayerDirection()}},FLOW:{name:"Current orientation",type:"terminal",process:function(t){return t.orientation}},RAND:{name:"Random direction",type:"terminal",process:function(){return V.random()}},RANDF:{name:"Random free direction",type:"terminal",process:function(t){return V.random(t.getFreeDirections())}},RANDB:{name:"Random blocked direction",type:"terminal",process:function(t){return V.random(t.getBlockedDirections())}},RNDEW:{name:"Randomly East or West",type:"terminal",process:function(){return V.randomEastWest()}},RNDNS:{name:"Randomly North or South",type:"terminal",process:function(){return V.randomNorthSouth()}},RNDNE:{name:"Randomly North or East",type:"terminal",process:function(){return V.randomNorthEast()}},NORTH:{name:"North",type:"terminal",process:function(){return V.North}},EAST:{name:"East",type:"terminal",process:function(){return V.East}},SOUTH:{name:"South",type:"terminal",process:function(){return V.South}},WEST:{name:"West",type:"terminal",process:function(){return V.West}},N:{name:"North shorthand",type:"terminal",process:function(){return V.North}},E:{name:"East shorthand",type:"terminal",process:function(){return V.East}},S:{name:"South shorthand",type:"terminal",process:function(){return V.South}},W:{name:"West shorthand",type:"terminal",process:function(){return V.West}}});o.prototype.getResult=function(t){for(var e=this.terminal.process(t),i=this.modifiers.slice(0);i.length;)e=i.pop().process(e);return e},r.prototype.execute=function(t){var e=G.deserialize(this.thingTemplate,t.board);t.board.replaceTile(t.point,e)},n.prototype.execute=function(t){t.foreground=this.newForeground},a.prototype.execute=function(t){return t.board.changeTiles(this.fromTemplate,this.toTemplate),K.CONTINUE},h.prototype.execute=function(t){t.spriteIndex=this.value},c.prototype.execute=function(t){t.remove(),this.magnetically&&t.board.player.push(V.opposite(t.getPlayerDirection()))},d.prototype.execute=function(t){t.scriptContext.stop()},p.prototype.execute=function(t){return t.board.game.adjustCounter(this.counter,this.amount),K.CONTINUE},u.prototype.execute=function(t){return this.expression.getResult(t)&&t.scriptContext.jumpToLabel(this.label)?K.CONTINUE_AFTER_JUMP:K.CONTINUE},l.prototype.execute=function(t){return t.locked=!0,K.CONTINUE},f.prototype.execute=function(t){return this.forceful?this.forcefulMove(t):this.move(t)},f.prototype.move=function(t){var e=t.scriptContext.heap,i=this.directionExpression.getResult(t),s="<count>";if(e[s]||(e[s]=this.directionExpression.count),i){if(t.move(i),e[s]-=1,e[s]>0)return K.REPEAT;delete e[s]}},f.prototype.forcefulMove=function(t){var e,i,s=t.scriptContext.heap,o="<count>",r="<stuck>";if(s[o]||(s[o]=this.directionExpression.count),e=s[r]?V.fromName(s[r]):this.directionExpression.getResult(t)){if(i=t.move(e),!i)return s[r]=V.getShortName(e),K.REPEAT;if(s[o]-=1,s[o]>0)return delete s[r],K.REPEAT;delete s[o],delete s[r]}},g.prototype.execute=function(t){return t.play(this.sequence,!0),K.CONTINUE},y.prototype.execute=function(t){var e,i=this.directionExpression.getResult(t),s=t.point.add(i);t.board.isOutside(s)||(e=G.deserialize(this.thingTemplate,t.board),e?(t.board.moveTile(t.point,s,!1,!0),t.board.isFreeOrSurrenderable(s)&&t.board.addThing(s,e,!0)):t.board.player.point.equals(s)||t.board.deleteTile(s))},m.prototype.execute=function(t){return t.scriptContext.restoreLabel(this.label),K.CONTINUE},v.prototype.execute=function(t){var e=q(t.board,this.text);return t.board.setDisplayMessage(e),K.CONTINUE},w.prototype.execute=function(t){var e=q(t.board,this.text);return t.scriptContext.addScrollContent(e,this.bold,this.label),K.CONTINUE},b.prototype.execute=function(t){var e=this.directionExpression.getResult(t);if(e){var i=t.board.getTile(t.point.add(e));i&&i.sendMessage(this.message)}},x.prototype.execute=function(t){var e,i;if("SELF"===this.recipient)return t.scriptContext.jumpToLabel(this.message)?K.CONTINUE_AFTER_JUMP:K.CONTINUE;for(e="ALL"===this.recipient?t.board.getScripables():t.board.getScriptables(this.recipient),i=0;i<e.length;i+=1)e[i].sendMessage(this.message);return K.CONTINUE},S.prototype.execute=function(t){t.board.game.setCounterValue(this.counter,this.value)},T.prototype.execute=function(t){var e=this.directionExpression.getResult(t);e&&(t.play("c-f#"),G.shoot(t.board,t.point.add(e),e,!1))},E.prototype.execute=function(t){t.pushable=!1,t.walkDirection=void 0},k.prototype.execute=function(t){t.speed=this.speed},C.prototype.execute=function(t){return t.board.game.getCounterValue(this.counter)<this.value?this.label?(t.scriptContext.jumpToLabel(this.label),K.CONTINUE_AFTER_JUMP):void 0:(t.board.game.adjustCounter(this.counter,-1*this.value),K.CONTINUE)},P.prototype.execute=function(t){var e=this.directionExpression.getResult(t);e&&G.shoot(t.board,t.point.add(e),e,!1,!0)},M.prototype.execute=function(t){t.setTorchRadius(this.radius)},I.prototype.execute=function(t){return t.locked=!1,K.CONTINUE},O.prototype.execute=function(t){t.board.game.setState(_.Victory)},B.prototype.execute=function(t){var e=t.scriptContext.heap,i="<cycles>";return e[i]||(e[i]=this.count),e[i]-=1,e[i]>0?K.REPEAT:void delete e[i]},A.prototype.execute=function(t){var e=this.directionExpression.getResult(t);return t.walkDirection=e,K.CONTINUE},L.prototype.execute=function(t){return t.scriptContext.zapLabel(this.label),K.CONTINUE},R.prototype.getResult=function(t){return!this.subExpression.getResult(t)},z.prototype.getResult=function(t){return t.isPlayerAdjacent()},N.prototype.getResult=function(t){return t.isBlocked(this.directionExpression.getResult(t))},F.prototype.getResult=function(t){return this.directionExpression?t.isPlayerAligned(1,this.directionExpression.getResult(t)):t.isPlayerAligned(1)},D.prototype.getResult=function(t){return t.isPlayerVisible(this.radius)},W.prototype.getResult=function(t){return t.board.hasTile(this.thingTemplate,this.count)},U.prototype.getResult=function(t){return t.board.isLit(t.point,void 0,!0)},H.prototype.getResult=function(t){var e=t.getCounterValue(this.counter);switch(this.operand){case">":return e>this.value;case"<":return e<this.value;case">=":return e>=this.value;case"<=":return e<=this.value;case"=":return e===this.value}},i.CommandResult=K,i.DirectionModifier=Y,i.Direction=Z,i.DirectionExpression=o,i.Label=s,i.BecomeCommand=r,i.ChangeCommand=a,i.CharCommand=h,i.ColorCommand=n,i.DieCommand=c,i.EndCommand=d,i.GiveCommand=p,i.IfCommand=u,i.LockCommand=l,i.MoveCommand=f,i.PlayCommand=g,i.PutCommand=y,i.ScrollCommand=w,i.SendDirCommand=b,i.SendCommand=x,i.SetCommand=S,i.SpeedCommand=k,i.TakeCommand=C,i.ThrowStarCommand=P,i.TorchCommand=M,i.RestoreCommand=m,i.SayCommand=v,i.ShootCommand=T,i.StandCommand=E,i.UnlockCommand=I,i.VictoryCommand=O,i.WaitCommand=B,i.WalkCommand=A,i.ZapCommand=L,i.NotExpression=R,i.AdjacentExpression=z,i.BlockedExpression=N,i.AlignedExpression=F,i.PeepExpression=D,i.ExistsExpression=W,i.LitExpression=U,i.TestingExpression=H},{"./basic":3,"./game-state":6,"./i18n":8,"./things":20}],11:[function(t,e,i){"use strict";function s(t,e){this.owner=e,this.script=t,this.commandIndex=0,this.currentLabels={},this.heap={},this.initializeLabels(t),this.scrollContent=[],this.jumpCount=0}var o=t("./game-state").GameState,r=t("./jzt-script-commands");s.prototype.serialize=function(){var t,e={};e.commandIndex=this.commandIndex,e.currentLabels={},e.heap=this.heap;for(t in this.currentLabels)this.currentLabels.hasOwnProperty(t)&&this.currentLabels[t]&&(e.currentLabels[t]=this.currentLabels[t]);return e},s.prototype.deserialize=function(t){var e;this.commandIndex=t.commandIndex,this.heap=t.heap;for(e in t.currentLabels)t.currentLabels.hasOwnProperty(e)&&(this.currentLabels[e]=t.currentLabels[e])},s.prototype.inDefaultState=function(){var t,e=!0;if(0!==this.commandIndex)e=!1;else if(Object.keys(this.heap).length>0)e=!1;else for(t in this.currentLabels)if(this.currentLabels.hasOwnProperty(t)&&0!==this.currentLabels[t]){e=!1;break}return e},s.prototype.initializeLabels=function(t){var e;for(e in t.labelIndicies)t.labelIndicies.hasOwnProperty(e)&&(this.currentLabels[e]=0)},s.prototype.isRunning=function(){return this.commandIndex>=0&&this.commandIndex<this.script.commands.length},s.prototype.stop=function(){this.commandIndex=-1},s.prototype.addScrollContent=function(t,e,i){var s={text:t,center:e,label:i};this.scrollContent.push(s)},s.prototype.displayScroll=function(){var t,e;for(this.owner.board.game.scroll.setTitle(this.owner.name),this.owner.board.game.scroll.clearLines(),this.owner.board.game.scroll.listener=this.owner,t=0;t<this.scrollContent.length;t+=1)e=this.scrollContent[t],this.owner.board.game.scroll.addLine(e.text,e.center,e.label);this.scrollContent=[],this.owner.board.game.setState(o.Reading)},s.prototype.executeTick=function(){var t,e,i,s=this.scrollContent.length>0;if(this.owner.messageQueue.length>0&&(t=this.owner.messageQueue.shift(),this.owner.locked||this.jumpToLabel(t)),this.isRunning()){if(e=this.script.getCommand(this.commandIndex))switch(i=e.execute(this.owner),e.modifiesScroll&&(s=!1),s&&this.displayScroll(),i){case void 0:case r.CommandResult.NORMAL:this.advanceLine(),this.doneTick();break;case r.CommandResult.CONTINUE:this.advanceLine(),this.executeTick();break;case r.CommandResult.CONTINUE_AFTER_JUMP:this.jumpCount<=5?this.executeTick():this.doneTick();break;case r.CommandResult.REPEAT:this.doneTick();break;default:throw"Unexpected command execution."}}else s&&this.displayScroll()},s.prototype.doneTick=function(){this.jumpCount=0},s.prototype.jumpToLabel=function(t){if(this.currentLabels.hasOwnProperty(t)){var e=this.currentLabels[t],i=this.script.labelIndicies[t];if(e<i.length)return this.clearTemporaryHeapItems(),this.commandIndex=i[e],this.jumpCount+=1,!0}return!1},s.prototype.clearTemporaryHeapItems=function(){var t;for(t in this.heap)this.heap.hasOwnProperty(t)&&"<"===t[0]&&">"===t[t.length-1]&&delete this.heap[t]},s.prototype.zapLabel=function(t){var e;this.currentLabels.hasOwnProperty(t)&&(e=this.currentLabels[t],e+1<=this.script.labelIndicies[t].length&&(this.currentLabels[t]+=1))},s.prototype.restoreLabel=function(t){var e;this.currentLabels.hasOwnProperty(t)&&(e=this.currentLabels[t],e-1>=0&&(this.currentLabels[t]-=1))},s.prototype.advanceLine=function(){this.isRunning()&&(this.commandIndex+=1)},i.JztScriptContext=s},{"./game-state":6,"./jzt-script-commands":10}],12:[function(t,e,i){"use strict";function s(t){function e(t,e,i,s){function o(t,e,i){
return t&&t.name===e.toUpperCase()&&t.value&&t.value.toUpperCase()===i.toUpperCase()}for(var r=[],n=t.peek();!o(n,e,i);)r.unshift(t.pop()),n=t.peek();return o(n,e,i)&&s&&t.pop(),r}function i(t,e){var i=new r;return i.add(t),i.add(e),i}function u(t){return i(t,new n)}function f(e){return t?void 0:{assemble:e}}function w(){var t=new r;return t.add(new o("CW")),t.add(new o("CCW")),t.add(new o("OPP")),t.add(new o("RNDP")),t.assembler=f(function(t){t.push(g.DirectionModifier[t.pop().value.toUpperCase()])}),t}function b(){var t=new r;return t.add(new o("SEEK")),t.add(new o("SMART")),t.add(new o("FLOW")),t.add(new o("RAND")),t.add(new o("RANDF")),t.add(new o("RANDB")),t.add(new o("RNDEW")),t.add(new o("RNDNS")),t.add(new o("RNDNE")),t.add(new o("NORTH")),t.add(new o("EAST")),t.add(new o("SOUTH")),t.add(new o("WEST")),t.add(new o("N")),t.add(new o("E")),t.add(new o("S")),t.add(new o("W")),t.assembler=f(function(t){t.push(g.Direction[t.pop().value.toUpperCase()])}),t}function x(){var t=new a,e=new h(w());return t.add(e),t.add(b()),t.assembler=f(function(t){for(var e=new g.DirectionExpression(t.pop());t.peek()&&"modifier"===t.peek().type;)e.modifiers.unshift(t.pop());t.push(e)}),t}function S(){var t=new a;return t.add(x()),t.add(new c),t.assembler=f(function(t){var e=t.pop().value;t.peek().count=e}),t}function T(){var e=new r;return e.add(new o("Black")),e.add(new o("Blue")),e.add(new o("Green")),e.add(new o("Cyan")),e.add(new o("Red")),e.add(new o("Magenta")),e.add(new o("Brown")),e.add(new o("White")),e.add(new o("Grey")),e.add(new o("BrightBlue")),e.add(new o("BrightGreen")),e.add(new o("BrightCyan")),e.add(new o("BrightRed")),e.add(new o("BrightMagenta")),e.add(new o("Yellow")),e.add(new o("BrightWhite")),e.assembler=t?void 0:{assemble:function(t){t.push(y[t.pop().value.toUpperCase()])}},e}function E(){var e=new r;return e.add(new o("Empty")),e.add(new o("ActiveBomb")),e.add(new o("Ammo")),e.add(new o("Bear")),e.add(new o("Blinker")),e.add(new o("BlinkWall")),e.add(new o("Bomb")),e.add(new o("Boulder")),e.add(new o("BreakableWall")),e.add(new o("Bullet")),e.add(new o("Centipede")),e.add(new o("Conveyor")),e.add(new o("Door")),e.add(new o("Duplicator")),e.add(new o("Explosion")),e.add(new o("FakeWall")),e.add(new o("Forest")),e.add(new o("Gem")),e.add(new o("GeoFence")),e.add(new o("Heart")),e.add(new o("InvisibleWall")),e.add(new o("Key")),e.add(new o("Lava")),e.add(new o("LineWall")),e.add(new o("Lion")),e.add(new o("Passage")),e.add(new o("Player")),e.add(new o("Pusher")),e.add(new o("Ricochet")),e.add(new o("River")),e.add(new o("Ruffian")),e.add(new o("Scriptable")),e.add(new o("Signpost")),e.add(new o("SliderEw")),e.add(new o("SliderNs")),e.add(new o("Snake")),e.add(new o("SolidWall")),e.add(new o("Spider")),e.add(new o("SpiderWeb")),e.add(new o("SpinningGun")),e.add(new o("Teleporter")),e.add(new o("Text")),e.add(new o("ThrowingStar")),e.add(new o("Tiger")),e.add(new o("Torch")),e.add(new o("Wall")),e.add(new o("Water")),e.assembler=t?void 0:{assemble:function(t){t.push({type:t.pop().value.toUpperCase()})}},e}function k(){var e=new a;return e.add(T()),e.add(E()),e.assembler=t?void 0:{assemble:function(t){var e=t.pop();e.color=v.serialize(void 0,t.pop()),t.push(e)}},e}function C(t){var e=new a;return e.addDiscard(new o("Not")),e.add(t),e.assembler=f(function(t){t.push(new g.NotExpression(t.pop()))}),e}function P(){var t=new o("Adjacent");return t.discard=!0,t.assembler=f(function(t){t.push(new g.AdjacentExpression)}),t}function M(){var t=new a;return t.addDiscard(new o("Blocked")),t.add(x()),t.assembler=f(function(t){t.push(new g.BlockedExpression(t.pop()))}),t}function I(){var t=new a;return t.addDiscard(new o("Aligned")),t.add(x()),t.assembler=f(function(t){t.push(new g.AlignedExpression(t.pop()))}),t}function O(){var t=new a;return t.addDiscard(new o("Peep")),t.add(u(new c)),t.assembler=f(function(t){var e=t.peek()&&"NUMBER"===t.peek().name?t.pop().value:void 0;t.push(new g.PeepExpression(e))}),t}function B(){var t=new a;return t.addDiscard(new o("Exists")),t.add(u(new c)),t.add(i(E(),k())),t.assembler=f(function(t){var e=t.pop(),i=t.peek()&&"NUMBER"===t.peek().name?t.pop().value:void 0;t.push(new g.ExistsExpression(e,i))}),t}function A(){var t=new a;return t.addDiscard(new o("Lit")),t.assembler=f(function(t){t.push(new g.LitExpression)}),t}function L(){var t=new a,e=new r;return e.add(new o("<")),e.add(new o("<=")),e.add(new o(">")),e.add(new o(">=")),e.add(new o("=")),t.add(new d),t.add(e),t.add(new c),t.assembler=f(function(t){var e=t.pop().value,i=t.pop().value,s=t.pop().value.toUpperCase();t.push(new g.TestingExpression(s,i,e))}),t}function R(){var t=new r;return t.add(C(t)),t.add(P()),t.add(M()),t.add(I()),t.add(O()),t.add(B()),t.add(A()),t.add(L()),t}function z(){var t=new a;return t.addDiscard(new o(":")),t.add(new d),t.addDiscard(new p),t.assembler=f(function(t){t.push(new g.Label(t.pop().value.toUpperCase()))}),t}function N(){var t=new a;return t.addDiscard(new o("Become")),t.add(i(k(),E())),t.assembler=f(function(t){t.push(new g.BecomeCommand(t.pop()))}),t}function F(){var t=new a;return t.addDiscard(new o("Color")),t.add(T()),t.assembler=f(function(t){var e=t.pop();t.push(new g.ColorCommand(e))}),t}function D(){var t=new a;return t.addDiscard(new o("Change")),t.add(i(k(),E())),t.add(i(k(),E())),t.assembler=f(function(t){var e=t.pop();t.push(new g.ChangeCommand(t.pop(),e))}),t}function W(){var t=new a;return t.addDiscard(new o("Char")),t.add(new c),t.assembler=f(function(t){t.push(new g.CharCommand(t.pop().value))}),t}function U(){var t=new a;return t.addDiscard(new o("Die")),t.add(u(new o("Magnetically"))),t.assembler=f(function(t){var e=t.peek();e&&"WORD"===e.name&&"MAGNETICALLY"===e.value.toUpperCase()?(t.pop(),t.push(new g.DieCommand((!0)))):t.push(new g.DieCommand)}),t}function H(){var t=new o("End");return t.discard=!0,t.assembler=f(function(t){t.push(new g.EndCommand)}),t}function G(t,s){var r=new a,n=new a,c=i(x(),S());return s=void 0===s||s,n.addDiscard(new o(",")),n.add(c),r.add(new o(t||"Go")),r.add(c),r.add(new h(n)),r.assembler=f(function(i){var o,r,n=e(i,"WORD",t||"GO",!0);for(o=0;o<n.length;o+=1)r=n[o],i.push(new g.MoveCommand(r,s))}),r}function V(){var t=new a;return t.addDiscard(new o("Give")),t.add(new c),t.add(new d),t.assembler=f(function(t){t.push(new g.GiveCommand(t.pop().value,t.pop().value))}),t}function j(){var t=new a;return t.addDiscard(new o("If")),t.add(R()),t.add(new d),t.assembler=f(function(t){t.push(new g.IfCommand(t.pop().value.toUpperCase(),t.pop()))}),t}function _(){var t=new o("Lock");return t.discard=!0,t.assembler=f(function(t){t.push(new g.LockCommand)}),t}function q(){var t=new a;return t.addDiscard(new o("Play")),t.add(new l),t.assembler=f(function(t){t.push(new g.PlayCommand(t.pop().value))}),t}function K(){var t=new a;return t.addDiscard(new o("Put")),t.add(x()),t.add(i(E(),k())),t.assembler=f(function(t){t.push(new g.PutCommand(t.pop(),t.pop()))}),t}function Y(){var t=new a;return t.addDiscard(new o("Scroll")),t.add(u(new o("Bold"))),t.add(new l),t.add(u(new d)),t.assembler=f(function(t){var e="WORD"===t.peek().name?t.pop().value.toUpperCase():void 0,i=t.pop().value,s=!(!t.peek()||"WORD"!==t.peek().name||"BOLD"!==t.peek().value.toUpperCase())&&t.pop();t.push(new g.ScrollCommand(i,(!!s),e))}),t}function Z(){var t=new a;return t.add(new o("Send")),t.add(u(new d)),t.add(new d),t.assembler=f(function(t){var i=e(t,"WORD","SEND",!0),s=i.pop().value.toUpperCase(),o=i.length>0?i.pop().value.toUpperCase():"SELF";t.push(new g.SendCommand(o,s))}),t}function X(){var t=new a;return t.addDiscard(new o("SendDir")),t.add(x()),t.add(new d),t.assembler=f(function(t){var e=t.pop().value.toUpperCase(),i=t.pop();t.push(new g.SendDirCommand(i,e))}),t}function J(){var t=new a;return t.addDiscard(new o("Set")),t.add(u(new c)),t.add(new d),t.assembler=f(function(t){var e=t.pop().value.toUpperCase(),i=t.peek()&&"NUMBER"===t.peek().name?t.pop().value:1;t.push(new g.SetCommand(e,i))}),t}function Q(){var t=new a;return t.addDiscard(new o("Speed")),t.add(new c),t.assembler=f(function(t){var e=t.peek()&&"NUMBER"===t.peek().name?t.pop().value:void 0;t.push(new g.SpeedCommand(e))}),t}function $(){var t=new a;return t.addDiscard(new o("Take")),t.add(new c),t.add(new d),t.add(u(new d)),t.assembler=f(function(t){var e=t.pop().value.toUpperCase(),i="WORD"===t.peek().name?t.pop().value.toUpperCase():void 0,s=+t.pop().value;t.push(new g.TakeCommand(i||e,s,i?e:void 0))}),t}function tt(){var t=new a;return t.addDiscard(new o("ThrowStar")),t.add(x()),t.assembler=f(function(t){t.push(new g.ThrowStarCommand(t.pop()))}),t}function et(){var t=new a;return t.addDiscard(new o("Torch")),t.add(u(new c)),t.assembler=f(function(t){var e=t.peek()&&"NUMBER"===t.peek().name?t.pop().value:0;t.push(new g.TorchCommand(e))}),t}function it(){var t=new a;return t.addDiscard(new o("Restore")),t.add(new d),t.assembler=f(function(t){t.push(new g.RestoreCommand(t.pop().value.toUpperCase()))}),t}function st(){var t=new a;return t.addDiscard(new o("Say")),t.add(new l),t.assembler=f(function(t){t.push(new g.SayCommand(t.pop().value))}),t}function ot(){var t=new a;return t.addDiscard(new o("Shoot")),t.add(x()),t.assembler=f(function(t){t.push(new g.ShootCommand(t.pop()))}),t}function rt(){var t=new o("Stand");return t.discard=!0,t.assembler=f(function(t){t.push(new g.StandCommand)}),t}function nt(){var t=new o("Unlock");return t.discard=!0,t.assembler=f(function(t){t.push(new g.UnlockCommand)}),t}function at(){var t=new o("Victory");return t.discard=!0,t.assembler=f(function(t){t.push(new g.VictoryCommand)}),t}function ht(){var t=new a;return t.addDiscard(new o("Wait")),t.add(u(new c)),t.assembler=f(function(t){var e=t.peek()&&"NUMBER"===t.peek().name?t.pop().value:void 0;t.push(new g.WaitCommand(e))}),t}function ct(){var t=new a;return t.addDiscard(new o("Walk")),t.add(x()),t.assembler=f(function(t){t.push(new g.WalkCommand(t.pop()))}),t}function dt(){var t=new a;return t.addDiscard(new o("Zap")),t.add(new d),t.assembler=f(function(t){t.push(new g.ZapCommand(t.pop().value.toUpperCase()))}),t}function pt(){var t=new a,e=new r;return e.add(N()),e.add(D()),e.add(W()),e.add(F()),e.add(U()),e.add(H()),e.add(G()),e.add(V()),e.add(j()),e.add(_()),e.add(q()),e.add(K()),e.add(Y()),e.add(Z()),e.add(X()),e.add(J()),e.add(Q()),e.add($()),e.add(tt()),e.add(et()),e.add(G("Try",!1)),e.add(it()),e.add(st()),e.add(ot()),e.add(rt()),e.add(nt()),e.add(at()),e.add(ht()),e.add(ct()),e.add(dt()),t.add(e),t.addDiscard(new p),t}function ut(){var t,e=new r;return e.add(z()),e.add(pt()),e.addDiscard(new p),t=new h(e)}if(!(this instanceof s))throw m;this.parser=ut()}var o=t("./parser").Literal,r=t("./parser").Alternation,n=t("./parser").Empty,a=t("./parser").Sequence,h=t("./parser").Repetition,c=t("./parser").Number,d=t("./parser").Word,p=t("./parser").NewLine,u=t("./parser").Assembly,l=t("./parser").String,f=t("./lexer").Lexer,g=t("./jzt-script-commands"),y=t("./graphics").Colors,m=t("./basic").ConstructorError,v=t("./graphics").ColorUtilities;s.prototype.parse=function(t){var e,i,s,o;if("\n"!==t.charAt(t.length-1)&&(t+="\n"),e=new f(t),i=e.tokenizeAll(),s=new u(i),o=this.parser.completeMatch(s),void 0===o)throw"Catestrophic script error. No result.";return o.stack},i.JztScriptParser=s},{"./basic":3,"./graphics":7,"./jzt-script-commands":10,"./lexer":15,"./parser":17}],13:[function(t,e,i){"use strict";function s(t,e,i){if(!(this instanceof s))throw a;this.name=t,this.rawScript=e,this.labelIndicies={},this.commands=[],i&&this.compile()}var o=t("./jzt-script-commands"),r=t("./jzt-script-parser").JztScriptParser,n=new r,a=t("./basic").ConstructorError;t("./game-state").GameState;s.prototype.compile=function(){function t(t,e,i){i=void 0===i?t.commands.length:i,t.labelIndicies.hasOwnProperty(e.name)?t.labelIndicies[e.name].push(i):t.labelIndicies[e.name]=[i]}var e,i,s=n.parse(this.rawScript);for(e=0;e<s.length;e+=1)if(i=s[e],i instanceof o.Label)t(this,i);else{if("function"!=typeof i.execute)throw"Catestrophic script error. Unexpected object in command stack.";this.commands.push(i)}},s.prototype.getCommand=function(t){return this.commands[t]},s.prototype.serialize=function(){return{name:this.name,rawScript:this.rawScript}},i.JztScript=s},{"./basic":3,"./game-state":6,"./jzt-script-commands":10,"./jzt-script-parser":12}],14:[function(t,e,i){"use strict";function s(t){var e;if(!(this instanceof s))throw r;if(!t||!t.canvasElement||"CANVAS"!==t.canvasElement.nodeName)throw"Expected a valid canvas element in the configuration.";if("function"!=typeof Function.prototype.bind||!window.CanvasRenderingContext2D||"function"!=typeof requestAnimationFrame)return void("function"==typeof t.onLoadCallback&&t.onLoadCallback(!1));if(this.FPS=30,this.CPS=10,this.CYCLE_RATE=Math.round(this.FPS/this.CPS),this.CYCLE_TICKS=Math.floor(1e3/this.FPS)*this.CYCLE_RATE,this.FPS_INTERVAL=1e3/this.FPS,this.TRANSITION_STEPS=10,this.version=o,this.loopId=void 0,this.gameToLoad=void 0,this.gameLoaded=!1,this.loadingAnimationIndex=0,this.screenEffectIndex=0,this.previousStates=[],this.transition={animationIndex:0,type:"irisOut",callback:void 0},this.onLoadCallback=t.onLoadCallback,this.player=void 0,this.keyboard=new n,this.canvasElement=t.canvasElement,this.devicePixelRatio=1,this.notificationListeners=[],t.playTest&&(this.playTest=!0),t.playTest&&(this.playTest=t.playTest),t.notificationListeners)for(e=0;e<t.notificationListeners.length;e+=1)this.addNotificationListener(t.notificationListeners[e]);window.devicePixelRatio&&(this.devicePixelRatio=window.devicePixelRatio,this.canvasElement.width=this.canvasElement.width*window.devicePixelRatio,this.canvasElement.height=this.canvasElement.height*window.devicePixelRatio),this.context=this.canvasElement.getContext("2d"),this.context.imageSmoothingEnabled=!1,this.context.webkitImageSmoothingEnabled=!1,this.context.mozImageSmoothingEnabled=!1,this.context.msImageSmoothingEnabled=!1,this.context.oImageSmoothingEnabled=!1,this.resources={audio:new a,graphics:new h(this.onGraphicsLoaded.bind(this))},window.devicePixelRatio&&(this.resources.graphics.TILE_SIZE.x=this.resources.graphics.TILE_SIZE.x*window.devicePixelRatio,this.resources.graphics.TILE_SIZE.y=this.resources.graphics.TILE_SIZE.y*window.devicePixelRatio),this.screenWidth=Math.floor(this.context.canvas.width/this.resources.graphics.TILE_SIZE.x),this.screenHeight=Math.floor(this.context.canvas.height/this.resources.graphics.TILE_SIZE.y),this.settings={audioActive:this.resources.audio.active,audioVolume:this.resources.audio.userVolume,audioMute:!1,language:c.getLanguage()}}var o="1.0.0",r=t("./basic").ConstructorError,n=t("./input").KeyboardInput,a=t("./audio").Audio,h=t("./graphics").Graphics,c=t("./i18n"),d=t("./scroll").Scroll,p=t("./file-management").FileManagement,u=t("./popup").Splash,l=t("./basic").Point,f=t("./basic").Direction,g=t("./board").Board,y=t("./things").things,m=t("./graphics").Colors,v=t("./graphics").ColorUtilities,w=t("./basic").utilities,b=t("./popup").Popup,x=t("./game-state").GameState,S=t("./metadata");s.prototype.observeSettings=function(t){t.addListener(this.onSettingsChanged.bind(this)),t.initialize(this.settings)},s.prototype.addNotificationListener=function(t){this.notificationListeners.push(t)},s.prototype.serialize=function(){var t,e={};e.name=this.name,e.version=this.version,e.titleBoard=this.titleBoard,e.startingBoard=this.currentBoard.name,e.victoryBoard=this.victoryBoard,e.author=this.author,e.boards=[],e.counters={},e.savedGame=!0;for(t in this.counters)this.counters.hasOwnProperty(t)&&!isNaN(this.counters[t])&&(e.counters[t]=this.counters[t]);this.boards[this.currentBoard.name]=this.currentBoard.serialize();for(t in this.boards)this.boards.hasOwnProperty(t)&&e.boards.push(this.boards[t]);return e},s.prototype.restartGame=function(){this.loadGame(this.gameUrl||this.cachedGame)},s.prototype.loadGame=function(t){var e,i,s=this;if(this.keyboard.cancelInput(),this.previousStates=[],this.setState(x.Loading),"string"==typeof t){this.gameUrl=t;try{i=new XMLHttpRequest,i.onreadystatechange=function(){if(4===i.readyState)try{if(200!==i.status)throw"Unexpected HTTP request status "+i.status;e=JSON.parse(i.responseText),s.deserialize(e)}catch(t){s.catestrophicError(c.getMessage("status.loaderror"))}},i.open("GET",t,!0),i.send(null)}catch(o){this.catestrophicError(c.getMessage("status.loaderror"))}}else"object"==typeof t&&(this.cachedGame=t,this.deserialize(t))},s.prototype.catestrophicError=function(t){this.catestrophicErrorMessage=t,this.setState(x.Error)},s.prototype.deserialize=function(t){var e,i,s=!1;if(!t.version||t.version!==this.version)return void this.catestrophicError(c.getMessage("status.incompatible"));this.isRunning()&&(s=!0,this.resources.audio.cancel(),this.end()),this.name=t.name,this.currentBoard=void 0,this.titleBoard=t.titleBoard,this.startingBoard=t.startingBoard,this.victoryBoard=t.victoryBoard,this.author=t.author,this.boards={},this.readMessages={},this.savedGame=!!t.savedGame,this.keyboard.cancelInput(),this.previousStates=[],this.resources.audio.setActive(!this.settings.audioMute),this.counters={HEALTH:50,HEALTH_MAX:50,AMMO:0,GEMS:0,TORCHES:0,SCORE:0,TORCHLIFE:0,"<PLAYTIME>":0};for(e in t.counters)t.counters.hasOwnProperty(e)&&!isNaN(t.counters[e])&&(this.counters[e]=t.counters[e]);for(e=0;e<t.boards.length;e+=1)i=t.boards[e],this.boards[i.name]=i;this.gameLoaded=!0,s&&this.run()},s.prototype.adjustCounter=function(t,e){this.setCounterValue(t,this.getCounterValue(t)+e)},s.prototype.getCounterValue=function(t){return void 0===this.counters[t]?0:this.counters[t]},s.prototype.setCounterValue=function(t,e){var i=t+"_MAX",s=0;void 0===this.counters[t]?this.counters[t]=0:s=this.counters[t],this.counters[i]&&e>this.counters[i]&&(e=this.counters[i]),e<=0?delete this.counters[t]:this.counters[t]=e,s!==e&&this.notifyListeners("counter",{counter:t,value:e,oldValue:s})},s.prototype.onGraphicsLoaded=function(){this.scroll=new d(this),this.fileManagement=new p(this),this.DARK_PATTERN=this.context.createPattern(this.resources.graphics.DARK_IMAGE,"repeat"),this.NOISE_PATTERN=this.context.createPattern(this.resources.graphics.NOISE_IMAGE,"repeat"),"function"==typeof this.onLoadCallback&&this.onLoadCallback(!0)},s.prototype.movePlayerToPassage=function(t,e){var i=e===this.currentBoard.name?this.currentBoard:this.getBoard(e),s=i?i.getPassage(t):void 0,o=this;void 0!==i&&s&&(i.entryPoint=s.point,this.transition.type="irisOut",this.transition.callback=function(){o.setBoard(i,s.point),o.transition.type="irisIn",o.transition.animationIndex=0,o.transition.callback=function(){o.setState(x.Playing)}},this.setState(x.Transition))},s.prototype.pushState=function(t){this.previousStates.push(this.state),this.keyboard.cancelInput(),this.setState(t)},s.prototype.restoreState=function(){this.previousStates.length>0&&(this.keyboard.cancelInput(),this.setState(this.previousStates.pop()))},s.prototype.setState=function(t){if(t===x.Paused)this.player.background=this.player.background.lighten(),this.keyboard.cancelInput();else if(t===x.Playing)this.keyboard.cancelKey(this.keyboard.P),this.state===x.Title&&(this.currentBoard=void 0,this.setBoard(this.startingBoard)),this.player.background=this.player.background.darken(),this.notifyListeners("playing");else if(t===x.Reading)this.keyboard.cancelInput(),this.player.eventScheduler.takeEvent(),this.scroll.open();else if(t===x.FileManagement){if(this.playTest)return;this.fileManagement.open(void 0,this.state===x.Title),this.notifyListeners("file-management")}else t===x.GameOver?(this.resources.audio.cancel(),this.resources.audio.play("s-cd#g+c-ga#+dgfg#+cf---q.c",!0),this.resources.audio.setActive(!1,!1),this.notifyListeners("game-over",{score:this.getCounterValue("SCORE")})):t===x.Title?(this.titleBoard?this.setBoard(this.titleBoard):this.setBoard(this.startingBoard),this.player&&(this.player.remove(),this.player.point.x=-1,this.player.point.y=-1)):t===x.Victory?(this.victoryBoard&&this.setBoard(this.victoryBoard),this.player&&(this.player.remove(),this.player.point.x=-1,this.player.point.y=-1),this.notifyListeners("victory",{score:this.getCounterValue("SCORE"),time:this.getCounterValue("<PLAYTIME>")})):t===x.Splash?this.splash=new u(this):t===x.Transition&&(this.transition.animationIndex=0);this.state=t},s.prototype.movePlayerToBoardEdge=function(t,e,i){var s=e===this.currentBoard.name?this.currentBoard:this.getBoard(e),o=new l(this.player.point.x,this.player.point.y),r=new l(this.player.point.x,this.player.point.y);if(void 0!==s){switch(!i||t!==f.North&&t!==f.South?!i||t!==f.East&&t!==f.West||(o.y=o.y+i,r.y=r.y+i):(o.x=o.x+i,r.x=r.x+i),t){case f.North:o.y=-1,r.y=0;break;case f.East:o.x=s.width,r.x=s.width-1;break;case f.South:o.y=s.height,r.y=s.height-1;break;case f.West:o.x=-1,r.x=0}s.moveTile(o,r,!1,!0)&&(s.entryPoint=r,this.setBoard(s,r))}},s.prototype.getBoard=function(t){if(this.boards.hasOwnProperty(t))return new g(this.boards[t],this)},s.prototype.setBoard=function(t,e){this.currentBoard&&this.currentBoard.setTile(this.player.point,this.player.under),this.currentBoard&&this.currentBoard.equals(t)||(void 0!==this.currentBoard&&(this.boards[this.currentBoard.name]=this.currentBoard.serialize()),t instanceof g?this.currentBoard=t:this.currentBoard=new g(this.boards[t],this),this.player=new y.Player(this.currentBoard),this.player.game=this),e&&(this.player.point.x=e.x,this.player.point.y=e.y,this.player.under=this.currentBoard.getTile(e)),this.currentBoard.dark&&this.getCounterValue("TORCHLIFE")<=0&&this.oneTimeMessage("status.dark"),this.currentBoard.initializePlayer(this.player)},s.prototype.run=function(t){t&&(this.gameToLoad=t),this.isRunning()||(this.keyboard.initialize(),this.previousStates=[],this.playTest&&this.initialLoad(),this.gameLoaded?this.savedGame?(this.setBoard(this.startingBoard),this.pause(!0)):this.setState(x.Title):this.setState(x.Splash),this.boundLoop=this.loop.bind(this),this.then=Date.now(),this.previousTimestamp=this.then,this.loopId=requestAnimationFrame(this.boundLoop))},s.prototype.loop=function(){try{var t=Date.now(),e=t-this.then,i=t-this.previousTimestamp;this.loopId=requestAnimationFrame(this.boundLoop),e>this.FPS_INTERVAL&&(this.then=t-e%this.FPS_INTERVAL,this.previousTimestamp=t,this.update(i),this.draw())}catch(s){this.catestrophicError(c.getMessage("status.fatalerror"))}},s.prototype.pause=function(t){void 0===t&&(t=!0),this.showStatsWhenPaused=t,this.setState(x.Paused)},s.prototype.end=function(){this.loopId&&(cancelAnimationFrame(this.loopId),this.loopId=void 0)},s.prototype.isRunning=function(){return this.loopId},s.prototype.update=function(t){this.resources.graphics.update(),this.state===x.Playing?(this.currentBoard.update(t),this.checkCounters(t),this.player.update(),this.currentBoard.focusPoint=this.player.point,this.adjustCounter("<PLAYTIME>",t),this.keyboard.isPressed(this.keyboard.P)||this.keyboard.isPressed(this.keyboard.ENTER)?(this.resources.audio.play("++se.tc.e.sc"),this.pause(!0)):this.keyboard.isPressed(this.keyboard.S)?(this.fileManagement.dialogType=p.Type.SAVE,this.pushState(x.FileManagement)):this.keyboard.isPressed(this.keyboard.R)&&(this.fileManagement.dialogType=p.Type.OPEN,this.pushState(x.FileManagement))):this.state===x.Paused?this.keyboard.isAnyPressed()&&(this.keyboard.cancelKey(this.keyboard.P),this.keyboard.cancelKey(this.keyboard.ENTER),this.setState(x.Playing),this.player.foregroundColor=m.F):this.state===x.Reading?(this.scroll.update(),this.adjustCounter("<PLAYTIME>",t)):this.state===x.FileManagement?this.fileManagement.update():this.state===x.GameOver?(this.currentBoard.update(),this.currentBoard.setDisplayMessage(c.getMessage("status.gameover")),(this.keyboard.isPressed(this.keyboard.R)||this.keyboard.isPressed(this.keyboard.ENTER))&&(this.fileManagement.dialogType=p.Type.OPEN,this.pushState(x.FileManagement))):this.state===x.Title?(this.currentBoard.update(),this.currentBoard.setDisplayMessage(c.getMessage("status.title")),this.keyboard.isPressed(this.keyboard.P)||this.keyboard.isPressed(this.keyboard.SPACE)||this.keyboard.isPressed(this.keyboard.ENTER)?(this.keyboard.cancelKey(this.keyboard.P),this.keyboard.cancelKey(this.keyboard.ENTER),this.keyboard.cancelKey(this.keyboard.SPACE),this.setState(x.Playing)):this.keyboard.isPressed(this.keyboard.R)&&(this.fileManagement.dialogType=p.Type.OPEN,this.pushState(x.FileManagement))):this.state===x.Victory?(this.currentBoard.update(),(this.keyboard.isPressed(this.keyboard.R)||this.keyboard.isPressed(this.keyboard.ENTER))&&(this.fileManagement.dialogType=p.Type.OPEN,this.pushState(x.FileManagement))):this.state===x.Loading?(this.loadingAnimationIndex+=1,this.loadingAnimationIndex>=4*y.Conveyor.animationFrames.length&&(this.loadingAnimationIndex=0)):this.state===x.Transition?(this.transition.animationIndex+=1,this.transition.animationIndex>=this.TRANSITION_STEPS&&(this.transition.callback(),this.transition.animationIndex=0)):this.state===x.Splash&&(this.splash.update(),this.splash.done&&(delete this.splash,this.initialLoad()))},s.prototype.initialLoad=function(){this.gameToLoad?(this.loadGame(this.gameToLoad),delete this.gameToLoad):this.setState(x.Error)},s.prototype.checkCounters=function(t){var e=this.getCounterValue("TORCHLIFE");this.getCounterValue("HEALTH")<=0&&this.state!==x.GameOver?this.setState(x.GameOver):e>0&&(e-=t,this.setCounterValue("TORCHLIFE",e),e<=0&&this.resources.audio.play("tc-c-c"))},s.prototype.oneTimeMessage=function(t){var e;this.readMessages.hasOwnProperty(t)||(this.readMessages[t]=!0,e=c.getMessage(t),this.currentBoard.setDisplayMessage(e))},s.prototype.notifyListeners=function(t,e){var i,s;for(i=0;i<this.notificationListeners.length;i+=1)s=this.notificationListeners[i],(!s.types||s.types.indexOf(t)>=0)&&s.callback(t,e)},s.prototype.drawScreenEffect=function(){var t,e=10*this.devicePixelRatio,i=Math.round(256*Math.random()),s=Math.round(256*Math.random());for(this.screenEffectIndex+=1,this.screenEffectIndex>e&&(this.screenEffectIndex=0),this.context.fillStyle=this.NOISE_PATTERN,this.context.save(),this.context.translate(i,s),this.context.scale(2*this.devicePixelRatio,2*this.devicePixelRatio),this.context.fillRect(-i,-s,this.context.canvas.width,this.context.canvas.height),this.context.restore(),this.context.lineWidth=4*this.devicePixelRatio,this.context.strokeStyle="rgba(0,0,0,0.05)",this.context.beginPath(),t=-e;t<this.context.canvas.height;t+=e)this.context.moveTo(0,t+this.screenEffectIndex+e),this.context.lineTo(this.context.canvas.width,t+this.screenEffectIndex);for(this.context.stroke(),this.context.beginPath(),t=-e;t<this.context.canvas.height;t+=e)this.context.moveTo(0,t+2*this.devicePixelRatio+this.screenEffectIndex+e),this.context.lineTo(this.context.canvas.width,t+2*this.devicePixelRatio+this.screenEffectIndex);this.context.stroke()},s.prototype.drawErrorScreen=function(){var t=this.errorPopup?this.errorPopup.spriteGrid:void 0,e=this.catestrophicErrorMessage.length+7;void 0!==this.errorPopup&&this.errorPopup.language===c.Messages.currentLanguage||(this.errorPopup=new b((void 0),new l(e,3),this),this.errorPopup.setColor(m.Red,m.White),t=this.errorPopup.spriteGrid,t.addText(new l(2,1),this.catestrophicErrorMessage,m.BrightWhite),t.setTile(new l(e-4,1),58,m.Cycle),t.setTile(new l(e-3,1),40,m.Cycle)),this.errorPopup.render(this.context)},s.prototype.drawLoadingScreen=function(){var t,e=this.loadingPopup?this.loadingPopup.spriteGrid:void 0,i=24;void 0!==this.loadingPopup&&this.loadingPopup.language===c.Messages.currentLanguage||(this.loadingPopup=new b((void 0),new l(i,3),this),this.loadingPopup.setColor(m.Blue,m.White),e=this.loadingPopup.spriteGrid,e.addText(new l(4,1),c.getMessage("status.loading"),m.BrightWhite),this.loadingPopup.animationPosition=new l(2,1).add(this.loadingPopup.position)),this.loadingPopup.render(this.context),t=this.resources.graphics.getSprite(y.Conveyor.animationFrames[Math.floor(this.loadingAnimationIndex/4)]),t.draw(this.context,this.loadingPopup.animationPosition,m.Cycle)},s.prototype.drawPauseScreen=function(){function t(t){var e=a.getCounterValue(t).toString();return a.getCounterValue(t+"_MAX")&&(e+="/"+a.getCounterValue(t+"_MAX").toString()),e}var e,i,s,o,r=["9","A","B","C","D","E","F"],n=24,a=this;if(this.showStatsWhenPaused)for(void 0!==this.statusPopup&&this.statusPopup.language===c.Messages.currentLanguage||(this.statusPopup=new b(new l(this.screenWidth-(n+1),1),new l(n,8),this),this.statusPopup.language=c.Messages.currentLanguage,this.statusPopup.setTitle(c.getMessage("pause.paused")),e=this.statusPopup.spriteGrid,e.addText(new l(1,1),c.getMessage("pause.health"),m.Yellow),e.addText(new l(1,2),c.getMessage("pause.ammo"),m.Yellow),e.addText(new l(1,3),c.getMessage("pause.gems"),m.Yellow),e.addText(new l(1,4),c.getMessage("pause.torches"),m.Yellow),e.addText(new l(1,5),c.getMessage("pause.score"),m.Yellow),e.addText(new l(1,6),c.getMessage("pause.keys"),m.Yellow)),this.player.point.x>=this.currentBoard.windowOrigin.x+(this.screenWidth-n-2)?this.statusPopup.position.x=1:this.statusPopup.position.x=this.screenWidth-(n+1),i=this.statusPopup.position,this.statusPopup.render(this.context),this.resources.graphics.drawString(this.context,i.add(new l(13,1)),t("HEALTH"),m.BrightWhite),this.resources.graphics.drawString(this.context,i.add(new l(13,2)),t("AMMO"),m.BrightWhite),this.resources.graphics.drawString(this.context,i.add(new l(13,3)),t("GEMS"),m.BrightWhite),this.resources.graphics.drawString(this.context,i.add(new l(13,4)),t("TORCHES"),m.BrightWhite),this.resources.graphics.drawString(this.context,i.add(new l(13,5)),t("SCORE"),m.BrightWhite),i=i.add(new l(13,6)),o=this.resources.graphics.getSprite(12),s=0;s<r.length;s+=1)this.getCounterValue("KEY"+r[s])>0&&(o.draw(this.context,i,v.deserializeForeground(r[s])),i.x+=1)},s.prototype.drawTransition=function(){var t,e,i,s=this,o=Math.max(this.currentBoard.windowOrigin.x,0),r=Math.max(this.currentBoard.windowOrigin.y,0),n=Math.min(this.currentBoard.windowOrigin.x+this.currentBoard.windowSize.x,this.currentBoard.width),a=Math.min(this.currentBoard.windowOrigin.y+this.currentBoard.windowSize.y,this.currentBoard.height),h=Math.sqrt((o/2-this.player.point.x/2)*(o/2-this.player.point.x/2)+(r-this.player.point.y)*(r-this.player.point.y)),c=Math.sqrt((o/2-this.player.point.x/2)*(o/2-this.player.point.x/2)+(a-this.player.point.y)*(a-this.player.point.y)),d=Math.sqrt((n/2-this.player.point.x/2)*(n/2-this.player.point.x/2)+(a-this.player.point.y)*(a-this.player.point.y)),p=Math.sqrt((n/2-this.player.point.x/2)*(n/2-this.player.point.x/2)+(r-this.player.point.y)*(r-this.player.point.y));e=this.transition.animationIndex/this.TRANSITION_STEPS,e="irisOut"===this.transition.type?1-e:e,i=Math.max(h,c,d,p)*e,t=w.generateCircleData(this.player.point,Math.ceil(i)),this.currentBoard.eachDisplayable(function(e,i){t.contains(i)||s.resources.graphics.fillTile(s.context,i.subtract(s.currentBoard.windowOrigin),m.Grey)})},s.prototype.draw=function(){if(this.currentBoard&&!this.errorInRender)try{this.currentBoard.render(this.context)}catch(t){this.errorInRender=!0,this.catestrophicError(c.getMessage("status.fatalerror"))}else this.context.fillStyle=m.Grey.rgbValue,this.context.fillRect(0,0,this.context.canvas.width,this.context.canvas.height);this.state===x.Paused?(this.drawScreenEffect(),this.drawPauseScreen()):this.state===x.Reading?(this.drawScreenEffect(),this.scroll.render(this.context)):this.state===x.FileManagement?(this.drawScreenEffect(),this.fileManagement.render(this.context)):this.state===x.Loading?(this.drawScreenEffect(),this.drawLoadingScreen()):this.state===x.Splash?(this.splash.render(this.context),this.drawScreenEffect()):this.state===x.Error?(this.drawScreenEffect(),this.drawErrorScreen()):this.state===x.Transition&&this.drawTransition()},s.prototype.onSettingsChanged=function(t){t.hasOwnProperty("audioMute")&&(this.settings.audioMute=t.audioMute,this.resources.audio.setActive(!t.audioMute&&this.state!==x.GameOver)),t.hasOwnProperty("audioVolume")&&(this.settings.audioVolume=t.audioVolume,
this.resources.audio.userVolume=t.audioVolume),t.hasOwnProperty("language")&&(this.settings.language=t.language,c.setLanguage(t.language))},i.Game=s,i.version=S.version},{"./audio":2,"./basic":3,"./board":4,"./file-management":5,"./game-state":6,"./graphics":7,"./i18n":8,"./input":9,"./metadata":16,"./popup":18,"./scroll":19,"./things":20}],15:[function(t,e,i){"use strict";function s(t){return"\r"===t||"\n"===t}function o(t){return" "===t||"\t"===t||"\r"===t}function r(t){return t>="a"&&t<="z"||t>="A"&&t<="Z"||"_"===t}function n(t){return t>="0"&&t<="9"}function a(t){return r(t)||n(t)}function h(t,e){if(!(this instanceof h))throw c;this.skipComments=void 0===e||e,this.setInput(t)}var c=t("./basic").ConstructorError;h.prototype.setInput=function(t){this.position=0,this.buffer=t,this.bufferLength=this.buffer.length,this.line=1,this.column=1},h.prototype.tokenizeAll=function(){for(var t=[],e=this.nextToken();e;)t.push(e),e=this.nextToken();return t},h.prototype.nextToken=function(){var t,e,i;if(this.consumeNonTokens(),!(this.position>=this.bufferLength)){if(t=this.getCharacter(),"/"===t&&"/"===this.getCharacter(1))return e=this.createCommentToken(),this.skipComments?this.nextToken():e;if('"'===t)return this.createStringToken();if("<"===t||">"===t||"="===t||":"===t)return i=this.getCharacter(1),"="===i&&"="!==t?this.createToken("OPERATOR",t+i):this.createToken("OPERATOR",t);if(","===t)return this.createToken("PUNCTUATION",t);if(s(t))return e=this.createToken("NEWLINE","[New Line]",1),this.column=1,this.line+=1,e;if(n(t))return this.createNumberToken();if(r(t))return this.createWordToken();throw"Unrecognized token on line "+this.line+", column "+this.column}},h.prototype.getCharacter=function(t){var e=void 0===t?this.position:this.position+t;if(!(e<0||e>=this.bufferLength))return this.buffer.charAt(e)},h.prototype.createCommentToken=function(){var t,e;for(e=this.position+"//".length;e<this.bufferLength&&!s(this.buffer.charAt(e));)e+=1;return t=this.createToken("COMMENT",this.buffer.substring(this.position+"//".length,e),e-this.position)},h.prototype.createStringToken=function(){var t,e,i,o="";for(i=this.position+1;i<this.bufferLength;)if(e=this.buffer.charAt(i),"\\"===e&&'"'===this.buffer.charAt(i+1))o+='"',i+=2;else if("\\"===e&&"n"===this.buffer.charAt(i+1))o+="\n",i+=2;else{if('"'===e){i+=1;break}if(s(e))throw"Unterminated string literal on line "+this.line+", column "+this.column;o+=e,i+=1}return t=this.createToken("STRING",o,i-this.position)},h.prototype.createNumberToken=function(){for(var t=this.position;t<this.bufferLength&&n(this.buffer.charAt(t));)t+=1;return this.createToken("NUMBER",+this.buffer.substring(this.position,t),t-this.position)},h.prototype.createWordToken=function(){for(var t=this.position;t<this.bufferLength&&a(this.buffer.charAt(t));)t+=1;return this.createToken("WORD",this.buffer.substring(this.position,t))},h.prototype.consumeNonTokens=function(){for(;this.position<this.bufferLength;){if(!o(this.getCharacter()))return;this.position+=1,this.column+=1}},h.prototype.createToken=function(t,e,i){i=void 0===i?e.length:i;var s={name:t,value:e,line:this.line,column:this.column,position:this.position};return this.position+=i,this.column+=i,s},i.Lexer=h},{"./basic":3}],16:[function(t,e,i){e.exports={version:"1.0.57",date:1646580444040}},{}],17:[function(t,e,i){"use strict";function s(t){if(!(this instanceof s))throw y;this.tokens=t,this.index=0,this.stack=[],this.target=void 0}function o(){if(!(this instanceof o))throw y;this.assembler=void 0}function r(t){if(!(this instanceof r))throw y;if(!t)throw"Subparser is required.";this.subParser=t,this.assembler=void 0,this.preAssembler=void 0}function n(){if(!(this instanceof n))throw y;this.assembler=void 0}function a(){if(!(this instanceof a))throw y;this.assembler=void 0,this.subParsers=[]}function h(){if(!(this instanceof h))throw y;this.assembler=void 0,this.subParsers=[]}function c(){if(!(this instanceof c))throw y;this.assembler=void 0,this.subParsers=[]}function d(){if(!(this instanceof d))throw y;this.assembler=void 0,this.discard=!1}function p(){if(!(this instanceof p))throw y;this.assembler=void 0,this.discard=!1}function u(t,e){if(!(this instanceof u))throw y;this.assembler=void 0,this.caseSensitive=e,this.literalValue=t,this.discard=!1,e||(this.literalValue=this.literalValue.toUpperCase())}function l(){if(!(this instanceof l))throw y;this.assembler=void 0,this.discard=!1}function f(){if(!(this instanceof f))throw y;this.assembler=void 0,this.discard=!1}function g(){if(!(this instanceof g))throw y;this.assembler=void 0,this.discard=!1}var y=t("./basic").ConstructorError;s.prototype.clone=function(){var t=new s;return t.tokens=this.tokens.slice(0),t.index=this.index,t.stack=this.stack.slice(0),t.target=this.target?this.target.clone():void 0,t},s.prototype.current=function(){return this.tokens[this.index]},s.prototype.peek=function(){return this.stack[this.stack.length-1]},s.prototype.pop=function(){return this.stack.pop()},s.prototype.push=function(t){this.stack.push(t)},s.prototype.isDone=function(){return this.index>=this.tokens.length},s.prototype.next=function(){var t=this.tokens[this.index];return this.index+=1,t},o.prototype.match=function(){return[]},o.prototype.bestMatch=function(t){var e=this.matchAndAssemble([t]);return this.findBestAssembly(e)},o.prototype.completeMatch=function(t){var e,i=this.bestMatch(t);if(void 0!==i&&i.isDone())return i;throw e=i.current(),"Unexpected token '"+e.value+"' on line "+e.line+", column "+e.column},o.prototype.matchAndAssemble=function(t){var e,i=this.match(t);if(this.assembler)for(e=0;e<i.length;e+=1)this.assembler.assemble(i[e]);return i},o.prototype.findBestAssembly=function(t){var e,i,s;for(i=0;i<t.length;i+=1)s=t[i],e?s.index>e.index&&(e=s):e=s;return e},o.prototype.cloneAssemblies=function(t){var e,i,s=[];for(e=0;e<t.length;e+=1)i=t[e],s.push(i.clone());return s},r.prototype=new o,r.prototype.constructor=r,r.prototype.match=function(t){var e,i,s;if(void 0!==this.preAssembler)for(e=0;e<t.length;e+=1)i=t[e],this.preAssembler.assemble(i);for(s=this.cloneAssemblies(t);t.length>0;)t=this.subParser.matchAndAssemble(t),s=s.concat(t);return s},n.prototype=new o,n.prototype.constructor=n,n.prototype.match=function(t){return this.cloneAssemblies(t)},a.prototype=new o,a.constructor=a,a.prototype.add=function(t){this.subParsers.push(t)},a.prototype.addDiscard=function(t){t.discard=!0,this.subParsers.push(t)},h.prototype=new a,h.prototype.constructor=h,h.prototype.match=function(t){var e,i,s=!1,o=t,r=t;for(e=0;e<this.subParsers.length;e+=1){if(i=this.subParsers[e],r=i.matchAndAssemble(r),r.length<=0)return s&&this.determineTokenError(o),r;s=!0,o=r}return r},h.prototype.determineTokenError=function(t){var e,i=this.findBestAssembly(t);if(void 0===i.current())throw"Token expected";throw e=i.current(),"Unexpected token '"+e.value+"' on line "+e.line+", column "+e.column},c.prototype=new a,c.prototype.constructor=c,c.prototype.match=function(t){var e,i,s,o,r=[];for(o=0;o<this.subParsers.length;o+=1){i=this.subParsers[o];try{s=i.matchAndAssemble(t),r=r.concat(s)}catch(n){e=n}}if(r.length<=0&&void 0!==e)throw e;return r},d.prototype=new o,d.prototype.constructor=d,d.prototype.qualifies=function(){return!0},d.prototype.match=function(t){var e,i,s,o=[];for(e=0;e<t.length;e+=1)i=t[e],s=this.matchAssembly(i),void 0!==s&&o.push(s);return o},d.prototype.matchAssembly=function(t){var e,i;if(!t.isDone())return this.qualifies(t.current())?(e=t.clone(),i=e.next(),this.discard||e.stack.push(i),e):void 0},p.prototype=new d,p.prototype.qualifies=function(t){return"NUMBER"===t.name&&!isNaN(t.value)},u.prototype=new d,u.prototype.constructor=u,u.prototype.qualifies=function(t){var e=t.value;return"string"!=typeof e||this.caseSensitive||(e=e.toUpperCase()),this.literalValue===e},l.prototype=new d,l.prototype.constructor=l,l.prototype.qualifies=function(t){return"WORD"===t.name&&isNaN(parseInt(t.value,10))},f.prototype=new d,f.prototype.constructor=f,f.prototype.qualifies=function(t){return"STRING"===t.name},g.prototype=new d,g.prototype.constructor=g,g.prototype.qualifies=function(t){return"NEWLINE"===t.name},i.Alternation=c,i.Assembly=s,i.Parser=o,i.Repetition=r,i.CollectionParser=a,i.Sequence=h,i.Empty=n,i.Terminal=d,i.Literal=u,i.NewLine=g,i.Number=p,i.String=f,i.Word=l},{"./basic":3}],18:[function(t,e,i){"use strict";function s(t,e,i){t?this.position=t:(this.position=new n(0,0),this.position.x=Math.floor((i.screenWidth-e.x)/2),this.position.y=Math.floor((i.screenHeight-e.y)/2)),this.title=void 0,this.size=e,this.game=i,this.graphics=i.resources.graphics,this.spriteGrid=new a(this.size.x,this.size.y,this.graphics),this.setColor(h.Blue,h.BrightWhite)}function o(){this.startTime=Date.now(),this.renderFunctions=[]}function r(t){var e;this.game=t,this.animator=new o,this.done=!1,this.animationFrame=void 0,this.popup=new s((void 0),new n(50,20),t),this.popup.setColor(h.Black),this.popup.spriteGrid.clear(),e=this.popup.spriteGrid,this.animator.start(function(){e.addText(new n(1,1),"┌───┐",h.White),e.addText(new n(1,2),"│ o┌┴──┐ Association of",h.White),e.addText(new n(1,3),"└─┬┴──┐│ Shareware",h.White),e.addText(new n(1,4),"  │ o ├┘ Unprofessionals",h.White),e.addText(new n(1,5),"  └─┴─┘",h.White)}).then(300,function(){e.addText(new n(1,7),"x286 BIOS Version 2.1.16",h.White)}).then(400,function(){e.addText(new n(1,9),"Initializing Nostalgia Boot Agent v1.4.14",h.White),t.resources.audio.play("i++c")}).then(600,function(){e.addText(new n(1,10),"Nostalgia Boot Agent (v1.4.14) Loaded.",h.White)}).then(700,function(){e.addText(new n(1,12),"Starting Markrosoft DOS...",h.White)}).then(1200,function(){e.addText(new n(1,14),"Running autoexec.bat",h.White)}).then(1300,function(){e.addText(new n(1,15),"C:\\>cd JZT",h.White),e.addText(new n(1,16),"C:\\JZT\\>exe",h.White)}).then(2e3,function(){e.clear(),e.addArt(new n(7,5)," 0 0 0 0 0 0 0▄F▄F▀F▀F▀F▀F▀F█F▄F▄F▄F▀F▀F▀F▀F▀F▀F▄F F F▄F▄F▀F▀F▀F▀F▀F▀F▀F▄F\n 0 0 0▄F▄F▀F▀F▄9▄9█9█9█9▀9▄F▀F▄9▄9▄9█9█9█9█9▓9 0█F▀F▀F▄9▄9█9█9█9█9█9▀9 0█F\n 0 0█F 0▄9█9█9█9█9█9▓9 0▄F▀F█9█9▀9▀9▀9▀9 0█9▓9▓F 0█9█9█9▀9█9▓9▀9 0▄F▄F▀F▀F\n 0 0█F▄F▀9▀9 0▄F 0█9▓9 0▓F▄F▄F▄F▓F█F▀F▄9█9▓9 0▓F 0▀9▀9 0 0█9▓9 0█F\n 0 0 0 0▀F▀F▀F█F 0█9▓9 0█F 0 0█F▀F▄9█9█9▓9 0█F▀F▀F▀F▀F█F 0█9▓9 0▓F\n 0▄F▀F▀F▄F 0 0█F 0█9▓9 0▓F▄F▀F 0█9█9▓9 0▄F█F▄F 0 0 0 0█F 0█9▓9 0▓F\n█F 0█9█9 0▀F▀F▄9█9▓9▀9 0▓F█F 0█9▓9▀9 0▀F 0▄9▄9▀F▄F 0█F 0█9▓9▀9▄F▀F\n▀F▄F 0█9█9█9█9▓9█9▀9▄F▀F█F 0█9█9█9█9█9█9█9▓9▓9 0▓F 0█F 0█9▓9 0▓F\n 0 0▀F▄F▀9▀9▀9▀9▄F▀F 0▀F▄F▀9▀9▀9▀9▀9▀9▄F▄F▄F▄F▄F▀F F F▀F▄F▄F▄F▀F\n 0 0 0 0▀F▀F▀F▀F F F F F F▀F▀F▀F▀F▀F▀F"),e.addText(new n(46-c.version.length,15),c.version,h.Grey),e.addText(new n(13,18),"Created by Mark McIntyre",h.Grey),e.addText(new n(6,19),"(c) "+new Date(c.date).getFullYear()+" Mark McIntyre",h.Grey)}).end(4e3)}var n=t("./basic").Point,a=t("./graphics").SpriteGrid,h=t("./graphics").Colors,c=t("./metadata");s.prototype.setTitle=function(t){this.title=t,this.redraw()},s.prototype.render=function(t){var e=this.position.x,i=this.position.y,s=this.size.x,o=this.size.y;t.fillStyle=this.background.rgbValue,t.fillRect(e*this.graphics.TILE_SIZE.x,i*this.graphics.TILE_SIZE.y,s*this.graphics.TILE_SIZE.x,o*this.graphics.TILE_SIZE.y),this.spriteGrid.draw(t,this.position)},s.prototype.redraw=function(){this.spriteGrid.clear(),this.createBorder(this.spriteGrid)},s.prototype.setColor=function(t,e,i,s){this.background=t,this.foreground=e,this.scrollbarBackground=i||t,this.scrollbarForeground=s||e,this.redraw()},s.prototype.setScrollBar=function(t,e,i){var s,o=this.size.y-4,r=new n(this.size.x-2,1),a=Math.max(1,Math.floor(o*(i/e)));for(s=Math.round((o-a)*(t/(e-i))),s=Math.min(o-a-1,s),r.y=1;r.y<this.size.y-1;r.y+=1)1===r.y?this.spriteGrid.setTile(r,30,this.scrollbarForeground,this.scrollbarBackground):r.y===this.size.y-2?this.spriteGrid.setTile(r,31,this.scrollbarForeground,this.scrollbarBackground):r.y-2>=s&&r.y-2<=s+a?this.spriteGrid.setTile(r,219,this.scrollbarForeground):this.spriteGrid.setTile(r,177,this.scrollbarForeground,this.scrollbarBackground)},s.prototype.createBorder=function(t){var e,i,s=new n(0,0),o=this.size.x,r=this.size.y;for(t.setTile(new n(0,0),218,this.foreground),t.setTile(new n(o-1,0),191,this.foreground),s.x=1;s.x<o-1;s.x+=1)s.y=0,t.setTile(s,196,this.foreground),s.y=r-1,t.setTile(s,196,this.foreground);for(s.y=1;s.y<r-1;s.y+=1)s.x=0,t.setTile(s,179,this.foreground),s.x=o-1,t.setTile(s,179,this.foreground);t.setTile(new n(0,r-1),192,this.foreground),t.setTile(new n(o-1,r-1),217,this.foreground),this.title&&(e=" "+this.title+" ",i=Math.round((o-e.length)/2),this.spriteGrid.addText(new n(i,0),e,this.foreground))},o.prototype.start=function(t){return t.frameTime=0,this.renderFunctions.push(t),this},o.prototype.end=function(t){this.then(t,function(){})},o.prototype.update=function(){var t,e,i=Date.now()-this.startTime;for(e=this.renderFunctions.length-1;e>=0;e-=1)t=this.renderFunctions[e],i>=t.frameTime&&(t(),this.renderFunctions.splice(e,1))},o.prototype.then=function(t,e){return e.frameTime=t,this.renderFunctions.push(e),this},o.prototype.isDone=function(){return this.renderFunctions.length<=0},r.prototype.update=function(){this.animator.update(),this.done=this.animator.isDone()},r.prototype.render=function(t){this.popup.render(t)},i.Popup=s,i.Splash=r},{"./basic":3,"./graphics":7,"./metadata":16}],19:[function(t,e,i){"use strict";function s(t){var e;if(!(this instanceof s))throw o;this.game=t,this.graphics=t.resources.graphics,this.lines=[],this.position=0,this.cursor=-1,this.screenWidth=t.screenWidth,this.screenHeight=t.screenHeight,this.width=48,this.textAreaWidth=this.width-8,this.height=0,this.fullHeight=Math.min(Math.floor(t.context.canvas.height/this.graphics.TILE_SIZE.y)-2,24),this.textAreaHeight=this.fullHeight-4,this.state=s.ScrollState.Opening,this.origin=new r(0,0),this.cycleCount=0,this.labels=[],this.eventScheduler=new n(2*this.game.CYCLE_TICKS,0),e=this.graphics.getSprite(32),this.setHeight(0),this.setPosition(0)}var o=t("./basic").ConstructorError,r=t("./basic").Point,n=t("./basic").DelayedEventScheduler,a=t("./game-state").GameState,h=t("./graphics").Colors;s.ScrollState={Opening:0,Open:1,Closing:2,Closed:3},s.ScrollAction={Up:0,Down:1,Select:2,Exit:3},s.prototype.open=function(){this.state=s.ScrollState.Opening},s.prototype.addLine=function(t,e,i){function s(t){r=d.graphics.textToSprites(t),e&&(r.center=e),i&&(r.label=i,d.labels.push(d.lines.length)),d.lines.push(r)}var o,r,n,a,h=t.split(/\s+/),c=i?this.textAreaWidth-2:this.textAreaWidth,d=this;for(i&&this.lines.length>0&&this.lines[this.lines.length-1].label||this.lines.length>0&&d.lines.push([]),n=i?"":" ",a="",o=0;o<h.length;o+=1)a=h[o],a.length>c&&(a=a.substring(0,c)),n.length>0&&n.length<c&&(n+=" "),n.length>0&&n.length+a.length>c&&(s(n),n=""),n+=a;s(n)},s.prototype.setPosition=function(t){t>this.lines.length-this.textAreaHeight&&(t=this.lines.length-this.textAreaHeight),t<0&&(t=0),this.position=t},s.prototype.scrollUp=function(){var t,e=this.getVisibleLabels();if(e.length)if(e[0]===this.cursor)this.setPosition(this.position-1);else{for(t=e.length-1;e[t]>=this.cursor;)t-=1;this.cursor=e[t]}else this.setPosition(this.position-1),e=this.getVisibleLabels(),this.cursor=e.length?e[0]:-1},s.prototype.scrollDown=function(){var t,e=this.getVisibleLabels();if(e.length)if(e[e.length-1]===this.cursor)this.setPosition(this.position+1);else{for(t=0;e[t]<=this.cursor;)t+=1;this.cursor=e[t]}else this.setPosition(this.position+1),e=this.getVisibleLabels(),this.cursor=e.length?e[0]:-1},s.prototype.setTitle=function(t){t?(this.title=this.graphics.textToSprites(t),this.title.center=!0):this.title=void 0},s.prototype.getVisibleLabels=function(){var t=[],e=0;if(this.labels.length)for(e=this.position;e<Math.min(this.lines.length,this.position+this.textAreaHeight);++e)this.lines[e].label&&t.push(e);return t},s.prototype.getCurrentLabel=function(){return this.cursor>=0?this.lines[this.cursor].label:void 0},s.prototype.setHeight=function(t){this.height=t,this.textAreaHeight=this.title?this.height-4:this.height-2,this.textAreaHeight<0&&(this.textAreaHeight=0),this.origin.x=Math.floor((this.screenWidth-this.width)/2),this.origin.y=Math.floor((this.screenHeight-this.height)/2)},s.prototype.doTick=function(){var t,e=this.eventScheduler.takeEvent();e===s.ScrollAction.Up?this.scrollUp():e===s.ScrollAction.Down?this.scrollDown():e===s.ScrollAction.Select?(this.state=s.ScrollState.Closing,t=this.getCurrentLabel(),t&&this.listener&&this.listener.sendMessage(t)):e===s.ScrollAction.Exit&&(this.state=s.ScrollState.Closing)},s.prototype.update=function(){var t,e=this.game.keyboard;this.state===s.ScrollState.Opening?(this.setHeight(this.height+2),this.setPosition(0),this.height>=Math.min(this.fullHeight,this.lines.length+4)&&(this.setHeight(Math.min(this.fullHeight,this.lines.length+4)),t=this.getVisibleLabels(),t.length&&(this.cursor=t[0]),this.state=s.ScrollState.Open)):this.state===s.ScrollState.Open?(e.isPressed(e.UP)?this.eventScheduler.scheduleEvent(e.isPressed(e.UP),s.ScrollAction.Up):e.isPressed(e.DOWN)?this.eventScheduler.scheduleEvent(e.isPressed(e.DOWN),s.ScrollAction.Down):e.isPressed(e.ENTER)?this.eventScheduler.scheduleEvent(e.isPressed(e.ENTER),s.ScrollAction.Select):e.isPressed(e.ESCAPE)||e.isPressed(e.SPACE)?this.eventScheduler.scheduleEvent(e.isPressed(e.ESCAPE),s.ScrollAction.Exit):this.eventScheduler.cancelEvent(),this.cycleCount+=1,this.cycleCount>=this.game.CYCLE_RATE&&(this.cycleCount=0,this.doTick())):this.state===s.ScrollState.Closing?(this.setHeight(this.height-2),this.height<=2&&(this.state=s.ScrollState.Closed)):this.state===s.ScrollState.Closed&&this.game.setState(a.Playing)},s.prototype.clearLines=function(){this.lines=[],this.labels=[],this.setPosition(0),this.cursor=-1},s.prototype.drawLine=function(t){var e,i=this.position+t,s=this.lines[i],o=this.title?3:1;s&&(e=this.origin.clone(),e.x+=4,e.y+=o+t,s.selected=this.position+t===this.cursor,this.drawText(s,e))},s.prototype.drawText=function(t,e){var i=h.Yellow;t.center&&(i=h.BrightWhite,e.x+=Math.floor((this.textAreaWidth-t.length)/2)),t.label&&(i=h.BrightWhite,t.selected?this.graphics.getSprite(16).draw(this.game.context,e,h.Cycle):this.graphics.getSprite(7).draw(this.game.context,e,h.White),e.x+=2),this.graphics.drawSprites(this.game.context,e,t,i,void 0)},s.prototype.drawScrollBar=function(t,e,i,s,o,r){var n,a,c=i-2,d=Math.max(1,Math.floor(c*(o/r))),p=r-o;for(e=e.clone(),n=Math.ceil((c-d-2)*(s/p)),a=0;a<i;a+=1,e.y+=1)0===a?this.graphics.getSprite(30).draw(t,e,h.BrightBlue):a===i-1?this.graphics.getSprite(31).draw(t,e,h.BrightBlue):a>=n+1&&a<=n+1+d?this.graphics.getSprite(219).draw(t,e,h.BrightBlue):this.graphics.getSprite(177).draw(t,e,h.BrightBlue)},s.prototype.render=function(t){var e,i,o,n,a=[],c=this.origin.x,d=this.origin.y;for(t.fillStyle=h.Blue.rgbValue,t.fillRect(c*this.graphics.TILE_SIZE.x,d*this.graphics.TILE_SIZE.y,this.width*this.graphics.TILE_SIZE.x,this.height*this.graphics.TILE_SIZE.y),a.push(this.graphics.getSprite(218)),o=this.width-1,e=this.graphics.getSprite(196);o-1>0;)o-=1,a.push(e);if(a.push(this.graphics.getSprite(191)),this.graphics.drawSprites(t,new r(c,d),a,h.BrightWhite),this.title&&this.height>3){for(a=[],a.push(this.graphics.getSprite(179)),o=this.width-1,e=this.graphics.getSprite(32);o-1>0;)o-=1,a.push(e);a.push(this.graphics.getSprite(179)),d+=1,n=new r(c,d),this.graphics.drawSprites(t,n,a,h.BrightWhite),this.title&&(n.x+=4,this.drawText(this.title,n))}if(this.title&&this.height>2){for(a=[],a.push(this.graphics.getSprite(195)),o=this.width-1,e=this.graphics.getSprite(196);o-1>0;)o-=1,a.push(e);a.push(this.graphics.getSprite(180)),d+=1,this.graphics.drawSprites(t,new r(c,d),a,h.BrightWhite)}if(!this.title||this.height>4)for(i=0;i<this.textAreaHeight;i+=1){for(a=[],a.push(this.graphics.getSprite(179)),o=this.width-1,e=this.graphics.getSprite(32);o-1>0;)o-=1,a.push(e);a.push(this.graphics.getSprite(179)),d+=1,this.graphics.drawSprites(t,new r(c,d),a,h.BrightWhite),this.drawLine(i)}if(this.height>1){for(a=[],a.push(this.graphics.getSprite(192)),o=this.width-1,e=this.graphics.getSprite(196);o-1>0;)o-=1,a.push(e);a.push(this.graphics.getSprite(217)),d+=1,this.graphics.drawSprites(t,new r(c,d),a,h.BrightWhite)}this.state===s.ScrollState.Open&&this.lines.length>this.textAreaHeight&&this.drawScrollBar(t,new r(this.origin.x+this.width-2,this.origin.y+3),this.height-4,this.position,this.textAreaHeight,this.lines.length-1)},i.Scroll=s},{"./basic":3,"./game-state":6,"./graphics":7}],20:[function(t,e,i){"use strict";function s(t,e){i.things[t]=e,e.type=t}function o(t){this.spriteIndex=63,this.board=t,this.point=new Q(0,0),this.foreground=$.Yellow,this.background=void 0,this.type=this.constructor.type}function r(t){o.call(this,t),this.cycleCount=0,this.speed=3}function n(t){r.call(this,t),this.name="UnknownScriptable",this.scriptContext=void 0,this.messageQueue=[],this.walkDirection=void 0,this.locked=!1,this.orientation=void 0,this.spriteIndex=1,this.torchRadius=void 0,this.pushable=!1}function a(t){r.call(this,t),this.timeToLive=9,this.speed=6,this.spriteIndex=57,this.radius=4,this.conveyable=!0}function h(t){o.call(this,t),this.spriteIndex=132,this.background=void 0,this.foreground=$.Cyan}function c(t){r.call(this,t),this.spriteIndex=153,this.background=void 0,this.foreground=$.Brown,this.sensitivity=9,this.speed=3,this.conveyable=!0}function d(t){r.call(this,t),this.direction=it.North,this.period=3,this.delay=0,this.currentTick=0,this.spriteIndex=206,this.background=void 0,this.foreground=$.Yellow,this.blinkState=!1}function p(t){o.call(this,t),this.horizontal=!1,this.background=void 0,this.foreground=$.Yellow}function u(t){o.call(this,t),this.radius=4,this.spriteIndex=11,this.conveyable=!0}function l(t){o.call(this,t),this.conveyable=!0,this.spriteIndex=254}function f(t){o.call(this,t),this.spriteIndex=177,this.background=$.Black,this.foreground=$.BrightCyan}function g(t){r.call(this,t),this.spriteIndex=248,this.foreground=$.BrightWhite,this.background=void 0,this.direction=it.North,this.speed=1}function y(t){r.call(this,t),this.spriteIndex=79,this.foreground=$.BrightBlue,this.background=void 0,this.speed=3,this.follower=void 0,this.head=!1,this.leader=void 0,this.linked=!1,this.firstTick=!0,this.orientation=void 0,this.deviance=0,this.intelligence=0}function m(t){r.call(this,t),this.clockwise=!0,this.animationIndex=Math.floor(Math.random()*m.animationFrames.length-1),this.spriteIndex=179}function v(t){o.call(this,t),this.spriteIndex=10,this.foreground=$.BrightWhite,this.background=$.Blue}function w(t){r.call(this,t),this.MAX_STEPS=20,this.copyDirection=it.East,this.speed=10,this.spriteIndex=250,this.background=void 0,this.currentStep=0,this.foreground=$.BrightWhite}function b(t){r.call(this,t),this.radius=4,this.timeToLive=b.MAX_TTL,this.speed=1,this.spriteIndex=0}function x(t){o.call(this,t),this.spriteIndex=178,this.foreground=$.Yellow,this.background=$.Black}function S(t){o.call(this,t),this.spriteIndex=176,this.foreground=$.Black,this.background=$.Green}function T(t){o.call(this,t),this.spriteIndex=4,this.background=void 0,this.foreground=$.BrightMagenta,this.conveyable=!0}function E(t){o.call(this,t),this.foreground=$.Grey,this.background=void 0}function k(t){o.call(this,t),this.spriteIndex=3,this.foreground=$.BrightRed,this.background=void 0,this.conveyable=!0}function C(t){o.call(this,t),this.spriteIndex=0,this.foreground=$.BrightGreen}function P(t){o.call(this,t),this.spriteIndex=12,this.background=void 0,this.foreground=$.BrightBlue,this.conveyable=!0}function M(t){o.call(this,t),this.background=$.BrightRed,this.foreground=$.BrightRed,this.cycleCount=0,this.cycleRate=5*t.game.CYCLE_RATE,this.spriteIndex=176}function I(t){o.call(this,t),this.foreground=$.BrightBlue,this.spriteIndex=void 0}function O(t){r.call(this,t),this.intelligence=3,this.spriteIndex=234,this.foreground=$.BrightRed,this.background=void 0,this.speed=2,this.conveyable=!0}function B(t){o.call(this,t),this.spriteIndex=240,this.foreground=$.BrightWhite,this.background=$.Blue,this.targetBoard=void 0,this.passageId=0,this.glow=!0}function A(t){r.call(this,t),this.name="Player",this.spriteIndex=2,this.point=new Q((-1),(-1)),this.foreground=$.BrightWhite,this.background=$.Blue,this.conveyable=!0,t&&(this.eventScheduler=new rt(2*t.game.CYCLE_TICKS,0)),this.game=void 0,this.speed=1,this.glow=!0}function L(t){r.call(this,t),this.orientation=it.South,this.speed=3,this.initializeSprite()}function R(t){o.call(this,t),this.spriteIndex=42,this.background=void 0,this.foreground=$.BrightGreen}function z(t){o.call(this,t),this.direction=it.North,this.background=$.Blue,this.foreground=$.BrightBlue,this.speed=1,this.initialize()}function N(t){r.call(this,t),this.spriteIndex=5,this.background=void 0,this.foreground=$.BrightMagenta,this.intelligence=5,this.restingTime=5,this.moving=!1,this.timeLeft=0,this.speed=1,this.orientation=it.North,this.conveyable=!0}function F(t){o.call(this,t),this.spriteIndex=209,this.background=void 0,this.foreground=$.Brown,this.text=void 0}function D(t){o.call(this,t),this.spriteIndex=29,this.background=void 0,this.foreground=$.BrightWhite}function W(t){o.call(this,t),this.spriteIndex=18,this.background=void 0,this.foreground=$.BrightWhite}function U(t){r.call(this,t),this.spriteIndex=235,this.background=void 0,this.foreground=$.Green,this.conveyable=!0,this.speed=3}function H(t){o.call(this,t),this.spriteIndex=219}function G(t){r.call(this,t),this.spriteIndex=15,this.foreground=$.BrightRed,this.background=void 0,this.intelligence=5,this.speed=1}function V(t){o.call(this,t),this.spriteIndex=void 0,this.foreground=$.Grey,this.background=void 0}function j(t){r.call(this,t),this.intelligence=5,this.firingRate=5,this.spriteIndex=24,this.animationIndex=Math.floor(Math.random()*j.animationFrames.length-1),this.speed=2}function _(t){r.call(this,t),this.orientation=it.East,this.animationFrame=2,this.speed=3}function q(t){o.call(this,t),this.i18n={en:0},this.foreground=$.BrightWhite,this.background=$.Blue}function K(t){r.call(this,t),this.speed=1,this.spriteIndex=179,this.animationIndex=Math.floor(Math.random()*K.animationFrames.length-1),this.foreground=$.Cycle,this.timeToLive=255,this.nextMove=Math.floor(2*Math.random())}function Y(t){r.call(this,t),this.spriteIndex=227,this.foreground=$.BrightCyan,this.background=void 0,this.intelligence=5,this.firingRate=5,this.speed=2,this.conveyable=!0}function Z(t){o.call(this,t),this.spriteIndex=157,this.glow=!0}function X(t){o.call(this,t),this.spriteIndex=178}function J(t){o.call(this,t),this.spriteIndex=176,this.background=$.BrightWhite,this.foreground=$.BrightBlue}var Q=t("./basic").Point,$=t("./graphics").Colors,tt=t("./graphics").ColorUtilities,et=t("./basic").utilities,it=t("./basic").Direction,st=t("./game-state").GameState,ot=t("./jzt-script-context").JztScriptContext,rt=t("./basic").DelayedEventScheduler,nt=t("./i18n"),at={},ht=0,ct=1,dt=6e4,pt=4;i.things={},o.prototype.serialize=function(){var t={};return t.type=this.constructor.type,t.color=tt.serialize(this.background,this.foreground),this.under&&(t.under=this.under.serialize()),t},o.prototype.deserialize=function(t){t.color?(this.foreground=tt.deserializeForeground(t.color),this.background=tt.deserializeBackground(t.color)):(this.foreground||(this.foreground=$.Yellow),this.background=void 0),t.under&&(this.under=at.deserialize(t.under,this.board))},o.prototype.play=function(t,e,i){i&&this.board.game.resources.audio.isPlaying()||this.board.game.resources.audio.play(t,e)},o.prototype.adjustCounter=function(t,e){this.board.game.adjustCounter(t,e)},o.prototype.setCounterValue=function(t,e){this.board.game.setCounterValue(t,e)},o.prototype.getCounterValue=function(t){return this.board.game.getCounterValue(t)},o.prototype.sendMessage=function(){},o.prototype.push=function(){},o.prototype.isSurrenderable=function(){return!1},o.prototype.isBlocked=function(t){var e,i=this.point.add(t);return!this.board.isFree(i)&&(!!this.board.isOutside(i)||(e=this.board.getTile(i),e?!e.isSurrenderable(this):void 0))},o.prototype.isPlayerVisible=function(t){function e(t){var e=s.board.getTile(t);return e&&e!==s&&"Player"!==e.type}var i=et.generateLineData(this.point,this.board.player.point),s=this,o=this.point,r=!0;return!(i.points.length>t)&&(i.forEach(function(t){o.x!==t.x&&o.y!==t.y&&(e(new Q(o.x,t.y))||e(new Q(t.x,o.y)))&&(r=!1),e(t)&&(r=!1),o=t}),r)},o.prototype.isPlayerAdjacent=function(t){function e(t){var e=i.board.getTile(i.point.add(t));e&&"Player"===e.type&&(s=!0)}var i=this,s=!1;return t?e(t):it.each(e),s},o.prototype.isPlayerAligned=function(t,e){return this.point.aligned(this.board.player.point,t,e)},o.prototype.move=function(t,e){return this.board.moveTile(this.point,this.point.add(t),e)},o.prototype.remove=function(){this.removed=!0,this.board.deleteTile(this.point)},o.prototype.getSpriteIndex=function(){return this.spriteIndex},o.prototype.getAdjacentThing=function(t){return this.board.getTile(this.point.add(t))},o.prototype.equals=function(t){var e=t.type.toUpperCase(),i=t.color?tt.deserializeForeground(t.color):void 0;return this.constructor.type.toUpperCase()===e&&(void 0===i||i===this.foreground)},o.prototype.oneTimeMessage=function(t){this.board.game.oneTimeMessage(t)},o.prototype.clone=function(){var t=this.serialize();return at.deserialize(t,this.board)},r.prototype=new o,r.prototype.serialize=function(){var t=o.prototype.serialize.call(this)||{};return t.speed=this.speed,t},r.prototype.deserialize=function(t){o.prototype.deserialize.call(this,t),t.speed&&(this.speed=t.speed),this.cycleCount=Math.floor(Math.random()*this.speed)},r.prototype.getPlayerDirection=function(t){return this.point.directionTo(this.board.player.point,t)},r.prototype.getSmartDirection=function(){return this.board.getSmartDirection(this.point)},r.prototype.influenceSmartPath=function(){},r.prototype.isAttackable=function(t){return!this.isBlocked(t)||this.isPlayerAdjacent(t)},r.prototype.getAttackableDirections=function(){var t=[],e=this;return it.each(function(i){e.isAttackable(i)&&t.push(i)}),t},r.prototype.getFreeDirections=function(){var t=[],e=this;return it.each(function(i){e.isBlocked(i)||t.push(i)}),t},r.prototype.getBlockedDirections=function(){var t=[],e=this;return it.each(function(i){e.isBlocked(i)&&t.push(i)}),t},r.prototype.update=function(){if(!this.removed){if(this.board.game.state===st.GameOver)return void this.doTick();this.cycleCount+=1,this.cycleCount>=this.speed*this.board.game.CYCLE_RATE&&(this.cycleCount=0,this.doTick())}},r.prototype.updateOnReverse=function(){return!1},r.prototype.doTick=function(){},n.prototype=new r,n.prototype.constructor=n,n.prototype.serialize=function(){var t=r.prototype.serialize.call(this)||{};return t.name=this.name,t.spriteIndex=this.spriteIndex,t.script=this.scriptName,et.storeOption(t,"pushable",this.pushable,!1),this.torchRadius>0&&(t.torchRadius=this.torchRadius),this.scriptContext&&(this.scriptContext.inDefaultState()||(t.scriptContext=this.scriptContext.serialize()),this.messageQueue.length>0&&(t.messageQueue=this.messageQueue.slice(0)),et.storeOption(t,"walkDirection",it.getName(this.walkDirection)),et.storeOption(t,"locked",this.locked,!1),et.storeOption(t,"orientation",it.getName(this.orientation))),t},n.prototype.deserialize=function(t){r.prototype.deserialize.call(this,t),this.name=t.name||"UnknownScriptable",this.spriteIndex=void 0!==t.spriteIndex?t.spriteIndex:1,this.setTorchRadius(void 0!==t.torchRadius?t.torchRadius:0),this.pushable=void 0!==t.pushable&&t.pushable,this.locked=t.locked,t.walkDirection&&(this.walkDirection=it.fromName(t.walkDirection)),t.orientation&&(this.orientation=it.fromName(t.orientation)),this.scriptName=t.script;var e=this.board.getScript(this.scriptName);e&&(this.scriptContext=new ot(e,this),t.scriptContext&&this.scriptContext.deserialize(t.scriptContext),Array.isArray(t.messageQueue)&&t.messageQueue.length>0&&(this.messageQueue=t.messageQueue.slice(0)))},n.prototype.sendMessage=function(t){this.locked||this.messageQueue[this.messageQueue.length-1]!==t&&this.messageQueue.push(t);
},n.prototype.move=function(t){return this.orientation=t,r.prototype.move.call(this,t)},n.prototype.push=function(t){this.pushable&&this.move(t)},n.prototype.walk=function(){this.walkDirection&&(this.move(this.walkDirection)||this.sendMessage("THUD"))},n.prototype.doTick=function(){this.walk(),this.scriptContext&&this.scriptContext.executeTick()},n.prototype.setTorchRadius=function(t){this.torchRadius=t},n.prototype.getTorch=function(){if(this.torchRadius>0)return et.generateCircleData(this.point,this.torchRadius)},a.prototype=new r,a.prototype.constructor=a,a.prototype.serialize=function(){var t=r.prototype.serialize.call(this);return t.timeToLive=this.timeToLive,t.radius=this.radius,t},a.prototype.deserialize=function(t){r.prototype.deserialize.call(this,t),this.timeToLive=t.timeToLive||9,this.radius=t.radius||4},a.prototype.push=function(t){this.move(t)},a.prototype.getSpriteIndex=function(){return 57-(9-this.timeToLive)},a.prototype.doTick=function(){var t;this.play(this.timeToLive%2?"8":"5"),this.timeToLive-=1,this.timeToLive<0&&(t=new i.things.Explosion(this.board),t.radius=this.radius,this.board.replaceTile(this.point,t))},h.prototype=new o,h.prototype.constructor=h,h.prototype.serialize=function(){var t=o.prototype.serialize.call(this);return delete t.color,t},h.prototype.deserialize=function(t){o.prototype.deserialize.call(this,t),this.background=void 0,this.foreground=$.Cyan},h.prototype.push=function(t){this.move(t)},h.prototype.sendMessage=function(t){"TOUCH"===t&&(this.oneTimeMessage("status.ammo"),this.play("tcc#d"),this.adjustCounter("AMMO",5),this.remove())},c.prototype=new r,c.prototype.constructor=c,c.prototype.serialize=function(){var t=r.prototype.serialize.call(this);return delete t.color,t.sensitivity=this.sensitivity,t},c.prototype.deserialize=function(t){r.prototype.deserialize.call(this,t),this.background=void 0,this.foreground=$.Brown,this.sensitivity=t.sensitivity||9},c.prototype.push=function(t,e){e&&"River"===e.type?this.move(t,!0):this.move(t)||(this.play("t+c---c++++c--c"),this.remove())},c.prototype.sendMessage=function(t){"SHOT"===t||"BOMBED"===t?(this.play("t+c---c++++c--c",!0),this.adjustCounter("SCORE",10),this.remove()):"TOUCH"===t&&(this.board.player.sendMessage("SHOT"),this.remove())},c.prototype.doTick=function(){var t,e;if(this.isPlayerAligned(10-this.sensitivity)){if(e=this.getPlayerDirection("x"),void 0===e&&(e=this.getPlayerDirection("y")),t=this.board.getTile(this.point.add(e)),t&&("BreakableWall"===t.type||"Player"===t.type))return t.sendMessage("SHOT"),void this.remove();if(t&&"River"===t.type&&t.direction===it.opposite(e))return;this.move(e,!0)}},d.prototype=new r,d.prototype.constructor=d,d.prototype.serialize=function(){var t=r.prototype.serialize.call(this);return t.period=this.period,t.delay=this.delay,t.direction=it.getShortName(this.direction),t},d.prototype.deserialize=function(t){r.prototype.deserialize.call(this,t),this.cycleCount=0,this.period=t.period||3,this.delay=t.delay||0,this.currentTick=this.period-this.delay-1,this.direction=t.direction?it.fromName(t.direction):it.North},d.prototype.doTick=function(){this.currentTick+=1,this.currentTick>=this.period&&(this.currentTick=0,this.blinkState=!this.blinkState,this.blink())},d.prototype.blink=function(){for(var t,e,i=this.point;;){if(i=i.add(this.direction),this.board.isOutside(i))break;if(t=this.board.getTile(i))if(this.blinkState||"BlinkWall"!==t.type){if("Player"!==t.type)break;if(t.sendMessage("SHOT"),t.isBlocked(it.clockwise(this.direction))?t.isBlocked(it.counterClockwise(this.direction))||(e=t.move(it.counterClockwise(this.direction))):e=t.move(it.clockwise(this.direction)),!e)break}else t.remove();this.blinkState&&this.board.addThing(i,this.createBlinkWall())}},d.prototype.createBlinkWall=function(){var t=new i.things.BlinkWall(this.board);return t.horizontal=this.direction!==it.North&&this.direction!==it.South,t.foreground=this.foreground,t},p.prototype=new o,p.prototype.constructor=p,p.prototype.serialize=function(){var t=o.prototype.serialize.call(this);return this.horizontal&&(t.horizontal=this.horizontal),t},p.prototype.deserialize=function(t){o.prototype.deserialize.call(this,t),this.horizontal=void 0!==t.horizontal&&t.horizontal},p.prototype.getSpriteIndex=function(){return this.horizontal?205:186},u.prototype=new o,u.prototype.constructor=u,u.prototype.deserialize=function(t){o.prototype.deserialize.call(this,t),this.radius=t.radius||4},u.prototype.serialize=function(){var t=o.prototype.serialize.call(this);return t.radius=this.radius,t},u.prototype.push=function(t){this.move(t)},u.prototype.sendMessage=function(t){var e;"TOUCH"===t&&(this.play("tcf+cf+c"),e=new a(this.board),e.radius=this.radius,e.foreground=this.foreground,e.background=this.background,this.board.replaceTile(this.point,e))},l.prototype=new o,l.prototype.constructor=l,l.prototype.push=function(t,e){e&&"River"===e.type?this.move(t,!0):this.move(t)&&this.play("t--f",!1,!0)},f.prototype=new o,f.prototype.constructor=f,f.prototype.sendMessage=function(t){"SHOT"===t||"BOMBED"===t?(this.play("t-c"),this.remove()):"TOUCH"===t&&this.oneTimeMessage("status.breakable")},g.prototype=new r,g.prototype.constructor=g,g.prototype.serialize=function(){var t=r.prototype.serialize.call(this)||{};return delete t.color,t.direction=it.getShortName(this.direction),this.fromPlayer&&(t.fromPlayer=!0),t},g.prototype.deserialize=function(t){r.prototype.deserialize.call(this,t),this.background=void 0,this.foreground=$.BrightWhite,this.direction=it.fromName(t.direction),t.fromPlayer&&(this.fromPlayer=t.fromPlayer)},g.prototype.sendMessage=function(t){"TOUCH"===t&&(this.board.player.sendMessage("SHOT"),this.remove())},g.prototype.updateOnReverse=function(){return this.direction===it.South||this.direction===it.East},g.prototype.influenceSmartPath=function(){var t,e;if(this.fromPlayer)for(t=this.point,e=0;e<10;e+=1)t=t.add(this.direction),this.board.adjustSmartPathWeight(t,100-10*e)},g.prototype.doTick=function(){this.move(this.direction,!0)||(this.attack(),this.react())},g.prototype.attack=function(){var t=this.board.getTile(this.point.add(this.direction));t&&(this.fromPlayer||"Player"===t.type||"Scriptable"===t.type||"BreakableWall"===t.type)&&t.sendMessage("SHOT")},g.prototype.react=function(){var t=this.getAdjacentThing(this.direction);if(t&&"Player"!==t.type){if("Ricochet"===t.type)return void this.ricochet(it.opposite(this.direction));if(t=this.getAdjacentThing(it.clockwise(this.direction)),t&&"Ricochet"===t.type)return void this.ricochet(it.counterClockwise(this.direction));if(t=this.getAdjacentThing(it.counterClockwise(this.direction)),t&&"Ricochet"===t.type)return void this.ricochet(it.clockwise(this.direction))}this.remove()},g.prototype.ricochet=function(t){this.direction=t,this.move(t,!0)?this.play("9",!1,!0):(this.attack(),this.remove())},g.prototype.push=function(){this.remove()},y.prototype=new r,y.prototype.constructor=y,y.prototype.serialize=function(){var t=r.prototype.serialize.call(this);return t.head=this.head,t.deviance=this.deviance,t.intelligence=this.intelligence,this.orientation&&(t.orientation=it.getShortName(this.orientation)),this.follower&&(t.nextSegment=it.getShortName(this.point.directionTo(this.follower.point))),t},y.prototype.deserialize=function(t){r.prototype.deserialize.call(this,t),this.head=t.head,this.intelligence=t.intelligence,this.deviance=t.deviance,t.orientation&&(this.orientation=it.fromName(t.orientation)),t.nextSegment&&(this.nextSegment=it.fromName(t.nextSegment)),this.deviance>10&&(this.deviance=10),this.intelligence>10&&(this.intelligence=10),this.head&&(this.spriteIndex=233),this.cycleCount=0},y.prototype.getAdjacentSegment=function(){function t(t){return t&&"Centipede"===t.type&&!t.linked&&!t.nextSegment&&!t.head}var e;return this.nextSegment&&(e=this.board.getTile(this.point.add(this.nextSegment)),delete this.nextSegment,e&&"Centipede"===e.type&&!e.head)?e:(e=this.board.getTile(this.point.add(it.North)),t(e)?e:(e=this.board.getTile(this.point.add(it.East)),t(e)?e:(e=this.board.getTile(this.point.add(it.South)),t(e)?e:(e=this.board.getTile(this.point.add(it.West)),t(e)?e:void 0))))},y.prototype.linkSegments=function(t){this.linked=!0,this.leader=t,this.leader&&(this.deviance=t.deviance,this.intelligence=t.intelligence,this.cycleCount=t.cycleCount,this.speed=t.speed),this.follower=this.getAdjacentSegment(),this.follower&&(this.head&&(this.orientation=this.follower.point.directionTo(this.point)),this.follower.linkSegments(this))},y.prototype.reverse=function(){var t=this.follower,e=this.leader;this.head&&(this.head=!1,this.spriteIndex=79),this.leader=this.follower,this.follower=e,t?t.reverse():this.becomeHead()},y.prototype.becomeHead=function(){this.head=!0,this.spriteIndex=233,this.cycleCount=Math.floor(Math.random()*this.speed)},y.prototype.move=function(t){var e=this.point.clone();return this.head&&this.isPlayerAdjacent(t)?(this.board.player.sendMessage("SHOT"),void this.remove()):(this.board.moveTile(this.point,this.point.add(t),!0),void(this.follower&&(t=this.follower.point.directionTo(e),this.follower.move(t))))},y.prototype.push=function(){this.play("t+c---c++++c--c"),this.remove()},y.prototype.remove=function(){this.leader&&(this.leader.follower=void 0),this.follower&&(this.follower.leader=void 0),r.prototype.remove.call(this)},y.prototype.sendMessage=function(t){"SHOT"!==t&&"BOMBED"!==t||(this.play("t+c---c++++c--c",!0),this.adjustCounter("SCORE",10),this.remove()),"TOUCH"===t&&(this.board.player.sendMessage("SHOT"),this.remove())},y.prototype.deviate=function(){if(this.deviance<=0)return!1;var t=Math.floor(20*Math.random());return t<=this.deviance},y.prototype.seekPlayer=function(){if(this.intelligence<=0)return!1;if(this.isPlayerAligned()){var t=Math.floor(10*Math.random());return t<=this.intelligence}return!1},y.prototype.doTick=function(){var t,e;this.firstTick?this.firstTick=!1:this.head||void 0!==this.leader||this.becomeHead(),this.head&&(this.linked||this.linkSegments(),this.seekPlayer()&&(this.orientation=this.getPlayerDirection()),this.orientation&&this.isAttackable(this.orientation)&&!this.deviate()?this.move(this.orientation):(e=this.getAttackableDirections(),e.length>0?(t=it.random(e),this.orientation=t,this.move(t)):this.reverse()))},m.prototype=new r,m.prototype.constructor=m,m.animationFrames=[179,47,45,92],m.MoveAction={MOVE:1,TENTATIVE:2},m.prototype.serialize=function(){var t=r.prototype.serialize.call(this);return t.clockwise=this.clockwise,t},m.prototype.deserialize=function(t){r.prototype.deserialize.call(this,t),this.clockwise=t.clockwise},m.prototype.markPath=function(t){var e,i,s,o=m.MoveAction;for(e=t.length-1;e>=0;e-=1)i=this.board.getTile(t[e]),i&&i.conveyable&&(e===t.length-1?t[e].action=o.TENTATIVE:this.board.isOutside(t[e+1])||(s=this.board.getTile(t[e+1]),!s||!s.conveyable&&s.surrenderable?t[e].action=o.MOVE:t[e].action=t[e+1].action));if(this.board.isFreeOrSurrenderable(t[0])||t[0].action===o.MOVE||t[0].action===o.TENTATIVE)for(e=0;e<t.length;e+=1)t[e].action===o.TENTATIVE&&(t[e].action=o.MOVE)},m.prototype.executePath=function(t){var e,i,s;for(e=t.length-1;e>=0;e-=1)t[e].action===m.MoveAction.MOVE&&(s=this.board.getTile(t[e]),this.board.deleteTile(t[e]),e===t.length-1?i=s:this.board.addThing(t[e+1],s));i&&this.board.addThing(t[0],i)},m.prototype.doTick=function(){var t;this.clockwise?(this.animationIndex+=1,this.animationIndex>=m.animationFrames.length&&(this.animationIndex=0),t=[new Q(this.point.x-1,this.point.y-1),new Q(this.point.x,this.point.y-1),new Q(this.point.x+1,this.point.y-1),new Q(this.point.x+1,this.point.y),new Q(this.point.x+1,this.point.y+1),new Q(this.point.x,this.point.y+1),new Q(this.point.x-1,this.point.y+1),new Q(this.point.x-1,this.point.y)]):(this.animationIndex-=1,this.animationIndex<0&&(this.animationIndex=m.animationFrames.length-1),t=[new Q(this.point.x-1,this.point.y-1),new Q(this.point.x-1,this.point.y),new Q(this.point.x-1,this.point.y+1),new Q(this.point.x,this.point.y+1),new Q(this.point.x+1,this.point.y+1),new Q(this.point.x+1,this.point.y),new Q(this.point.x+1,this.point.y-1),new Q(this.point.x,this.point.y-1)]),this.markPath(t),this.executePath(t),this.spriteIndex=m.animationFrames[this.animationIndex]},v.prototype=new o,v.prototype.constructor=v,v.prototype.deserialize=function(t){o.prototype.deserialize.call(this,t),this.foreground=$.BrightWhite,this.background?(this.background.isLight()&&(this.background=this.background.darken()),this.background===$.Black&&(this.background=$.White)):this.background=$.Blue},v.prototype.sendMessage=function(t){var e,i;"TOUCH"===t&&(e=nt.getMessage("doors."+this.background.code),i="KEY"+this.background.lighten().code,this.getCounterValue(i)>0?(this.remove(),this.adjustCounter(i,-1),this.board.setDisplayMessage(nt.getMessage("doors.open",e)),this.play("tcgbcgb+ic")):(this.board.setDisplayMessage(nt.getMessage("doors.locked",e)),this.play("t--gc")))},w.prototype=new r,w.prototype.constructor=w,w.animationFrames=[250,249,7,9,111,79],w.prototype.serialize=function(){var t=r.prototype.serialize.call(this);return delete t.color,t.copyDirection=it.getShortName(this.copyDirection),t},w.prototype.deserialize=function(t){r.prototype.deserialize.call(this,t),this.background=void 0,this.foreground=$.BrightWhite,t.copyDirection&&(this.copyDirection=it.fromName(t.copyDirection))},w.prototype.doTick=function(){var t,e,i,s,o,r=!1;this.currentStep+=1,this.currentStep>=this.MAX_STEPS&&(this.currentStep=0,s=this.point.add(this.copyDirection),t=this.board.getTile(s),o=this.point.add(it.opposite(this.copyDirection)),this.board.isOutside(o)?t=void 0:e=this.board.getTile(o),t&&(i=!e||this.board.moveTile(this.point,o,!1,!0),i&&(r=!0,this.board.addThing(o,t.clone(),!0))),this.play(r?"scdefg":"--g#f#")),this.spriteIndex=w.animationFrames[Math.round(this.currentStep/this.MAX_STEPS*(w.animationFrames.length-1))]},b.prototype=new r,b.prototype.constructor=b,b.MAX_TTL=5,b.prototype.deserialize=function(t){r.prototype.deserialize.call(this,t),this.radius=t.radius||4,this.timeToLive=t.timeToLive||b.MAX_TTL},b.prototype.serialize=function(){var t=r.prototype.serialize(this);return t.radius=this.radius,t.timeToLive=this.timeToLive,t},b.prototype.doTick=function(){var t,e,i;if(this.timeToLive===b.MAX_TTL)for(this.play("t+++c-c-c-c-c-c",!0),t=et.pointsInCircle(this.point,this.radius),e=0;e<t.length;e+=1)i=this.board.getTile(t[e]),i&&i.sendMessage("BOMBED");this.timeToLive-=1,this.timeToLive<=0&&this.remove()},b.prototype.getTorch=function(){return et.generateCircleData(this.point,Math.round(this.radius*this.timeToLive/(b.MAX_TTL-1))+2)},b.prototype.render=function(t){var e,i,s,o=this.board.game.resources.graphics.getSprite(176+Math.round(2*this.timeToLive/b.MAX_TTL));for(s=this.timeToLive===b.MAX_TTL?Math.round(this.radius/2):Math.round(this.radius*this.timeToLive/(b.MAX_TTL-1)),e=et.pointsInCircle(this.point,s),i=0;i<e.length;i+=1)o.draw(t,e[i].subtract(this.board.windowOrigin),$.Yellow,$.Red)},x.prototype=new o,x.prototype.constructor=x,x.prototype.isSurrenderable=function(){return!0},x.prototype.getSpriteIndex=function(){return this.board.game.isEditor?176:178},S.prototype=new o,S.noteCycle=["e","-b","f#","b","f","c","g","+c"],S.noteIndex=0,S.prototype.constructor=S,S.prototype.serialize=function(){var t=o.prototype.serialize.call(this);return delete t.color,t},S.prototype.deserialize=function(t){o.prototype.deserialize.call(this,t),this.background=$.Green,this.foreground=$.Black},S.prototype.sendMessage=function(t){"TOUCH"===t&&(this.oneTimeMessage("status.forest"),this.play(S.noteCycle[S.noteIndex]),S.noteIndex+=1,S.noteIndex>=S.noteCycle.length&&(S.noteIndex=0),this.board.deleteTile(this.point))},T.prototype=new o,T.prototype.constructor=T,T.prototype.sendMessage=function(t){"TOUCH"===t?(this.oneTimeMessage("status.gem"),this.remove(),this.adjustCounter("HEALTH",1),this.adjustCounter("GEMS",1),this.adjustCounter("SCORE",10),this.play("t+c-gec")):"SHOT"!==t&&"BOMBED"!==t||(this.remove(),this.play("t-c"))},T.prototype.push=function(t,e){e&&"River"===e.type?this.move(t,!0):this.move(t)||this.remove()},E.restrictions=["Scriptable","Lion","Tiger","Bear","Ruffian","Centipede","Spider","Snake"],E.prototype=new o,E.prototype.constructor=E,E.prototype.isSurrenderable=function(t){if(t&&E.restrictions.indexOf(t.type)<0)return!0},E.prototype.getSpriteIndex=function(){return this.board.game.isEditor?176:0},k.prototype=new o,k.prototype.constructor=k,k.prototype.serialize=function(){var t=o.prototype.serialize.call(this);return delete t.color,t},k.prototype.deserialize=function(t){o.prototype.deserialize.call(this,t),this.foreground=$.BrightRed,this.background=void 0},k.prototype.sendMessage=function(t){"TOUCH"===t&&(this.remove(),this.play("tcefg+ceg"),this.adjustCounter("HEALTH_MAX",10),this.adjustCounter("HEALTH",10),this.adjustCounter("SCORE",500),this.board.setDisplayMessage(nt.getMessage("status.heart")))},k.prototype.push=function(t,e){e&&"River"===e.type?this.move(t,!0):this.move(t)},C.prototype=new o,C.prototype.constructor=C,C.prototype.sendMessage=function(t){var e,s=i.things.Wall;"TOUCH"===t&&(e=new s,e.foreground=this.foreground,e.background=this.background,this.oneTimeMessage("status.invisible"),this.board.replaceTile(this.point,e),this.play("t--dc"))},C.prototype.getSpriteIndex=function(){return this.board.game.isEditor?176:0},P.prototype=new o,P.prototype.constructor=P,P.prototype.deserialize=function(t){o.prototype.deserialize.call(this,t),this.foreground=this.foreground.lighten(),(this.foreground.cycles||this.foreground===$.Grey)&&(this.foreground=$.BrightWhite),this.background=void 0},P.prototype.sendMessage=function(t){var e;"TOUCH"===t&&(e=nt.getMessage("keys."+this.foreground.code),this.getCounterValue("KEY"+this.foreground.code)>0?(this.board.setDisplayMessage(nt.getMessage("keys.toomany",e)),this.play("sc-c")):(this.remove(),this.adjustCounter("KEY"+this.foreground.code,1),this.board.setDisplayMessage(nt.getMessage("keys.collect",e)),this.play("t+cegcegceg+sc")))},P.prototype.push=function(t,e){e&&"Player"===e.type||(e&&"River"===e.type?this.move(t,!0):this.move(t)&&this.play("t--f",!1,!0))},M.prototype=new o,M.prototype.constructor=M,M.prototype.serialize=function(){var t=o.prototype.serialize.call(this);return delete t.color,t},M.prototype.deserialize=function(t){o.prototype.deserialize.call(this,t),this.background=$.BrightRed,this.foreground=$.BrightRed},M.prototype.updateWhileUnder=function(){var t=this.board.getTile(this.point);t&&("Player"===t.type?(this.cycleCount+=1,this.cycleCount>this.cycleRate&&(this.cycleCount=0,t.sendMessage("SHOT"))):"Scriptable"===t.type?t.sendMessage("LAVA"):t.lavaWalker||t.sendMessage("SHOT"))},M.prototype.sendMessage=function(t){"TOUCH"===t&&(this.cycleCount=0,this.board.player.sendMessage("SHOT"))},M.prototype.isSurrenderable=function(){return!0},I.prototype=new o,I.prototype.constructor=I,I.lineMap={"":249,N:208,E:198,S:210,W:181,NE:200,NS:186,NW:188,ES:201,EW:205,SW:187,NES:204,NEW:202,NSW:185,ESW:203,NESW:206},I.prototype.getSpriteIndex=function(){function t(t,e){var i=t.board.getTile(t.point.add(e));return i&&"LineWall"===i.type}if(void 0!==this.spriteIndex&&!this.board.game.isEditor)return this.spriteIndex;var e="";return e+=t(this,it.North)?"N":"",e+=t(this,it.East)?"E":"",e+=t(this,it.South)?"S":"",e+=t(this,it.West)?"W":"",this.spriteIndex=I.lineMap[e],this.spriteIndex},O.prototype=new r,O.prototype.constructor=O,O.prototype.serialize=function(){var t=r.prototype.serialize.call(this);return delete t.color,t.intelligence=this.intelligence,t},O.prototype.deserialize=function(t){r.prototype.deserialize.call(this,t),this.background=void 0,this.foreground=$.BrightRed,this.intelligence=t.intelligence},O.prototype.sendMessage=function(t){"SHOT"===t||"BOMBED"===t?(this.play("t+c---c++++c--c",!0),this.adjustCounter("SCORE",10),this.remove()):"TOUCH"===t&&(this.board.player.sendMessage("SHOT"),this.remove())},O.prototype.push=function(t,e){e&&"River"===e.type?this.move(t,!0):this.move(t)||(this.play("t+c---c++++c--c"),this.remove())},O.prototype.seekPlayer=function(){var t=Math.floor(10*Math.random());return t<=this.intelligence},O.prototype.doTick=function(){var t=this.seekPlayer()?this.getPlayerDirection():it.random(),e=this.board.getTile(this.point.add(t));return e&&"Player"===e.type?(e.sendMessage("SHOT"),void this.remove()):void(e&&"River"===e.type&&e.direction===it.opposite(t)||this.move(t,!0))},B.prototype=new o,B.prototype.constructor=B,B.prototype.sendMessage=function(t){"TOUCH"===t&&(this.play("tceg tc#fg# tdf#a td#ga# teg#+c"),this.board.game.movePlayerToPassage(this.passageId,this.targetBoard))},B.prototype.serialize=function(){var t=o.prototype.serialize.call(this);return t.passageId=this.passageId,t.targetBoard=this.targetBoard,t},B.prototype.deserialize=function(t){o.prototype.deserialize.call(this,t),this.foreground=$.BrightWhite,this.background||(this.background=$.Blue),this.targetBoard=t.targetBoard,this.passageId=t.passageId},A.prototype=new r,A.prototype.constructor=A,A.prototype.serialize=function(){return this.under?this.under.serialize():0},A.prototype.push=function(t){this.move(t)},A.prototype.move=function(t){var e,i=this.point.clone(),s=this.point.add(t);return this.board.isOutside(s)?(t=this.point.directionTo(s),this.board.movePlayerOffBoard(t),!1):(e=this.board.getTile(s),e&&e.sendMessage("TOUCH"),!!this.point.equals(i)&&this.board.moveTile(this.point,s))},A.prototype.shoot=function(t){return this.board.canPlayerShoot(!0)<=0?void this.play("02"):void(this.getCounterValue("AMMO")>0?(this.adjustCounter("AMMO",-1),at.shoot(this.board,this.point.add(t),t,!0)):this.board.setDisplayMessage(nt.getMessage("status.noammo")))},A.prototype.doTick=function(){var t=this.eventScheduler.takeEvent();t&&(t.type===ht?this.move(t.direction):t.type===ct&&this.shoot(t.direction))},A.prototype.update=function(){var t=this.game.keyboard,e=t.getMostRecentPress([t.UP,t.RIGHT,t.DOWN,t.LEFT]);t.isPressed(t.SHIFT)||t.isPressed(t.SPACE)?e===t.UP?this.eventScheduler.scheduleEvent(t.isPressed(t.UP),{type:ct,direction:it.North}):e===t.RIGHT?this.eventScheduler.scheduleEvent(t.isPressed(t.RIGHT),{type:ct,direction:it.East}):e===t.DOWN?this.eventScheduler.scheduleEvent(t.isPressed(t.DOWN),{type:ct,direction:it.South}):e===t.LEFT?this.eventScheduler.scheduleEvent(t.isPressed(t.LEFT),{type:ct,direction:it.West}):this.eventScheduler.cancelEvent():(e===t.UP?this.eventScheduler.scheduleEvent(t.isPressed(t.UP),{type:ht,direction:it.North}):e===t.RIGHT?this.eventScheduler.scheduleEvent(t.isPressed(t.RIGHT),{type:ht,direction:it.East}):e===t.DOWN?this.eventScheduler.scheduleEvent(t.isPressed(t.DOWN),{type:ht,direction:it.South}):e===t.LEFT?this.eventScheduler.scheduleEvent(t.isPressed(t.LEFT),{type:ht,direction:it.West}):this.eventScheduler.cancelEvent(),t.isPressed([t.T])&&this.useTorch()),r.prototype.update.call(this),this.board.initializeTorch(this)},A.prototype.useTorch=function(){if(!(this.game.getCounterValue("TORCHLIFE")>1e4))if(this.game.getCounterValue("TORCHES")>0){if(!this.board.dark)return void this.board.setDisplayMessage(nt.getMessage("status.notdark"));this.game.adjustCounter("TORCHES",-1),this.game.setCounterValue("TORCHLIFE",dt)}else this.board.setDisplayMessage(nt.getMessage("status.notorches"))},A.prototype.getTorch=function(){var t=this.game.getCounterValue("TORCHLIFE"),e=pt;if(t>0)return t<2e4&&(e=Math.ceil(t*pt/(dt/3))),et.generateCircleData(this.point,e)},A.prototype.sendMessage=function(t){"SHOT"!==t&&"BOMBED"!==t||(this.play("t--c+c-c+d#",!0),this.adjustCounter("HEALTH",-10),this.board.playerHurt())},L.prototype=new r,L.prototype.constructor=L,L.prototype.initializeSprite=function(){this.orientation===it.North?this.spriteIndex=30:this.orientation===it.East?this.spriteIndex=16:this.orientation===it.South?this.spriteIndex=31:this.orientation===it.West&&(this.spriteIndex=17)},L.prototype.serialize=function(){var t=r.prototype.serialize.call(this);return t.orientation=it.getName(this.orientation),t},L.prototype.deserialize=function(t){r.prototype.deserialize.call(this,t),this.background=void 0,t.orientation&&(this.orientation=it.fromName(t.orientation)),this.initializeSprite()},L.prototype.doTick=function(){this.move(this.orientation)&&this.play("t--f",!1,!0)},R.prototype=new o,R.prototype.constructor=R,R.prototype.serialize=function(){var t=o.prototype.serialize.call(this);return delete t.color,t},R.prototype.deserialize=function(t){o.prototype.deserialize.call(this,t),this.background=void 0,this.foreground=$.BrightGreen},z.prototype=new o,z.prototype.constructor=z,z.prototype.initialize=function(){switch(it.getShortName(this.direction)){case"N":this.spriteIndex=30;break;case"E":this.spriteIndex=16;break;case"S":this.spriteIndex=31;break;case"W":this.spriteIndex=17}},z.prototype.updateWhileUnder=function(){r.prototype.update.call(this)},z.prototype.doTick=function(){var t=this.board.getTile(this.point);t.conveyable&&t.push(this.direction,this)},z.prototype.isSurrenderable=function(){return!0},z.prototype.serialize=function(){var t=r.prototype.serialize.call(this);return delete t.color,delete t.speed,t.direction=it.getShortName(this.direction),t},z.prototype.deserialize=function(t){r.prototype.deserialize.call(this,t),this.background=$.Blue,this.foreground=$.BrightBlue,t.direction&&(this.direction=it.fromName(t.direction)),this.initialize()},N.prototype=new r,N.prototype.constructor=N,N.prototype.serialize=function(){var t=r.prototype.serialize.call(this);return delete t.color,t.intelligence=this.intelligence,t.restingTime=this.restingTime,t},N.prototype.deserialize=function(t){r.prototype.deserialize.call(this,t),this.background=void 0,this.foreground=$.BrightMagenta,this.intelligence=t.intelligence||5,this.restingTime=t.restingTime||5},N.prototype.push=function(t,e){e&&"River"===e.type?this.move(t,!0):this.move(t)||(this.remove(),this.play("t+c---c++++c--c"))},N.prototype.sendMessage=function(t){"SHOT"===t||"BOMBED"===t?(this.play("t+c---c++++c--c",!0),this.adjustCounter("SCORE",10),this.remove()):"TOUCH"===t&&(this.board.player.sendMessage("SHOT"),this.remove())},N.prototype.seekPlayer=function(){var t=Math.floor(10*Math.random());return t<=this.intelligence},N.prototype.doTick=function(){if(this.timeLeft-=1,this.timeLeft<=0&&(this.moving=!this.moving,this.moving?(this.orientation=this.seekPlayer()?this.getPlayerDirection():it.random(),this.timeLeft=Math.floor(10*Math.random())):this.timeLeft=Math.floor(10*Math.random())-(10-this.restingTime)),this.moving){var t=this.board.getTile(this.point.add(this.orientation));if(t&&"Player"===t.type)return t.sendMessage("SHOT"),void this.remove();if(t&&"River"===t.type&&t.direction===it.opposite(this.orientation))return;this.move(this.orientation,!0)}},F.prototype=new o,F.prototype.constructor=F,F.prototype.serialize=function(){var t=o.prototype.serialize.call(this);return delete t.color,t.text=this.text,t},F.prototype.deserialize=function(t){o.prototype.deserialize.call(this,t),this.background=void 0,this.foreground=$.Brown,this.text=t.text},F.prototype.sendMessage=function(t){var e,i,s;if("TOUCH"===t){for(this.board.game.scroll.setTitle(nt.getMessage("obstacles.signpost")),this.board.game.scroll.clearLines(),this.text||(this.text=nt.getMessage("obstacles.signpostmessage")),e=this.text.split("\n"),i=0;i<e.length;i+=1)s=nt.getBoardMessage(this.board,e[i]),this.board.game.scroll.addLine(s);this.play("tc-c+d-d+e-e+f-f+g-g"),this.board.game.setState(st.Reading)}},D.prototype=new o,D.prototype.constructor=D,D.prototype.push=function(t){(t.equals(it.East)||t.equals(it.West))&&this.move(t)&&this.play("t--f",!1,!0)},W.prototype=new o,W.prototype.constructor=W,W.prototype.push=function(t){(t.equals(it.North)||t.equals(it.South))&&this.move(t)&&this.play("t--f",!1,!0)},U.prototype=new r,U.prototype.constructor=U,U.prototype.serialize=function(){var t=r.prototype.serialize.call(this);return delete t.color,t},U.prototype.push=function(t,e){e&&"River"===e.type?this.move(t,!0):this.move(t)||(this.play("t+c---c++++c--c"),this.remove())},U.prototype.sendMessage=function(t){"SHOT"===t||"BOMBED"===t?(this.play("t+c---c++++c--c",!0),this.adjustCounter("SCORE",10),this.remove()):"TOUCH"===t&&(this.board.player.sendMessage("SHOT"),this.remove())},U.prototype.doTick=function(){var t,e=this.getSmartDirection();if(e){if(this.foreground=$.BrightGreen,t=this.board.getTile(this.point.add(e)),t&&"Player"===t.type)return t.sendMessage("SHOT"),void this.remove();this.move(e,!0)}else this.foreground=$.Green},H.prototype=new o,H.prototype.constructor=H,G.prototype=new r,G.prototype.constructor=G,G.prototype.serialize=function(){var t=r.prototype.serialize.call(this);return t.intelligence=this.intelligence,t},G.prototype.deserialize=function(t){r.prototype.deserialize.call(this,t),this.intelligence=t.intelligence},G.prototype.seekPlayer=function(){var t=Math.floor(10*Math.random());return t<=this.intelligence},G.prototype.isAttackable=function(t){var e=this.board.getTile(this.point.add(t));return e&&("SpiderWeb"===e.type||"Player"===e.type)},G.prototype.sendMessage=function(t){"SHOT"===t||"BOMBED"===t?(this.play("t+c---c++++c--c",!0),this.adjustCounter("SCORE",10),this.remove()):"TOUCH"===t&&(this.board.player.sendMessage("SHOT"),this.remove())},G.prototype.push=function(t){this.move(t)||(this.play("t+c---c++++c--c"),this.remove())},G.prototype.doTick=function(){var t,e=this.seekPlayer()?this.getPlayerDirection():it.random(this.getAttackableDirections());if(void 0!==e){if(t=this.board.getTile(this.point.add(e)),t&&"Player"===t.type)return t.sendMessage("SHOT"),void this.remove();t&&"SpiderWeb"===t.type&&this.move(e,!0)}},V.prototype=new o,V.prototype.constructor=V,V.lineMap={"":249,N:179,E:196,S:179,W:196,NE:192,NS:179,NW:217,ES:218,EW:196,SW:191,NES:195,NEW:193,NSW:180,ESW:194,NESW:197},V.prototype.getSpriteIndex=function(){function t(t,e){var i=t.board.getTile(t.point.add(e));return i&&("SpiderWeb"===i.type||i.under&&"SpiderWeb"===i.under.type)}if(void 0!==this.spriteIndex&&!this.board.game.isEditor)return this.spriteIndex;var e="";return e+=t(this,it.North)?"N":"",e+=t(this,it.East)?"E":"",e+=t(this,it.South)?"S":"",e+=t(this,it.West)?"W":"",this.spriteIndex=V.lineMap[e],this.spriteIndex},V.prototype.isSurrenderable=function(){return!0},j.prototype=new r,j.prototype.constructor=j,j.animationFrames=[24,26,25,27],j.prototype.serialize=function(){var t=r.prototype.serialize.call(this);return t.intelligence=this.intelligence,t.firingRate=this.firingRate,t},j.prototype.deserialize=function(t){r.prototype.deserialize.call(this,t),this.intelligence=t.intelligence||5,this.firingRate=t.firingRate||5},j.prototype.doTick=function(){function t(t){if(Math.floor(10*Math.random())<=e.firingRate){var i=t?it.random():e.getPlayerDirection();at.shoot(e.board,e.point.add(i),i)}}var e=this;this.animationIndex+=1,this.animationIndex>=j.animationFrames.length&&(this.animationIndex=0),this.spriteIndex=j.animationFrames[this.animationIndex],Math.floor(9*Math.random())<=this.intelligence?this.isPlayerAligned(2)&&t():t(!0)},_.prototype=new r,_.prototype.constructor=_,_.animationFrames={North:[196,126,94,126],East:[179,41,62,41],South:[196,126,118,126],West:[179,40,60,40]},_.prototype.serialize=function(){var t=r.prototype.serialize.call(this);return t.orientation=it.getName(this.orientation),t},_.prototype.deserialize=function(t){r.prototype.deserialize.call(this,t),t.orientation&&(this.orientation=it.fromName(t.orientation))},_.prototype.doTick=function(){this.animationFrame+=1,this.animationFrame>=_.animationFrames[it.getName(this.orientation)].length&&(this.animationFrame=0)},_.prototype.getSpriteIndex=function(){return _.animationFrames[it.getName(this.orientation)][this.animationFrame]},_.prototype.push=function(t){if(this.orientation.equals(t)){var e,i=this.point.add(it.opposite(this.orientation)),s=this.point.add(this.orientation),o=this.board.getTile(s),r=(!o||"Teleporter"!==o.type)&&this.board.moveTile(i,s);if(r)return this.play("tc+d-e+f#-g#+a#c+d"),
!0;for(;!this.board.isOutside(s);){if(e=this.board.getTile(s),e&&"Teleporter"===e.type&&e.orientation===it.opposite(this.orientation)){if(this.board.moveTile(i,s.add(this.orientation)))return this.play("tc+d-e+f#-g#+a#c+d"),!0;break}s=s.add(this.orientation)}}},q.prototype=new o,q.prototype.constructor=q,q.prototype.serialize=function(){var t=o.prototype.serialize.call(this);return t.i18n=this.i18n,t},q.prototype.deserialize=function(t){o.prototype.deserialize.call(this,t),this.i18n=t.i18n||{en:0},this.foreground=$.BrightWhite},q.prototype.getSpriteIndex=function(){var t;return t=this.i18n.hasOwnProperty(nt.getLanguage())?this.i18n[nt.getLanguage()]:this.i18n[nt.DefaultLanguage],t||0},K.prototype=new r,K.prototype.constructor=K,K.animationFrames=[179,47,196,92],K.prototype.serialize=function(){var t=r.prototype.serialize.call(this);return delete t.color,t.timeToLive=this.timeToLive,t},K.prototype.deserialize=function(t){r.prototype.deserialize.call(this,t),this.foreground=$.Cycle,this.background=void 0,this.timeToLive=t.timeToLive||100},K.prototype.sendMessage=function(t){"TOUCH"===t&&(this.board.player.sendMessage("SHOT"),this.remove())},K.prototype.doTick=function(){var t,e;if(this.timeToLive-=1,this.timeToLive<=0)return void this.remove();if(this.animationIndex+=1,this.animationIndex>=K.animationFrames.length&&(this.animationIndex=0),this.spriteIndex=K.animationFrames[this.animationIndex],this.nextMove-=1,this.nextMove<=0){if(this.nextMove=2,t=this.getPlayerDirection(),e=this.board.getTile(this.point.add(t)),e&&("BreakableWall"===e.type||"Player"===e.type))return e.sendMessage("SHOT"),void this.remove();this.move(this.getPlayerDirection())}},Y.prototype=new r,Y.prototype.constructor=Y,Y.prototype.serialize=function(){var t=r.prototype.serialize.call(this);return delete t.color,t.intelligence=this.intelligence,t.firingRate=this.firingRate,t},Y.prototype.deserialize=function(t){r.prototype.deserialize(this,t),this.background=void 0,this.foreground=$.BrightCyan,this.intelligence=void 0===t.intelligence?5:t.intelligence,this.firingRate=void 0===t.firingRate?5:t.firingRate},Y.prototype.sendMessage=function(t){"SHOT"===t||"BOMBED"===t?(this.play("t+c---c++++c--c",!0),this.adjustCounter("SCORE",10),this.remove()):"TOUCH"===t&&(this.board.player.sendMessage("SHOT"),this.remove())},Y.prototype.push=function(t,e){e&&"River"===e.type?this.move(t,!0):this.move(t)||(this.play("t+c---c++++c--c"),this.remove())},Y.prototype.seekPlayer=function(){var t=Math.floor(10*Math.random());return t<=this.intelligence},Y.prototype.shootPlayer=function(){var t=Math.floor(20*Math.random());return t<=this.firingRate},Y.prototype.doTick=function(){var t,e=this.seekPlayer()?this.getPlayerDirection():it.random(),i=this.board.getTile(this.point.add(e));return i&&"Player"===i.type?(i.sendMessage("SHOT"),void this.remove()):(i&&"River"===i.type&&i.direction===it.opposite(e)||this.move(e,!0),void(this.shootPlayer()&&(t=this.getPlayerDirection(),at.shoot(this.board,this.point.add(t),t))))},Z.prototype=new o,Z.prototype.constructor=Z,Z.prototype.serialize=function(){var t=o.prototype.serialize.call(this);return delete t.color,t},Z.prototype.deserialize=function(t){o.prototype.deserialize.call(this,t),this.background=void 0,this.foreground=$.Brown},Z.prototype.push=function(t){this.move(t)},Z.prototype.sendMessage=function(t){"TOUCH"===t&&(this.oneTimeMessage("status.torch"),this.play("tcase"),this.adjustCounter("TORCHES",1),this.remove())},X.prototype=new o,X.prototype.constructor=X,J.prototype=new o,J.prototype.constructor=J,J.prototype.serialize=function(){var t=o.prototype.serialize.call(this);return delete t.color,t},J.prototype.deserialize=function(t){o.prototype.deserialize.call(this,t),this.background=$.BrightWhite,this.foreground=$.BrightBlue},J.prototype.isSurrenderable=function(t){if(t&&("Bullet"===t.type||"ThrowingStar"===t.type))return!0},J.prototype.sendMessage=function(t){"TOUCH"===t&&(this.play("t+c+c"),this.board.setDisplayMessage(nt.getMessage("obstacles.water"),1))},at.deserialize=function(t,e){var i,s,o;if(t&&t.type&&(i=at.getThingMap(),s=i[t.type.toUpperCase()]))return o=new s(e),o.deserialize(t),o},at.isKnownThing=function(t){var e=at.getThingMap();return void 0!==e[t.toUpperCase()]},at.getThingMap=function(){var t;if(void 0===at.thingMap){at.thingMap={};for(t in i.things)i.things.hasOwnProperty(t)&&i.things[t].type&&(at.thingMap[t.toUpperCase()]=i.things[t])}return at.thingMap},at.shoot=function(t,e,i,s,o){var r=t.getTile(e),n=o?new K(t):new g(t);n.direction=i,s&&(n.fromPlayer=s),void 0===r||r.isSurrenderable(n)?(t.addThing(e,n,!0),s&&t.game.resources.audio.play("t+c-c-c")):s&&r&&"Ricochet"===r.type?t.player.sendMessage("SHOT"):(s||r&&("Player"===r.type||"Scriptable"===r.type||"BreakableWall"===r.type))&&(s&&t.game.resources.audio.play("t+c-c-c"),r.sendMessage("SHOT"))},i.Thing=o,i.UpdateableThing=r,s("Scriptable",n),s("ActiveBomb",a),s("Ammo",h),s("Bear",c),s("Blinker",d),s("BlinkWall",p),s("Bomb",u),s("Boulder",l),s("BreakableWall",f),s("Bullet",g),s("Centipede",y),s("Conveyor",m),s("Door",v),s("Duplicator",w),s("Explosion",b),s("FakeWall",x),s("Forest",S),s("Gem",T),s("GeoFence",E),s("Heart",k),s("InvisibleWall",C),s("Key",P),s("Lava",M),s("LineWall",I),s("Lion",O),s("Passage",B),s("Player",A),s("Pusher",L),s("Ricochet",R),s("River",z),s("Ruffian",N),s("Signpost",F),s("SliderEw",D),s("SliderNs",W),s("Snake",U),s("SolidWall",H),s("Spider",G),s("SpiderWeb",V),s("SpinningGun",j),s("Teleporter",_),s("Text",q),s("ThrowingStar",K),s("Tiger",Y),s("Torch",Z),s("Wall",X),s("Water",J),i.ThingFactory=at},{"./basic":3,"./game-state":6,"./graphics":7,"./i18n":8,"./jzt-script-context":11}]},{},[14])(14)});
