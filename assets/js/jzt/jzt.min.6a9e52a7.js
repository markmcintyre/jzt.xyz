/* 
 * JZT — A DOS-Era Adventure Game for the Web
 * Copyright © 2023 Mark McIntyre
 * Created by Mark McIntyre
 * All rights reserved.
 * 
 * Version : 1.0.58
 * Released: 2023-02-04
 */
!function(t){if("object"==typeof exports&&"undefined"!=typeof module)module.exports=t();else if("function"==typeof define&&define.amd)define([],t);else{("undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:this).jzt=t()}}(function(){return function(){return function t(e,i,s){function o(n,a){if(!i[n]){if(!e[n]){var h="function"==typeof require&&require;if(!a&&h)return h(n,!0);if(r)return r(n,!0);var c=new Error("Cannot find module '"+n+"'");throw c.code="MODULE_NOT_FOUND",c}var p=i[n]={exports:{}};e[n][0].call(p.exports,function(t){return o(e[n][1][t]||t)},p,p.exports,t,e,i,s)}return i[n].exports}for(var r="function"==typeof require&&require,n=0;n<s.length;n++)o(s[n]);return o}}()({1:[function(t,e,i){var s=function(){var t=String.fromCharCode,e="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",i="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+-$",s={};function o(t,e){if(!s[t]){s[t]={};for(var i=0;i<t.length;i++)s[t][t.charAt(i)]=i}return s[t][e]}var r={compressToBase64:function(t){if(null==t)return"";var i=r._compress(t,6,function(t){return e.charAt(t)});switch(i.length%4){default:case 0:return i;case 1:return i+"===";case 2:return i+"==";case 3:return i+"="}},decompressFromBase64:function(t){return null==t?"":""==t?null:r._decompress(t.length,32,function(i){return o(e,t.charAt(i))})},compressToUTF16:function(e){return null==e?"":r._compress(e,15,function(e){return t(e+32)})+" "},decompressFromUTF16:function(t){return null==t?"":""==t?null:r._decompress(t.length,16384,function(e){return t.charCodeAt(e)-32})},compressToUint8Array:function(t){for(var e=r.compress(t),i=new Uint8Array(2*e.length),s=0,o=e.length;s<o;s++){var n=e.charCodeAt(s);i[2*s]=n>>>8,i[2*s+1]=n%256}return i},decompressFromUint8Array:function(e){if(null===e||void 0===e)return r.decompress(e);for(var i=new Array(e.length/2),s=0,o=i.length;s<o;s++)i[s]=256*e[2*s]+e[2*s+1];var n=[];return i.forEach(function(e){n.push(t(e))}),r.decompress(n.join(""))},compressToEncodedURIComponent:function(t){return null==t?"":r._compress(t,6,function(t){return i.charAt(t)})},decompressFromEncodedURIComponent:function(t){return null==t?"":""==t?null:(t=t.replace(/ /g,"+"),r._decompress(t.length,32,function(e){return o(i,t.charAt(e))}))},compress:function(e){return r._compress(e,16,function(e){return t(e)})},_compress:function(t,e,i){if(null==t)return"";var s,o,r,n={},a={},h="",c="",p="",d=2,l=3,u=2,f=[],g=0,y=0;for(r=0;r<t.length;r+=1)if(h=t.charAt(r),Object.prototype.hasOwnProperty.call(n,h)||(n[h]=l++,a[h]=!0),c=p+h,Object.prototype.hasOwnProperty.call(n,c))p=c;else{if(Object.prototype.hasOwnProperty.call(a,p)){if(p.charCodeAt(0)<256){for(s=0;s<u;s++)g<<=1,y==e-1?(y=0,f.push(i(g)),g=0):y++;for(o=p.charCodeAt(0),s=0;s<8;s++)g=g<<1|1&o,y==e-1?(y=0,f.push(i(g)),g=0):y++,o>>=1}else{for(o=1,s=0;s<u;s++)g=g<<1|o,y==e-1?(y=0,f.push(i(g)),g=0):y++,o=0;for(o=p.charCodeAt(0),s=0;s<16;s++)g=g<<1|1&o,y==e-1?(y=0,f.push(i(g)),g=0):y++,o>>=1}0==--d&&(d=Math.pow(2,u),u++),delete a[p]}else for(o=n[p],s=0;s<u;s++)g=g<<1|1&o,y==e-1?(y=0,f.push(i(g)),g=0):y++,o>>=1;0==--d&&(d=Math.pow(2,u),u++),n[c]=l++,p=String(h)}if(""!==p){if(Object.prototype.hasOwnProperty.call(a,p)){if(p.charCodeAt(0)<256){for(s=0;s<u;s++)g<<=1,y==e-1?(y=0,f.push(i(g)),g=0):y++;for(o=p.charCodeAt(0),s=0;s<8;s++)g=g<<1|1&o,y==e-1?(y=0,f.push(i(g)),g=0):y++,o>>=1}else{for(o=1,s=0;s<u;s++)g=g<<1|o,y==e-1?(y=0,f.push(i(g)),g=0):y++,o=0;for(o=p.charCodeAt(0),s=0;s<16;s++)g=g<<1|1&o,y==e-1?(y=0,f.push(i(g)),g=0):y++,o>>=1}0==--d&&(d=Math.pow(2,u),u++),delete a[p]}else for(o=n[p],s=0;s<u;s++)g=g<<1|1&o,y==e-1?(y=0,f.push(i(g)),g=0):y++,o>>=1;0==--d&&(d=Math.pow(2,u),u++)}for(o=2,s=0;s<u;s++)g=g<<1|1&o,y==e-1?(y=0,f.push(i(g)),g=0):y++,o>>=1;for(;;){if(g<<=1,y==e-1){f.push(i(g));break}y++}return f.join("")},decompress:function(t){return null==t?"":""==t?null:r._decompress(t.length,32768,function(e){return t.charCodeAt(e)})},_decompress:function(e,i,s){var o,r,n,a,h,c,p,d=[],l=4,u=4,f=3,g="",y=[],m={val:s(0),position:i,index:1};for(o=0;o<3;o+=1)d[o]=o;for(n=0,h=Math.pow(2,2),c=1;c!=h;)a=m.val&m.position,m.position>>=1,0==m.position&&(m.position=i,m.val=s(m.index++)),n|=(a>0?1:0)*c,c<<=1;switch(n){case 0:for(n=0,h=Math.pow(2,8),c=1;c!=h;)a=m.val&m.position,m.position>>=1,0==m.position&&(m.position=i,m.val=s(m.index++)),n|=(a>0?1:0)*c,c<<=1;p=t(n);break;case 1:for(n=0,h=Math.pow(2,16),c=1;c!=h;)a=m.val&m.position,m.position>>=1,0==m.position&&(m.position=i,m.val=s(m.index++)),n|=(a>0?1:0)*c,c<<=1;p=t(n);break;case 2:return""}for(d[3]=p,r=p,y.push(p);;){if(m.index>e)return"";for(n=0,h=Math.pow(2,f),c=1;c!=h;)a=m.val&m.position,m.position>>=1,0==m.position&&(m.position=i,m.val=s(m.index++)),n|=(a>0?1:0)*c,c<<=1;switch(p=n){case 0:for(n=0,h=Math.pow(2,8),c=1;c!=h;)a=m.val&m.position,m.position>>=1,0==m.position&&(m.position=i,m.val=s(m.index++)),n|=(a>0?1:0)*c,c<<=1;d[u++]=t(n),p=u-1,l--;break;case 1:for(n=0,h=Math.pow(2,16),c=1;c!=h;)a=m.val&m.position,m.position>>=1,0==m.position&&(m.position=i,m.val=s(m.index++)),n|=(a>0?1:0)*c,c<<=1;d[u++]=t(n),p=u-1,l--;break;case 2:return y.join("")}if(0==l&&(l=Math.pow(2,f),f++),d[p])g=d[p];else{if(p!==u)return null;g=r+r.charAt(0)}y.push(g),d[u++]=r+g.charAt(0),r=g,0==--l&&(l=Math.pow(2,f),f++)}}};return r}();void 0!==e&&null!=e&&(e.exports=s)},{}],2:[function(t,e,i){"use strict";var s=t("./basic").ConstructorError,o=[16.35,17.32,18.35,19.45,20.6,21.83,23.12,24.5,25.96,27.5,29.14,30.87,32.7,34.65,36.71,38.89,41.2,43.65,46.25,49,51.91,55,58.27,61.74,65.41,69.3,73.42,77.78,82.41,87.31,92.5,98,103.8,110,116.5,123.5,130.8,138.6,146.8,155.6,164.8,174.6,185,196,207.7,220,233.1,246.9,261.6,277.2,293.7,311.1,329.6,349.2,370,392,415.3,440,466.2,493.9,523.3,554.4,587.3,622.3,659.3,698.5,740,784,830.6,880,932.3,987.8,1047,1109,1175,1245,1319,1397,1480,1568,1661,1760,1865,1976,2093,2217,2349,2489,2637,2794,2960,3136,3322,3520,3729,3951,4186,4435,4699,4978,5274,5588,5920,6272,6645,7040,7459,7902],r={tick:[],tweet:[],cowbell:[],snare:[],woodblock:[],lowSnare:[],tom:[],lowWoodblock:[],bass:[]};function n(t,e){if(!(this instanceof n))throw s;this.noteIndex=t,this.frequency=o[this.noteIndex],this.duration=e}function a(t){if(!(this instanceof a))throw s;this.notes=[],this.parse(t)}function h(){var t=window.AudioContext||window.webkitAudioContext;if(!(this instanceof h))throw s;this.setActive(!0),this.active&&(this.context=new t,this.userVolume=.1,this.delay=.06,this.volume=this.context.createGain?this.context.createGain():this.context.createGainNode(),this.volume.gain.value=0,this.volume.connect(this.context.destination),this.oscillator=this.context.createOscillator(),this.oscillator.type=this.oscillator.SQUARE||"square",this.oscillator.connect(this.volume),this.oscillator.start||(this.oscillator.start=this.oscillator.noteOn),this.timestamp=this.context.currentTime,this.interruptTimestamp=this.context.currentTime,this.oscillator.start(this.context.currentTime))}n.prototype.adjustNote=function(t){void 0!==this.noteIndex&&(this.noteIndex+=t,this.noteIndex>=o.length-1?this.noteIndex=o.length-1:this.noteIndex<0&&(this.noteIndex=0),this.frequency=o[this.noteIndex])},n.prototype.shiftUp=function(){this.adjustNote(1)},n.prototype.shiftDown=function(){this.adjustNote(-1)},n.prototype.octaveUp=function(t){this.adjustNote(12*t)},n.prototype.octaveDown=function(t){this.adjustNote(-12*t)},n.prototype.bendTo=function(t){this.endFrequency=o[t]},a.prototype.addPercussiveSound=function(t,e){var i,s=e;for(i in t)t.hasOwnProperty(i)&&(this.notes.push({frequency:t[i],duration:.0015}),s-=.0015);s>0&&this.addRest(s)},a.prototype.addRest=function(t){this.notes.push(new n(void 0,t))},a.prototype.parse=function(t){var e,i,s,o,a=4,h=.05625,c=h/3,p=-1,d=!1;for(t=t.toUpperCase(),o=0;o<t.length;o+=1){switch(e=void 0,t.charAt(o)){case"T":h=.05625;break;case"S":h=.1125;break;case"I":h=.225;break;case"Q":h=.45;break;case"H":h=.9;break;case"W":h=1.8;break;case"3":p=3,c=h/3;break;case"+":a+=1;break;case"-":a-=1;break;case".":d=!0;break;case"X":e=new n;break;case"C":e=new n(0);break;case"D":e=new n(2);break;case"E":e=new n(4);break;case"F":e=new n(5);break;case"G":e=new n(7);break;case"A":e=new n(9);break;case"B":e=new n(11);break;case"0":this.addPercussiveSound(r.tick,h);break;case"1":this.addPercussiveSound(r.tweet,h);break;case"2":this.addPercussiveSound(r.cowbell,h);break;case"4":this.addPercussiveSound(r.snare,h);break;case"5":this.addPercussiveSound(r.woodblock,h);break;case"6":this.addPercussiveSound(r.lowSnare,h);break;case"7":this.addPercussiveSound(r.tom,h);break;case"8":this.addPercussiveSound(r.lowWoodblock,h);break;case"9":this.addPercussiveSound(r.bass,h);break;default:e=void 0}e&&(s=h,"#"===(i=o>=t.length?void 0:t.charAt(o+1))?(e.shiftUp(),o+=1):"!"===i&&(e.shiftDown(),o+=1),p>0&&(p-=1,s=c),d&&(d=!1,s=h+h/2),e.octaveUp(a),e.duration=s,this.notes.push(e))}},h.prototype.setActive=function(t,e){e=void 0===e||e,this.active&&!t&&e&&this.cancel(),this.active=t&&(window.AudioContext||window.webkitAudioContext)},h.prototype.cancel=function(){if(this.active&&this.oscillator){var t=this.context.currentTime+this.delay;this.oscillator.frequency.cancelScheduledValues(t),this.volume.gain.cancelScheduledValues(t),this.volume.gain.setValueAtTime(0,t),this.timestamp=this.context.currentTime,this.interruptTimestamp=this.context.currentTime}},h.prototype.isPlaying=function(){return this.active&&this.context.currentTime+this.delay<this.timestamp},h.prototype.playAfter=function(t,e){if(this.active){var i,s,o,r;for(o=new a(t),this.timestamp<this.context.currentTime+this.delay&&(this.timestamp=this.context.currentTime+this.delay),r=this.timestamp,i=0;i<o.notes.length;i+=1)(s=o.notes[i]).frequency&&s.endFrequency?(this.oscillator.frequency.setValueAtTime(s.frequency,this.timestamp),this.oscillator.frequency.linearRampToValueAtTime(s.endFrequency,this.timestamp+s.duration)):s.frequency?this.oscillator.frequency.setValueAtTime(s.frequency,this.timestamp):(this.volume.gain.setValueAtTime(0,this.timestamp),this.volume.gain.setValueAtTime(this.userVolume,this.timestamp+s.duration)),this.timestamp+=s.duration;this.volume.gain.setValueAtTime(this.userVolume,r),this.volume.gain.setValueAtTime(0,this.timestamp),e&&(this.interruptTimestamp=this.timestamp)}},h.prototype.play=function(t,e){this.active&&this.context.currentTime+this.delay>=this.interruptTimestamp&&(this.cancel(),this.playAfter(t,e))},function(){var t;for(r.tick.push(3200),t=0;t<14;++t)r.tweet.push(100*t+1e3);for(t=0;t<16;++t)r.cowbell.push(t%2*1600+1600+t%4+1600);for(t=0;t<14;++t)r.snare.push(1600*Math.random()+800);for(t=0;t<8;++t)r.woodblock.push(1600),r.woodblock.push(1600*Math.random()+800);for(t=0;t<14;++t)r.lowSnare.push(t%2*880+880+t%3*440);for(t=0;t<14;++t)r.tom.push(700-12*t);for(t=0;t<14;++t)r.lowWoodblock.push(20*t+1200-Math.random()*t*40);for(t=0;t<14;++t)r.bass.push(440*Math.random()+220)}(),i.Audio=h},{"./basic":3}],3:[function(t,e,i){"use strict";var s,o="Constructor must be called with new.";function r(t,e){if(!(this instanceof r))throw o;this.x=t,this.y=e}function n(t,e){if(!(this instanceof n))throw o;this.initialDelay=t,this.subsequentDelay=e,this.event=void 0,this.nextAllowableEvent=0}function a(){if(!(this instanceof a))throw o;this.notifications=[]}r.prototype.clone=function(){return new r(this.x,this.y)},r.prototype.add=function(t){return new r(this.x+t.x,this.y+t.y)},r.prototype.subtract=function(t){return new r(this.x-t.x,this.y-t.y)},r.prototype.adjacent=function(t){var e=Math.abs(this.x-t.x),i=Math.abs(this.y-t.y);return!(e>1||i>1)},r.prototype.aligned=function(t,e,i){return e=void 0===e?1:e,i?i===s.North?t.y<this.y&&Math.abs(this.x-t.x)<e:i===s.South?t.y>this.y&&Math.abs(this.x-t.x)<e:i===s.East?t.x>this.x&&Math.abs(this.y-t.y)<e:i===s.West?t.x<this.x&&Math.abs(this.y-t.y)<e:void 0:Math.abs(this.x-t.x)<e||Math.abs(this.y-t.y)<e},r.prototype.directionTo=function(t,e){var i=this.x-t.x,o=this.y-t.y;if(0!==i||0!==o){if(void 0===e&&(e=0===i?"y":0===o?"x":Math.floor(2*Math.random())?"x":"y"),"x"===e){if(0===i)return;return i<0?s.East:s.West}if(0!==o)return o<0?s.South:s.North}},r.prototype.compareTo=function(t){return this.x===t.x?this.y-t.y:this.x-t.x},r.prototype.equals=function(t){return this.x===t.x&&this.y===t.y},r.prototype.toString=function(){return"("+this.x+", "+this.y+")"},(s={North:new r(0,-1),East:new r(1,0),South:new r(0,1),West:new r(-1,0)}).each=function(t){t(s.North),t(s.East),t(s.South),t(s.West)},s.fromName=function(t){switch(t){case"N":case"North":return s.North;case"E":case"East":return s.East;case"S":case"South":return s.South;case"W":case"West":return s.West;default:return}},s.getName=function(t){switch(t){case s.North:return"North";case s.East:return"East";case s.South:return"South";case s.West:return"West"}},s.getShortName=function(t){switch(t){case s.North:return"N";case s.East:return"E";case s.South:return"S";case s.West:return"W"}},s.clockwise=function(t){switch(t){case s.North:return s.East;case s.East:return s.South;case s.South:return s.West;case s.West:return s.North}},s.randomPerpendicular=function(t){switch(t){case s.North:case s.South:return s.randomEastWest();default:return s.randomNorthSouth()}},s.randomNorthSouth=function(){return s.random([s.North,s.South])},s.randomEastWest=function(){return s.random([s.East,s.West])},s.randomNorthEast=function(){return s.random([s.North,s.East])},s.random=function(t){return t||(t=[s.North,s.East,s.South,s.West]),t[Math.floor(Math.random()*t.length)]},s.counterClockwise=function(t){switch(t){case s.North:return s.West;case s.West:return s.South;case s.South:return s.East;case s.East:return s.North}},s.opposite=function(t){switch(t){case s.North:return s.South;case s.East:return s.West;case s.South:return s.North;case s.West:return s.East}},n.prototype.scheduleEvent=function(t,e){var i=Date.now();i>this.nextAllowableEvent&&(t+this.initialDelay<i?this.nextAllowableEvent=i+this.subsequentDelay:this.nextAllowableEvent=i+this.initialDelay,this.event=e)},n.prototype.cancelEvent=function(){this.nextAllowableEvent=0},n.prototype.takeEvent=function(){var t=this.event;return this.event=void 0,t},a.prototype.addNotification=function(t,e){this.notifications.push({type:t,message:e,timestamp:Date.now()})};var h={storeOption:function(t,e,i,s){i!==s&&(t[e]=i)},generateLineData:function(t,e){var i,s,o,n={},a=Math.abs(e.x-t.x),h=Math.abs(e.y-t.y),c=t.x<e.x?1:-1,p=t.y<e.y?1:-1,d=a-h;for(n.points=[],n.contains=function(t){var e;for(e=0;e<this.points.length;e+=1)if(this.points[e].equals(t))return!0;return!1},n.forEach=function(t){var e;if(t&&"function"==typeof t)for(e=0;e<this.points.length;e+=1)t(this.points[e])},s=t.x,o=t.y;;){if(n.points.push(new r(s,o)),s===e.x&&o===e.y)return n;(i=2*d)>-h&&(d-=h,s+=c),i<a&&(d+=a,o+=p)}return n},generateCircleData:function(t,e){return h.generateEllipseData(t,2*e,e)},generateEllipseData:function(t,e,i){var s,o,r={},n=e*e,a=i*i,h=2*n,c=2*a,p=0,d=i,l=0,u=h*d;if(r.contains=function(t){return!!this[t.y]&&(o=this[t.y],t.x>=o[0]&&t.x<=o[1])},0===e&&0===i)return r[t.y]=[t.x,t.x],r;for(s=Math.round(a-n*i+.25*n);l<u;)p+=1,l+=c,s<0?s+=a+l:(d-=1,s+=a+l-(u-=h)),o=[t.x-p,t.x+p],r[t.y+d]=o,r[t.y-d]=o;for(s=Math.round(a*(p+.5)*(p+.5)+n*(d-1)*(d-1)-n*a);d>0;)d-=1,u-=h,s>0?s+=n-u:(p+=1,s+=n-u+(l+=c)),o=[t.x-p,t.x+p],r[t.y+d]=o,r[t.y-d]=o;return r},pointsInCircle:function(t,e){return h.pointsInEllipse(t,2*e,e)},pointsInEllipse:function(t,e,i){var s,o,n,a,c,p=[],d=h.generateEllipseData(t,e,i);for(o in d)if(d.hasOwnProperty(o))for(a=(n=d[o])[0],c=n[1],s=a;s<=c;s+=1)p.push(new r(s,o));return p}};i.Point=r,i.Direction=s,i.DelayedEventScheduler=n,i.NotificationListener=a,i.utilities=h,i.ConstructorError=o},{}],4:[function(t,e,i){"use strict";var s=t("./basic").ConstructorError,o=t("./basic").Point,r=t("./graphics").Colors,n=t("./basic").utilities,a=t("./jzt-script").JztScript,h=(t("./things").things,t("./things").ThingFactory),c=t("./basic").Direction,p=t("./i18n");function d(t,e){if(!(this instanceof d))throw s;this.validateData(t),this.name=t.name,this.game=e,this.tiles=[],this.scripts=[],this.dark=t.dark,this.reenter=t.reenter,this.smartPath=[],this.customRenderSet=[],this.torches=[],this.previousTorches=[],this.focusPoint=new o(0,0),this.maxPlayerBullets=void 0!==t.maxPlayerBullets?t.maxPlayerBullets:1/0,this.playerBullets=0,this.i18n=void 0,this.north=t.north,this.east=t.east,this.south=t.south,this.west=t.west,this.northOffset=t.northOffset||0,this.eastOffset=t.eastOffset||0,this.southOffset=t.southOffset||0,this.westOffset=t.westOffset||0,this.defaultPlayerX=t.playerX,this.defaultPlayerY=t.playerY,t.hasOwnProperty("entryPointX")&&t.hasOwnProperty("entryPointY")&&(this.entryPoint=new o(t.entryPointX,t.entryPointY)),this.displayMessage=void 0,this.displayMessageTick=0,this.DISPLAY_MESSAGE_TTL=3*e.FPS,this.DARK_SPRITE=e.resources.graphics.getSprite(176),this.DARK_SPRITE_COLOR=r.Grey,this.height=t.height,this.width=t.width,this.initializeI18n(t.i18n),this.initializeScripts(t.scripts),this.initializeTiles(t.tiles),this.initializeWindow()}d.prototype.validateData=function(t){var e=!0;if(t.height&&t.width||(e=!1),"number"!=typeof t.height&&(e=!1),"number"!=typeof t.width&&(e=!1),(t.height>256||t.height<10)&&(e=!1),(t.width>256||t.width<10)&&(e=!1),t.tiles&&Array.isArray(t.tiles)||(e=!1),t.scripts&&Array.isArray(t.scripts)||(e=!1),!e)throw"Invalid board data."},d.prototype.serialize=function(){var t,e,i,s={};for(s.name=this.name,n.storeOption(s,"dark",this.dark),n.storeOption(s,"displayMessage",this.displayMessage),n.storeOption(s,"north",this.north),n.storeOption(s,"east",this.east),n.storeOption(s,"south",this.south),n.storeOption(s,"west",this.west),n.storeOption(s,"northOffset",this.northOffset),n.storeOption(s,"eastOffset",this.eastOffset),n.storeOption(s,"southOffset",this.southOffset),n.storeOption(s,"westOffset",this.westOffset),n.storeOption(s,"reenter",this.reenter),this.maxPlayerBullets!==1/0&&(s.maxPlayerBullets=this.maxPlayerBullets),this.player?(s.playerX=this.player.point.x,s.playerY=this.player.point.y):(s.playerX=this.defaultPlayerX,s.playerY=this.defaultPlayerY),this.entryPoint&&(s.entryPointX=this.entryPoint.x,s.entryPointY=this.entryPoint.y),s.width=this.width,s.height=this.height,s.tiles=[],s.scripts=[],this.each(function(t){t?s.tiles.push(t.serialize()):s.tiles.push(0)}),t=0;t<this.scripts.length;t+=1)e=this.scripts[t],this.game.isEditor?s.scripts.push({name:e.name,rawScript:e.rawScript||e.script}):s.scripts.push(e.serialize());if(this.i18n)for(t in s.i18n={},this.i18n)if(this.i18n.hasOwnProperty(t)&&("string"==typeof this.i18n[t]||2===t.length))for(i in s.i18n[t]={},this.i18n[t])this.i18n[t].hasOwnProperty(i)&&"string"==typeof this.i18n[t][i]&&(s.i18n[t][i]=this.i18n[t][i]);return s},d.prototype.initializeScripts=function(t){var e,i;if(this.game.isEditor)this.scripts=t;else for(e=0;e<t.length;e+=1)try{i=new a(t[e].name,t[e].rawScript,!0),this.scripts.push(i)}catch(i){this.game.notifyListeners("script-error",{scriptName:t[e].name,error:i})}},d.prototype.initializeI18n=function(t){var e,i;if(t)for(e in this.i18n={},t)if(t.hasOwnProperty(e)&&"string"==typeof e&&2===e.length)for(i in this.i18n[e]={},t[e])t[e].hasOwnProperty(i)&&"string"==typeof t[e][i]&&(this.i18n[e][i]=t[e][i])},d.prototype.getScriptables=function(t){var e=[];return this.each(function(i){i&&"Scriptable"===i.type&&(!t||i.name&&i.name.toUpperCase()===t)&&e.push(i)}),e},d.prototype.initializePlayer=function(t){var e,i,s;if(this.isOutside(t.point)&&(t.point.x=this.defaultPlayerX,t.point.y=this.defaultPlayerY),s=this.getTile(t.point),t.under=s,this.player=t,this.setTile(t.point,t),this.player.board=this,this.initializeTorch(this.player),this.focusPoint=this.player.point,this.entryPoint||(this.entryPoint=t.point.clone()),!this.game.isEditor)for(e=this.getScriptables(),i=0;i<e.length;i+=1)e[i].sendMessage("ENTER")},d.prototype.initializeTiles=function(t){var e,i,s,r=new o(0,0);for(e in t)t.hasOwnProperty(e)&&(i=t[e],void 0!==(s=h.deserialize(i,this))&&(this.setTile(r,s),this.initializeTorch(s)),r.x+=1,r.x>=this.width&&(r.x=0,r.y+=1))},d.prototype.initializeTorch=function(t){var e;!this.game.isEditor&&this.dark&&"function"==typeof t.getTorch&&(e=t.getTorch())&&this.torches.push(e)},d.prototype.initializeWindow=function(){var t=this.game.context.canvas.width,e=this.game.context.canvas.height;this.windowSize=new o(0,0),this.windowOrigin=new o(0,0),this.windowSize.x=Math.floor(t/this.game.resources.graphics.TILE_SIZE.x),this.windowSize.y=Math.floor(e/this.game.resources.graphics.TILE_SIZE.y),this.windowLimit=new o(this.width-this.windowSize.x,this.height-this.windowSize.y),this.updateWindowPosition(),this.windowSize.x>this.width&&(this.windowOrigin.x=-Math.round((this.windowSize.x-this.width)/2)),this.windowSize.y>this.height&&(this.windowOrigin.y=-Math.round((this.windowSize.y-this.height)/2))},d.prototype.updateWindowPosition=function(){this.focusPoint&&(this.width>this.windowSize.x&&(this.windowOrigin.x=this.focusPoint.x-Math.round(this.windowSize.x/2),this.windowOrigin.x=this.windowOrigin.x<0?0:this.windowOrigin.x>this.windowLimit.x?this.windowLimit.x:this.windowOrigin.x),this.height>this.windowSize.y&&(this.windowOrigin.y=this.focusPoint.y-Math.round(this.windowSize.y/2),this.windowOrigin.y=this.windowOrigin.y<0?0:this.windowOrigin.y>this.windowLimit.y?this.windowLimit.y:this.windowOrigin.y))},d.prototype.getScript=function(t){var e,i;if(t&&this.scripts)for(e=0;e<this.scripts.length;e+=1)if(t===(i=this.scripts[e]).name)return i},d.prototype.each=function(t){var e=this.tiles.slice(0),i=new o(0,0);for(i.y=0;i.y<this.height;i.y+=1)for(i.x=0;i.x<this.width;i.x+=1)t(e[i.x+i.y*this.width],i)},d.prototype.eachBackwards=function(t){var e=this.tiles.slice(0),i=new o(0,0);for(i.y=this.height-1;i.y>=0;i.y-=1)for(i.x=this.width-1;i.x>=0;i.x-=1)t(e[i.x+i.y*this.width],i)},d.prototype.eachDisplayable=function(t){var e=this.tiles.slice(0),i=new o(0,0),s=this.windowOrigin.y,r=s+this.windowSize.y,n=this.windowOrigin.x,a=n+this.windowSize.x;for(n=n<0?0:n,s=s<0?0:s,a=a>this.width?this.width:a,r=r>this.height?this.height:r,i.y=s;i.y<r;i.y+=1)for(i.x=n;i.x<a;i.x+=1)t(e[i.x+i.y*this.width],i)},d.prototype.hasTile=function(t,e){var i=0;return this.each(function(e){e&&e.equals(t)&&(i+=1)}),void 0===e?i>0:e<=0?i<=0:i>=e},d.prototype.changeTiles=function(t,e){var i,s=this;this.each(function(o){o&&o.equals(t)&&((i=h.deserialize(e,s))&&void 0===e.color&&(i.foreground=o.foreground),s.replaceTile(o.point,i))})},d.prototype.deleteTile=function(t){var e=this.getTile(t);e&&this.setTile(t,e.under)},d.prototype.moveTile=function(t,e,i,s){var o,r=this.getTile(t),n=this.getTile(e);if(this.isFree(e))return s||(this.setTile(e,r),this.setTile(t,void 0===r?void 0:r.under),void 0!==r&&(r.under=void 0)),!0;if(!this.isOutside(e)&&n.isSurrenderable(r))return!(n.under&&!n.under.isSurrenderable(r))&&(s||(void 0!==r&&(o=r.under,r.under=n),this.setTile(e,r),this.setTile(t,o)),!0);if(!i&&n){if(n.under&&!n.under.isSurrenderable(r))return!1;if(n.push(t.directionTo(e),r))return!0;if(this.isFree(e)||this.getTile(e).isSurrenderable(r))return this.moveTile(t,e,i,s)}return!1},d.prototype.setTile=function(t,e){this.isOutside(t)||(e&&(e.point=t.clone(),"Player"!==e.type||t.equals(this.player.point)||(this.deleteTile(this.player.point),(e=this.player).point=t.clone(),this.initializePlayer(this.player))),this.tiles[t.x+t.y*this.width]=e)},d.prototype.addThing=function(t,e,i){var s=this.getTile(t);s&&(i&&s.isSurrenderable(e)?e.under=s:this.deleteTile(t)),this.setTile(t,e)},d.prototype.isFreeOrSurrenderable=function(t,e){var i=this.getTile(t);return!this.isOutside(t)&&(!i||i.isSurrenderable(e))},d.prototype.getTile=function(t){if(!(t.x>=this.width||t.x<0||t.y>=this.height||t.y<0))return this.tiles[t.x+t.y*this.width]},d.prototype.replaceTile=function(t,e){this.deleteTile(t),this.addThing(t,e,!0)},d.prototype.isOutside=function(t){return t.y<0||t.y>=this.height||(t.x<0||t.x>=this.width)},d.prototype.isOutsideWindow=function(t){return t.x<this.windowOrigin.x||t.x>=this.windowOrigin.x+this.windowSize.x||(t.y<this.windowOrigin.y||t.y>=this.windowOrigin.y+this.windowSize.y)},d.prototype.isFree=function(t){return!this.isOutside(t)&&!this.getTile(t)},d.prototype.movePlayerOffBoard=function(t){var e,i;switch(t){case c.North:e=this.north,i=this.northOffset;break;case c.East:e=this.east,i=this.eastOffset;break;case c.South:e=this.south,i=this.southOffset;break;case c.West:e=this.west,i=this.westOffset;break;default:return}this.game.movePlayerToBoardEdge(c.opposite(t),e,i)},d.prototype.getPassage=function(t){var e,i,s;for(e=0;e<this.height;e+=1)for(i=0;i<this.width;i+=1)if((s=this.getTile(new o(i,e)))&&"Passage"===s.type&&s.passageId===t)return s},d.prototype.addMessage=function(t){this.messageQueue.push(t)},d.prototype.isLit=function(t,e,i){var s,o=i?this.previousTorches:this.torches;if(!this.dark)return!0;if(e&&e.glow)return!0;for(s=0;s<o.length;s+=1)if(o[s].contains(t))return!0;return!1},d.prototype.canPlayerShoot=function(t){return t&&this.maxPlayerBullets<=0&&this.setDisplayMessage(p.getMessage("status.noshoot")),this.playerBullets<this.maxPlayerBullets},d.prototype.update=function(){var t=this;this.updateSmartPath(this.player.point),this.customRenderSet=[],this.playerBullets=0,this.dark&&(this.previousTorches=this.torches,this.torches=[]),this.each(function(e){e&&("Bullet"===e.type&&e.fromPlayer&&(t.playerBullets+=1),"function"==typeof e.update&&"function"==typeof e.updateOnReverse&&"Player"!==e.type&&(e.updateOnReverse()||e.update()),e.under&&e.under.updateWhileUnder&&e.under.updateWhileUnder(),e.render&&t.customRenderSet.push(e),"Player"!==e.type&&t.initializeTorch(e))}),this.eachBackwards(function(t){t&&"function"==typeof t.update&&"function"==typeof t.updateOnReverse&&t.updateOnReverse()&&"Player"!==t.type&&t.update()})},d.prototype.equals=function(t){var e=t instanceof d?t.name:t;return this.name===e},d.prototype.setDisplayMessage=function(t,e){void 0!==t?(this.displayMessage=" "+t+" ",this.displayMessage.length>this.windowSize.x&&(this.displayMessage=this.displayMessage.substring(0,this.windowSize.x)),this.displayMessageTick=e?this.game.FPS*e:this.DISPLAY_MESSAGE_TTL):(this.displayMessage=void 0,this.displayMessageTick=0)},d.prototype.render=function(t){var e,i,s,o,n,a=this,h=this.game.context.canvas.width,c=this.game.context.canvas.height;for(this.updateWindowPosition(),(this.windowOrigin.x<0||this.windowOrigin.y<0)&&(t.fillStyle=r.Grey.rgbValue,t.fillRect(0,0,h,c)),t.fillStyle=!a.game.isEditor&&a.dark?this.game.DARK_PATTERN:r.Black.rgbValue,i=Math.max(-this.windowOrigin.x*this.game.resources.graphics.TILE_SIZE.x,0),s=Math.max(-this.windowOrigin.y*this.game.resources.graphics.TILE_SIZE.y,0),o=Math.min(this.width*this.game.resources.graphics.TILE_SIZE.x,this.windowSize.x*this.game.resources.graphics.TILE_SIZE.x),n=Math.min(this.height*this.game.resources.graphics.TILE_SIZE.y,this.windowSize.y*this.game.resources.graphics.TILE_SIZE.y),t.fillRect(i,s,o,n),this.eachDisplayable(function(e,i){var s,o;(a.game.isEditor||!a.dark||a.isLit(i,e))&&(e&&!e.hidden?(s=a.game.resources.graphics.getSprite(e.getSpriteIndex()),!(o=e.background)&&e.under&&e.under.background?o=e.under.background.isLight()?e.under.background.darken():e.under.background:!o&&a.dark&&(o=r.Black),s.draw(t,i.subtract(a.windowOrigin),e.foreground,o)):!e&&a.dark&&a.game.resources.graphics.fillTile(t,i.subtract(a.windowOrigin),r.Black))}),e=0;e<this.customRenderSet.length;e+=1)this.customRenderSet[e].render(t);void 0!==this.displayMessage&&this.renderMessage(t)},d.prototype.adjustSmartPathWeight=function(t,e){var i=t.x+t.y*this.width;this.isOutside(t)||void 0===this.smartPath[i]||(this.smartPath[i]+=e)},d.prototype.updateSmartPath=function(t){var e=this;this.smartPath=[],function t(i,s,o){var r,n,a,h;o<50&&i>=0&&i<e.width&&s>=0&&s<e.height&&(r=i+s*e.width,h=void 0===(n=e.tiles[r])||n&&"Bullet"===n.type,a=e.smartPath[r],(o<=0||h&&(void 0===a||a>o))&&(e.smartPath[i+s*e.width]=o,t(i+1,s,o+=1),t(i-1,s,o),t(i,s+1,o),t(i,s-1,o)))}(t.x,t.y,0),this.updatePathWeights()},d.prototype.updatePathWeights=function(){this.each(function(t){t&&t.influenceSmartPath&&t.influenceSmartPath()})},d.prototype.getSmartValue=function(t){var e;return t.x>=this.width||t.x<0||t.y>=this.height||t.y<0?1/0:void 0===(e=this.smartPath[t.x+t.y*this.width])?1/0:e},d.prototype.getSmartDirection=function(t){var e,i=[],s=this,o=1/0;if(c.each(function(r){(e=s.getSmartValue(t.add(r)))<o?((i=[]).push(r),o=e):e===o&&i.push(r)}),o!==1/0)return i.length<=1?i[0]:c.random(i)},d.prototype.getMessage=function(t){var e,i=p.getLanguage();return void 0===(e=this.getMessageForLanguage(i,t))&&i!==p.DefaultLanguage&&(e=this.getMessageForLanguage(p.DefaultLanguage,t)),void 0!==e?e:"??? "+t+" ???"},d.prototype.getMessageForLanguage=function(t,e){if(this.i18n&&this.i18n.hasOwnProperty(t)&&this.i18n[t].hasOwnProperty(e))return this.i18n[t][e]},d.prototype.playerHurt=function(){this.setDisplayMessage(p.getMessage("status.hurt")),this.reenter&&this.moveTile(this.player.point,this.entryPoint)},d.prototype.renderMessage=function(t){var e=new o;e.x=Math.floor((this.windowSize.x-this.displayMessage.length)/2),e.y=this.windowSize.y-1,this.game.resources.graphics.drawString(t,e,this.displayMessage,r.Cycle,r.Black),this.displayMessageTick-=1,this.displayMessageTick<=0&&(this.displayMessage=void 0)},i.Board=d},{"./basic":3,"./graphics":7,"./i18n":8,"./jzt-script":13,"./things":20}],5:[function(t,e,i){"use strict";var s=t("./basic").ConstructorError,o=t("./basic").Point,r=t("./basic").DelayedEventScheduler,n=t("./popup").Popup,a=t("./graphics").Colors,h=t("lz-string"),c=t("./i18n"),p=0,d=1,l=2,u=3,f=4;function g(t){return"jzt-save-meta|"+(t||"")}function y(t){return"jzt-save|"+(t||"")}function m(t){if(!(this instanceof m))throw s;this.game=t,this.dialogType=m.Type.SAVE,this.files=[],this.graphics=this.game.resources.graphics,this.cycleCount=0,this.selectedIndex=0,this.offset=0,this.width=48,this.height=Math.min(Math.floor(t.context.canvas.height/this.graphics.TILE_SIZE.y)-2,24),this.boxWidth=this.width-3,this.boxHeight=5,this.visibleBoxCount=Math.floor((this.height-2)/this.boxHeight),this.eventScheduler=new r(2*this.game.CYCLE_TICKS,this.game.CYCLE_TICKS),this.popup=new n(void 0,new o(this.width,this.height),this.game),this.popup.setColor(a.Blue,a.BrightWhite,a.Blue,a.BrightBlue),this.spriteGrid=this.popup.spriteGrid}m.Type={SAVE:1,OPEN:2},m.prototype.setAlert=function(t){this.game.keyboard.cancelInput(),this.alert=new n(void 0,new o(t.length+4,3),this.game),this.alert.spriteGrid.addText(new o(2,1),t,a.BrightWhite,a.Blue)},m.prototype.clearAlert=function(){this.alert=void 0},m.prototype.open=function(t,e){var i,s,o=g();for(s in t&&(this.dialogType=t),this.popup.title=c.getMessage(this.dialogType===m.Type.SAVE?"file.save":"file.load"),this.selectedIndex=0,this.offset=0,this.files=[],localStorage)localStorage.hasOwnProperty(s)&&0===s.lastIndexOf(o,0)&&(i=JSON.parse(localStorage[s])).name===this.game.name&&this.files.push(i);this.files.sort(function(t,e){return e.timestamp-t.timestamp}),e||this.files.unshift(null),this.popup.redraw(),this.initializeSlots()},m.prototype.update=function(){var t=this.game.keyboard;t.isPressed(t.UP)?this.eventScheduler.scheduleEvent(t.isPressed(t.UP),p):t.isPressed(t.DOWN)?this.eventScheduler.scheduleEvent(t.isPressed(t.DOWN),d):t.isPressed(t.ENTER)||t.isPressed(t.SPACE)?this.eventScheduler.scheduleEvent(t.isPressed(t.ENTER),l):t.isPressed(t.DELETE)||t.isPressed(t.BACKSPACE)?this.eventScheduler.scheduleEvent(t.isPressed(t.DELETE),u):t.isPressed(t.ESCAPE)||t.isPressed(t.S)||t.isPressed(t.R)?this.eventScheduler.scheduleEvent(t.isPressed(t.ESCAPE),f):this.eventScheduler.cancelEvent(),this.cycleCount+=1,this.cycleCount>=this.game.CYCLE_RATE&&(this.cycleCount=0,this.doTick())},m.prototype.doTick=function(){var t,e=this.eventScheduler.takeEvent();if(!this.alert||e!==l&&e!==f)if(e===p)this.selectedIndex-=1,this.selectedIndex<0&&(this.selectedIndex=0),this.selectedIndex<this.offset&&(this.offset=this.selectedIndex),this.initializeSlots();else if(e===d)this.selectedIndex+=1,this.selectedIndex>=this.files.length-1&&(this.selectedIndex=this.files.length-1),this.selectedIndex>=this.offset+this.visibleBoxCount&&(this.offset=this.selectedIndex-this.visibleBoxCount+1),this.initializeSlots();else if(e===l){if(this.dialogType===m.Type.SAVE){(t=this.files[this.selectedIndex])&&this.deleteFile(t);try{this.saveFile()}catch(t){return void this.setAlert(c.getMessage("status.nosave"))}}else this.dialogType===m.Type.OPEN&&(t=this.files[this.selectedIndex],this.loadFile(t));this.game.restoreState()}else e===u?(t=this.files[this.selectedIndex])&&this.deleteFile(t):e===f&&this.game.restoreState();else this.clearAlert()},m.prototype.deleteFile=function(t){var e=y(t.timestamp),i=g(t.timestamp);localStorage.hasOwnProperty(e)&&delete localStorage[e],localStorage.hasOwnProperty(i)&&delete localStorage[i],this.open()},m.prototype.loadFile=function(t){var e,i;t?(i=y(t.timestamp),localStorage.hasOwnProperty(i)&&(e=localStorage[i],e=h.decompressFromUTF16(e),e=JSON.parse(e),this.game.deserialize(e))):this.game.restartGame()},m.prototype.saveFile=function(){var t,e={name:this.game.name,board:this.game.currentBoard.name,timestamp:Date.now()},i=g(e.timestamp),s=y(e.timestamp);t=this.game.serialize(),t=JSON.stringify(t),t=h.compressToUTF16(t),localStorage[i]=JSON.stringify(e),localStorage[s]=t},m.prototype.initializeSlots=function(){var t,e,i=this;function s(t){return t<=9?"0"+t:t}function r(t,e,r){var n,h,p,d,l,u,f,g,y=new o(0,0),w=r?a.White:a.Cyan,v=e*i.boxHeight+2;for(y.x=2;y.x<i.boxWidth;y.x+=1)for(y.y=v;y.y<v+i.boxHeight;y.y+=1)y.x===i.boxWidth-1&&y.y===v?i.spriteGrid.setTile(y,220,a.Black):y.x===i.boxWidth-1&&y.y!==v+i.boxHeight-1?i.spriteGrid.setTile(y,void 0,a.BrightWhite,a.Black):y.y===v+i.boxHeight-1&&2!==y.x?i.spriteGrid.setTile(y,223,a.Black):y.y===v+i.boxHeight-1&&2===y.x||i.spriteGrid.setTile(y,void 0,a.BrightWhite,w);y.x=3,y.y=v+1,t?(h=t.name||c.getMessage("file.saved"),i.spriteGrid.addText(y,h,r?a.BrightWhite:a.Grey,w)):i.dialogType===m.Type.SAVE?(h=c.getMessage("file.new"),y.x=Math.round((i.boxWidth-h.length)/2),i.spriteGrid.addText(y,h,r?a.BrightWhite:a.Grey,w)):(h=c.getMessage("file.restart"),y.x=Math.round((i.boxWidth-h.length)/2),i.spriteGrid.addText(y,h,r?a.BrightWhite:a.Grey,w),y.y+=1,y.x=Math.round((i.boxWidth-i.game.name.length)/2),i.spriteGrid.addText(y,i.game.name,r?a.BrightBlue:a.Grey,w)),t&&t.timestamp&&(p=new Date(t.timestamp),d=p.getDate(),l=p.getMonth()+1,u=p.getFullYear(),f=p.getHours(),g=p.getMinutes(),n=u+"-"+s(l)+"-"+s(d)+" "+f+":"+s(g),y.x=i.boxWidth-n.length-2,i.spriteGrid.addText(y,n,a.Grey,w)),t&&t.board&&(y.x=3,y.y+=1,i.spriteGrid.addText(y,t.board,r?a.BrightBlue:a.Grey,w))}for(e=Math.min(this.visibleBoxCount,this.files.length),t=0;t<e;t+=1)r(this.files[this.offset+t],t,t+this.offset===this.selectedIndex);this.popup.setScrollBar(this.offset,this.files.length,e)},m.prototype.render=function(t){this.alert?this.alert.render(t):this.popup.render(t)},i.FileManagement=m},{"./basic":3,"./graphics":7,"./i18n":8,"./popup":18,"lz-string":1}],6:[function(t,e,i){"use strict";i.GameState={Error:-2,Splash:-1,Loading:0,Playing:1,Paused:2,GameOver:3,Reading:4,Title:5,Victory:6,FileManagement:7,Transition:8}},{}],7:[function(t,e,i){"use strict";var s,o,r=t("./basic").ConstructorError,n=t("./basic").Point,a="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAIAAAAEAAQMAAABBN+zkAAAABlBMVEUAAAD///+l2Z/dAAAGBElEQVRYw8WXv4skRRTHC4WOmr01e7jLbWJwYaEwV0ixC+K/YGJU3El5QSEbtQMWfWdy/4OJmYn/g9DMycOguHAZmHHZaDeRY0DYm2Cp9vuqZ2Z/eHqnrlrT86M/87rej3r9XrVSq9HjdW1cgrZdg7v24DF+fY1/iARs+Q8eklLfzcK2tQLe9QePSSSysa3q7bP3vX44KyCe9XTmvxkDWKV+eJbzGf7/6Idk9cMzpb45g0RbABWJr/toiOSS1B5+XuYw26LWPku0OCMxbFsNasd0cko3TO9e5csbg8148hY+4hXQVeQfMwKwVniyZf3MwZI1WNxt/czAvAK2s1ruk58FuYS0umeyypn8V2WO2nXBxCKxU0DOXY6xzLETcjtIRCNa1I7JllrS+V42xY6dOhNZ0ZK3xVLMIZdctT+qfzzo+qkXoK/87aHE6HqDrA+sgr60w74XJpPgdF3OEFCrcsdG6dqLTCUqQqwbgBLEuoCK5gB9q7IoFKDTWqLoyk9dKnOAuCLBnCQz8ZO6YdKnjRLDAJ5c80X/gXP/fBiKsc5GFnGIfzDMu51jZnHVseJxVdmuq5ixukoDUF2FFcD61uoIq5ouLurYiqU1AegqV0xciasV4RJX1RVrAbqtBXQrIJkJrwIx1wxQFy2kTJvj3Rh1HCsNO27d8T8a2xd2mbNle/d0wRxVNN4H7z289u7FKdwPfuIfPJgUkM8B2Hf+0aMOILicWR1z7Px43GWqx+7oGCAXiWMWwM9FAsAhyJRCCfWcZdIC/AMBHYta5wV4AZHFsMWHbMenWQz7F1z/XXIodREvYgv97LNVNuB+Ys8DYP2k5gF8ivPgn+pO7hkAh9Xk6Gt9IiAyaiPzkbGkDwU4DnUBpLUZgK8ERHJ6t4AjeM4hB5rorQKOBZgX+NCVgEU8jTZuB7bZvlWKSn3T/K0bRfP1Q78WkDpRuwjMCVUnZkAOmgMytFonqYDP5B5fgfEYlrommC1Pv8yxcnXgwIvUUBUoe8Qw+i5llzxVYzoSkAC6V4OwBpy4AD+AJsYmIiq2OrXsN/lRSwm8OtJNMJYKdwt5s0WHzbWo4dae3wQQnjfzeJEkqbMAo3xqWAMETodYtADgHcCRkQqDYgHgzAD0BtQDcBvAo2RzKFUJRTgiFrsNBW4zDJNVWedHtfregHrTCVc/lm9aPOXibeUMvHKKkNbKJjJJBwVLvdXinMIZGXhFyhNCNVl1mdUUaI0pjjF8jNEYEwIA1xhSGOCLFIOE+hwjiksewCR1CcN3XVeaMNwvwA4AEjaxgHozR93EBqPCPNZagOqaHX+v99Ir7heEQjsURfi83EJY9hGKMdqGouDTDmTgISVCVbCf+SRLlYZrUVKcXSJKKcHIlGC6W9CPpFyDgscDcG1qVRylS0DHkGg3wOM3wHQDrBNt/hLQqYD8xXNoaZo2RrogvvRkFZepUtfT4/DqDfNno7kaILQzNbeSKF3Z4mmUvAYh0AJEKYLl5lzAZLKx4nTflIgUdSam+XmJbUo0mqLDcvK5jbqkA8IZBRxjrq7SmqYjlQQ8FxWV8xYSBWA27qr5c4s5roCn30oONDY2pRTB4f0b60rVDRf3qzfLj3c++RkWjpQajXBg1o+///I6+LsSy5Fano/y+Wh5KUHVqKrWEsvleYbEec7L5VpihGNU0nal5RL8NxJlryNElddtgr3R/YOX/f3+Zb+R0HpVeff6Xo77B/i7SJQnIgnZqERV/V9ADpK3PJ8t7vS3A3Ds7eHrmgRdkej7/mBv76DvlwjL4o7YNZK3BPP/Ba8f47xuPuhWu9LPWQlqDUrI2zoKwB7US+sjVWED36QuuNbPUfTrtgWYT7ugp57Qgvdns8hqCgkSkIOfzSAx5bUEwK8r4KaRLMAwBwBPnZQfjxo2aMmHjlrzwqpul9fPn7f+QFcAquOd6boib8nzg+yqhpqt6501kOyXGrlT9hkALpaiLLsIKdN1+ElAi60bynQByyiXiEQrmn4Z+qLsQ6ao7PB31Sh1TdOyvRmALAHAqqOKRI8n6sHC3T915S+A3wBO89vlg2hdWgAAAABJRU5ErkJggg==";function h(t,e){if(!(this instanceof h))throw r;this.point=t,this.owner=e}function c(t){if(!(this instanceof c))throw r;var e=this;this.TILE_SIZE=new n(16,32),this.SPRITE_SIZE=new n(8,16),this.DARK_IMAGE=void 0,this.NOISE_IMAGE=void 0,this.blinkCycle=0,this.blinkState=!0,this.sprites=[],this.spriteSource=new Image,this.spriteSource.src=a,this.colorSpriteSources=[],this.onLoadCallback=t,this.spriteSource.onload=function(){var t,o,r,a,c,p,d,l,u,f,g,y;for(a in s)if(s.hasOwnProperty(a)){for((t=document.createElement("canvas")).width=this.width,t.height=this.height,e.colorSpriteSources[a]=t,o=t.getContext("2d"),r=this.width*this.height*4,a=s[a],o.drawImage(this,0,0),p=(c=o.getImageData(0,0,this.width,this.height)).data,d=0;d<r;d+=4)p[d]>=255?(p[d]=a.r,p[d+1]=a.g,p[d+2]=a.b,p[d+3]=255):p[d+3]=0;o.putImageData(c,0,0)}for(l=this.width/e.SPRITE_SIZE.x,u=this.height/e.SPRITE_SIZE.y,f=0;f<u;f+=1)for(g=0;g<l;g+=1)y=new h(new n(g*e.SPRITE_SIZE.x,f*e.SPRITE_SIZE.y),e),e.sprites.push(y);for((t=document.createElement("canvas")).width=256,t.height=256,r=262144,p=(c=(o=t.getContext("2d")).getImageData(0,0,o.canvas.width,o.canvas.height)).data,d=0;d<r;d+=4)p[d]=0,p[d+1]=0,p[d+2]=0,p[d+3]=Math.round(20*Math.random());o.putImageData(c,0,0),e.NOISE_IMAGE=t,(t=document.createElement("canvas")).width=e.TILE_SIZE.x,t.height=e.TILE_SIZE.y,(o=t.getContext("2d")).imageSmoothingEnabled=!1,(y=e.getSprite(176)).draw(o,new n(0,0),i.Colors.Grey,i.Colors.Black),e.DARK_IMAGE=t,e.onLoadCallback()}}function p(t,e,i){if(!(this instanceof p))throw r;this.width=t,this.height=e,this.graphics=i,this.tiles=[]}function d(t,e,i,s,o,n){if(!(this instanceof d))throw r;function a(t){var e=t.toString(16);return e.length<=1&&(e="0"+e),e}this.code=t,this.name=e,void 0!==i&&(this.index=i),void 0!==s&&void 0!==o&&void 0!==n&&(this.r=s,this.g=o,this.b=n,this.rgbValue="#"+a(s)+a(o)+a(n))}function l(t,e,i){if(!(this instanceof l))throw r;d.call(this,t,e),this.cycles=!0,this.cycleSequence=i,this.code=t,this.name=e,this.cycleIndex=0,this.update()}function u(t){return s[parseInt(t,16)]}h.prototype.draw=function(t,e,i,s){var o,r,n;s&&s.isLight()&&(o=!0,s=s.darken()),r=e.x*this.owner.TILE_SIZE.x,n=e.y*this.owner.TILE_SIZE.y,s&&(t.fillStyle=s.rgbValue,t.fillRect(r,n,this.owner.TILE_SIZE.x,this.owner.TILE_SIZE.y)),o&&this.owner.blinkState||t.drawImage(this.owner.colorSpriteSources[i.index],this.point.x,this.point.y,this.owner.SPRITE_SIZE.x,this.owner.SPRITE_SIZE.y,r,n,this.owner.TILE_SIZE.x,this.owner.TILE_SIZE.y)},c.prototype.update=function(){this.blinkCycle+=1,this.blinkCycle>10&&(this.blinkState=!this.blinkState,i.Colors.Cycle.update(),this.blinkCycle=0)},c.prototype.fillTile=function(t,e,i){var s=e.x*this.TILE_SIZE.x,o=e.y*this.TILE_SIZE.y;i&&(t.fillStyle=i.rgbValue,t.fillRect(s,o,this.TILE_SIZE.x,this.TILE_SIZE.y))},c.prototype.getSprite=function(t){return this.sprites[t]},c.prototype.textToSprites=function(t){var e,i,s=[];for(e=0;e<t.length;e+=1)i=this.convertSpecialCharacter(t.charAt(e)),s.push(this.getSprite(i));return s},c.prototype.drawString=function(t,e,i,s,o){this.drawSprites(t,e,this.textToSprites(i),s,o)},c.prototype.drawSprites=function(t,e,i,o,r){var n;for(e=e.clone(),o=o||s.Yellow,r=r||void 0,n=0;n<i.length;n+=1)i[n].draw(t,e,o,r),e.x+=1},c.characterTable={"⍪":1,"☻":2,"♥":3,"♦":4,"♣":5,"♠":6,"•":7,"◘":8,"○":9,"◙":10,"♂":11,"♀":12,"♪":13,"♫":14,"☼":15,"►":16,"◄":17,"↕":18,"‼":19,"¶":20,"§":21,"▬":22,"↊":23,"↑":24,"↓":25,"→":26,"←":27,"∟":28,"↔":29,"▲":30,"▼":31,"⌃":127,"Ç":128,"ü":129,"é":130,"â":131,"ä":132,"à":133,"å":134,"ç":135,"ê":136,"ë":137,"è":138,"ï":139,"î":140,"ì":141,"Ä":142,"Å":143,"É":144,"æ":145,"Æ":146,"ô":147,"ö":148,"ò":149,"û":150,"ù":151,"ÿ":152,"Ö":153,"Ü":154,"¢":155,"£":156,"¥":157,"₧":158,"ƒ":159,"á":160,"í":161,"ó":162,"ú":163,"ñ":164,"Ñ":165,"ª":166,"º":167,"¿":168,"⌐":169,"¬":170,"½":171,"¼":172,"¡":173,"«":174,"»":175,"░":176,"▒":177,"▓":178,"│":179,"┤":180,"╡":181,"╢":182,"╖":183,"╕":184,"╣":185,"║":186,"╗":187,"╝":188,"╜":189,"╛":190,"┐":191,"└":192,"┴":193,"┬":194,"├":195,"─":196,"┼":197,"╞":198,"╟":199,"╚":200,"╔":201,"╩":202,"╦":203,"╠":204,"═":205,"╬":206,"╧":207,"╨":208,"╤":209,"╥":210,"╙":211,"╘":212,"╒":213,"╓":214,"╫":215,"╪":216,"┘":217,"┌":218,"█":219,"▄":220,"▌":221,"▐":222,"▀":223,"α":224,"ß":225,"Γ":226,"π":227,"Σ":228,"σ":229,"µ":230,"τ":231,"Φ":232,"Θ":233,"Ω":234,"δ":235,"∞":236,"φ":237,"ε":238,"∩":239,"≡":240,"±":241,"≥":242,"≤":243,"⌠":244,"⌡":245,"÷":246,"≈":247,"°":248,"∙":249,"·":250,"√":251,"ⁿ":252,"²":253,"■":254},c.prototype.convertSpecialCharacter=function(t){var e=t.charCodeAt(0);return e>=32&&e<=126?e:c.characterTable.hasOwnProperty(t)?c.characterTable[t]:63},p.prototype.setTile=function(t,e,i,o){this.tiles[t.x+t.y*this.width]={sprite:e?this.graphics.getSprite(e):void 0,foreground:i||s.White,background:o}},p.prototype.setColor=function(t,e,i){var s=this.tiles[t.x+t.y*this.width];s&&(s.foreground=e||s.foreground,s.background=i||s.background)},p.prototype.clear=function(){this.tiles=[]},p.prototype.addText=function(t,e,i,s){var o,r=t.clone();for(e=this.graphics.textToSprites(e),o=0;o<e.length;o+=1)r.x=t.x+o,this.tiles[r.x+r.y*this.width]={sprite:e[o],foreground:i,background:s}},p.prototype.addArt=function(t,e){var s,o,r,n=t.clone();for(s=0;s<e.length;s+=1)"\n"===(o=e.charAt(s))?(n.x=t.x,n.y+=1):(o=this.graphics.convertSpecialCharacter(o),s+1<=e.length&&(s+=1,r=i.ColorUtilities.getColor(e.charAt(s))),this.setTile(n,o,r),n.x+=1)},p.prototype.getTile=function(t){return this.tiles[t.x+t.y*this.width]},p.prototype.draw=function(t,e){var i,s=new n(0,0);for(s.x=0;s.x<this.width;s.x+=1)for(s.y=0;s.y<this.height;s.y+=1)(i=this.getTile(s))&&(i.sprite?i.sprite.draw(t,s.add(e),i.foreground,i.background):this.graphics.fillTile(t,s.add(e),i.background))},d.prototype.darken=function(){return s[this.index-8]||this},d.prototype.lighten=function(){return s[this.index+8]||this},d.prototype.isLight=function(){return this.index>=8},d.prototype.isDark=function(){return this.index<8},l.prototype=new d,l.prototype.constructor=l,l.prototype.update=function(){var t;this.cycleIndex=this.cycleIndex+1<this.cycleSequence.length?this.cycleIndex+1:0,t=this.cycleSequence[this.cycleIndex],this.index=t.index,this.r=t.r,this.g=t.g,this.b=t.b,this.rgbValue=t.rgbValue},s=[new d("0","Black",0,0,0,0),new d("1","Blue",1,0,0,170),new d("2","Green",2,0,170,0),new d("3","Cyan",3,0,170,170),new d("4","Red",4,170,0,0),new d("5","Magenta",5,170,0,170),new d("6","Brown",6,170,85,0),new d("7","White",7,170,170,170),new d("8","Grey",8,85,85,85),new d("9","BrightBlue",9,85,85,255),new d("A","BrightGreen",10,85,255,85),new d("B","BrightCyan",11,85,255,255),new d("C","BrightRed",12,255,85,85),new d("D","BrightMagenta",13,255,85,255),new d("E","Yellow",14,255,255,85),new d("F","BrightWhite",15,255,255,255)],o=new l("*","Cycle",[s[9],s[10],s[11],s[12],s[13],s[14],s[15]]),i.Colors={},function(t,e){var i;for(i=0;i<t.length;i+=1)e[t[i].name]=t[i],e[t[i].name.toUpperCase()]=t[i]}(s,i.Colors),i.Colors.Cycle=o,i.ColorUtilities={getColor:u,deserializeForeground:function(t){var e;if(2===t.length?e=t.charAt(1):1===t.length&&(e=t.charAt(0)),e)return"*"===e?o:u(e);throw"Invalid color code: "+t},deserializeBackground:function(t){var e;if(2===t.length)return"*"===(e=t.charAt(0))?void 0:u(e)},serialize:function(t,e){return(void 0===t?"*":t.code)+(void 0===e?"E":e instanceof l?"*":e.code)}},i.Color=d,i.Graphics=c,i.Sprite=h,i.SpriteGrid=p},{"./basic":3}],8:[function(t,e,i){"use strict";var s,o,r="en",n={en:{keys:{collect:"You now have the {0} key.",toomany:"You already have a {0} key.",9:"blue",A:"green",B:"cyan",C:"red",D:"purple",E:"yellow",F:"white"},doors:{locked:"The {0} door is locked.",open:"The {0} door is now open.",1:"blue",2:"green",3:"cyan",4:"red",5:"purple",6:"yellow",7:"white"},obstacles:{water:"Your way is blocked by water.",signpost:"Signpost",signpostmessage:"The signpost is curiously left blank."},status:{gameover:"Game over!",noammo:"You don't have any ammo.",hurt:"Ouch!",notorches:"You don't have any torches.",title:"Press [P] to play.",forest:"A path is cleared through the forest.",gem:"Gems give you health.",torch:"Torches light up dark rooms.",ammo:"Ammunition: 5 shots per container.",dark:"Room is dark -- You need to light a torch.",breakable:"This wall has several cracks.",noshoot:"You can't shoot here.",heart:"Maximum health increased by 10!",invisible:"You are blocked by an invisible wall.",notdark:"You don't need a torch here.",loading:"Loading...",loaderror:"Oops! Loading failed.",fatalerror:"I has error, Jim.",incompatible:"Um, this file isn't compatible.",nosave:"Yikes! You're out of save space."},pause:{paused:"Paused",health:"    Health:",ammo:"      Ammo:",gems:"      Gems:",torches:"   Torches:",score:"     Score:",keys:"      Keys:"},file:{new:"Empty Slot",saved:"Saved Game",save:"Save Game",load:"Restore Game",restart:"Restart Game"}},fr:{keys:{collect:"Vous avez maintenant la clé {0}.",toomany:"Vous avez déja une clé {0}.",9:"bleue",A:"verte",B:"cyan",C:"rouge",D:"violet",E:"jaune",F:"blanche"},doors:{locked:"La porte {0} est verrouillée.",open:"La porte {0} est maintenant overte.",1:"bleue",2:"verte",3:"cyan",4:"rouge",5:"violet",6:"jaune",7:"blanche"},obstacles:{water:"Votre chemin est bloquée par de l'eau",signpost:"Poteau Indicateur",signpostmessage:"Le poteau indicateur est curieusement vierge."},status:{gameover:"Game over !",noammo:"Vous n'avez plus de munitions.",hurt:"Aïe !",notorches:"Vous n'avez plus de torches.",title:"Appuyez sur [P] pour jouer.",forest:"Vous frayez un chemin dans la fôret.",gem:"Les bijoux augmentent vos PV.",torch:"Les torches éclairent des pièces sombres.",ammo:"Munitions: 5 bulles par unité.",dark:"Pièce sombre -- Vous avez besoin d'une torche!",breakable:"Ce mur a plusieurs fissures.",noshoot:"Il est interdit de tirer ici.",heart:"PV max a augmenté par 10 !",invisible:"Vous êtes bloqué par un mur invisible.",notdark:"Vous n'avez pas besoin d'une torche ici.",loading:"Chargement...",loaderror:"Oups! Chargement echoué.",fatalerror:"J'ai l'erreur, Jim.",incompatible:"Mais ce fichier est incompatible...",nosave:"Vous n'avez plus d'éspace pour sauvegarder."},pause:{paused:"Pause",health:"        PV:",ammo:" Munitions:",gems:"    Bijous:",torches:"   Torches:",score:"     Score:",keys:"      Clés:"},file:{new:"Espace Vide",saved:"Jeu Sauvegardé",save:"Sauvegarder",load:"Ouvrir",restart:"Récommencer"}}};function a(t,e){var i,s=e.split("."),o=t;for(i=0;i<s.length;i+=1){if(void 0===o[s[i]])return;o=o[s[i]]}return o}function h(t){s=t,o=n.hasOwnProperty(t)?n[t]:n[r]}h(r),i.DefaultLanguage=r,i.Messages=n,i.getMessage=function(t){var e,i,s=a(o,t);if(void 0===s&&o!==r&&(s=a(n[r],t)),void 0===s)return t;for(e=1;e<arguments.length;e+=1)i=new RegExp("\\{"+(e-1)+"\\}","g"),s=s.replace(i,arguments[e]);return s},i.findMessage=a,i.getLanguage=function(){return s},i.setLanguage=h,i.getBoardMessage=function(t,e){return 0===e.indexOf("i18n:")?t.getMessage(e.substring(5)):e}},{}],9:[function(t,e,i){"use strict";var s=t("./basic").ConstructorError;function o(){if(!(this instanceof o))throw s;this.LEFT=37,this.UP=38,this.RIGHT=39,this.DOWN=40,this.SHIFT=16,this.SPACE=32,this.ENTER=13,this.ESCAPE=27,this.T=84,this.P=80,this.S=83,this.R=82,this.BACKSPACE=8,this.DELETE=46,this.pressedKeys=0,this.pressed={},this.capturableKeys=[this.LEFT,this.UP,this.RIGHT,this.DOWN,this.SHIFT,this.SPACE,this.T,this.P,this.S,this.R,this.ENTER,this.ESCAPE,this.BACKSPACE,this.DELETE]}o.prototype.initialize=function(){this.initialized||(this.boundOnKeyUp=this.onKeyUp.bind(this),this.boundOnKeyDown=this.onKeyDown.bind(this),window.addEventListener("keydown",this.boundOnKeyDown,!1),window.addEventListener("keyup",this.boundOnKeyUp,!1)),this.initialized=!0},o.prototype.cancelInput=function(){var t;for(t in this.pressed)this.pressed.hasOwnProperty(t)&&(this.pressed[t]=-1);this.pressedKeys=0},o.prototype.cancelKey=function(t){void 0!==this.pressed[t]&&(this.pressed[t]=-1,this.pressedKeys-=1,this.pressedKeys<0&&(this.pressedKeys=0))},o.prototype.isAnyPressed=function(){return this.pressedKeys>0},o.prototype.isPressed=function(t){return void 0!==this.pressed[t]&&this.pressed[t]>0?this.pressed[t]:void 0},o.prototype.getMostRecentPress=function(t){var e,i,s,o=0;if(!(this.pressedKeys<=0)){for(t||(t=this.capturableKeys),e=0;e<t.length;e+=1)i=t[e],this.pressed[i]>o&&(o=this.pressed[i],s=i);return s}},o.prototype.onKeyDown=function(t){this.capturableKeys.indexOf(t.keyCode)>=0&&(void 0===this.pressed[t.keyCode]&&(this.pressed[t.keyCode]=Date.now(),this.pressedKeys+=1),t.preventDefault())},o.prototype.onKeyUp=function(t){this.capturableKeys.indexOf(t.keyCode)>=0&&(delete this.pressed[t.keyCode],this.pressedKeys-=1,this.pressedKeys<0&&(this.pressedKeys=0),t.preventDefault())},i.KeyboardInput=o},{"./basic":3}],10:[function(t,e,i){"use strict";var s=t("./things").ThingFactory,o=t("./basic").Direction,r=t("./basic").ConstructorError,n=t("./game-state").GameState,a=t("./i18n").getBoardMessage,h=Object.freeze({NORMAL:0,CONTINUE:1,CONTINUE_AFTER_JUMP:2,REPEAT:3}),c=Object.freeze({CW:{name:"Clockwise",type:"modifier",process:function(t){return o.clockwise(t)}},CCW:{name:"Counter-clockwise",type:"modifier",process:function(t){return o.counterClockwise(t)}},OPP:{name:"Opposite",type:"modifier",process:function(t){return o.opposite(t)}},RNDP:{name:"Perpendicularly Random",type:"modifier",process:function(t){return o.randomPerpendicular(t)}}}),p=Object.freeze({SEEK:{name:"Toward player",type:"terminal",process:function(t){return t.getPlayerDirection()}},SMART:{name:"Smart seek",type:"terminal",process:function(t){return t.getSmartDirection()||t.getPlayerDirection()}},FLOW:{name:"Current orientation",type:"terminal",process:function(t){return t.orientation}},RAND:{name:"Random direction",type:"terminal",process:function(){return o.random()}},RANDF:{name:"Random free direction",type:"terminal",process:function(t){return o.random(t.getFreeDirections())}},RANDB:{name:"Random blocked direction",type:"terminal",process:function(t){return o.random(t.getBlockedDirections())}},RNDEW:{name:"Randomly East or West",type:"terminal",process:function(){return o.randomEastWest()}},RNDNS:{name:"Randomly North or South",type:"terminal",process:function(){return o.randomNorthSouth()}},RNDNE:{name:"Randomly North or East",type:"terminal",process:function(){return o.randomNorthEast()}},NORTH:{name:"North",type:"terminal",process:function(){return o.North}},EAST:{name:"East",type:"terminal",process:function(){return o.East}},SOUTH:{name:"South",type:"terminal",process:function(){return o.South}},WEST:{name:"West",type:"terminal",process:function(){return o.West}},N:{name:"North shorthand",type:"terminal",process:function(){return o.North}},E:{name:"East shorthand",type:"terminal",process:function(){return o.East}},S:{name:"South shorthand",type:"terminal",process:function(){return o.South}},W:{name:"West shorthand",type:"terminal",process:function(){return o.West}}});function d(t){if(!(this instanceof d))throw r;this.modifiers=[],this.terminal=t,this.count=1}function l(t){if(!(this instanceof l))throw r;this.thingTemplate=t}function u(t){this.newForeground=t}function f(t,e){if(!(this instanceof f))throw r;this.fromTemplate=t,this.toTemplate=e}function g(t){if(!(this instanceof g))throw r;this.value=t}function y(t){if(!(this instanceof y))throw r;this.magnetically=t}function m(){if(!(this instanceof m))throw r}function w(t,e){if(!(this instanceof w))throw r;this.counter=t.toUpperCase(),this.amount=e}function v(t,e){if(!(this instanceof v))throw r;this.label=t,this.expression=e}function b(){if(!(this instanceof b))throw r}function x(t,e){this.directionExpression=t,this.forceful=e}function T(t){this.sequence=t}function S(t,e){this.thingTemplate=t,this.directionExpression=e}function E(t){this.label=t}function k(t){this.text=t}function C(t,e,i){this.text=t,this.bold=e,this.label=i,this.modifiesScroll=!0}function P(t,e){this.directionExpression=t,this.message=e}function M(t,e){this.recipient=t,this.message=e}function I(t,e){this.counter=t,this.value=e}function O(t){this.directionExpression=t}function B(){if(!(this instanceof B))throw r}function A(t){this.speed=t||3}function L(t,e,i){this.counter=t,this.value=e,this.label=i}function R(t){this.directionExpression=t}function z(t){this.radius=t}function N(){if(!(this instanceof N))throw r}function F(){if(!(this instanceof F))throw r}function D(t){this.count=t}function W(t){this.directionExpression=t}function U(t){this.label=t}function H(t){this.subExpression=t}function G(){if(!(this instanceof G))throw r}function V(t){this.directionExpression=t}function j(t){this.directionExpression=t}function _(t){this.radius=t}function q(t,e){this.thingTemplate=t,this.count=e}function K(){if(!(this instanceof K))throw r}function Y(t,e,i){this.counter=t,this.operand=e,this.value=i}d.prototype.getResult=function(t){for(var e=this.terminal.process(t),i=this.modifiers.slice(0);i.length;)e=i.pop().process(e);return e},l.prototype.execute=function(t){var e=s.deserialize(this.thingTemplate,t.board);t.board.replaceTile(t.point,e)},u.prototype.execute=function(t){t.foreground=this.newForeground},f.prototype.execute=function(t){return t.board.changeTiles(this.fromTemplate,this.toTemplate),h.CONTINUE},g.prototype.execute=function(t){t.spriteIndex=this.value},y.prototype.execute=function(t){t.remove(),this.magnetically&&t.board.player.push(o.opposite(t.getPlayerDirection()))},m.prototype.execute=function(t){t.scriptContext.stop()},w.prototype.execute=function(t){return t.board.game.adjustCounter(this.counter,this.amount),h.CONTINUE},v.prototype.execute=function(t){return this.expression.getResult(t)&&t.scriptContext.jumpToLabel(this.label)?h.CONTINUE_AFTER_JUMP:h.CONTINUE},b.prototype.execute=function(t){return t.locked=!0,h.CONTINUE},x.prototype.execute=function(t){return this.forceful?this.forcefulMove(t):this.move(t)},x.prototype.move=function(t){var e=t.scriptContext.heap,i=this.directionExpression.getResult(t),s="<count>";if(e[s]||(e[s]=this.directionExpression.count),i){if(t.move(i),e[s]-=1,e[s]>0)return h.REPEAT;delete e[s]}},x.prototype.forcefulMove=function(t){var e,i=t.scriptContext.heap,s="<count>",r="<stuck>";if(i[s]||(i[s]=this.directionExpression.count),e=i[r]?o.fromName(i[r]):this.directionExpression.getResult(t)){if(!t.move(e))return i[r]=o.getShortName(e),h.REPEAT;if(i[s]-=1,i[s]>0)return delete i[r],h.REPEAT;delete i[s],delete i[r]}},T.prototype.execute=function(t){return t.play(this.sequence,!0),h.CONTINUE},S.prototype.execute=function(t){var e,i=this.directionExpression.getResult(t),o=t.point.add(i);t.board.isOutside(o)||((e=s.deserialize(this.thingTemplate,t.board))?(t.board.moveTile(t.point,o,!1,!0),t.board.isFreeOrSurrenderable(o)&&t.board.addThing(o,e,!0)):t.board.player.point.equals(o)||t.board.deleteTile(o))},E.prototype.execute=function(t){return t.scriptContext.restoreLabel(this.label),h.CONTINUE},k.prototype.execute=function(t){var e=a(t.board,this.text);return t.board.setDisplayMessage(e),h.CONTINUE},C.prototype.execute=function(t){var e=a(t.board,this.text);return t.scriptContext.addScrollContent(e,this.bold,this.label),h.CONTINUE},P.prototype.execute=function(t){var e=this.directionExpression.getResult(t);if(e){var i=t.board.getTile(t.point.add(e));i&&i.sendMessage(this.message)}},M.prototype.execute=function(t){var e,i;if("SELF"===this.recipient)return t.scriptContext.jumpToLabel(this.message)?h.CONTINUE_AFTER_JUMP:h.CONTINUE;for(e="ALL"===this.recipient?t.board.getScripables():t.board.getScriptables(this.recipient),i=0;i<e.length;i+=1)e[i].sendMessage(this.message);return h.CONTINUE},I.prototype.execute=function(t){t.board.game.setCounterValue(this.counter,this.value)},O.prototype.execute=function(t){var e=this.directionExpression.getResult(t);e&&(t.play("c-f#"),s.shoot(t.board,t.point.add(e),e,!1))},B.prototype.execute=function(t){t.pushable=!1,t.walkDirection=void 0},A.prototype.execute=function(t){t.speed=this.speed},L.prototype.execute=function(t){return t.board.game.getCounterValue(this.counter)<this.value?this.label?(t.scriptContext.jumpToLabel(this.label),h.CONTINUE_AFTER_JUMP):void 0:(t.board.game.adjustCounter(this.counter,-1*this.value),h.CONTINUE)},R.prototype.execute=function(t){var e=this.directionExpression.getResult(t);e&&s.shoot(t.board,t.point.add(e),e,!1,!0)},z.prototype.execute=function(t){t.setTorchRadius(this.radius)},N.prototype.execute=function(t){return t.locked=!1,h.CONTINUE},F.prototype.execute=function(t){t.board.game.setState(n.Victory)},D.prototype.execute=function(t){var e=t.scriptContext.heap,i="<cycles>";if(e[i]||(e[i]=this.count),e[i]-=1,e[i]>0)return h.REPEAT;delete e[i]},W.prototype.execute=function(t){var e=this.directionExpression.getResult(t);return t.walkDirection=e,h.CONTINUE},U.prototype.execute=function(t){return t.scriptContext.zapLabel(this.label),h.CONTINUE},H.prototype.getResult=function(t){return!this.subExpression.getResult(t)},G.prototype.getResult=function(t){return t.isPlayerAdjacent()},V.prototype.getResult=function(t){return t.isBlocked(this.directionExpression.getResult(t))},j.prototype.getResult=function(t){return this.directionExpression?t.isPlayerAligned(1,this.directionExpression.getResult(t)):t.isPlayerAligned(1)},_.prototype.getResult=function(t){return t.isPlayerVisible(this.radius)},q.prototype.getResult=function(t){return t.board.hasTile(this.thingTemplate,this.count)},K.prototype.getResult=function(t){return t.board.isLit(t.point,void 0,!0)},Y.prototype.getResult=function(t){var e=t.getCounterValue(this.counter);switch(this.operand){case">":return e>this.value;case"<":return e<this.value;case">=":return e>=this.value;case"<=":return e<=this.value;case"=":return e===this.value}},i.CommandResult=h,i.DirectionModifier=c,i.Direction=p,i.DirectionExpression=d,i.Label=function t(e){if(!(this instanceof t))throw r;this.name=e},i.BecomeCommand=l,i.ChangeCommand=f,i.CharCommand=g,i.ColorCommand=u,i.DieCommand=y,i.EndCommand=m,i.GiveCommand=w,i.IfCommand=v,i.LockCommand=b,i.MoveCommand=x,i.PlayCommand=T,i.PutCommand=S,i.ScrollCommand=C,i.SendDirCommand=P,i.SendCommand=M,i.SetCommand=I,i.SpeedCommand=A,i.TakeCommand=L,i.ThrowStarCommand=R,i.TorchCommand=z,i.RestoreCommand=E,i.SayCommand=k,i.ShootCommand=O,i.StandCommand=B,i.UnlockCommand=N,i.VictoryCommand=F,i.WaitCommand=D,i.WalkCommand=W,i.ZapCommand=U,i.NotExpression=H,i.AdjacentExpression=G,i.BlockedExpression=V,i.AlignedExpression=j,i.PeepExpression=_,i.ExistsExpression=q,i.LitExpression=K,i.TestingExpression=Y},{"./basic":3,"./game-state":6,"./i18n":8,"./things":20}],11:[function(t,e,i){"use strict";var s=t("./game-state").GameState,o=t("./jzt-script-commands");function r(t,e){this.owner=e,this.script=t,this.commandIndex=0,this.currentLabels={},this.heap={},this.initializeLabels(t),this.scrollContent=[],this.jumpCount=0}r.prototype.serialize=function(){var t,e={};for(t in e.commandIndex=this.commandIndex,e.currentLabels={},e.heap=this.heap,this.currentLabels)this.currentLabels.hasOwnProperty(t)&&this.currentLabels[t]&&(e.currentLabels[t]=this.currentLabels[t]);return e},r.prototype.deserialize=function(t){var e;for(e in this.commandIndex=t.commandIndex,this.heap=t.heap,t.currentLabels)t.currentLabels.hasOwnProperty(e)&&(this.currentLabels[e]=t.currentLabels[e])},r.prototype.inDefaultState=function(){var t,e=!0;if(0!==this.commandIndex)e=!1;else if(Object.keys(this.heap).length>0)e=!1;else for(t in this.currentLabels)if(this.currentLabels.hasOwnProperty(t)&&0!==this.currentLabels[t]){e=!1;break}return e},r.prototype.initializeLabels=function(t){var e;for(e in t.labelIndicies)t.labelIndicies.hasOwnProperty(e)&&(this.currentLabels[e]=0)},r.prototype.isRunning=function(){return this.commandIndex>=0&&this.commandIndex<this.script.commands.length},r.prototype.stop=function(){this.commandIndex=-1},r.prototype.addScrollContent=function(t,e,i){var s={text:t,center:e,label:i};this.scrollContent.push(s)},r.prototype.displayScroll=function(){var t,e;for(this.owner.board.game.scroll.setTitle(this.owner.name),this.owner.board.game.scroll.clearLines(),this.owner.board.game.scroll.listener=this.owner,t=0;t<this.scrollContent.length;t+=1)e=this.scrollContent[t],this.owner.board.game.scroll.addLine(e.text,e.center,e.label);this.scrollContent=[],this.owner.board.game.setState(s.Reading)},r.prototype.executeTick=function(){var t,e,i,s=this.scrollContent.length>0;if(this.owner.messageQueue.length>0&&(t=this.owner.messageQueue.shift(),this.owner.locked||this.jumpToLabel(t)),this.isRunning()){if(e=this.script.getCommand(this.commandIndex))switch(i=e.execute(this.owner),e.modifiesScroll&&(s=!1),s&&this.displayScroll(),i){case void 0:case o.CommandResult.NORMAL:this.advanceLine(),this.doneTick();break;case o.CommandResult.CONTINUE:this.advanceLine(),this.executeTick();break;case o.CommandResult.CONTINUE_AFTER_JUMP:this.jumpCount<=5?this.executeTick():this.doneTick();break;case o.CommandResult.REPEAT:this.doneTick();break;default:throw"Unexpected command execution."}}else s&&this.displayScroll()},r.prototype.doneTick=function(){this.jumpCount=0},r.prototype.jumpToLabel=function(t){if(this.currentLabels.hasOwnProperty(t)){var e=this.currentLabels[t],i=this.script.labelIndicies[t];if(e<i.length)return this.clearTemporaryHeapItems(),this.commandIndex=i[e],this.jumpCount+=1,!0}return!1},r.prototype.clearTemporaryHeapItems=function(){var t;for(t in this.heap)this.heap.hasOwnProperty(t)&&"<"===t[0]&&">"===t[t.length-1]&&delete this.heap[t]},r.prototype.zapLabel=function(t){this.currentLabels.hasOwnProperty(t)&&this.currentLabels[t]+1<=this.script.labelIndicies[t].length&&(this.currentLabels[t]+=1)},r.prototype.restoreLabel=function(t){this.currentLabels.hasOwnProperty(t)&&this.currentLabels[t]-1>=0&&(this.currentLabels[t]-=1)},r.prototype.advanceLine=function(){this.isRunning()&&(this.commandIndex+=1)},i.JztScriptContext=r},{"./game-state":6,"./jzt-script-commands":10}],12:[function(t,e,i){"use strict";var s=t("./parser").Literal,o=t("./parser").Alternation,r=t("./parser").Empty,n=t("./parser").Sequence,a=t("./parser").Repetition,h=t("./parser").Number,c=t("./parser").Word,p=t("./parser").NewLine,d=t("./parser").Assembly,l=t("./parser").String,u=t("./lexer").Lexer,f=t("./jzt-script-commands"),g=t("./graphics").Colors,y=t("./basic").ConstructorError,m=t("./graphics").ColorUtilities;function w(t){if(!(this instanceof w))throw y;function e(t,e,i,s){var o=[],r=t.peek();function n(t,e,i){return t&&t.name===e.toUpperCase()&&t.value&&t.value.toUpperCase()===i.toUpperCase()}for(;!n(r,e,i);)o.unshift(t.pop()),r=t.peek();return n(r,e,i)&&s&&t.pop(),o}function i(t,e){var i=new o;return i.add(t),i.add(e),i}function d(t){return i(t,new r)}function u(e){return t?void 0:{assemble:e}}function v(){var t,e,i=new n,r=new a(((t=new o).add(new s("CW")),t.add(new s("CCW")),t.add(new s("OPP")),t.add(new s("RNDP")),t.assembler=u(function(t){t.push(f.DirectionModifier[t.pop().value.toUpperCase()])}),t));return i.add(r),i.add(((e=new o).add(new s("SEEK")),e.add(new s("SMART")),e.add(new s("FLOW")),e.add(new s("RAND")),e.add(new s("RANDF")),e.add(new s("RANDB")),e.add(new s("RNDEW")),e.add(new s("RNDNS")),e.add(new s("RNDNE")),e.add(new s("NORTH")),e.add(new s("EAST")),e.add(new s("SOUTH")),e.add(new s("WEST")),e.add(new s("N")),e.add(new s("E")),e.add(new s("S")),e.add(new s("W")),e.assembler=u(function(t){t.push(f.Direction[t.pop().value.toUpperCase()])}),e)),i.assembler=u(function(t){for(var e=new f.DirectionExpression(t.pop());t.peek()&&"modifier"===t.peek().type;)e.modifiers.unshift(t.pop());t.push(e)}),i}function b(){var e=new o;return e.add(new s("Black")),e.add(new s("Blue")),e.add(new s("Green")),e.add(new s("Cyan")),e.add(new s("Red")),e.add(new s("Magenta")),e.add(new s("Brown")),e.add(new s("White")),e.add(new s("Grey")),e.add(new s("BrightBlue")),e.add(new s("BrightGreen")),e.add(new s("BrightCyan")),e.add(new s("BrightRed")),e.add(new s("BrightMagenta")),e.add(new s("Yellow")),e.add(new s("BrightWhite")),e.assembler=t?void 0:{assemble:function(t){t.push(g[t.pop().value.toUpperCase()])}},e}function x(){var e=new o;return e.add(new s("Empty")),e.add(new s("ActiveBomb")),e.add(new s("Ammo")),e.add(new s("Bear")),e.add(new s("Blinker")),e.add(new s("BlinkWall")),e.add(new s("Bomb")),e.add(new s("Boulder")),e.add(new s("BreakableWall")),e.add(new s("Bullet")),e.add(new s("Centipede")),e.add(new s("Conveyor")),e.add(new s("Door")),e.add(new s("Duplicator")),e.add(new s("Explosion")),e.add(new s("FakeWall")),e.add(new s("Forest")),e.add(new s("Gem")),e.add(new s("GeoFence")),e.add(new s("Heart")),e.add(new s("InvisibleWall")),e.add(new s("Key")),e.add(new s("Lava")),e.add(new s("LineWall")),e.add(new s("Lion")),e.add(new s("Passage")),e.add(new s("Player")),e.add(new s("Pusher")),e.add(new s("Ricochet")),e.add(new s("River")),e.add(new s("Ruffian")),e.add(new s("Scriptable")),e.add(new s("Signpost")),e.add(new s("SliderEw")),e.add(new s("SliderNs")),e.add(new s("Snake")),e.add(new s("SolidWall")),e.add(new s("Spider")),e.add(new s("SpiderWeb")),e.add(new s("SpinningGun")),e.add(new s("Teleporter")),e.add(new s("Text")),e.add(new s("ThrowingStar")),e.add(new s("Tiger")),e.add(new s("Torch")),e.add(new s("Wall")),e.add(new s("Water")),e.assembler=t?void 0:{assemble:function(t){t.push({type:t.pop().value.toUpperCase()})}},e}function T(){var e=new n;return e.add(b()),e.add(x()),e.assembler=t?void 0:{assemble:function(t){var e=t.pop();e.color=m.serialize(void 0,t.pop()),t.push(e)}},e}function S(){var t,e,r,a,p,l,g,y,m,w,b=new o;return b.add((t=b,(e=new n).addDiscard(new s("Not")),e.add(t),e.assembler=u(function(t){t.push(new f.NotExpression(t.pop()))}),e)),b.add(((r=new s("Adjacent")).discard=!0,r.assembler=u(function(t){t.push(new f.AdjacentExpression)}),r)),b.add(((a=new n).addDiscard(new s("Blocked")),a.add(v()),a.assembler=u(function(t){t.push(new f.BlockedExpression(t.pop()))}),a)),b.add(((p=new n).addDiscard(new s("Aligned")),p.add(v()),p.assembler=u(function(t){t.push(new f.AlignedExpression(t.pop()))}),p)),b.add(((l=new n).addDiscard(new s("Peep")),l.add(d(new h)),l.assembler=u(function(t){var e=t.peek()&&"NUMBER"===t.peek().name?t.pop().value:void 0;t.push(new f.PeepExpression(e))}),l)),b.add(((g=new n).addDiscard(new s("Exists")),g.add(d(new h)),g.add(i(x(),T())),g.assembler=u(function(t){var e=t.pop(),i=t.peek()&&"NUMBER"===t.peek().name?t.pop().value:void 0;t.push(new f.ExistsExpression(e,i))}),g)),b.add(((y=new n).addDiscard(new s("Lit")),y.assembler=u(function(t){t.push(new f.LitExpression)}),y)),b.add((m=new n,(w=new o).add(new s("<")),w.add(new s("<=")),w.add(new s(">")),w.add(new s(">=")),w.add(new s("=")),m.add(new c),m.add(w),m.add(new h),m.assembler=u(function(t){var e=t.pop().value,i=t.pop().value,s=t.pop().value.toUpperCase();t.push(new f.TestingExpression(s,i,e))}),m)),b}function E(t,o){var r=new n,c=new n,p=i(v(),function(){var t=new n;return t.add(v()),t.add(new h),t.assembler=u(function(t){var e=t.pop().value;t.peek().count=e}),t}());return o=void 0===o||o,c.addDiscard(new s(",")),c.add(p),r.add(new s(t||"Go")),r.add(p),r.add(new a(c)),r.assembler=u(function(i){var s,r,n=e(i,"WORD",t||"GO",!0);for(s=0;s<n.length;s+=1)r=n[s],i.push(new f.MoveCommand(r,o))}),r}function k(){var t,r,a,g,y,m,w,k,C,P,M,I,O,B,A,L,R,z,N,F,D,W,U,H,G,V,j,_,q=new n,K=new o;return K.add(((t=new n).addDiscard(new s("Become")),t.add(i(T(),x())),t.assembler=u(function(t){t.push(new f.BecomeCommand(t.pop()))}),t)),K.add(((r=new n).addDiscard(new s("Change")),r.add(i(T(),x())),r.add(i(T(),x())),r.assembler=u(function(t){var e=t.pop();t.push(new f.ChangeCommand(t.pop(),e))}),r)),K.add(((a=new n).addDiscard(new s("Char")),a.add(new h),a.assembler=u(function(t){t.push(new f.CharCommand(t.pop().value))}),a)),K.add(((g=new n).addDiscard(new s("Color")),g.add(b()),g.assembler=u(function(t){var e=t.pop();t.push(new f.ColorCommand(e))}),g)),K.add(((y=new n).addDiscard(new s("Die")),y.add(d(new s("Magnetically"))),y.assembler=u(function(t){var e=t.peek();e&&"WORD"===e.name&&"MAGNETICALLY"===e.value.toUpperCase()?(t.pop(),t.push(new f.DieCommand(!0))):t.push(new f.DieCommand)}),y)),K.add(((m=new s("End")).discard=!0,m.assembler=u(function(t){t.push(new f.EndCommand)}),m)),K.add(E()),K.add(((w=new n).addDiscard(new s("Give")),w.add(new h),w.add(new c),w.assembler=u(function(t){t.push(new f.GiveCommand(t.pop().value,t.pop().value))}),w)),K.add(((k=new n).addDiscard(new s("If")),k.add(S()),k.add(new c),k.assembler=u(function(t){t.push(new f.IfCommand(t.pop().value.toUpperCase(),t.pop()))}),k)),K.add(((C=new s("Lock")).discard=!0,C.assembler=u(function(t){t.push(new f.LockCommand)}),C)),K.add(((P=new n).addDiscard(new s("Play")),P.add(new l),P.assembler=u(function(t){t.push(new f.PlayCommand(t.pop().value))}),P)),K.add(((M=new n).addDiscard(new s("Put")),M.add(v()),M.add(i(x(),T())),M.assembler=u(function(t){t.push(new f.PutCommand(t.pop(),t.pop()))}),M)),K.add(((I=new n).addDiscard(new s("Scroll")),I.add(d(new s("Bold"))),I.add(new l),I.add(d(new c)),I.assembler=u(function(t){var e="WORD"===t.peek().name?t.pop().value.toUpperCase():void 0,i=t.pop().value,s=!(!t.peek()||"WORD"!==t.peek().name||"BOLD"!==t.peek().value.toUpperCase())&&t.pop();t.push(new f.ScrollCommand(i,!!s,e))}),I)),K.add(((O=new n).add(new s("Send")),O.add(d(new c)),O.add(new c),O.assembler=u(function(t){var i=e(t,"WORD","SEND",!0),s=i.pop().value.toUpperCase(),o=i.length>0?i.pop().value.toUpperCase():"SELF";t.push(new f.SendCommand(o,s))}),O)),K.add(((B=new n).addDiscard(new s("SendDir")),B.add(v()),B.add(new c),B.assembler=u(function(t){var e=t.pop().value.toUpperCase(),i=t.pop();t.push(new f.SendDirCommand(i,e))}),B)),K.add(((A=new n).addDiscard(new s("Set")),A.add(d(new h)),A.add(new c),A.assembler=u(function(t){var e=t.pop().value.toUpperCase(),i=t.peek()&&"NUMBER"===t.peek().name?t.pop().value:1;t.push(new f.SetCommand(e,i))}),A)),K.add(((L=new n).addDiscard(new s("Speed")),L.add(new h),L.assembler=u(function(t){var e=t.peek()&&"NUMBER"===t.peek().name?t.pop().value:void 0;t.push(new f.SpeedCommand(e))}),L)),K.add(((R=new n).addDiscard(new s("Take")),R.add(new h),R.add(new c),R.add(d(new c)),R.assembler=u(function(t){var e=t.pop().value.toUpperCase(),i="WORD"===t.peek().name?t.pop().value.toUpperCase():void 0,s=+t.pop().value;t.push(new f.TakeCommand(i||e,s,i?e:void 0))}),R)),K.add(((z=new n).addDiscard(new s("ThrowStar")),z.add(v()),z.assembler=u(function(t){t.push(new f.ThrowStarCommand(t.pop()))}),z)),K.add(((N=new n).addDiscard(new s("Torch")),N.add(d(new h)),N.assembler=u(function(t){var e=t.peek()&&"NUMBER"===t.peek().name?t.pop().value:0;t.push(new f.TorchCommand(e))}),N)),K.add(E("Try",!1)),K.add(((F=new n).addDiscard(new s("Restore")),F.add(new c),F.assembler=u(function(t){t.push(new f.RestoreCommand(t.pop().value.toUpperCase()))}),F)),K.add(((D=new n).addDiscard(new s("Say")),D.add(new l),D.assembler=u(function(t){t.push(new f.SayCommand(t.pop().value))}),D)),K.add(((W=new n).addDiscard(new s("Shoot")),W.add(v()),W.assembler=u(function(t){t.push(new f.ShootCommand(t.pop()))}),W)),K.add(((U=new s("Stand")).discard=!0,U.assembler=u(function(t){t.push(new f.StandCommand)}),U)),K.add(((H=new s("Unlock")).discard=!0,H.assembler=u(function(t){t.push(new f.UnlockCommand)}),H)),K.add(((G=new s("Victory")).discard=!0,G.assembler=u(function(t){t.push(new f.VictoryCommand)}),G)),K.add(((V=new n).addDiscard(new s("Wait")),V.add(d(new h)),V.assembler=u(function(t){var e=t.peek()&&"NUMBER"===t.peek().name?t.pop().value:void 0;t.push(new f.WaitCommand(e))}),V)),K.add(((j=new n).addDiscard(new s("Walk")),j.add(v()),j.assembler=u(function(t){t.push(new f.WalkCommand(t.pop()))}),j)),K.add(((_=new n).addDiscard(new s("Zap")),_.add(new c),_.assembler=u(function(t){t.push(new f.ZapCommand(t.pop().value.toUpperCase()))}),_)),q.add(K),q.addDiscard(new p),q}var C,P;this.parser=((P=new o).add(((C=new n).addDiscard(new s(":")),C.add(new c),C.addDiscard(new p),C.assembler=u(function(t){t.push(new f.Label(t.pop().value.toUpperCase()))}),C)),P.add(k()),P.addDiscard(new p),new a(P))}w.prototype.parse=function(t){var e,i,s;if("\n"!==t.charAt(t.length-1)&&(t+="\n"),e=new u(t).tokenizeAll(),i=new d(e),void 0===(s=this.parser.completeMatch(i)))throw"Catestrophic script error. No result.";return s.stack},i.JztScriptParser=w},{"./basic":3,"./graphics":7,"./jzt-script-commands":10,"./lexer":15,"./parser":17}],13:[function(t,e,i){"use strict";var s=t("./jzt-script-commands"),o=new(0,t("./jzt-script-parser").JztScriptParser),r=t("./basic").ConstructorError;t("./game-state").GameState;function n(t,e,i){if(!(this instanceof n))throw r;this.name=t,this.rawScript=e,this.labelIndicies={},this.commands=[],i&&this.compile()}n.prototype.compile=function(){var t,e,i,r,n,a=o.parse(this.rawScript);for(t=0;t<a.length;t+=1)if((e=a[t])instanceof s.Label)i=this,r=e,n=void 0===(n=void 0)?i.commands.length:n,i.labelIndicies.hasOwnProperty(r.name)?i.labelIndicies[r.name].push(n):i.labelIndicies[r.name]=[n];else{if("function"!=typeof e.execute)throw"Catestrophic script error. Unexpected object in command stack.";this.commands.push(e)}},n.prototype.getCommand=function(t){return this.commands[t]},n.prototype.serialize=function(){return{name:this.name,rawScript:this.rawScript}},i.JztScript=n},{"./basic":3,"./game-state":6,"./jzt-script-commands":10,"./jzt-script-parser":12}],14:[function(t,e,i){"use strict";var s="1.0.0",o=t("./basic").ConstructorError,r=t("./input").KeyboardInput,n=t("./audio").Audio,a=t("./graphics").Graphics,h=t("./i18n"),c=t("./scroll").Scroll,p=t("./file-management").FileManagement,d=t("./popup").Splash,l=t("./basic").Point,u=t("./basic").Direction,f=t("./board").Board,g=t("./things").things,y=t("./graphics").Colors,m=t("./graphics").ColorUtilities,w=t("./basic").utilities,v=t("./popup").Popup,b=t("./game-state").GameState,x=t("./metadata");function T(t){var e;if(!(this instanceof T))throw o;if(!t||!t.canvasElement||"CANVAS"!==t.canvasElement.nodeName)throw"Expected a valid canvas element in the configuration.";if("function"==typeof Function.prototype.bind&&window.CanvasRenderingContext2D&&"function"==typeof requestAnimationFrame){if(this.FPS=30,this.CPS=10,this.CYCLE_RATE=Math.round(this.FPS/this.CPS),this.CYCLE_TICKS=Math.floor(1e3/this.FPS)*this.CYCLE_RATE,this.FPS_INTERVAL=1e3/this.FPS,this.TRANSITION_STEPS=10,this.version=s,this.loopId=void 0,this.gameToLoad=void 0,this.gameLoaded=!1,this.loadingAnimationIndex=0,this.screenEffectIndex=0,this.previousStates=[],this.transition={animationIndex:0,type:"irisOut",callback:void 0},this.onLoadCallback=t.onLoadCallback,this.player=void 0,this.keyboard=new r,this.canvasElement=t.canvasElement,this.devicePixelRatio=1,this.notificationListeners=[],t.playTest&&(this.playTest=!0),t.playTest&&(this.playTest=t.playTest),t.notificationListeners)for(e=0;e<t.notificationListeners.length;e+=1)this.addNotificationListener(t.notificationListeners[e]);window.devicePixelRatio&&(this.devicePixelRatio=window.devicePixelRatio,this.canvasElement.width=this.canvasElement.width*window.devicePixelRatio,this.canvasElement.height=this.canvasElement.height*window.devicePixelRatio),this.context=this.canvasElement.getContext("2d"),this.context.imageSmoothingEnabled=!1,this.resources={audio:new n,graphics:new a(this.onGraphicsLoaded.bind(this))},window.devicePixelRatio&&(this.resources.graphics.TILE_SIZE.x=this.resources.graphics.TILE_SIZE.x*window.devicePixelRatio,this.resources.graphics.TILE_SIZE.y=this.resources.graphics.TILE_SIZE.y*window.devicePixelRatio),this.screenWidth=Math.floor(this.context.canvas.width/this.resources.graphics.TILE_SIZE.x),this.screenHeight=Math.floor(this.context.canvas.height/this.resources.graphics.TILE_SIZE.y),this.settings={audioActive:this.resources.audio.active,audioVolume:this.resources.audio.userVolume,audioMute:!1,language:h.getLanguage()}}else"function"==typeof t.onLoadCallback&&t.onLoadCallback(!1)}T.prototype.observeSettings=function(t){t.addListener(this.onSettingsChanged.bind(this)),t.initialize(this.settings)},T.prototype.addNotificationListener=function(t){this.notificationListeners.push(t)},T.prototype.serialize=function(){var t,e={};for(t in e.name=this.name,e.version=this.version,e.titleBoard=this.titleBoard,e.startingBoard=this.currentBoard.name,e.victoryBoard=this.victoryBoard,e.author=this.author,e.boards=[],e.counters={},e.savedGame=!0,this.counters)this.counters.hasOwnProperty(t)&&!isNaN(this.counters[t])&&(e.counters[t]=this.counters[t]);for(t in this.boards[this.currentBoard.name]=this.currentBoard.serialize(),this.boards)this.boards.hasOwnProperty(t)&&e.boards.push(this.boards[t]);return e},T.prototype.restartGame=function(){this.loadGame(this.gameUrl||this.cachedGame)},T.prototype.loadGame=function(t){var e,i,s=this;if(this.keyboard.cancelInput(),this.previousStates=[],this.setState(b.Loading),"string"==typeof t){this.gameUrl=t;try{(i=new XMLHttpRequest).onreadystatechange=function(){if(4===i.readyState)try{if(200!==i.status)throw"Unexpected HTTP request status "+i.status;e=JSON.parse(i.responseText),s.deserialize(e)}catch(t){s.catestrophicError(h.getMessage("status.loaderror"),t)}},i.open("GET",t,!0),i.send(null)}catch(t){this.catestrophicError(h.getMessage("status.loaderror"),t)}}else"object"==typeof t&&(this.cachedGame=t,this.deserialize(t))},T.prototype.catestrophicError=function(t,e){e&&console.error(t,e,e.stack||e),this.catestrophicErrorMessage=t,this.setState(b.Error)},T.prototype.deserialize=function(t){var e,i,s=!1;if(t.version&&t.version===this.version){for(e in this.isRunning()&&(s=!0,this.resources.audio.cancel(),this.end()),this.name=t.name,this.currentBoard=void 0,this.titleBoard=t.titleBoard,this.startingBoard=t.startingBoard,this.victoryBoard=t.victoryBoard,this.author=t.author,this.boards={},this.readMessages={},this.savedGame=!!t.savedGame,this.keyboard.cancelInput(),this.previousStates=[],this.resources.audio.setActive(!this.settings.audioMute),this.counters={HEALTH:50,HEALTH_MAX:50,AMMO:0,GEMS:0,TORCHES:0,SCORE:0,TORCHLIFE:0,"<PLAYTIME>":0},t.counters)t.counters.hasOwnProperty(e)&&!isNaN(t.counters[e])&&(this.counters[e]=t.counters[e]);for(e=0;e<t.boards.length;e+=1)i=t.boards[e],this.boards[i.name]=i;this.gameLoaded=!0,s&&this.run()}else this.catestrophicError(h.getMessage("status.incompatible"))},T.prototype.adjustCounter=function(t,e){this.setCounterValue(t,this.getCounterValue(t)+e)},T.prototype.getCounterValue=function(t){return void 0===this.counters[t]?0:this.counters[t]},T.prototype.setCounterValue=function(t,e){var i=t+"_MAX",s=0;void 0===this.counters[t]?this.counters[t]=0:s=this.counters[t],this.counters[i]&&e>this.counters[i]&&(e=this.counters[i]),e<=0?delete this.counters[t]:this.counters[t]=e,s!==e&&this.notifyListeners("counter",{counter:t,value:e,oldValue:s})},T.prototype.onGraphicsLoaded=function(){this.scroll=new c(this),this.fileManagement=new p(this),this.DARK_PATTERN=this.context.createPattern(this.resources.graphics.DARK_IMAGE,"repeat"),this.NOISE_PATTERN=this.context.createPattern(this.resources.graphics.NOISE_IMAGE,"repeat"),"function"==typeof this.onLoadCallback&&this.onLoadCallback(!0)},T.prototype.movePlayerToPassage=function(t,e){var i=e===this.currentBoard.name?this.currentBoard:this.getBoard(e),s=i?i.getPassage(t):void 0,o=this;void 0!==i&&s&&(i.entryPoint=s.point,this.transition.type="irisOut",this.transition.callback=function(){o.setBoard(i,s.point),o.transition.type="irisIn",o.transition.animationIndex=0,o.transition.callback=function(){o.setState(b.Playing)}},this.setState(b.Transition))},T.prototype.pushState=function(t){this.previousStates.push(this.state),this.keyboard.cancelInput(),this.setState(t)},T.prototype.restoreState=function(){this.previousStates.length>0&&(this.keyboard.cancelInput(),this.setState(this.previousStates.pop()))},T.prototype.setState=function(t){if(t===b.Paused)this.player.background=this.player.background.lighten(),this.keyboard.cancelInput();else if(t===b.Playing)this.keyboard.cancelKey(this.keyboard.P),this.state===b.Title&&(this.currentBoard=void 0,this.setBoard(this.startingBoard)),this.player.background=this.player.background.darken(),this.notifyListeners("playing");else if(t===b.Reading)this.keyboard.cancelInput(),this.player.eventScheduler.takeEvent(),this.scroll.open();else if(t===b.FileManagement){if(this.playTest)return;this.fileManagement.open(void 0,this.state===b.Title),this.notifyListeners("file-management")}else t===b.GameOver?(this.resources.audio.cancel(),this.resources.audio.play("s-cd#g+c-ga#+dgfg#+cf---q.c",!0),this.resources.audio.setActive(!1,!1),this.notifyListeners("game-over",{score:this.getCounterValue("SCORE")})):t===b.Title?(this.titleBoard?this.setBoard(this.titleBoard):this.setBoard(this.startingBoard),this.player&&(this.player.remove(),this.player.point.x=-1,this.player.point.y=-1)):t===b.Victory?(this.victoryBoard&&this.setBoard(this.victoryBoard),this.player&&(this.player.remove(),this.player.point.x=-1,this.player.point.y=-1),this.notifyListeners("victory",{score:this.getCounterValue("SCORE"),time:this.getCounterValue("<PLAYTIME>")})):t===b.Splash?this.splash=new d(this):t===b.Transition&&(this.transition.animationIndex=0);this.state=t},T.prototype.movePlayerToBoardEdge=function(t,e,i){var s=e===this.currentBoard.name?this.currentBoard:this.getBoard(e),o=new l(this.player.point.x,this.player.point.y),r=new l(this.player.point.x,this.player.point.y);if(void 0!==s){switch(!i||t!==u.North&&t!==u.South?!i||t!==u.East&&t!==u.West||(o.y=o.y+i,r.y=r.y+i):(o.x=o.x+i,r.x=r.x+i),t){case u.North:o.y=-1,r.y=0;break;case u.East:o.x=s.width,r.x=s.width-1;break;case u.South:o.y=s.height,r.y=s.height-1;break;case u.West:o.x=-1,r.x=0}s.moveTile(o,r,!1,!0)&&(s.entryPoint=r,this.setBoard(s,r))}},T.prototype.getBoard=function(t){if(this.boards.hasOwnProperty(t))return new f(this.boards[t],this)},T.prototype.setBoard=function(t,e){this.currentBoard&&this.currentBoard.setTile(this.player.point,this.player.under),this.currentBoard&&this.currentBoard.equals(t)||(void 0!==this.currentBoard&&(this.boards[this.currentBoard.name]=this.currentBoard.serialize()),this.currentBoard=t instanceof f?t:new f(this.boards[t],this),this.player=new g.Player(this.currentBoard),this.player.game=this),e&&(this.player.point.x=e.x,this.player.point.y=e.y,this.player.under=this.currentBoard.getTile(e)),this.currentBoard.dark&&this.getCounterValue("TORCHLIFE")<=0&&this.oneTimeMessage("status.dark"),this.currentBoard.initializePlayer(this.player)},T.prototype.run=function(t){t&&(this.gameToLoad=t),this.isRunning()||(this.keyboard.initialize(),this.previousStates=[],this.playTest&&this.initialLoad(),this.gameLoaded?this.savedGame?(this.setBoard(this.startingBoard),this.pause(!0)):this.setState(b.Title):this.setState(b.Splash),this.boundLoop=this.loop.bind(this),this.then=Date.now(),this.previousTimestamp=this.then,this.loopId=requestAnimationFrame(this.boundLoop))},T.prototype.loop=function(){try{var t=Date.now(),e=t-this.then,i=t-this.previousTimestamp;this.loopId=requestAnimationFrame(this.boundLoop),e>this.FPS_INTERVAL&&(this.then=t-e%this.FPS_INTERVAL,this.previousTimestamp=t,this.update(i),this.draw())}catch(t){this.catestrophicError(h.getMessage("status.fatalerror"),t)}},T.prototype.pause=function(t){void 0===t&&(t=!0),this.showStatsWhenPaused=t,this.setState(b.Paused)},T.prototype.end=function(){this.loopId&&(cancelAnimationFrame(this.loopId),this.loopId=void 0)},T.prototype.isRunning=function(){return this.loopId},T.prototype.update=function(t){this.resources.graphics.update(),this.state===b.Playing?(this.currentBoard.update(t),this.checkCounters(t),this.player.update(),this.currentBoard.focusPoint=this.player.point,this.adjustCounter("<PLAYTIME>",t),this.keyboard.isPressed(this.keyboard.P)||this.keyboard.isPressed(this.keyboard.ENTER)?(this.resources.audio.play("++se.tc.e.sc"),this.pause(!0)):this.keyboard.isPressed(this.keyboard.S)?(this.fileManagement.dialogType=p.Type.SAVE,this.pushState(b.FileManagement)):this.keyboard.isPressed(this.keyboard.R)&&(this.fileManagement.dialogType=p.Type.OPEN,this.pushState(b.FileManagement))):this.state===b.Paused?this.keyboard.isAnyPressed()&&(this.keyboard.cancelKey(this.keyboard.P),this.keyboard.cancelKey(this.keyboard.ENTER),this.setState(b.Playing),this.player.foregroundColor=y.F):this.state===b.Reading?(this.scroll.update(),this.adjustCounter("<PLAYTIME>",t)):this.state===b.FileManagement?this.fileManagement.update():this.state===b.GameOver?(this.currentBoard.update(),this.currentBoard.setDisplayMessage(h.getMessage("status.gameover")),(this.keyboard.isPressed(this.keyboard.R)||this.keyboard.isPressed(this.keyboard.ENTER))&&(this.fileManagement.dialogType=p.Type.OPEN,this.pushState(b.FileManagement))):this.state===b.Title?(this.currentBoard.update(),this.currentBoard.setDisplayMessage(h.getMessage("status.title")),this.keyboard.isPressed(this.keyboard.P)||this.keyboard.isPressed(this.keyboard.SPACE)||this.keyboard.isPressed(this.keyboard.ENTER)?(this.keyboard.cancelKey(this.keyboard.P),this.keyboard.cancelKey(this.keyboard.ENTER),this.keyboard.cancelKey(this.keyboard.SPACE),this.setState(b.Playing)):this.keyboard.isPressed(this.keyboard.R)&&(this.fileManagement.dialogType=p.Type.OPEN,this.pushState(b.FileManagement))):this.state===b.Victory?(this.currentBoard.update(),(this.keyboard.isPressed(this.keyboard.R)||this.keyboard.isPressed(this.keyboard.ENTER))&&(this.fileManagement.dialogType=p.Type.OPEN,this.pushState(b.FileManagement))):this.state===b.Loading?(this.loadingAnimationIndex+=1,this.loadingAnimationIndex>=4*g.Conveyor.animationFrames.length&&(this.loadingAnimationIndex=0)):this.state===b.Transition?(this.transition.animationIndex+=1,this.transition.animationIndex>=this.TRANSITION_STEPS&&(this.transition.callback(),this.transition.animationIndex=0)):this.state===b.Splash&&(this.splash.update(),this.splash.done&&(delete this.splash,this.initialLoad()))},T.prototype.initialLoad=function(){this.gameToLoad?(this.loadGame(this.gameToLoad),delete this.gameToLoad):this.setState(b.Error)},T.prototype.checkCounters=function(t){var e=this.getCounterValue("TORCHLIFE");this.getCounterValue("HEALTH")<=0&&this.state!==b.GameOver?this.setState(b.GameOver):e>0&&(e-=t,this.setCounterValue("TORCHLIFE",e),e<=0&&this.resources.audio.play("tc-c-c"))},T.prototype.oneTimeMessage=function(t){var e;this.readMessages.hasOwnProperty(t)||(this.readMessages[t]=!0,e=h.getMessage(t),this.currentBoard.setDisplayMessage(e))},T.prototype.notifyListeners=function(t,e){var i,s;for(i=0;i<this.notificationListeners.length;i+=1)(!(s=this.notificationListeners[i]).types||s.types.indexOf(t)>=0)&&s.callback(t,e)},T.prototype.drawScreenEffect=function(){var t,e=10*this.devicePixelRatio,i=Math.round(256*Math.random()),s=Math.round(256*Math.random());for(this.screenEffectIndex+=1,this.screenEffectIndex>e&&(this.screenEffectIndex=0),this.context.fillStyle=this.NOISE_PATTERN,this.context.save(),this.context.translate(i,s),this.context.scale(2*this.devicePixelRatio,2*this.devicePixelRatio),this.context.fillRect(-i,-s,this.context.canvas.width,this.context.canvas.height),this.context.restore(),this.context.lineWidth=4*this.devicePixelRatio,this.context.strokeStyle="rgba(0,0,0,0.05)",this.context.beginPath(),t=-e;t<this.context.canvas.height;t+=e)this.context.moveTo(0,t+this.screenEffectIndex+e),this.context.lineTo(this.context.canvas.width,t+this.screenEffectIndex);for(this.context.stroke(),this.context.beginPath(),t=-e;t<this.context.canvas.height;t+=e)this.context.moveTo(0,t+2*this.devicePixelRatio+this.screenEffectIndex+e),this.context.lineTo(this.context.canvas.width,t+2*this.devicePixelRatio+this.screenEffectIndex);this.context.stroke()},T.prototype.drawErrorScreen=function(){var t=this.errorPopup?this.errorPopup.spriteGrid:void 0,e=this.catestrophicErrorMessage.length+7;void 0!==this.errorPopup&&this.errorPopup.language===h.Messages.currentLanguage||(this.errorPopup=new v(void 0,new l(e,3),this),this.errorPopup.setColor(y.Red,y.White),(t=this.errorPopup.spriteGrid).addText(new l(2,1),this.catestrophicErrorMessage,y.BrightWhite),t.setTile(new l(e-4,1),58,y.Cycle),t.setTile(new l(e-3,1),40,y.Cycle)),this.errorPopup.render(this.context)},T.prototype.drawLoadingScreen=function(){this.loadingPopup&&this.loadingPopup.spriteGrid;void 0!==this.loadingPopup&&this.loadingPopup.language===h.Messages.currentLanguage||(this.loadingPopup=new v(void 0,new l(24,3),this),this.loadingPopup.setColor(y.Blue,y.White),this.loadingPopup.spriteGrid.addText(new l(4,1),h.getMessage("status.loading"),y.BrightWhite),this.loadingPopup.animationPosition=new l(2,1).add(this.loadingPopup.position)),this.loadingPopup.render(this.context),this.resources.graphics.getSprite(g.Conveyor.animationFrames[Math.floor(this.loadingAnimationIndex/4)]).draw(this.context,this.loadingPopup.animationPosition,y.Cycle)},T.prototype.drawPauseScreen=function(){var t,e,i,s,o=["9","A","B","C","D","E","F"],r=this;function n(t){var e=r.getCounterValue(t).toString();return r.getCounterValue(t+"_MAX")&&(e+="/"+r.getCounterValue(t+"_MAX").toString()),e}if(this.showStatsWhenPaused)for(void 0!==this.statusPopup&&this.statusPopup.language===h.Messages.currentLanguage||(this.statusPopup=new v(new l(this.screenWidth-25,1),new l(24,8),this),this.statusPopup.language=h.Messages.currentLanguage,this.statusPopup.setTitle(h.getMessage("pause.paused")),(t=this.statusPopup.spriteGrid).addText(new l(1,1),h.getMessage("pause.health"),y.Yellow),t.addText(new l(1,2),h.getMessage("pause.ammo"),y.Yellow),t.addText(new l(1,3),h.getMessage("pause.gems"),y.Yellow),t.addText(new l(1,4),h.getMessage("pause.torches"),y.Yellow),t.addText(new l(1,5),h.getMessage("pause.score"),y.Yellow),t.addText(new l(1,6),h.getMessage("pause.keys"),y.Yellow)),this.player.point.x>=this.currentBoard.windowOrigin.x+(this.screenWidth-24-2)?this.statusPopup.position.x=1:this.statusPopup.position.x=this.screenWidth-25,e=this.statusPopup.position,this.statusPopup.render(this.context),this.resources.graphics.drawString(this.context,e.add(new l(13,1)),n("HEALTH"),y.BrightWhite),this.resources.graphics.drawString(this.context,e.add(new l(13,2)),n("AMMO"),y.BrightWhite),this.resources.graphics.drawString(this.context,e.add(new l(13,3)),n("GEMS"),y.BrightWhite),this.resources.graphics.drawString(this.context,e.add(new l(13,4)),n("TORCHES"),y.BrightWhite),this.resources.graphics.drawString(this.context,e.add(new l(13,5)),n("SCORE"),y.BrightWhite),e=e.add(new l(13,6)),s=this.resources.graphics.getSprite(12),i=0;i<o.length;i+=1)this.getCounterValue("KEY"+o[i])>0&&(s.draw(this.context,e,m.deserializeForeground(o[i])),e.x+=1)},T.prototype.drawTransition=function(){var t,e,i,s=this,o=Math.max(this.currentBoard.windowOrigin.x,0),r=Math.max(this.currentBoard.windowOrigin.y,0),n=Math.min(this.currentBoard.windowOrigin.x+this.currentBoard.windowSize.x,this.currentBoard.width),a=Math.min(this.currentBoard.windowOrigin.y+this.currentBoard.windowSize.y,this.currentBoard.height),h=Math.sqrt((o/2-this.player.point.x/2)*(o/2-this.player.point.x/2)+(r-this.player.point.y)*(r-this.player.point.y)),c=Math.sqrt((o/2-this.player.point.x/2)*(o/2-this.player.point.x/2)+(a-this.player.point.y)*(a-this.player.point.y)),p=Math.sqrt((n/2-this.player.point.x/2)*(n/2-this.player.point.x/2)+(a-this.player.point.y)*(a-this.player.point.y)),d=Math.sqrt((n/2-this.player.point.x/2)*(n/2-this.player.point.x/2)+(r-this.player.point.y)*(r-this.player.point.y));e=this.transition.animationIndex/this.TRANSITION_STEPS,e="irisOut"===this.transition.type?1-e:e,i=Math.max(h,c,p,d)*e,t=w.generateCircleData(this.player.point,Math.ceil(i)),this.currentBoard.eachDisplayable(function(e,i){t.contains(i)||s.resources.graphics.fillTile(s.context,i.subtract(s.currentBoard.windowOrigin),y.Grey)})},T.prototype.draw=function(){if(this.currentBoard&&!this.errorInRender)try{this.currentBoard.render(this.context)}catch(t){this.errorInRender=!0,this.catestrophicError(h.getMessage("status.fatalerror"),t)}else this.context.fillStyle=y.Grey.rgbValue,this.context.fillRect(0,0,this.context.canvas.width,this.context.canvas.height);this.state===b.Paused?(this.drawScreenEffect(),this.drawPauseScreen()):this.state===b.Reading?(this.drawScreenEffect(),this.scroll.render(this.context)):this.state===b.FileManagement?(this.drawScreenEffect(),this.fileManagement.render(this.context)):this.state===b.Loading?(this.drawScreenEffect(),this.drawLoadingScreen()):this.state===b.Splash?(this.splash.render(this.context),this.drawScreenEffect()):this.state===b.Error?(this.drawScreenEffect(),this.drawErrorScreen()):this.state===b.Transition&&this.drawTransition()},T.prototype.onSettingsChanged=function(t){t.hasOwnProperty("audioMute")&&(this.settings.audioMute=t.audioMute,this.resources.audio.setActive(!t.audioMute&&this.state!==b.GameOver)),t.hasOwnProperty("audioVolume")&&(this.settings.audioVolume=t.audioVolume,this.resources.audio.userVolume=t.audioVolume),t.hasOwnProperty("language")&&(this.settings.language=t.language,h.setLanguage(t.language))},i.Game=T,i.version=x.version},{"./audio":2,"./basic":3,"./board":4,"./file-management":5,"./game-state":6,"./graphics":7,"./i18n":8,"./input":9,"./metadata":16,"./popup":18,"./scroll":19,"./things":20}],15:[function(t,e,i){"use strict";var s=t("./basic").ConstructorError;function o(t){return"\r"===t||"\n"===t}function r(t){return t>="a"&&t<="z"||t>="A"&&t<="Z"||"_"===t}function n(t){return t>="0"&&t<="9"}function a(t,e){if(!(this instanceof a))throw s;this.skipComments=void 0===e||e,this.setInput(t)}a.prototype.setInput=function(t){this.position=0,this.buffer=t,this.bufferLength=this.buffer.length,this.line=1,this.column=1},a.prototype.tokenizeAll=function(){for(var t=[],e=this.nextToken();e;)t.push(e),e=this.nextToken();return t},a.prototype.nextToken=function(){var t,e,i;if(this.consumeNonTokens(),!(this.position>=this.bufferLength)){if("/"===(t=this.getCharacter())&&"/"===this.getCharacter(1))return e=this.createCommentToken(),this.skipComments?this.nextToken():e;if('"'===t)return this.createStringToken();if("<"===t||">"===t||"="===t||":"===t)return"="===(i=this.getCharacter(1))&&"="!==t?this.createToken("OPERATOR",t+i):this.createToken("OPERATOR",t);if(","===t)return this.createToken("PUNCTUATION",t);if(o(t))return e=this.createToken("NEWLINE","[New Line]",1),this.column=1,this.line+=1,e;if(n(t))return this.createNumberToken();if(r(t))return this.createWordToken();throw"Unrecognized token on line "+this.line+", column "+this.column}},a.prototype.getCharacter=function(t){var e=void 0===t?this.position:this.position+t;if(!(e<0||e>=this.bufferLength))return this.buffer.charAt(e)},a.prototype.createCommentToken=function(){var t;for(t=this.position+"//".length;t<this.bufferLength&&!o(this.buffer.charAt(t));)t+=1;return this.createToken("COMMENT",this.buffer.substring(this.position+"//".length,t),t-this.position)},a.prototype.createStringToken=function(){var t,e,i="";for(e=this.position+1;e<this.bufferLength;)if("\\"===(t=this.buffer.charAt(e))&&'"'===this.buffer.charAt(e+1))i+='"',e+=2;else if("\\"===t&&"n"===this.buffer.charAt(e+1))i+="\n",e+=2;else{if('"'===t){e+=1;break}if(o(t))throw"Unterminated string literal on line "+this.line+", column "+this.column;i+=t,e+=1}return this.createToken("STRING",i,e-this.position)},a.prototype.createNumberToken=function(){for(var t=this.position;t<this.bufferLength&&n(this.buffer.charAt(t));)t+=1;return this.createToken("NUMBER",+this.buffer.substring(this.position,t),t-this.position)},a.prototype.createWordToken=function(){for(var t,e=this.position;e<this.bufferLength&&(r(t=this.buffer.charAt(e))||n(t));)e+=1;return this.createToken("WORD",this.buffer.substring(this.position,e))},a.prototype.consumeNonTokens=function(){for(;this.position<this.bufferLength;){if(" "!==(t=this.getCharacter())&&"\t"!==t&&"\r"!==t)return;this.position+=1,this.column+=1}var t},a.prototype.createToken=function(t,e,i){i=void 0===i?e.length:i;var s={name:t,value:e,line:this.line,column:this.column,position:this.position};return this.position+=i,this.column+=i,s},i.Lexer=a},{"./basic":3}],16:[function(t,e,i){e.exports={version:"1.0.58",date:1675525841552}},{}],17:[function(t,e,i){"use strict";var s=t("./basic").ConstructorError;function o(t){if(!(this instanceof o))throw s;this.tokens=t,this.index=0,this.stack=[],this.target=void 0}function r(){if(!(this instanceof r))throw s;this.assembler=void 0}function n(t){if(!(this instanceof n))throw s;if(!t)throw"Subparser is required.";this.subParser=t,this.assembler=void 0,this.preAssembler=void 0}function a(){if(!(this instanceof a))throw s;this.assembler=void 0}function h(){if(!(this instanceof h))throw s;this.assembler=void 0,this.subParsers=[]}function c(){if(!(this instanceof c))throw s;this.assembler=void 0,this.subParsers=[]}function p(){if(!(this instanceof p))throw s;this.assembler=void 0,this.subParsers=[]}function d(){if(!(this instanceof d))throw s;this.assembler=void 0,this.discard=!1}function l(){if(!(this instanceof l))throw s;this.assembler=void 0,this.discard=!1}function u(t,e){if(!(this instanceof u))throw s;this.assembler=void 0,this.caseSensitive=e,this.literalValue=t,this.discard=!1,e||(this.literalValue=this.literalValue.toUpperCase())}function f(){if(!(this instanceof f))throw s;this.assembler=void 0,this.discard=!1}function g(){if(!(this instanceof g))throw s;this.assembler=void 0,this.discard=!1}function y(){if(!(this instanceof y))throw s;this.assembler=void 0,this.discard=!1}o.prototype.clone=function(){var t=new o;return t.tokens=this.tokens.slice(0),t.index=this.index,t.stack=this.stack.slice(0),t.target=this.target?this.target.clone():void 0,t},o.prototype.current=function(){return this.tokens[this.index]},o.prototype.peek=function(){return this.stack[this.stack.length-1]},o.prototype.pop=function(){return this.stack.pop()},o.prototype.push=function(t){this.stack.push(t)},o.prototype.isDone=function(){return this.index>=this.tokens.length},o.prototype.next=function(){var t=this.tokens[this.index];return this.index+=1,t},r.prototype.match=function(){return[]},r.prototype.bestMatch=function(t){var e=this.matchAndAssemble([t]);return this.findBestAssembly(e)},r.prototype.completeMatch=function(t){var e,i=this.bestMatch(t);if(void 0!==i&&i.isDone())return i;throw"Unexpected token '"+(e=i.current()).value+"' on line "+e.line+", column "+e.column},r.prototype.matchAndAssemble=function(t){var e,i=this.match(t);if(this.assembler)for(e=0;e<i.length;e+=1)this.assembler.assemble(i[e]);return i},r.prototype.findBestAssembly=function(t){var e,i,s;for(i=0;i<t.length;i+=1)s=t[i],e?s.index>e.index&&(e=s):e=s;return e},r.prototype.cloneAssemblies=function(t){var e,i,s=[];for(e=0;e<t.length;e+=1)i=t[e],s.push(i.clone());return s},n.prototype=new r,n.prototype.constructor=n,n.prototype.match=function(t){var e,i,s;if(void 0!==this.preAssembler)for(e=0;e<t.length;e+=1)i=t[e],this.preAssembler.assemble(i);for(s=this.cloneAssemblies(t);t.length>0;)t=this.subParser.matchAndAssemble(t),s=s.concat(t);return s},a.prototype=new r,a.prototype.constructor=a,a.prototype.match=function(t){return this.cloneAssemblies(t)},h.prototype=new r,h.constructor=h,h.prototype.add=function(t){this.subParsers.push(t)},h.prototype.addDiscard=function(t){t.discard=!0,this.subParsers.push(t)},c.prototype=new h,c.prototype.constructor=c,c.prototype.match=function(t){var e,i=!1,s=t,o=t;for(e=0;e<this.subParsers.length;e+=1){if((o=this.subParsers[e].matchAndAssemble(o)).length<=0)return i&&this.determineTokenError(s),o;i=!0,s=o}return o},c.prototype.determineTokenError=function(t){var e,i=this.findBestAssembly(t);if(void 0===i.current())throw"Token expected";throw"Unexpected token '"+(e=i.current()).value+"' on line "+e.line+", column "+e.column},p.prototype=new h,p.prototype.constructor=p,p.prototype.match=function(t){var e,i,s,o,r=[];for(o=0;o<this.subParsers.length;o+=1){i=this.subParsers[o];try{s=i.matchAndAssemble(t),r=r.concat(s)}catch(t){e=t}}if(r.length<=0&&void 0!==e)throw e;return r},d.prototype=new r,d.prototype.constructor=d,d.prototype.qualifies=function(){return!0},d.prototype.match=function(t){var e,i,s,o=[];for(e=0;e<t.length;e+=1)i=t[e],void 0!==(s=this.matchAssembly(i))&&o.push(s);return o},d.prototype.matchAssembly=function(t){var e,i;if(!t.isDone())return this.qualifies(t.current())?(i=(e=t.clone()).next(),this.discard||e.stack.push(i),e):void 0},l.prototype=new d,l.prototype.qualifies=function(t){return"NUMBER"===t.name&&!isNaN(t.value)},u.prototype=new d,u.prototype.constructor=u,u.prototype.qualifies=function(t){var e=t.value;return"string"!=typeof e||this.caseSensitive||(e=e.toUpperCase()),this.literalValue===e},f.prototype=new d,f.prototype.constructor=f,f.prototype.qualifies=function(t){return"WORD"===t.name&&isNaN(parseInt(t.value,10))},g.prototype=new d,g.prototype.constructor=g,g.prototype.qualifies=function(t){return"STRING"===t.name},y.prototype=new d,y.prototype.constructor=y,y.prototype.qualifies=function(t){return"NEWLINE"===t.name},i.Alternation=p,i.Assembly=o,i.Parser=r,i.Repetition=n,i.CollectionParser=h,i.Sequence=c,i.Empty=a,i.Terminal=d,i.Literal=u,i.NewLine=y,i.Number=l,i.String=g,i.Word=f},{"./basic":3}],18:[function(t,e,i){"use strict";var s=t("./basic").Point,o=t("./graphics").SpriteGrid,r=t("./graphics").Colors,n=t("./metadata");function a(t,e,i){t?this.position=t:(this.position=new s(0,0),this.position.x=Math.floor((i.screenWidth-e.x)/2),this.position.y=Math.floor((i.screenHeight-e.y)/2)),this.title=void 0,this.size=e,this.game=i,this.graphics=i.resources.graphics,this.spriteGrid=new o(this.size.x,this.size.y,this.graphics),this.setColor(r.Blue,r.BrightWhite)}function h(){this.startTime=Date.now(),this.renderFunctions=[]}function c(t){var e;this.game=t,this.animator=new h,this.done=!1,this.animationFrame=void 0,this.popup=new a(void 0,new s(50,20),t),this.popup.setColor(r.Black),this.popup.spriteGrid.clear(),e=this.popup.spriteGrid,this.animator.start(function(){e.addText(new s(1,1),"┌───┐",r.White),e.addText(new s(1,2),"│ o┌┴──┐ Association of",r.White),e.addText(new s(1,3),"└─┬┴──┐│ Shareware",r.White),e.addText(new s(1,4),"  │ o ├┘ Unprofessionals",r.White),e.addText(new s(1,5),"  └─┴─┘",r.White)}).then(300,function(){e.addText(new s(1,7),"x286 BIOS Version 2.1.16",r.White)}).then(400,function(){e.addText(new s(1,9),"Initializing Nostalgia Boot Agent v1.4.14",r.White),t.resources.audio.play("i++c")}).then(600,function(){e.addText(new s(1,10),"Nostalgia Boot Agent (v1.4.14) Loaded.",r.White)}).then(700,function(){e.addText(new s(1,12),"Starting Markrosoft DOS...",r.White)}).then(1200,function(){e.addText(new s(1,14),"Running autoexec.bat",r.White)}).then(1300,function(){e.addText(new s(1,15),"C:\\>cd JZT",r.White),e.addText(new s(1,16),"C:\\JZT\\>exe",r.White)}).then(2e3,function(){e.clear(),e.addArt(new s(7,5)," 0 0 0 0 0 0 0▄F▄F▀F▀F▀F▀F▀F█F▄F▄F▄F▀F▀F▀F▀F▀F▀F▄F F F▄F▄F▀F▀F▀F▀F▀F▀F▀F▄F\n 0 0 0▄F▄F▀F▀F▄9▄9█9█9█9▀9▄F▀F▄9▄9▄9█9█9█9█9▓9 0█F▀F▀F▄9▄9█9█9█9█9█9▀9 0█F\n 0 0█F 0▄9█9█9█9█9█9▓9 0▄F▀F█9█9▀9▀9▀9▀9 0█9▓9▓F 0█9█9█9▀9█9▓9▀9 0▄F▄F▀F▀F\n 0 0█F▄F▀9▀9 0▄F 0█9▓9 0▓F▄F▄F▄F▓F█F▀F▄9█9▓9 0▓F 0▀9▀9 0 0█9▓9 0█F\n 0 0 0 0▀F▀F▀F█F 0█9▓9 0█F 0 0█F▀F▄9█9█9▓9 0█F▀F▀F▀F▀F█F 0█9▓9 0▓F\n 0▄F▀F▀F▄F 0 0█F 0█9▓9 0▓F▄F▀F 0█9█9▓9 0▄F█F▄F 0 0 0 0█F 0█9▓9 0▓F\n█F 0█9█9 0▀F▀F▄9█9▓9▀9 0▓F█F 0█9▓9▀9 0▀F 0▄9▄9▀F▄F 0█F 0█9▓9▀9▄F▀F\n▀F▄F 0█9█9█9█9▓9█9▀9▄F▀F█F 0█9█9█9█9█9█9█9▓9▓9 0▓F 0█F 0█9▓9 0▓F\n 0 0▀F▄F▀9▀9▀9▀9▄F▀F 0▀F▄F▀9▀9▀9▀9▀9▀9▄F▄F▄F▄F▄F▀F F F▀F▄F▄F▄F▀F\n 0 0 0 0▀F▀F▀F▀F F F F F F▀F▀F▀F▀F▀F▀F"),e.addText(new s(46-n.version.length,15),n.version,r.Grey),e.addText(new s(13,18),"Created by Mark McIntyre",r.Grey),e.addText(new s(6,19),"(c) "+new Date(n.date).getFullYear()+" Mark McIntyre",r.Grey)}).end(4e3)}a.prototype.setTitle=function(t){this.title=t,this.redraw()},a.prototype.render=function(t){var e=this.position.x,i=this.position.y,s=this.size.x,o=this.size.y;t.fillStyle=this.background.rgbValue,t.fillRect(e*this.graphics.TILE_SIZE.x,i*this.graphics.TILE_SIZE.y,s*this.graphics.TILE_SIZE.x,o*this.graphics.TILE_SIZE.y),this.spriteGrid.draw(t,this.position)},a.prototype.redraw=function(){this.spriteGrid.clear(),this.createBorder(this.spriteGrid)},a.prototype.setColor=function(t,e,i,s){this.background=t,this.foreground=e,this.scrollbarBackground=i||t,this.scrollbarForeground=s||e,this.redraw()},a.prototype.setScrollBar=function(t,e,i){var o,r=this.size.y-4,n=new s(this.size.x-2,1),a=Math.max(1,Math.floor(r*(i/e)));for(o=Math.round(t/(e-i)*(r-a)),o=Math.min(r-a-1,o),n.y=1;n.y<this.size.y-1;n.y+=1)1===n.y?this.spriteGrid.setTile(n,30,this.scrollbarForeground,this.scrollbarBackground):n.y===this.size.y-2?this.spriteGrid.setTile(n,31,this.scrollbarForeground,this.scrollbarBackground):n.y-2>=o&&n.y-2<=o+a?this.spriteGrid.setTile(n,219,this.scrollbarForeground):this.spriteGrid.setTile(n,177,this.scrollbarForeground,this.scrollbarBackground)},a.prototype.createBorder=function(t){var e,i,o=new s(0,0),r=this.size.x,n=this.size.y;for(t.setTile(new s(0,0),218,this.foreground),t.setTile(new s(r-1,0),191,this.foreground),o.x=1;o.x<r-1;o.x+=1)o.y=0,t.setTile(o,196,this.foreground),o.y=n-1,t.setTile(o,196,this.foreground);for(o.y=1;o.y<n-1;o.y+=1)o.x=0,t.setTile(o,179,this.foreground),o.x=r-1,t.setTile(o,179,this.foreground);t.setTile(new s(0,n-1),192,this.foreground),t.setTile(new s(r-1,n-1),217,this.foreground),this.title&&(e=" "+this.title+" ",i=Math.round((r-e.length)/2),this.spriteGrid.addText(new s(i,0),e,this.foreground))},h.prototype.start=function(t){return t.frameTime=0,this.renderFunctions.push(t),this},h.prototype.end=function(t){this.then(t,function(){})},h.prototype.update=function(){var t,e,i=Date.now()-this.startTime;for(e=this.renderFunctions.length-1;e>=0;e-=1)i>=(t=this.renderFunctions[e]).frameTime&&(t(),this.renderFunctions.splice(e,1))},h.prototype.then=function(t,e){return e.frameTime=t,this.renderFunctions.push(e),this},h.prototype.isDone=function(){return this.renderFunctions.length<=0},c.prototype.update=function(){this.animator.update(),this.done=this.animator.isDone()},c.prototype.render=function(t){this.popup.render(t)},i.Popup=a,i.Splash=c},{"./basic":3,"./graphics":7,"./metadata":16}],19:[function(t,e,i){"use strict";var s=t("./basic").ConstructorError,o=t("./basic").Point,r=t("./basic").DelayedEventScheduler,n=t("./game-state").GameState,a=t("./graphics").Colors;function h(t){if(!(this instanceof h))throw s;this.game=t,this.graphics=t.resources.graphics,this.lines=[],this.position=0,this.cursor=-1,this.screenWidth=t.screenWidth,this.screenHeight=t.screenHeight,this.width=48,this.textAreaWidth=this.width-8,this.height=0,this.fullHeight=Math.min(Math.floor(t.context.canvas.height/this.graphics.TILE_SIZE.y)-2,24),this.textAreaHeight=this.fullHeight-4,this.state=h.ScrollState.Opening,this.origin=new o(0,0),this.cycleCount=0,this.labels=[],this.eventScheduler=new r(2*this.game.CYCLE_TICKS,0),this.graphics.getSprite(32),this.setHeight(0),this.setPosition(0)}h.ScrollState={Opening:0,Open:1,Closing:2,Closed:3},h.ScrollAction={Up:0,Down:1,Select:2,Exit:3},h.prototype.open=function(){this.state=h.ScrollState.Opening},h.prototype.addLine=function(t,e,i){var s,o,r,n,a=t.split(/\s+/),h=i?this.textAreaWidth-2:this.textAreaWidth,c=this;function p(t){o=c.graphics.textToSprites(t),e&&(o.center=e),i&&(o.label=i,c.labels.push(c.lines.length)),c.lines.push(o)}for(i&&this.lines.length>0&&this.lines[this.lines.length-1].label||this.lines.length>0&&c.lines.push([]),r=i?"":" ",n="",s=0;s<a.length;s+=1)(n=a[s]).length>h&&(n=n.substring(0,h)),r.length>0&&r.length<h&&(r+=" "),r.length>0&&r.length+n.length>h&&(p(r),r=""),r+=n;p(r)},h.prototype.setPosition=function(t){t>this.lines.length-this.textAreaHeight&&(t=this.lines.length-this.textAreaHeight),t<0&&(t=0),this.position=t},h.prototype.scrollUp=function(){var t,e=this.getVisibleLabels();if(e.length)if(e[0]===this.cursor)this.setPosition(this.position-1);else{for(t=e.length-1;e[t]>=this.cursor;)t-=1;this.cursor=e[t]}else this.setPosition(this.position-1),e=this.getVisibleLabels(),this.cursor=e.length?e[0]:-1},h.prototype.scrollDown=function(){var t,e=this.getVisibleLabels();if(e.length)if(e[e.length-1]===this.cursor)this.setPosition(this.position+1);else{for(t=0;e[t]<=this.cursor;)t+=1;this.cursor=e[t]}else this.setPosition(this.position+1),e=this.getVisibleLabels(),this.cursor=e.length?e[0]:-1},h.prototype.setTitle=function(t){t?(this.title=this.graphics.textToSprites(t),this.title.center=!0):this.title=void 0},h.prototype.getVisibleLabels=function(){var t=[],e=0;if(this.labels.length)for(e=this.position;e<Math.min(this.lines.length,this.position+this.textAreaHeight);++e)this.lines[e].label&&t.push(e);return t},h.prototype.getCurrentLabel=function(){return this.cursor>=0?this.lines[this.cursor].label:void 0},h.prototype.setHeight=function(t){this.height=t,this.textAreaHeight=this.title?this.height-4:this.height-2,this.textAreaHeight<0&&(this.textAreaHeight=0),this.origin.x=Math.floor((this.screenWidth-this.width)/2),this.origin.y=Math.floor((this.screenHeight-this.height)/2)},h.prototype.doTick=function(){var t,e=this.eventScheduler.takeEvent();e===h.ScrollAction.Up?this.scrollUp():e===h.ScrollAction.Down?this.scrollDown():e===h.ScrollAction.Select?(this.state=h.ScrollState.Closing,(t=this.getCurrentLabel())&&this.listener&&this.listener.sendMessage(t)):e===h.ScrollAction.Exit&&(this.state=h.ScrollState.Closing)},h.prototype.update=function(){var t,e=this.game.keyboard;this.state===h.ScrollState.Opening?(this.setHeight(this.height+2),this.setPosition(0),this.height>=Math.min(this.fullHeight,this.lines.length+4)&&(this.setHeight(Math.min(this.fullHeight,this.lines.length+4)),(t=this.getVisibleLabels()).length&&(this.cursor=t[0]),this.state=h.ScrollState.Open)):this.state===h.ScrollState.Open?(e.isPressed(e.UP)?this.eventScheduler.scheduleEvent(e.isPressed(e.UP),h.ScrollAction.Up):e.isPressed(e.DOWN)?this.eventScheduler.scheduleEvent(e.isPressed(e.DOWN),h.ScrollAction.Down):e.isPressed(e.ENTER)?this.eventScheduler.scheduleEvent(e.isPressed(e.ENTER),h.ScrollAction.Select):e.isPressed(e.ESCAPE)||e.isPressed(e.SPACE)?this.eventScheduler.scheduleEvent(e.isPressed(e.ESCAPE),h.ScrollAction.Exit):this.eventScheduler.cancelEvent(),this.cycleCount+=1,this.cycleCount>=this.game.CYCLE_RATE&&(this.cycleCount=0,this.doTick())):this.state===h.ScrollState.Closing?(this.setHeight(this.height-2),this.height<=2&&(this.state=h.ScrollState.Closed)):this.state===h.ScrollState.Closed&&this.game.setState(n.Playing)},h.prototype.clearLines=function(){this.lines=[],this.labels=[],this.setPosition(0),this.cursor=-1},h.prototype.drawLine=function(t){var e,i=this.position+t,s=this.lines[i],o=this.title?3:1;s&&((e=this.origin.clone()).x+=4,e.y+=o+t,s.selected=this.position+t===this.cursor,this.drawText(s,e))},h.prototype.drawText=function(t,e){var i=a.Yellow;t.center&&(i=a.BrightWhite,e.x+=Math.floor((this.textAreaWidth-t.length)/2)),t.label&&(i=a.BrightWhite,t.selected?this.graphics.getSprite(16).draw(this.game.context,e,a.Cycle):this.graphics.getSprite(7).draw(this.game.context,e,a.White),e.x+=2),this.graphics.drawSprites(this.game.context,e,t,i,void 0)},h.prototype.drawScrollBar=function(t,e,i,s,o,r){var n,h,c=i-2,p=Math.max(1,Math.floor(c*(o/r))),d=r-o;for(e=e.clone(),n=Math.ceil(s/d*(c-p-2)),h=0;h<i;h+=1,e.y+=1)0===h?this.graphics.getSprite(30).draw(t,e,a.BrightBlue):h===i-1?this.graphics.getSprite(31).draw(t,e,a.BrightBlue):h>=n+1&&h<=n+1+p?this.graphics.getSprite(219).draw(t,e,a.BrightBlue):this.graphics.getSprite(177).draw(t,e,a.BrightBlue)},h.prototype.render=function(t){var e,i,s,r,n=[],c=this.origin.x,p=this.origin.y;for(t.fillStyle=a.Blue.rgbValue,t.fillRect(c*this.graphics.TILE_SIZE.x,p*this.graphics.TILE_SIZE.y,this.width*this.graphics.TILE_SIZE.x,this.height*this.graphics.TILE_SIZE.y),n.push(this.graphics.getSprite(218)),s=this.width-1,e=this.graphics.getSprite(196);s-1>0;)s-=1,n.push(e);if(n.push(this.graphics.getSprite(191)),this.graphics.drawSprites(t,new o(c,p),n,a.BrightWhite),this.title&&this.height>3){for((n=[]).push(this.graphics.getSprite(179)),s=this.width-1,e=this.graphics.getSprite(32);s-1>0;)s-=1,n.push(e);n.push(this.graphics.getSprite(179)),r=new o(c,p+=1),this.graphics.drawSprites(t,r,n,a.BrightWhite),this.title&&(r.x+=4,this.drawText(this.title,r))}if(this.title&&this.height>2){for((n=[]).push(this.graphics.getSprite(195)),s=this.width-1,e=this.graphics.getSprite(196);s-1>0;)s-=1,n.push(e);n.push(this.graphics.getSprite(180)),p+=1,this.graphics.drawSprites(t,new o(c,p),n,a.BrightWhite)}if(!this.title||this.height>4)for(i=0;i<this.textAreaHeight;i+=1){for((n=[]).push(this.graphics.getSprite(179)),s=this.width-1,e=this.graphics.getSprite(32);s-1>0;)s-=1,n.push(e);n.push(this.graphics.getSprite(179)),p+=1,this.graphics.drawSprites(t,new o(c,p),n,a.BrightWhite),this.drawLine(i)}if(this.height>1){for((n=[]).push(this.graphics.getSprite(192)),s=this.width-1,e=this.graphics.getSprite(196);s-1>0;)s-=1,n.push(e);n.push(this.graphics.getSprite(217)),p+=1,this.graphics.drawSprites(t,new o(c,p),n,a.BrightWhite)}this.state===h.ScrollState.Open&&this.lines.length>this.textAreaHeight&&this.drawScrollBar(t,new o(this.origin.x+this.width-2,this.origin.y+3),this.height-4,this.position,this.textAreaHeight,this.lines.length-1)},i.Scroll=h},{"./basic":3,"./game-state":6,"./graphics":7}],20:[function(t,e,i){"use strict";var s=t("./basic").Point,o=t("./graphics").Colors,r=t("./graphics").ColorUtilities,n=t("./basic").utilities,a=t("./basic").Direction,h=t("./game-state").GameState,c=t("./jzt-script-context").JztScriptContext,p=t("./basic").DelayedEventScheduler,d=t("./i18n"),l={};function u(t,e){i.things[t]=e,e.type=t}function f(t){this.spriteIndex=63,this.board=t,this.point=new s(0,0),this.foreground=o.Yellow,this.background=void 0,this.type=this.constructor.type}function g(t){f.call(this,t),this.cycleCount=0,this.speed=3}function y(t){g.call(this,t),this.name="UnknownScriptable",this.scriptContext=void 0,this.messageQueue=[],this.walkDirection=void 0,this.locked=!1,this.orientation=void 0,this.spriteIndex=1,this.torchRadius=void 0,this.pushable=!1}function m(t){g.call(this,t),this.timeToLive=9,this.speed=6,this.spriteIndex=57,this.radius=4,this.conveyable=!0}function w(t){f.call(this,t),this.spriteIndex=132,this.background=void 0,this.foreground=o.Cyan}function v(t){g.call(this,t),this.spriteIndex=153,this.background=void 0,this.foreground=o.Brown,this.sensitivity=9,this.speed=3,this.conveyable=!0}function b(t){g.call(this,t),this.direction=a.North,this.period=3,this.delay=0,this.currentTick=0,this.spriteIndex=206,this.background=void 0,this.foreground=o.Yellow,this.blinkState=!1}function x(t){f.call(this,t),this.horizontal=!1,this.background=void 0,this.foreground=o.Yellow}function T(t){f.call(this,t),this.radius=4,this.spriteIndex=11,this.conveyable=!0}function S(t){f.call(this,t),this.conveyable=!0,this.spriteIndex=254}function E(t){f.call(this,t),this.spriteIndex=177,this.background=o.Black,this.foreground=o.BrightCyan}function k(t){g.call(this,t),this.spriteIndex=248,this.foreground=o.BrightWhite,this.background=void 0,this.direction=a.North,this.speed=1}function C(t){g.call(this,t),this.spriteIndex=79,this.foreground=o.BrightBlue,this.background=void 0,this.speed=3,this.follower=void 0,this.head=!1,this.leader=void 0,this.linked=!1,this.firstTick=!0,this.orientation=void 0,this.deviance=0,this.intelligence=0}function P(t){g.call(this,t),this.clockwise=!0,this.animationIndex=Math.floor(Math.random()*P.animationFrames.length-1),this.spriteIndex=179}function M(t){f.call(this,t),this.spriteIndex=10,this.foreground=o.BrightWhite,this.background=o.Blue}function I(t){g.call(this,t),this.MAX_STEPS=20,this.copyDirection=a.East,this.speed=10,this.spriteIndex=250,this.background=void 0,this.currentStep=0,this.foreground=o.BrightWhite}function O(t){g.call(this,t),this.radius=4,this.timeToLive=O.MAX_TTL,this.speed=1,this.spriteIndex=0}function B(t){f.call(this,t),this.spriteIndex=178,this.foreground=o.Yellow,this.background=o.Black}function A(t){f.call(this,t),this.spriteIndex=176,this.foreground=o.Black,this.background=o.Green}function L(t){f.call(this,t),this.spriteIndex=4,this.background=void 0,this.foreground=o.BrightMagenta,this.conveyable=!0}function R(t){f.call(this,t),this.foreground=o.Grey,this.background=void 0}function z(t){f.call(this,t),this.spriteIndex=3,this.foreground=o.BrightRed,this.background=void 0,this.conveyable=!0}function N(t){f.call(this,t),this.spriteIndex=0,this.foreground=o.BrightGreen}function F(t){f.call(this,t),this.spriteIndex=12,this.background=void 0,this.foreground=o.BrightBlue,this.conveyable=!0}function D(t){f.call(this,t),this.background=o.BrightRed,this.foreground=o.BrightRed,this.cycleCount=0,this.cycleRate=5*t.game.CYCLE_RATE,this.spriteIndex=176}function W(t){f.call(this,t),this.foreground=o.BrightBlue,this.spriteIndex=void 0}function U(t){g.call(this,t),this.intelligence=3,this.spriteIndex=234,this.foreground=o.BrightRed,this.background=void 0,this.speed=2,this.conveyable=!0}function H(t){f.call(this,t),this.spriteIndex=240,this.foreground=o.BrightWhite,this.background=o.Blue,this.targetBoard=void 0,this.passageId=0,this.glow=!0}function G(t){g.call(this,t),this.name="Player",this.spriteIndex=2,this.point=new s(-1,-1),this.foreground=o.BrightWhite,this.background=o.Blue,this.conveyable=!0,t&&(this.eventScheduler=new p(2*t.game.CYCLE_TICKS,0)),this.game=void 0,this.speed=1,this.glow=!0}function V(t){g.call(this,t),this.orientation=a.South,this.speed=3,this.initializeSprite()}function j(t){f.call(this,t),this.spriteIndex=42,this.background=void 0,this.foreground=o.BrightGreen}function _(t){f.call(this,t),this.direction=a.North,this.background=o.Blue,this.foreground=o.BrightBlue,this.speed=1,this.initialize()}function q(t){g.call(this,t),this.spriteIndex=5,this.background=void 0,this.foreground=o.BrightMagenta,this.intelligence=5,this.restingTime=5,this.moving=!1,this.timeLeft=0,this.speed=1,this.orientation=a.North,this.conveyable=!0}function K(t){f.call(this,t),this.spriteIndex=209,this.background=void 0,this.foreground=o.Brown,this.text=void 0}function Y(t){f.call(this,t),this.spriteIndex=29,this.background=void 0,this.foreground=o.BrightWhite}function Z(t){f.call(this,t),this.spriteIndex=18,this.background=void 0,this.foreground=o.BrightWhite}function X(t){g.call(this,t),this.spriteIndex=235,this.background=void 0,this.foreground=o.Green,this.conveyable=!0,this.speed=3}function J(t){f.call(this,t),this.spriteIndex=219}function Q(t){g.call(this,t),this.spriteIndex=15,this.foreground=o.BrightRed,this.background=void 0,this.intelligence=5,this.speed=1}function $(t){f.call(this,t),this.spriteIndex=void 0,this.foreground=o.Grey,this.background=void 0}function tt(t){g.call(this,t),this.intelligence=5,this.firingRate=5,this.spriteIndex=24,this.animationIndex=Math.floor(Math.random()*tt.animationFrames.length-1),this.speed=2}function et(t){g.call(this,t),this.orientation=a.East,this.animationFrame=2,this.speed=3}function it(t){f.call(this,t),this.i18n={en:0},this.foreground=o.BrightWhite,this.background=o.Blue}function st(t){g.call(this,t),this.speed=1,this.spriteIndex=179,this.animationIndex=Math.floor(Math.random()*st.animationFrames.length-1),this.foreground=o.Cycle,this.timeToLive=255,this.nextMove=Math.floor(2*Math.random())}function ot(t){g.call(this,t),this.spriteIndex=227,this.foreground=o.BrightCyan,this.background=void 0,this.intelligence=5,this.firingRate=5,this.speed=2,this.conveyable=!0}function rt(t){f.call(this,t),this.spriteIndex=157,this.glow=!0}function nt(t){f.call(this,t),this.spriteIndex=178}function at(t){f.call(this,t),this.spriteIndex=176,this.background=o.BrightWhite,this.foreground=o.BrightBlue}i.things={},f.prototype.serialize=function(){var t={};return t.type=this.constructor.type,t.color=r.serialize(this.background,this.foreground),this.under&&(t.under=this.under.serialize()),t},f.prototype.deserialize=function(t){t.color?(this.foreground=r.deserializeForeground(t.color),this.background=r.deserializeBackground(t.color)):(this.foreground||(this.foreground=o.Yellow),this.background=void 0),t.under&&(this.under=l.deserialize(t.under,this.board))},f.prototype.play=function(t,e,i){i&&this.board.game.resources.audio.isPlaying()||this.board.game.resources.audio.play(t,e)},f.prototype.adjustCounter=function(t,e){this.board.game.adjustCounter(t,e)},f.prototype.setCounterValue=function(t,e){this.board.game.setCounterValue(t,e)},f.prototype.getCounterValue=function(t){return this.board.game.getCounterValue(t)},f.prototype.sendMessage=function(){},f.prototype.push=function(){},f.prototype.isSurrenderable=function(){return!1},f.prototype.isBlocked=function(t){var e,i=this.point.add(t);return!this.board.isFree(i)&&(!!this.board.isOutside(i)||((e=this.board.getTile(i))?!e.isSurrenderable(this):void 0))},f.prototype.isPlayerVisible=function(t){var e=n.generateLineData(this.point,this.board.player.point),i=this,o=this.point,r=!0;function a(t){var e=i.board.getTile(t);return e&&e!==i&&"Player"!==e.type}return!(e.points.length>t)&&(e.forEach(function(t){o.x!==t.x&&o.y!==t.y&&(a(new s(o.x,t.y))||a(new s(t.x,o.y)))&&(r=!1),a(t)&&(r=!1),o=t}),r)},f.prototype.isPlayerAdjacent=function(t){var e=this,i=!1;function s(t){var s=e.board.getTile(e.point.add(t));s&&"Player"===s.type&&(i=!0)}return t?s(t):a.each(s),i},f.prototype.isPlayerAligned=function(t,e){return this.point.aligned(this.board.player.point,t,e)},f.prototype.move=function(t,e){return this.board.moveTile(this.point,this.point.add(t),e)},f.prototype.remove=function(){this.removed=!0,this.board.deleteTile(this.point)},f.prototype.getSpriteIndex=function(){return this.spriteIndex},f.prototype.getAdjacentThing=function(t){return this.board.getTile(this.point.add(t))},f.prototype.equals=function(t){var e=t.type.toUpperCase(),i=t.color?r.deserializeForeground(t.color):void 0;return this.constructor.type.toUpperCase()===e&&(void 0===i||i===this.foreground)},f.prototype.oneTimeMessage=function(t){this.board.game.oneTimeMessage(t)},f.prototype.clone=function(){var t=this.serialize();return l.deserialize(t,this.board)},g.prototype=new f,g.prototype.serialize=function(){var t=f.prototype.serialize.call(this)||{};return t.speed=this.speed,t},g.prototype.deserialize=function(t){f.prototype.deserialize.call(this,t),t.speed&&(this.speed=t.speed),this.cycleCount=Math.floor(Math.random()*this.speed)},g.prototype.getPlayerDirection=function(t){return this.point.directionTo(this.board.player.point,t)},g.prototype.getSmartDirection=function(){return this.board.getSmartDirection(this.point)},g.prototype.influenceSmartPath=function(){},g.prototype.isAttackable=function(t){return!this.isBlocked(t)||this.isPlayerAdjacent(t)},g.prototype.getAttackableDirections=function(){var t=[],e=this;return a.each(function(i){e.isAttackable(i)&&t.push(i)}),t},g.prototype.getFreeDirections=function(){var t=[],e=this;return a.each(function(i){e.isBlocked(i)||t.push(i)}),t},g.prototype.getBlockedDirections=function(){var t=[],e=this;return a.each(function(i){e.isBlocked(i)&&t.push(i)}),t},g.prototype.update=function(){this.removed||(this.board.game.state!==h.GameOver?(this.cycleCount+=1,this.cycleCount>=this.speed*this.board.game.CYCLE_RATE&&(this.cycleCount=0,this.doTick())):this.doTick())},g.prototype.updateOnReverse=function(){return!1},g.prototype.doTick=function(){},y.prototype=new g,y.prototype.constructor=y,y.prototype.serialize=function(){var t=g.prototype.serialize.call(this)||{};return t.name=this.name,t.spriteIndex=this.spriteIndex,t.script=this.scriptName,n.storeOption(t,"pushable",this.pushable,!1),this.torchRadius>0&&(t.torchRadius=this.torchRadius),this.scriptContext&&(this.scriptContext.inDefaultState()||(t.scriptContext=this.scriptContext.serialize()),this.messageQueue.length>0&&(t.messageQueue=this.messageQueue.slice(0)),n.storeOption(t,"walkDirection",a.getName(this.walkDirection)),n.storeOption(t,"locked",this.locked,!1),n.storeOption(t,"orientation",a.getName(this.orientation))),t},y.prototype.deserialize=function(t){g.prototype.deserialize.call(this,t),this.name=t.name||"UnknownScriptable",this.spriteIndex=void 0!==t.spriteIndex?t.spriteIndex:1,this.setTorchRadius(void 0!==t.torchRadius?t.torchRadius:0),this.pushable=void 0!==t.pushable&&t.pushable,this.locked=t.locked,t.walkDirection&&(this.walkDirection=a.fromName(t.walkDirection)),t.orientation&&(this.orientation=a.fromName(t.orientation)),this.scriptName=t.script;var e=this.board.getScript(this.scriptName);e&&(this.scriptContext=new c(e,this),t.scriptContext&&this.scriptContext.deserialize(t.scriptContext),Array.isArray(t.messageQueue)&&t.messageQueue.length>0&&(this.messageQueue=t.messageQueue.slice(0)))},y.prototype.sendMessage=function(t){this.locked||this.messageQueue[this.messageQueue.length-1]!==t&&this.messageQueue.push(t)},y.prototype.move=function(t){return this.orientation=t,g.prototype.move.call(this,t)},y.prototype.push=function(t){this.pushable&&this.move(t)},y.prototype.walk=function(){this.walkDirection&&(this.move(this.walkDirection)||this.sendMessage("THUD"))},y.prototype.doTick=function(){this.walk(),this.scriptContext&&this.scriptContext.executeTick()},y.prototype.setTorchRadius=function(t){this.torchRadius=t},y.prototype.getTorch=function(){if(this.torchRadius>0)return n.generateCircleData(this.point,this.torchRadius)},m.prototype=new g,m.prototype.constructor=m,m.prototype.serialize=function(){var t=g.prototype.serialize.call(this);return t.timeToLive=this.timeToLive,t.radius=this.radius,t},m.prototype.deserialize=function(t){g.prototype.deserialize.call(this,t),this.timeToLive=t.timeToLive||9,this.radius=t.radius||4},m.prototype.push=function(t){this.move(t)},m.prototype.getSpriteIndex=function(){return 57-(9-this.timeToLive)},m.prototype.doTick=function(){var t;this.play(this.timeToLive%2?"8":"5"),this.timeToLive-=1,this.timeToLive<0&&((t=new i.things.Explosion(this.board)).radius=this.radius,this.board.replaceTile(this.point,t))},w.prototype=new f,w.prototype.constructor=w,w.prototype.serialize=function(){var t=f.prototype.serialize.call(this);return delete t.color,t},w.prototype.deserialize=function(t){f.prototype.deserialize.call(this,t),this.background=void 0,this.foreground=o.Cyan},w.prototype.push=function(t){this.move(t)},w.prototype.sendMessage=function(t){"TOUCH"===t&&(this.oneTimeMessage("status.ammo"),this.play("tcc#d"),this.adjustCounter("AMMO",5),this.remove())},v.prototype=new g,v.prototype.constructor=v,v.prototype.serialize=function(){var t=g.prototype.serialize.call(this);return delete t.color,t.sensitivity=this.sensitivity,t},v.prototype.deserialize=function(t){g.prototype.deserialize.call(this,t),this.background=void 0,this.foreground=o.Brown,this.sensitivity=t.sensitivity||9},v.prototype.push=function(t,e){e&&"River"===e.type?this.move(t,!0):this.move(t)||(this.play("t+c---c++++c--c"),this.remove())},v.prototype.sendMessage=function(t){"SHOT"===t||"BOMBED"===t?(this.play("t+c---c++++c--c",!0),this.adjustCounter("SCORE",10),this.remove()):"TOUCH"===t&&(this.board.player.sendMessage("SHOT"),this.remove())},v.prototype.doTick=function(){var t,e;if(this.isPlayerAligned(10-this.sensitivity)){if(void 0===(e=this.getPlayerDirection("x"))&&(e=this.getPlayerDirection("y")),(t=this.board.getTile(this.point.add(e)))&&("BreakableWall"===t.type||"Player"===t.type))return t.sendMessage("SHOT"),void this.remove();if(t&&"River"===t.type&&t.direction===a.opposite(e))return;this.move(e,!0)}},b.prototype=new g,b.prototype.constructor=b,b.prototype.serialize=function(){var t=g.prototype.serialize.call(this);return t.period=this.period,t.delay=this.delay,t.direction=a.getShortName(this.direction),t},b.prototype.deserialize=function(t){g.prototype.deserialize.call(this,t),this.cycleCount=0,this.period=t.period||3,this.delay=t.delay||0,this.currentTick=this.period-this.delay-1,this.direction=t.direction?a.fromName(t.direction):a.North},b.prototype.doTick=function(){this.currentTick+=1,this.currentTick>=this.period&&(this.currentTick=0,this.blinkState=!this.blinkState,this.blink())},b.prototype.blink=function(){for(var t,e,i=this.point;i=i.add(this.direction),!this.board.isOutside(i);){if(t=this.board.getTile(i))if(this.blinkState||"BlinkWall"!==t.type){if("Player"!==t.type)break;if(t.sendMessage("SHOT"),t.isBlocked(a.clockwise(this.direction))?t.isBlocked(a.counterClockwise(this.direction))||(e=t.move(a.counterClockwise(this.direction))):e=t.move(a.clockwise(this.direction)),!e)break}else t.remove();this.blinkState&&this.board.addThing(i,this.createBlinkWall())}},b.prototype.createBlinkWall=function(){var t=new i.things.BlinkWall(this.board);return t.horizontal=this.direction!==a.North&&this.direction!==a.South,t.foreground=this.foreground,t},x.prototype=new f,x.prototype.constructor=x,x.prototype.serialize=function(){var t=f.prototype.serialize.call(this);return this.horizontal&&(t.horizontal=this.horizontal),t},x.prototype.deserialize=function(t){f.prototype.deserialize.call(this,t),this.horizontal=void 0!==t.horizontal&&t.horizontal},x.prototype.getSpriteIndex=function(){return this.horizontal?205:186},T.prototype=new f,T.prototype.constructor=T,T.prototype.deserialize=function(t){f.prototype.deserialize.call(this,t),this.radius=t.radius||4},T.prototype.serialize=function(){var t=f.prototype.serialize.call(this);return t.radius=this.radius,t},T.prototype.push=function(t){this.move(t)},T.prototype.sendMessage=function(t){var e;"TOUCH"===t&&(this.play("tcf+cf+c"),(e=new m(this.board)).radius=this.radius,e.foreground=this.foreground,e.background=this.background,this.board.replaceTile(this.point,e))},S.prototype=new f,S.prototype.constructor=S,S.prototype.push=function(t,e){e&&"River"===e.type?this.move(t,!0):this.move(t)&&this.play("t--f",!1,!0)},E.prototype=new f,E.prototype.constructor=E,E.prototype.sendMessage=function(t){"SHOT"===t||"BOMBED"===t?(this.play("t-c"),this.remove()):"TOUCH"===t&&this.oneTimeMessage("status.breakable")},k.prototype=new g,k.prototype.constructor=k,k.prototype.serialize=function(){var t=g.prototype.serialize.call(this)||{};return delete t.color,t.direction=a.getShortName(this.direction),this.fromPlayer&&(t.fromPlayer=!0),t},k.prototype.deserialize=function(t){g.prototype.deserialize.call(this,t),this.background=void 0,this.foreground=o.BrightWhite,this.direction=a.fromName(t.direction),t.fromPlayer&&(this.fromPlayer=t.fromPlayer)},k.prototype.sendMessage=function(t){"TOUCH"===t&&(this.board.player.sendMessage("SHOT"),this.remove())},k.prototype.updateOnReverse=function(){return this.direction===a.South||this.direction===a.East},k.prototype.influenceSmartPath=function(){var t,e;if(this.fromPlayer)for(t=this.point,e=0;e<10;e+=1)t=t.add(this.direction),this.board.adjustSmartPathWeight(t,100-10*e)},k.prototype.doTick=function(){this.move(this.direction,!0)||(this.attack(),this.react())},k.prototype.attack=function(){var t=this.board.getTile(this.point.add(this.direction));t&&(this.fromPlayer||"Player"===t.type||"Scriptable"===t.type||"BreakableWall"===t.type)&&t.sendMessage("SHOT")},k.prototype.react=function(){var t=this.getAdjacentThing(this.direction);if(t&&"Player"!==t.type){if("Ricochet"===t.type)return void this.ricochet(a.opposite(this.direction));if((t=this.getAdjacentThing(a.clockwise(this.direction)))&&"Ricochet"===t.type)return void this.ricochet(a.counterClockwise(this.direction));if((t=this.getAdjacentThing(a.counterClockwise(this.direction)))&&"Ricochet"===t.type)return void this.ricochet(a.clockwise(this.direction))}this.remove()},k.prototype.ricochet=function(t){this.direction=t,this.move(t,!0)?this.play("9",!1,!0):(this.attack(),this.remove())},k.prototype.push=function(){this.remove()},C.prototype=new g,C.prototype.constructor=C,C.prototype.serialize=function(){var t=g.prototype.serialize.call(this);return t.head=this.head,t.deviance=this.deviance,t.intelligence=this.intelligence,this.orientation&&(t.orientation=a.getShortName(this.orientation)),this.follower&&(t.nextSegment=a.getShortName(this.point.directionTo(this.follower.point))),t},C.prototype.deserialize=function(t){g.prototype.deserialize.call(this,t),this.head=t.head,this.intelligence=t.intelligence,this.deviance=t.deviance,t.orientation&&(this.orientation=a.fromName(t.orientation)),t.nextSegment&&(this.nextSegment=a.fromName(t.nextSegment)),this.deviance>10&&(this.deviance=10),this.intelligence>10&&(this.intelligence=10),this.head&&(this.spriteIndex=233),this.cycleCount=0},C.prototype.getAdjacentSegment=function(){function t(t){return t&&"Centipede"===t.type&&!t.linked&&!t.nextSegment&&!t.head}var e;return this.nextSegment&&(e=this.board.getTile(this.point.add(this.nextSegment)),delete this.nextSegment,e&&"Centipede"===e.type&&!e.head)?e:t(e=this.board.getTile(this.point.add(a.North)))?e:t(e=this.board.getTile(this.point.add(a.East)))?e:t(e=this.board.getTile(this.point.add(a.South)))?e:t(e=this.board.getTile(this.point.add(a.West)))?e:void 0},C.prototype.linkSegments=function(t){this.linked=!0,this.leader=t,this.leader&&(this.deviance=t.deviance,this.intelligence=t.intelligence,this.cycleCount=t.cycleCount,this.speed=t.speed),this.follower=this.getAdjacentSegment(),this.follower&&(this.head&&(this.orientation=this.follower.point.directionTo(this.point)),this.follower.linkSegments(this))},C.prototype.reverse=function(){var t=this.follower,e=this.leader;this.head&&(this.head=!1,this.spriteIndex=79),this.leader=this.follower,this.follower=e,t?t.reverse():this.becomeHead()},C.prototype.becomeHead=function(){this.head=!0,this.spriteIndex=233,this.cycleCount=Math.floor(Math.random()*this.speed)},C.prototype.move=function(t){var e=this.point.clone();if(this.head&&this.isPlayerAdjacent(t))return this.board.player.sendMessage("SHOT"),void this.remove();this.board.moveTile(this.point,this.point.add(t),!0),this.follower&&(t=this.follower.point.directionTo(e),this.follower.move(t))},C.prototype.push=function(){this.play("t+c---c++++c--c"),this.remove()},C.prototype.remove=function(){this.leader&&(this.leader.follower=void 0),this.follower&&(this.follower.leader=void 0),g.prototype.remove.call(this)},C.prototype.sendMessage=function(t){"SHOT"!==t&&"BOMBED"!==t||(this.play("t+c---c++++c--c",!0),this.adjustCounter("SCORE",10),this.remove()),"TOUCH"===t&&(this.board.player.sendMessage("SHOT"),this.remove())},C.prototype.deviate=function(){return!(this.deviance<=0)&&Math.floor(20*Math.random())<=this.deviance},C.prototype.seekPlayer=function(){return!(this.intelligence<=0)&&(!!this.isPlayerAligned()&&Math.floor(10*Math.random())<=this.intelligence)},C.prototype.doTick=function(){var t,e;this.firstTick?this.firstTick=!1:this.head||void 0!==this.leader||this.becomeHead(),this.head&&(this.linked||this.linkSegments(),this.seekPlayer()&&(this.orientation=this.getPlayerDirection()),this.orientation&&this.isAttackable(this.orientation)&&!this.deviate()?this.move(this.orientation):(e=this.getAttackableDirections()).length>0?(t=a.random(e),this.orientation=t,this.move(t)):this.reverse())},P.prototype=new g,P.prototype.constructor=P,P.animationFrames=[179,47,45,92],P.MoveAction={MOVE:1,TENTATIVE:2},P.prototype.serialize=function(){var t=g.prototype.serialize.call(this);return t.clockwise=this.clockwise,t},P.prototype.deserialize=function(t){g.prototype.deserialize.call(this,t),this.clockwise=t.clockwise},P.prototype.markPath=function(t){var e,i,s,o=P.MoveAction;for(e=t.length-1;e>=0;e-=1)(i=this.board.getTile(t[e]))&&i.conveyable&&(e===t.length-1?t[e].action=o.TENTATIVE:this.board.isOutside(t[e+1])||(!(s=this.board.getTile(t[e+1]))||!s.conveyable&&s.surrenderable?t[e].action=o.MOVE:t[e].action=t[e+1].action));if(this.board.isFreeOrSurrenderable(t[0])||t[0].action===o.MOVE||t[0].action===o.TENTATIVE)for(e=0;e<t.length;e+=1)t[e].action===o.TENTATIVE&&(t[e].action=o.MOVE)},P.prototype.executePath=function(t){var e,i,s;for(e=t.length-1;e>=0;e-=1)t[e].action===P.MoveAction.MOVE&&(s=this.board.getTile(t[e]),this.board.deleteTile(t[e]),e===t.length-1?i=s:this.board.addThing(t[e+1],s));i&&this.board.addThing(t[0],i)},P.prototype.doTick=function(){var t;this.clockwise?(this.animationIndex+=1,this.animationIndex>=P.animationFrames.length&&(this.animationIndex=0),t=[new s(this.point.x-1,this.point.y-1),new s(this.point.x,this.point.y-1),new s(this.point.x+1,this.point.y-1),new s(this.point.x+1,this.point.y),new s(this.point.x+1,this.point.y+1),new s(this.point.x,this.point.y+1),new s(this.point.x-1,this.point.y+1),new s(this.point.x-1,this.point.y)]):(this.animationIndex-=1,this.animationIndex<0&&(this.animationIndex=P.animationFrames.length-1),t=[new s(this.point.x-1,this.point.y-1),new s(this.point.x-1,this.point.y),new s(this.point.x-1,this.point.y+1),new s(this.point.x,this.point.y+1),new s(this.point.x+1,this.point.y+1),new s(this.point.x+1,this.point.y),new s(this.point.x+1,this.point.y-1),new s(this.point.x,this.point.y-1)]),this.markPath(t),this.executePath(t),this.spriteIndex=P.animationFrames[this.animationIndex]},M.prototype=new f,M.prototype.constructor=M,M.prototype.deserialize=function(t){f.prototype.deserialize.call(this,t),this.foreground=o.BrightWhite,this.background?(this.background.isLight()&&(this.background=this.background.darken()),this.background===o.Black&&(this.background=o.White)):this.background=o.Blue},M.prototype.sendMessage=function(t){var e,i;"TOUCH"===t&&(e=d.getMessage("doors."+this.background.code),i="KEY"+this.background.lighten().code,this.getCounterValue(i)>0?(this.remove(),this.adjustCounter(i,-1),this.board.setDisplayMessage(d.getMessage("doors.open",e)),this.play("tcgbcgb+ic")):(this.board.setDisplayMessage(d.getMessage("doors.locked",e)),this.play("t--gc")))},I.prototype=new g,I.prototype.constructor=I,I.animationFrames=[250,249,7,9,111,79],I.prototype.serialize=function(){var t=g.prototype.serialize.call(this);return delete t.color,t.copyDirection=a.getShortName(this.copyDirection),t},I.prototype.deserialize=function(t){g.prototype.deserialize.call(this,t),this.background=void 0,this.foreground=o.BrightWhite,t.copyDirection&&(this.copyDirection=a.fromName(t.copyDirection))},I.prototype.doTick=function(){var t,e,i,s,o=!1;this.currentStep+=1,this.currentStep>=this.MAX_STEPS&&(this.currentStep=0,i=this.point.add(this.copyDirection),t=this.board.getTile(i),s=this.point.add(a.opposite(this.copyDirection)),this.board.isOutside(s)?t=void 0:e=this.board.getTile(s),t&&(!e||this.board.moveTile(this.point,s,!1,!0))&&(o=!0,this.board.addThing(s,t.clone(),!0)),this.play(o?"scdefg":"--g#f#")),this.spriteIndex=I.animationFrames[Math.round(this.currentStep/this.MAX_STEPS*(I.animationFrames.length-1))]},O.prototype=new g,O.prototype.constructor=O,O.MAX_TTL=5,O.prototype.deserialize=function(t){g.prototype.deserialize.call(this,t),this.radius=t.radius||4,this.timeToLive=t.timeToLive||O.MAX_TTL},O.prototype.serialize=function(){var t=g.prototype.serialize(this);return t.radius=this.radius,t.timeToLive=this.timeToLive,t},O.prototype.doTick=function(){var t,e,i;if(this.timeToLive===O.MAX_TTL)for(this.play("t+++c-c-c-c-c-c",!0),t=n.pointsInCircle(this.point,this.radius),e=0;e<t.length;e+=1)(i=this.board.getTile(t[e]))&&i.sendMessage("BOMBED");this.timeToLive-=1,this.timeToLive<=0&&this.remove()},O.prototype.getTorch=function(){return n.generateCircleData(this.point,Math.round(this.radius*this.timeToLive/(O.MAX_TTL-1))+2)},O.prototype.render=function(t){var e,i,s,r=this.board.game.resources.graphics.getSprite(176+Math.round(2*this.timeToLive/O.MAX_TTL));for(s=this.timeToLive===O.MAX_TTL?Math.round(this.radius/2):Math.round(this.radius*this.timeToLive/(O.MAX_TTL-1)),e=n.pointsInCircle(this.point,s),i=0;i<e.length;i+=1)r.draw(t,e[i].subtract(this.board.windowOrigin),o.Yellow,o.Red)},B.prototype=new f,B.prototype.constructor=B,B.prototype.isSurrenderable=function(){return!0},B.prototype.getSpriteIndex=function(){return this.board.game.isEditor?176:178},A.prototype=new f,A.noteCycle=["e","-b","f#","b","f","c","g","+c"],A.noteIndex=0,A.prototype.constructor=A,A.prototype.serialize=function(){var t=f.prototype.serialize.call(this);return delete t.color,t},A.prototype.deserialize=function(t){f.prototype.deserialize.call(this,t),this.background=o.Green,this.foreground=o.Black},A.prototype.sendMessage=function(t){"TOUCH"===t&&(this.oneTimeMessage("status.forest"),this.play(A.noteCycle[A.noteIndex]),A.noteIndex+=1,A.noteIndex>=A.noteCycle.length&&(A.noteIndex=0),this.board.deleteTile(this.point))},L.prototype=new f,L.prototype.constructor=L,L.prototype.sendMessage=function(t){"TOUCH"===t?(this.oneTimeMessage("status.gem"),this.remove(),this.adjustCounter("HEALTH",1),this.adjustCounter("GEMS",1),this.adjustCounter("SCORE",10),this.play("t+c-gec")):"SHOT"!==t&&"BOMBED"!==t||(this.remove(),this.play("t-c"))},L.prototype.push=function(t,e){e&&"River"===e.type?this.move(t,!0):this.move(t)||this.remove()},R.restrictions=["Scriptable","Lion","Tiger","Bear","Ruffian","Centipede","Spider","Snake"],R.prototype=new f,R.prototype.constructor=R,R.prototype.isSurrenderable=function(t){if(t&&R.restrictions.indexOf(t.type)<0)return!0},R.prototype.getSpriteIndex=function(){return this.board.game.isEditor?176:0},z.prototype=new f,z.prototype.constructor=z,z.prototype.serialize=function(){var t=f.prototype.serialize.call(this);return delete t.color,t},z.prototype.deserialize=function(t){f.prototype.deserialize.call(this,t),this.foreground=o.BrightRed,this.background=void 0},z.prototype.sendMessage=function(t){"TOUCH"===t&&(this.remove(),this.play("tcefg+ceg"),this.adjustCounter("HEALTH_MAX",10),this.adjustCounter("HEALTH",10),this.adjustCounter("SCORE",500),this.board.setDisplayMessage(d.getMessage("status.heart")))},z.prototype.push=function(t,e){e&&"River"===e.type?this.move(t,!0):this.move(t)},N.prototype=new f,N.prototype.constructor=N,N.prototype.sendMessage=function(t){var e,s=i.things.Wall;"TOUCH"===t&&((e=new s).foreground=this.foreground,e.background=this.background,this.oneTimeMessage("status.invisible"),this.board.replaceTile(this.point,e),this.play("t--dc"))},N.prototype.getSpriteIndex=function(){return this.board.game.isEditor?176:0},F.prototype=new f,F.prototype.constructor=F,F.prototype.deserialize=function(t){f.prototype.deserialize.call(this,t),this.foreground=this.foreground.lighten(),(this.foreground.cycles||this.foreground===o.Grey)&&(this.foreground=o.BrightWhite),this.background=void 0},F.prototype.sendMessage=function(t){var e;"TOUCH"===t&&(e=d.getMessage("keys."+this.foreground.code),this.getCounterValue("KEY"+this.foreground.code)>0?(this.board.setDisplayMessage(d.getMessage("keys.toomany",e)),this.play("sc-c")):(this.remove(),this.adjustCounter("KEY"+this.foreground.code,1),this.board.setDisplayMessage(d.getMessage("keys.collect",e)),this.play("t+cegcegceg+sc")))},F.prototype.push=function(t,e){e&&"Player"===e.type||(e&&"River"===e.type?this.move(t,!0):this.move(t)&&this.play("t--f",!1,!0))},D.prototype=new f,D.prototype.constructor=D,D.prototype.serialize=function(){var t=f.prototype.serialize.call(this);return delete t.color,t},D.prototype.deserialize=function(t){f.prototype.deserialize.call(this,t),this.background=o.BrightRed,this.foreground=o.BrightRed},D.prototype.updateWhileUnder=function(){var t=this.board.getTile(this.point);t&&("Player"===t.type?(this.cycleCount+=1,this.cycleCount>this.cycleRate&&(this.cycleCount=0,t.sendMessage("SHOT"))):"Scriptable"===t.type?t.sendMessage("LAVA"):t.lavaWalker||t.sendMessage("SHOT"))},D.prototype.sendMessage=function(t){"TOUCH"===t&&(this.cycleCount=0,this.board.player.sendMessage("SHOT"))},D.prototype.isSurrenderable=function(){return!0},W.prototype=new f,W.prototype.constructor=W,W.lineMap={"":249,N:208,E:198,S:210,W:181,NE:200,NS:186,NW:188,ES:201,EW:205,SW:187,NES:204,NEW:202,NSW:185,ESW:203,NESW:206},W.prototype.getSpriteIndex=function(){if(void 0!==this.spriteIndex&&!this.board.game.isEditor)return this.spriteIndex;function t(t,e){var i=t.board.getTile(t.point.add(e));return i&&"LineWall"===i.type}var e="";return e+=t(this,a.North)?"N":"",e+=t(this,a.East)?"E":"",e+=t(this,a.South)?"S":"",e+=t(this,a.West)?"W":"",this.spriteIndex=W.lineMap[e],this.spriteIndex},U.prototype=new g,U.prototype.constructor=U,U.prototype.serialize=function(){var t=g.prototype.serialize.call(this);return delete t.color,t.intelligence=this.intelligence,t},U.prototype.deserialize=function(t){g.prototype.deserialize.call(this,t),this.background=void 0,this.foreground=o.BrightRed,this.intelligence=t.intelligence},U.prototype.sendMessage=function(t){"SHOT"===t||"BOMBED"===t?(this.play("t+c---c++++c--c",!0),this.adjustCounter("SCORE",10),this.remove()):"TOUCH"===t&&(this.board.player.sendMessage("SHOT"),this.remove())},U.prototype.push=function(t,e){e&&"River"===e.type?this.move(t,!0):this.move(t)||(this.play("t+c---c++++c--c"),this.remove())},U.prototype.seekPlayer=function(){return Math.floor(10*Math.random())<=this.intelligence},U.prototype.doTick=function(){var t=this.seekPlayer()?this.getPlayerDirection():a.random(),e=this.board.getTile(this.point.add(t));if(e&&"Player"===e.type)return e.sendMessage("SHOT"),void this.remove();e&&"River"===e.type&&e.direction===a.opposite(t)||this.move(t,!0)},H.prototype=new f,H.prototype.constructor=H,H.prototype.sendMessage=function(t){"TOUCH"===t&&(this.play("tceg tc#fg# tdf#a td#ga# teg#+c"),this.board.game.movePlayerToPassage(this.passageId,this.targetBoard))},H.prototype.serialize=function(){var t=f.prototype.serialize.call(this);return t.passageId=this.passageId,t.targetBoard=this.targetBoard,t},H.prototype.deserialize=function(t){f.prototype.deserialize.call(this,t),this.foreground=o.BrightWhite,this.background||(this.background=o.Blue),this.targetBoard=t.targetBoard,this.passageId=t.passageId},G.prototype=new g,G.prototype.constructor=G,G.prototype.serialize=function(){return this.under?this.under.serialize():0},G.prototype.push=function(t){this.move(t)},G.prototype.move=function(t){var e,i=this.point.clone(),s=this.point.add(t);return this.board.isOutside(s)?(t=this.point.directionTo(s),this.board.movePlayerOffBoard(t),!1):((e=this.board.getTile(s))&&e.sendMessage("TOUCH"),!!this.point.equals(i)&&this.board.moveTile(this.point,s))},G.prototype.shoot=function(t){this.board.canPlayerShoot(!0)<=0?this.play("02"):this.getCounterValue("AMMO")>0?(this.adjustCounter("AMMO",-1),l.shoot(this.board,this.point.add(t),t,!0)):this.board.setDisplayMessage(d.getMessage("status.noammo"))},G.prototype.doTick=function(){var t=this.eventScheduler.takeEvent();t&&(0===t.type?this.move(t.direction):1===t.type&&this.shoot(t.direction))},G.prototype.update=function(){var t=this.game.keyboard,e=t.getMostRecentPress([t.UP,t.RIGHT,t.DOWN,t.LEFT]);t.isPressed(t.SHIFT)||t.isPressed(t.SPACE)?e===t.UP?this.eventScheduler.scheduleEvent(t.isPressed(t.UP),{type:1,direction:a.North}):e===t.RIGHT?this.eventScheduler.scheduleEvent(t.isPressed(t.RIGHT),{type:1,direction:a.East}):e===t.DOWN?this.eventScheduler.scheduleEvent(t.isPressed(t.DOWN),{type:1,direction:a.South}):e===t.LEFT?this.eventScheduler.scheduleEvent(t.isPressed(t.LEFT),{type:1,direction:a.West}):this.eventScheduler.cancelEvent():(e===t.UP?this.eventScheduler.scheduleEvent(t.isPressed(t.UP),{type:0,direction:a.North}):e===t.RIGHT?this.eventScheduler.scheduleEvent(t.isPressed(t.RIGHT),{type:0,direction:a.East}):e===t.DOWN?this.eventScheduler.scheduleEvent(t.isPressed(t.DOWN),{type:0,direction:a.South}):e===t.LEFT?this.eventScheduler.scheduleEvent(t.isPressed(t.LEFT),{type:0,direction:a.West}):this.eventScheduler.cancelEvent(),t.isPressed([t.T])&&this.useTorch()),g.prototype.update.call(this),this.board.initializeTorch(this)},G.prototype.useTorch=function(){if(!(this.game.getCounterValue("TORCHLIFE")>1e4))if(this.game.getCounterValue("TORCHES")>0){if(!this.board.dark)return void this.board.setDisplayMessage(d.getMessage("status.notdark"));this.game.adjustCounter("TORCHES",-1),this.game.setCounterValue("TORCHLIFE",6e4)}else this.board.setDisplayMessage(d.getMessage("status.notorches"))},G.prototype.getTorch=function(){var t=this.game.getCounterValue("TORCHLIFE"),e=4;if(t>0)return t<2e4&&(e=Math.ceil(4*t/2e4)),n.generateCircleData(this.point,e)},G.prototype.sendMessage=function(t){"SHOT"!==t&&"BOMBED"!==t||(this.play("t--c+c-c+d#",!0),this.adjustCounter("HEALTH",-10),this.board.playerHurt())},V.prototype=new g,V.prototype.constructor=V,V.prototype.initializeSprite=function(){this.orientation===a.North?this.spriteIndex=30:this.orientation===a.East?this.spriteIndex=16:this.orientation===a.South?this.spriteIndex=31:this.orientation===a.West&&(this.spriteIndex=17)},V.prototype.serialize=function(){var t=g.prototype.serialize.call(this);return t.orientation=a.getName(this.orientation),t},V.prototype.deserialize=function(t){g.prototype.deserialize.call(this,t),this.background=void 0,t.orientation&&(this.orientation=a.fromName(t.orientation)),this.initializeSprite()},V.prototype.doTick=function(){this.move(this.orientation)&&this.play("t--f",!1,!0)},j.prototype=new f,j.prototype.constructor=j,j.prototype.serialize=function(){var t=f.prototype.serialize.call(this);return delete t.color,t},j.prototype.deserialize=function(t){f.prototype.deserialize.call(this,t),this.background=void 0,this.foreground=o.BrightGreen},_.prototype=new f,_.prototype.constructor=_,_.prototype.initialize=function(){switch(a.getShortName(this.direction)){case"N":this.spriteIndex=30;break;case"E":this.spriteIndex=16;break;case"S":this.spriteIndex=31;break;case"W":this.spriteIndex=17}},_.prototype.updateWhileUnder=function(){g.prototype.update.call(this)},_.prototype.doTick=function(){var t=this.board.getTile(this.point);t.conveyable&&t.push(this.direction,this)},_.prototype.isSurrenderable=function(){return!0},_.prototype.serialize=function(){var t=g.prototype.serialize.call(this);return delete t.color,delete t.speed,t.direction=a.getShortName(this.direction),t},_.prototype.deserialize=function(t){g.prototype.deserialize.call(this,t),this.background=o.Blue,this.foreground=o.BrightBlue,t.direction&&(this.direction=a.fromName(t.direction)),this.initialize()},q.prototype=new g,q.prototype.constructor=q,q.prototype.serialize=function(){var t=g.prototype.serialize.call(this);return delete t.color,t.intelligence=this.intelligence,t.restingTime=this.restingTime,t},q.prototype.deserialize=function(t){g.prototype.deserialize.call(this,t),this.background=void 0,this.foreground=o.BrightMagenta,this.intelligence=t.intelligence||5,this.restingTime=t.restingTime||5},q.prototype.push=function(t,e){e&&"River"===e.type?this.move(t,!0):this.move(t)||(this.remove(),this.play("t+c---c++++c--c"))},q.prototype.sendMessage=function(t){"SHOT"===t||"BOMBED"===t?(this.play("t+c---c++++c--c",!0),this.adjustCounter("SCORE",10),this.remove()):"TOUCH"===t&&(this.board.player.sendMessage("SHOT"),this.remove())},q.prototype.seekPlayer=function(){return Math.floor(10*Math.random())<=this.intelligence},q.prototype.doTick=function(){if(this.timeLeft-=1,this.timeLeft<=0&&(this.moving=!this.moving,this.moving?(this.orientation=this.seekPlayer()?this.getPlayerDirection():a.random(),this.timeLeft=Math.floor(10*Math.random())):this.timeLeft=Math.floor(10*Math.random())-(10-this.restingTime)),this.moving){var t=this.board.getTile(this.point.add(this.orientation));if(t&&"Player"===t.type)return t.sendMessage("SHOT"),void this.remove();if(t&&"River"===t.type&&t.direction===a.opposite(this.orientation))return;this.move(this.orientation,!0)}},K.prototype=new f,K.prototype.constructor=K,K.prototype.serialize=function(){var t=f.prototype.serialize.call(this);return delete t.color,t.text=this.text,t},K.prototype.deserialize=function(t){f.prototype.deserialize.call(this,t),this.background=void 0,this.foreground=o.Brown,this.text=t.text},K.prototype.sendMessage=function(t){var e,i,s;if("TOUCH"===t){for(this.board.game.scroll.setTitle(d.getMessage("obstacles.signpost")),this.board.game.scroll.clearLines(),this.text||(this.text=d.getMessage("obstacles.signpostmessage")),e=this.text.split("\n"),i=0;i<e.length;i+=1)s=d.getBoardMessage(this.board,e[i]),this.board.game.scroll.addLine(s);this.play("tc-c+d-d+e-e+f-f+g-g"),this.board.game.setState(h.Reading)}},Y.prototype=new f,Y.prototype.constructor=Y,Y.prototype.push=function(t){(t.equals(a.East)||t.equals(a.West))&&this.move(t)&&this.play("t--f",!1,!0)},Z.prototype=new f,Z.prototype.constructor=Z,Z.prototype.push=function(t){(t.equals(a.North)||t.equals(a.South))&&this.move(t)&&this.play("t--f",!1,!0)},X.prototype=new g,X.prototype.constructor=X,X.prototype.serialize=function(){var t=g.prototype.serialize.call(this);return delete t.color,t},X.prototype.push=function(t,e){e&&"River"===e.type?this.move(t,!0):this.move(t)||(this.play("t+c---c++++c--c"),this.remove())},X.prototype.sendMessage=function(t){"SHOT"===t||"BOMBED"===t?(this.play("t+c---c++++c--c",!0),this.adjustCounter("SCORE",10),this.remove()):"TOUCH"===t&&(this.board.player.sendMessage("SHOT"),this.remove())},X.prototype.doTick=function(){var t,e=this.getSmartDirection();if(e){if(this.foreground=o.BrightGreen,(t=this.board.getTile(this.point.add(e)))&&"Player"===t.type)return t.sendMessage("SHOT"),void this.remove();this.move(e,!0)}else this.foreground=o.Green},J.prototype=new f,J.prototype.constructor=J,Q.prototype=new g,Q.prototype.constructor=Q,Q.prototype.serialize=function(){var t=g.prototype.serialize.call(this);return t.intelligence=this.intelligence,t},Q.prototype.deserialize=function(t){g.prototype.deserialize.call(this,t),this.intelligence=t.intelligence},Q.prototype.seekPlayer=function(){return Math.floor(10*Math.random())<=this.intelligence},Q.prototype.isAttackable=function(t){var e=this.board.getTile(this.point.add(t));return e&&("SpiderWeb"===e.type||"Player"===e.type)},Q.prototype.sendMessage=function(t){"SHOT"===t||"BOMBED"===t?(this.play("t+c---c++++c--c",!0),this.adjustCounter("SCORE",10),this.remove()):"TOUCH"===t&&(this.board.player.sendMessage("SHOT"),this.remove())},Q.prototype.push=function(t){this.move(t)||(this.play("t+c---c++++c--c"),this.remove())},Q.prototype.doTick=function(){var t,e=this.seekPlayer()?this.getPlayerDirection():a.random(this.getAttackableDirections());if(void 0!==e){if((t=this.board.getTile(this.point.add(e)))&&"Player"===t.type)return t.sendMessage("SHOT"),void this.remove();t&&"SpiderWeb"===t.type&&this.move(e,!0)}},$.prototype=new f,$.prototype.constructor=$,$.lineMap={"":249,N:179,E:196,S:179,W:196,NE:192,NS:179,NW:217,ES:218,EW:196,SW:191,NES:195,NEW:193,NSW:180,ESW:194,NESW:197},$.prototype.getSpriteIndex=function(){if(void 0!==this.spriteIndex&&!this.board.game.isEditor)return this.spriteIndex;function t(t,e){var i=t.board.getTile(t.point.add(e));return i&&("SpiderWeb"===i.type||i.under&&"SpiderWeb"===i.under.type)}var e="";return e+=t(this,a.North)?"N":"",e+=t(this,a.East)?"E":"",e+=t(this,a.South)?"S":"",e+=t(this,a.West)?"W":"",this.spriteIndex=$.lineMap[e],this.spriteIndex},$.prototype.isSurrenderable=function(){return!0},tt.prototype=new g,tt.prototype.constructor=tt,tt.animationFrames=[24,26,25,27],tt.prototype.serialize=function(){var t=g.prototype.serialize.call(this);return t.intelligence=this.intelligence,t.firingRate=this.firingRate,t},tt.prototype.deserialize=function(t){g.prototype.deserialize.call(this,t),this.intelligence=t.intelligence||5,this.firingRate=t.firingRate||5},tt.prototype.doTick=function(){var t=this;function e(e){if(Math.floor(10*Math.random())<=t.firingRate){var i=e?a.random():t.getPlayerDirection();l.shoot(t.board,t.point.add(i),i)}}this.animationIndex+=1,this.animationIndex>=tt.animationFrames.length&&(this.animationIndex=0),this.spriteIndex=tt.animationFrames[this.animationIndex],Math.floor(9*Math.random())<=this.intelligence?this.isPlayerAligned(2)&&e():e(!0)},et.prototype=new g,et.prototype.constructor=et,et.animationFrames={North:[196,126,94,126],East:[179,41,62,41],South:[196,126,118,126],West:[179,40,60,40]},et.prototype.serialize=function(){var t=g.prototype.serialize.call(this);return t.orientation=a.getName(this.orientation),t},et.prototype.deserialize=function(t){g.prototype.deserialize.call(this,t),t.orientation&&(this.orientation=a.fromName(t.orientation))},et.prototype.doTick=function(){this.animationFrame+=1,this.animationFrame>=et.animationFrames[a.getName(this.orientation)].length&&(this.animationFrame=0)},et.prototype.getSpriteIndex=function(){return et.animationFrames[a.getName(this.orientation)][this.animationFrame]},et.prototype.push=function(t){if(this.orientation.equals(t)){var e,i=this.point.add(a.opposite(this.orientation)),s=this.point.add(this.orientation),o=this.board.getTile(s);if((!o||"Teleporter"!==o.type)&&this.board.moveTile(i,s))return this.play("tc+d-e+f#-g#+a#c+d"),!0;for(;!this.board.isOutside(s);){if((e=this.board.getTile(s))&&"Teleporter"===e.type&&e.orientation===a.opposite(this.orientation)){if(this.board.moveTile(i,s.add(this.orientation)))return this.play("tc+d-e+f#-g#+a#c+d"),!0;break}s=s.add(this.orientation)}}},it.prototype=new f,it.prototype.constructor=it,it.prototype.serialize=function(){var t=f.prototype.serialize.call(this);return t.i18n=this.i18n,t},it.prototype.deserialize=function(t){f.prototype.deserialize.call(this,t),this.i18n=t.i18n||{en:0},this.foreground=o.BrightWhite},it.prototype.getSpriteIndex=function(){return(this.i18n.hasOwnProperty(d.getLanguage())?this.i18n[d.getLanguage()]:this.i18n[d.DefaultLanguage])||0},st.prototype=new g,st.prototype.constructor=st,st.animationFrames=[179,47,196,92],st.prototype.serialize=function(){var t=g.prototype.serialize.call(this);return delete t.color,t.timeToLive=this.timeToLive,t},st.prototype.deserialize=function(t){g.prototype.deserialize.call(this,t),this.foreground=o.Cycle,this.background=void 0,this.timeToLive=t.timeToLive||100},st.prototype.sendMessage=function(t){"TOUCH"===t&&(this.board.player.sendMessage("SHOT"),this.remove())},st.prototype.doTick=function(){var t,e;if(this.timeToLive-=1,this.timeToLive<=0)this.remove();else if(this.animationIndex+=1,this.animationIndex>=st.animationFrames.length&&(this.animationIndex=0),this.spriteIndex=st.animationFrames[this.animationIndex],this.nextMove-=1,this.nextMove<=0){if(this.nextMove=2,t=this.getPlayerDirection(),(e=this.board.getTile(this.point.add(t)))&&("BreakableWall"===e.type||"Player"===e.type))return e.sendMessage("SHOT"),void this.remove();this.move(this.getPlayerDirection())}},ot.prototype=new g,ot.prototype.constructor=ot,ot.prototype.serialize=function(){var t=g.prototype.serialize.call(this);return delete t.color,t.intelligence=this.intelligence,t.firingRate=this.firingRate,t},ot.prototype.deserialize=function(t){g.prototype.deserialize(this,t),this.background=void 0,this.foreground=o.BrightCyan,this.intelligence=void 0===t.intelligence?5:t.intelligence,this.firingRate=void 0===t.firingRate?5:t.firingRate},ot.prototype.sendMessage=function(t){"SHOT"===t||"BOMBED"===t?(this.play("t+c---c++++c--c",!0),this.adjustCounter("SCORE",10),this.remove()):"TOUCH"===t&&(this.board.player.sendMessage("SHOT"),this.remove())},ot.prototype.push=function(t,e){e&&"River"===e.type?this.move(t,!0):this.move(t)||(this.play("t+c---c++++c--c"),this.remove())},ot.prototype.seekPlayer=function(){return Math.floor(10*Math.random())<=this.intelligence},ot.prototype.shootPlayer=function(){return Math.floor(20*Math.random())<=this.firingRate},ot.prototype.doTick=function(){var t,e=this.seekPlayer()?this.getPlayerDirection():a.random(),i=this.board.getTile(this.point.add(e));if(i&&"Player"===i.type)return i.sendMessage("SHOT"),void this.remove();i&&"River"===i.type&&i.direction===a.opposite(e)||this.move(e,!0),this.shootPlayer()&&(t=this.getPlayerDirection(),l.shoot(this.board,this.point.add(t),t))},rt.prototype=new f,rt.prototype.constructor=rt,rt.prototype.serialize=function(){var t=f.prototype.serialize.call(this);return delete t.color,t},rt.prototype.deserialize=function(t){f.prototype.deserialize.call(this,t),this.background=void 0,this.foreground=o.Brown},rt.prototype.push=function(t){this.move(t)},rt.prototype.sendMessage=function(t){"TOUCH"===t&&(this.oneTimeMessage("status.torch"),this.play("tcase"),this.adjustCounter("TORCHES",1),this.remove())},nt.prototype=new f,nt.prototype.constructor=nt,at.prototype=new f,at.prototype.constructor=at,at.prototype.serialize=function(){var t=f.prototype.serialize.call(this);return delete t.color,t},at.prototype.deserialize=function(t){f.prototype.deserialize.call(this,t),this.background=o.BrightWhite,this.foreground=o.BrightBlue},at.prototype.isSurrenderable=function(t){if(t&&("Bullet"===t.type||"ThrowingStar"===t.type))return!0},at.prototype.sendMessage=function(t){"TOUCH"===t&&(this.play("t+c+c"),this.board.setDisplayMessage(d.getMessage("obstacles.water"),1))},l.deserialize=function(t,e){var i,s;if(t&&t.type&&(i=l.getThingMap()[t.type.toUpperCase()]))return(s=new i(e)).deserialize(t),s},l.isKnownThing=function(t){return void 0!==l.getThingMap()[t.toUpperCase()]},l.getThingMap=function(){var t;if(void 0===l.thingMap)for(t in l.thingMap={},i.things)i.things.hasOwnProperty(t)&&i.things[t].type&&(l.thingMap[t.toUpperCase()]=i.things[t]);return l.thingMap},l.shoot=function(t,e,i,s,o){var r=t.getTile(e),n=o?new st(t):new k(t);n.direction=i,s&&(n.fromPlayer=s),void 0===r||r.isSurrenderable(n)?(t.addThing(e,n,!0),s&&t.game.resources.audio.play("t+c-c-c")):s&&r&&"Ricochet"===r.type?t.player.sendMessage("SHOT"):(s||r&&("Player"===r.type||"Scriptable"===r.type||"BreakableWall"===r.type))&&(s&&t.game.resources.audio.play("t+c-c-c"),r.sendMessage("SHOT"))},i.Thing=f,i.UpdateableThing=g,u("Scriptable",y),u("ActiveBomb",m),u("Ammo",w),u("Bear",v),u("Blinker",b),u("BlinkWall",x),u("Bomb",T),u("Boulder",S),u("BreakableWall",E),u("Bullet",k),u("Centipede",C),u("Conveyor",P),u("Door",M),u("Duplicator",I),u("Explosion",O),u("FakeWall",B),u("Forest",A),u("Gem",L),u("GeoFence",R),u("Heart",z),u("InvisibleWall",N),u("Key",F),u("Lava",D),u("LineWall",W),u("Lion",U),u("Passage",H),u("Player",G),u("Pusher",V),u("Ricochet",j),u("River",_),u("Ruffian",q),u("Signpost",K),u("SliderEw",Y),u("SliderNs",Z),u("Snake",X),u("SolidWall",J),u("Spider",Q),u("SpiderWeb",$),u("SpinningGun",tt),u("Teleporter",et),u("Text",it),u("ThrowingStar",st),u("Tiger",ot),u("Torch",rt),u("Wall",nt),u("Water",at),i.ThingFactory=l},{"./basic":3,"./game-state":6,"./graphics":7,"./i18n":8,"./jzt-script-context":11}]},{},[14])(14)});
